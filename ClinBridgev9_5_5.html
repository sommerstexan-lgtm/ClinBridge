<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CRFJX46Y7Y"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-CRFJX46Y7Y');
</script>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0">
<title>ClinBridge v9.5.5</title>
<link rel="apple-touch-icon" href="https://sommerstexan-lgtm.github.io/ClinBridge/ClinBridge-App-logo.JPG">
<link rel="icon" type="image/jpeg" href="https://sommerstexan-lgtm.github.io/ClinBridge/ClinBridge-App-logo.JPG">
<style>
body{font-family:-apple-system,sans-serif;background:#f9fafb;padding:16px;margin:0;font-size:18px}
.card{background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.1);padding:24px;margin-bottom:16px}
.hdr{font-size:32px;font-weight:bold;margin-bottom:16px}
.btn{width:100%;padding:20px;border:none;border-radius:12px;color:#fff;font-weight:600;margin-bottom:12px;font-size:20px;cursor:pointer}
.bp{background:#10b981}.ml{background:#9333ea}.fl{background:#3b82f6}.settings-btn{background:#6366f1}.wt{background:#f97316}.sy{background:#ec4899}.ac{background:#14b8a6}
.reading{border:2px solid #e5e7eb;border-radius:8px;padding:20px;margin-bottom:12px;position:relative;font-size:18px}
.drop{margin-top:8px;padding:12px;background:#f3f4f6;border-radius:6px;font-size:18px}
.flex{display:flex;justify-content:space-between}
.b{font-weight:700}
.del{position:absolute;top:8px;right:8px;background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:16px;font-weight:600;cursor:pointer}
.logo-img{
  display:block;
  margin:48px auto 24px auto;
  width:60%;
  max-width:720px;
  height:auto;
  border:none;
}


/* Weight Alert Styles */
.weight-alert{
  background:#fef3c7;
  border-left:4px solid #f59e0b;
  padding:16px;
  margin-bottom:16px;
  border-radius:8px;
  font-size:16px;
}
.weight-alert.critical{
  background:#fee2e2;
  border-left-color:#ef4444;
}

/* Symptom Severity Styles */
.severity-selector{
  display:flex;
  gap:8px;
  margin:12px 0;
  flex-wrap:wrap;
}
.severity-btn{
  flex:1;
  min-width:40px;
  padding:12px;
  border:2px solid #e5e7eb;
  border-radius:8px;
  background:#fff;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s;
}
.severity-btn.selected{
  border-color:#ec4899;
  background:#ec4899;
  color:#fff;
}
.severity-low{border-color:#10b981 !important;background:#10b981 !important;}
.severity-medium{border-color:#f59e0b !important;background:#f59e0b !important;}
.severity-high{border-color:#ef4444 !important;background:#ef4444 !important;}

/* Custom Dialog Styles */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:99999;overflow:auto}
.modal-content{background:#fff;margin:20px auto;padding:30px;border-radius:16px;max-width:800px;max-height:90vh;overflow-y:auto;font-size:20px}
.modal-title{font-size:32px;font-weight:bold;margin-bottom:20px;text-align:center}
.modal-btn{width:100%;padding:18px;margin:8px 0;border:none;border-radius:12px;font-size:24px;font-weight:600;cursor:pointer;background:#e5e7eb;color:#000}
.modal-btn:active{background:#d1d5db}
.modal-btn.selected{background:#3b82f6;color:#fff}
.modal-input{width:100%;padding:18px;margin:8px 0;border:2px solid #e5e7eb;border-radius:12px;font-size:22px;box-sizing:border-box;-webkit-appearance:none;appearance:none}
input[type="time"].modal-input,input[type="time"]{-webkit-appearance:auto;appearance:auto}
.modal-actions{display:flex;gap:12px;margin-top:20px}
.modal-cancel{background:#6b7280;color:#fff;flex:1;padding:18px;border:none;border-radius:12px;font-size:22px;font-weight:600;cursor:pointer}
.modal-ok{background:#10b981;color:#fff;flex:1;padding:18px;border:none;border-radius:12px;font-size:22px;font-weight:600;cursor:pointer}

/* Audio Alert Notification */
.audio-alert{
  display:none;
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#fff;
  border:4px solid #ef4444;
  border-radius:16px;
  padding:30px;
  box-shadow:0 10px 40px rgba(0,0,0,0.3);
  z-index:9999;
  min-width:320px;
  text-align:center;
  animation:pulse 1s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { transform: translate(-50%,-50%) scale(1); }
  50% { transform: translate(-50%,-50%) scale(1.05); }
}

.audio-alert-title{
  font-size:28px;
  font-weight:bold;
  color:#dc2626;
  margin-bottom:16px;
}

.audio-alert-event{
  font-size:24px;
  font-weight:600;
  color:#111827;
  margin-bottom:20px;
}

.audio-alert-btn{
  background:#ef4444;
  color:#fff;
  border:none;
  padding:16px 32px;
  border-radius:12px;
  font-size:20px;
  font-weight:600;
  cursor:pointer;
  width:100%;
}

.audio-alert-btn:active{
  background:#dc2626;
}

.missed-alert-badge{
  display:none;
  position:fixed;
  top:20px;
  right:20px;
  background:#ef4444;
  color:#fff;
  padding:12px 20px;
  border-radius:12px;
  font-size:16px;
  font-weight:600;
  box-shadow:0 4px 12px rgba(239,68,68,0.4);
  z-index:1999;
  cursor:pointer;
  animation:fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from { opacity:0; transform:translateY(-20px); }
  to { opacity:1; transform:translateY(0); }
}

/* HR Insights Tab Navigation */
.hr-tabs{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:6px;
  margin-bottom:12px;
  background:#f3f4f6;
  padding:6px;
  border-radius:12px;
}
.hr-tab{
  padding:10px;
  border:none;
  border-radius:8px;
  background:transparent;
  color:#6b7280;
  font-weight:600;
  font-size:15px;
  cursor:pointer;
  transition:all 0.2s;
}
.hr-tab.active{
  background:#fff;
  color:#7c3aed;
  box-shadow:0 2px 4px rgba(0,0,0,0.1);
}
.hr-stat-card{
  background:rgba(255,255,255,0.2);
  padding:10px;
  border-radius:8px;
  text-center;
}
.hr-stat-label{
  font-size:13px;
  opacity:0.9;
  margin-bottom:4px;
}
.hr-stat-value{
  font-size:28px;
  font-weight:bold;
  margin:4px 0;
}
.hr-stat-unit{
  font-size:13px;
  opacity:0.8;
}

/* HR Detector Specific Styles */
.stat-card{
  background:rgba(255,255,255,0.2);
  padding:15px;
  border-radius:8px;
  text-align:center;
}
.stat-value{
  font-size:32px;
  font-weight:bold;
  margin:5px 0;
}
.stat-label{
  font-size:14px;
  opacity:0.9;
}
.zone-bar{
  display:flex;
  height:40px;
  border-radius:8px;
  overflow:hidden;
  margin:15px 0;
}
.zone-segment{
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
  font-weight:600;
  font-size:14px;
}
.pattern-item{
  background:#f3f4f6;
  padding:15px;
  border-radius:8px;
  margin-bottom:10px;
  border-left:4px solid;
}
.pattern-high{border-left-color:#ef4444}
.pattern-medium{border-left-color:#f59e0b}
.pattern-low{border-left-color:#3b82f6}

/* Date Filter Toggle Styles */
.date-filter-container{
  display:flex;
  justify-content:center;
  gap:8px;
  margin-bottom:16px;
  padding:16px;
  background:#f9fafb;
  border-radius:12px;
}
.date-filter-btn{
  flex:1;
  max-width:200px;
  padding:14px 20px;
  border:2px solid #e5e7eb;
  border-radius:10px;
  background:#fff;
  font-size:18px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s ease;
  color:#6b7280;
}
.date-filter-btn:hover{
  border-color:#3b82f6;
  transform:translateY(-2px);
}
.date-filter-btn.active{
  background:#3b82f6;
  border-color:#3b82f6;
  color:#fff;
  box-shadow:0 4px 12px rgba(59,130,246,0.3);
}

/* Report Modal Styles */
.report-modal-content{max-width:800px}
.date-range-selector{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin:20px 0}
.date-range-btn{padding:16px;border:2px solid #e5e7eb;border-radius:12px;background:white;font-size:18px;font-weight:600;cursor:pointer;transition:all 0.2s ease}
.date-range-btn:hover{border-color:#3b82f6;background:#f9fafb}
.date-range-btn.active{border-color:#3b82f6;background:#3b82f6;color:white}
.custom-date-inputs{display:none;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0}
.custom-date-inputs.active{display:grid}
.report-preview{background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:20px;margin:20px 0;max-height:400px;overflow-y:auto;font-size:14px;font-family:monospace;white-space:pre-wrap}
.report-actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-top:20px}
.report-action-btn{padding:16px;border:none;border-radius:12px;font-size:18px;font-weight:600;cursor:pointer;color:white}
.report-action-btn.pdf{background:#ef4444}
.report-action-btn.excel{background:#10b981}
.report-action-btn.print{background:#6b7280}
.privacy-section{background:#f0f9ff;border-left:4px solid #3b82f6;padding:20px;margin:20px 0;border-radius:8px}
.privacy-title{font-size:24px;font-weight:700;margin-bottom:12px;color:#1e40af}
.privacy-grid{display:grid;gap:12px}
.privacy-item{display:flex;align-items:flex-start;gap:12px;padding:12px;background:white;border-radius:8px}
.privacy-icon{font-size:24px;flex-shrink:0}

/* Settings Modal Specific Styles */
.settings-section{
  background:#f8fafc;
  border-radius:12px;
  padding:24px;
  margin-bottom:24px;
  border-left:4px solid #6366f1;
}
.settings-section-title{
  font-size:24px;
  font-weight:700;
  color:#1e293b;
  margin-bottom:16px;
  display:flex;
  align-items:center;
  gap:10px;
}
.settings-label{
  display:block;
  font-size:16px;
  font-weight:600;
  color:#475569;
  margin-bottom:8px;
  margin-top:16px;
}
.settings-input{
  width:100%;
  padding:14px;
  font-size:18px;
  border:2px solid #e2e8f0;
  border-radius:10px;
  box-sizing:border-box;
  transition:border-color 0.3s ease;
}
.settings-input:focus{
  outline:none;
  border-color:#6366f1;
}
.condition-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  gap:12px;
  margin-top:12px;
}
.condition-category{
  font-size:16px;
  font-weight:700;
  color:#64748b;
  margin-top:20px;
  margin-bottom:8px;
  padding-left:4px;
  border-left:3px solid #6366f1;
  padding-left:12px;
  grid-column:1/-1;
}
.condition-btn{
  padding:14px;
  border:2px solid #e2e8f0;
  border-radius:10px;
  background:#fff;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s ease;
  text-align:left;
}
.condition-btn:hover{
  border-color:#6366f1;
  transform:translateY(-2px);
}
.condition-btn.selected{
  background:#6366f1;
  border-color:#6366f1;
  color:#fff;
}
.feature-toggle{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:16px;
  background:#fff;
  border:2px solid #e2e8f0;
  border-radius:10px;
  margin-bottom:10px;
  cursor:pointer;
  transition:all 0.2s ease;
}
.feature-toggle:hover{
  border-color:#6366f1;
  background:#f8fafc;
}
.feature-toggle.enabled{
  border-color:#10b981;
  background:#f0fdf4;
}
.feature-info{
  flex:1;
}
.feature-name{
  font-size:18px;
  font-weight:700;
  color:#1e293b;
  margin-bottom:4px;
}
.feature-desc{
  font-size:14px;
  color:#64748b;
  line-height:1.4;
}
.toggle-switch{
  width:60px;
  height:32px;
  background:#cbd5e1;
  border-radius:16px;
  position:relative;
  transition:background 0.3s ease;
}
.toggle-switch.on{
  background:#10b981;
}
.toggle-knob{
  width:28px;
  height:28px;
  background:#fff;
  border-radius:50%;
  position:absolute;
  top:2px;
  left:2px;
  transition:transform 0.3s ease;
  box-shadow:0 2px 4px rgba(0,0,0,0.2);
}
.toggle-switch.on .toggle-knob{
  transform:translateX(28px);
}
.save-notification{
  position:fixed;
  top:20px;
  right:20px;
  background:#10b981;
  color:#fff;
  padding:16px 24px;
  border-radius:12px;
  font-size:18px;
  font-weight:600;
  box-shadow:0 8px 24px rgba(16,185,129,0.4);
  z-index:2000;
  animation:slideInRight 0.4s ease,fadeOut 0.4s ease 2.6s;
  pointer-events:none;
}
@keyframes slideInRight{
  from{transform:translateX(400px);opacity:0}
  to{transform:translateX(0);opacity:1}
}
.privacy-icon{font-size:24px;flex-shrink:0}
@media(max-width:600px){.date-range-selector{grid-template-columns:1fr}}

/* Print Styles for Doctor's Reports */
@media print {
  /* Hide UI elements */
  .no-print, .btn, button, .modal-actions, .del {
    display: none !important;
  }
  
  /* Optimize for printing */
  body {
    background: white !important;
    padding: 0 !important;
    margin: 0 !important;
    font-size: 12pt !important;
  }
  
  .modal {
    display: block !important;
    position: static !important;
    background: white !important;
  }
  
  .modal-content, #doctorReportContent {
    box-shadow: none !important;
    max-width: 100% !important;
    max-height: none !important;
    padding: 20px !important;
    margin: 0 !important;
  }
  
  .report-section {
    page-break-inside: avoid;
    margin-bottom: 20px;
  }
  
  .page-break {
    page-break-after: always;
  }
  
  /* Table styling for print */
  table {
    width: 100%;
    border-collapse: collapse;
    page-break-inside: avoid;
  }
  
  th, td {
    border: 1px solid #000;
    padding: 8px;
    text-align: left;
  }
  
  th {
    background: #f0f0f0 !important;
    font-weight: bold;
  }
}

/* Doctor's Report Specific Styles */
.doctor-report-container {
  background: white;
  padding: 20px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

.report-header {
  text-align: center;
  border-bottom: 3px solid #3b82f6;
  padding-bottom: 16px;
  margin-bottom: 24px;
}

.report-section {
  margin-bottom: 24px;
  padding: 16px;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
}

.report-section-title {
  font-size: 20px;
  font-weight: 700;
  color: #1f2937;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 2px solid #e5e7eb;
}

.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin: 16px 0;
}

.metric-card {
  background: #f9fafb;
  padding: 16px;
  border-radius: 8px;
  border-left: 4px solid #3b82f6;
}

.metric-label {
  font-size: 14px;
  color: #6b7280;
  font-weight: 600;
}

.metric-value {
  font-size: 24px;
  font-weight: 700;
  color: #1f2937;
  margin-top: 4px;
}

.timeline-item {
  padding: 12px;
  margin: 8px 0;
  background: #fef3c7;
  border-left: 4px solid #f59e0b;
  border-radius: 4px;
}

.output-selector {
  background: #f0f9ff;
  padding: 20px;
  border-radius: 12px;
  margin: 20px 0;
}

.output-option {
  display: flex;
  align-items: center;
  padding: 12px;
  margin: 8px 0;
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
}

.output-option:hover {
  border-color: #3b82f6;
  background: #f9fafb;
}

.output-option input[type="radio"] {
  margin-right: 12px;
  width: 20px;
  height: 20px;
}

.output-option label {
  cursor: pointer;
  font-size: 18px;
  font-weight: 600;
  color: #374151;
}

</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
</head>
<body>

<!-- Audio Alert Notification (hidden for now) -->
<div id="audioAlertBox" class="audio-alert" style="display:none">
  <div class="audio-alert-title">üîî Event Reminder</div>
  <div id="audioAlertEventName" class="audio-alert-event"></div>
  <div id="audioAlertActions" style="display:flex;flex-direction:column;gap:10px;margin-bottom:12px"></div>
  <button class="audio-alert-btn" onclick="stopAudioAlert()">‚úì Done ‚Äî Dismiss</button>
</div>

<!-- Missed Alert Badge -->
<div id="missedAlertBadge" class="missed-alert-badge" onclick="dismissMissedAlert()">
  <span id="missedAlertText"></span> ‚úï
</div>

<!-- Save Notification -->
<div id="saveNotification" class="save-notification" style="display:none">
  ‚úì Settings saved successfully
</div>


<div style="max-width:900px;margin:0 auto;text-align:center;">
  <img class="logo-img" src="clinbridge-logo.png" alt="ClinBridge Logo">

  <div class="hdr" style="display:flex;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;gap:8px;">
    <div style="display:flex;flex-direction:column;align-items:flex-start;">
      <span>v9.5.5: Medical Grade - Free</span>
      <!-- VERSION UPDATE INSTRUCTION: When updating to a new version, ONLY change the date below. The version number is in the title above. Format: "Updated MMM DD, YYYY" -->
      <span style="font-size:14px;color:#6b7280;font-weight:normal;">Updated Feb 19, 2026</span>
    </div>
    <div id="t" style="font-size:18px;color:#6b7280;text-align:right;"></div>
  </div>
</div>
<!-- End ClinBridge header -->


<button class="btn bp" onclick="logBP()">üìä Log Blood Pressure</button>
<button class="btn wt" id="weightBtn" style="display:none" onclick="logWeight()">‚öñÔ∏è Log Weight</button>
<button class="btn sy" id="symptomBtn" style="display:none" onclick="logSymptom()">üíä Log Symptoms</button>
<button class="btn ac" id="activityBtn" style="display:none" onclick="logActivity()">üèÉ Log Activity</button>
<button class="btn ml" onclick="logMeal()">üçΩÔ∏è Log Meal</button>
<button class="btn fl" onclick="logFluid()">üíß Log Fluid</button>
<button class="btn" style="background:#f97316" onclick="logMedicine()">üíä Log Medicine</button>
<button class="btn" style="background:#dc2626" onclick="logProcedure()">üè• Log Medical Procedure</button>
<button class="btn" style="background:#fbbf24" onclick="planMyDay()">üìã Plan My Day</button>
<button class="btn" style="background:#10b981" onclick="openAppointmentModal()">ü©∫ Log Doctor Appointment</button>
<button class="btn" style="background:#8b5cf6" onclick="addNote()">üìù Add Note</button>
<button class="btn" style="background:#7c3aed" onclick="openHRDetector()">üìä HR Rate Detector</button>
<button class="btn" style="background:#ec4899" onclick="manageMedicines()">‚öôÔ∏è Manage Medicines</button>
<button class="btn" style="background:#f472b6" onclick="manageSymptoms()">ü©∫ Manage Symptoms</button>
<button class="btn" style="background:#14b8a6" onclick="openSettings()">‚öôÔ∏è Settings</button>
<button class="btn" style="background:#8b5cf6" onclick="openAnalyticsDashboard()">üìä Advanced Analytics</button>
<button class="btn" style="background:#10b981" onclick="openMedicationEffectiveness()">üíä Medication Effectiveness</button>
<button class="btn" style="background:#8b5cf6" onclick="openProcedureImpact()">üè• Procedure Impact Analysis</button>
<button class="btn" style="background:#6366f1" onclick="exportData()">üì§ Export Today's Data</button>
<button class="btn" style="background:#0ea5e9" onclick="openSyncBackup()">üîÑ Device Sync & Backup</button>
<button class="btn" style="background:#6b7280" onclick="openHelpModal('welcome')">
  üÜò Help, About &amp; Privacy
</button>

<div id="next-event" style="display:none;padding:20px;background:#dbeafe;border:3px solid #3b82f6;border-radius:12px;font-size:24px;color:#1e3a8a;margin-bottom:16px;text-align:center"></div>

<div id="todayZone" style="display:none"></div>

<div id="upcoming-events-widget" style="display:none;margin-bottom:16px"></div>

<div style="background:#fef3c7;border-radius:12px;padding:16px;margin-bottom:16px">
<div id="recent-fluid" style="font-size:22px;font-weight:600;color:#92400e"></div>
</div>

<div id="recent-appointment-widget" style="display:none;background:#dbeafe;border-radius:12px;padding:20px;margin-bottom:16px;border:2px solid #3b82f6">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<div id="recent-appointment-title" style="font-size:22px;font-weight:600;color:#1e3a8a">ü©∫ Most Recent Doctor Visit</div>
<button class="btn" style="background:#3b82f6;padding:8px 16px;font-size:14px" onclick="viewAllAppointments()">View All</button>
</div>
<div id="recent-appointment-content"></div>
</div>

<!-- === PHASE 2: MEDICATION EFFECTIVENESS SUMMARY === -->
<div class="card" id="medEffectivenessCard" style="display:none;background:linear-gradient(135deg,#dcfce7,#d1fae5);border:3px solid #10b981">
<div class="hdr" style="color:#166534;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
<span>üíä Medication Effectiveness</span>
<button onclick="openMedicationEffectiveness()" style="background:#10b981;color:#fff;border:none;padding:12px 24px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer">View Full Analysis</button>
</div>
<div id="medEffectivenessQuickView"></div>
</div>

<div class="card" id="bpCard">
<div class="hdr" id="bpHeader">üìä Today's Blood Pressure</div>
<div id="bp"></div>
</div>

<div class="card" id="weightCard" style="display:none">
<div class="hdr" id="weightHeader">‚öñÔ∏è Weight Tracking</div>
<div id="weightAlert"></div>
<div id="weight"></div>
<div class="hdr" style="margin-top:24px">üìà Weight Trends</div>
<div id="noChartDataWeight" style="padding:24px;text-align:center;color:#6b7280;background:#f3f4f6;border-radius:8px;margin-bottom:16px">
Need at least 2 weight entries to show chart
</div>
<canvas id="weightChart" style="max-height:400px;display:none"></canvas>
</div>

<div class="card" id="symptomCard" style="display:none">
  <div class="hdr" id="symptomHeader">
    üíä Symptom Tracking
    <button onclick="openSymptomReview()" style="margin-left:12px;padding:6px 12px;font-size:14px;border:none;border-radius:999px;background:#3b82f6;color:#fff;cursor:pointer;">
      Review for Doctor
    </button>
  </div>

  <!-- Daily symptom list -->
  <div id="symptom"></div>

  <!-- Symptom chart -->
  <div class="hdr" style="margin-top:24px">üìä Symptom Severity Trends</div>
  <div id="noChartDataSymptom" style="padding:24px;text-align:center;color:#6b7280;background:#f3f4f6;border-radius:8px;margin-bottom:16px">
    Need at least 2 symptom entries to show chart
  </div>
  <canvas id="symptomChart" style="max-height:400px;display:none"></canvas>
</div>

<div class="card" id="activityCard" style="display:none">
<div class="hdr" id="activityHeader">üèÉ Activity/Exercise Tracking</div>
<div id="activity"></div>
<div class="hdr" style="margin-top:24px">üìä Activity Duration Trends</div>
<div id="noChartDataActivity" style="padding:24px;text-align:center;color:#6b7280;background:#f3f4f6;border-radius:8px;margin-bottom:16px">
<div style="font-size:32px;margin-bottom:8px">üìä</div>
<div style="font-size:18px;font-weight:600;color:#374151;margin-bottom:4px">Coming Soon in v9.6</div>
<div style="font-size:14px;color:#9ca3af">Activity trend charts are being enhanced for better insights.</div>
</div>
<canvas id="activityChart" style="max-height:400px;display:none"></canvas>
</div>

<div class="card" id="mealsCard" style="display:none">
<div class="hdr" id="mealsHeader" style="display:flex;justify-content:space-between;align-items:center"><span>üçΩÔ∏è Meals</span><button class="btn" style="background:#f59e0b;padding:8px 16px;font-size:14px" onclick="viewAllMeals()">View All</button></div>
<div id="meals"></div>
</div>

<div class="card" id="medicinesCard" style="display:none">
<div class="hdr" id="medicinesHeader">üíä Medicines Taken</div>
<div id="medicines"></div>
</div>

<div class="card" id="notesCard" style="display:none">
<div class="hdr" id="notesHeader">üìù Notes</div>
<div id="notes"></div>
</div>

<div class="card" id="bpTrendsCard">
<div class="hdr">üìà BP Trends</div>
<div id="noChartData" style="padding:24px;text-align:center;color:#6b7280;background:#f3f4f6;border-radius:8px;margin-bottom:16px">
Need at least 2 BP readings to show chart
</div>
<canvas id="bpChart" style="max-height:400px;display:none"></canvas>
</div>

<div class="card" id="rateDetectorCard" style="display:none">
<div class="hdr">‚ö° HR Rate Detector</div>
<div id="rateDetectorInfo" style="padding:16px;background:#f3f4f6;border-radius:8px;margin-bottom:16px;font-size:16px;color:#374151">
<b>What is this?</b> Tracks your heart rate changes and patterns. Identifies spikes, zones, and trends that may need attention.
</div>
<div id="hrInsightsPanel" style="display:none;margin-bottom:16px">
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-bottom:16px">
<div style="background:#fff;border:2px solid #e5e7eb;border-radius:8px;padding:12px;text-align:center">
<div style="font-size:14px;color:#6b7280;margin-bottom:4px">Average HR</div>
<div id="hrAvg" style="font-size:24px;font-weight:700;color:#3b82f6">--</div>
<div style="font-size:12px;color:#6b7280">BPM</div>
</div>
<div style="background:#fff;border:2px solid #e5e7eb;border-radius:8px;padding:12px;text-align:center">
<div style="font-size:14px;color:#6b7280;margin-bottom:4px">Min / Max</div>
<div id="hrRange" style="font-size:20px;font-weight:700;color:#6b7280">--</div>
<div style="font-size:12px;color:#6b7280">BPM</div>
</div>
<div style="background:#fff;border:2px solid #e5e7eb;border-radius:8px;padding:12px;text-align:center">
<div style="font-size:14px;color:#6b7280;margin-bottom:4px">Trend</div>
<div id="hrTrend" style="font-size:24px;font-weight:700">--</div>
<div id="hrTrendText" style="font-size:12px;color:#6b7280">--</div>
</div>
</div>
<div id="hrZones" style="display:flex;gap:8px;margin-bottom:16px">
<div style="flex:1;background:#dbeafe;border:2px solid #3b82f6;border-radius:8px;padding:10px;text-align:center">
<div style="font-size:12px;color:#1e40af;font-weight:600">Low (&lt;60)</div>
<div id="hrZoneLow" style="font-size:20px;font-weight:700;color:#1e40af">0%</div>
</div>
<div style="flex:1;background:#dcfce7;border:2px solid #10b981;border-radius:8px;padding:10px;text-align:center">
<div style="font-size:12px;color:#065f46;font-weight:600">Normal (60-100)</div>
<div id="hrZoneNormal" style="font-size:20px;font-weight:700;color:#065f46">0%</div>
</div>
<div style="flex:1;background:#fee2e2;border:2px solid #ef4444;border-radius:8px;padding:10px;text-align:center">
<div style="font-size:12px;color:#991b1b;font-weight:600">High (&gt;100)</div>
<div id="hrZoneHigh" style="font-size:20px;font-weight:700;color:#991b1b">0%</div>
</div>
</div>
<div id="hrAlerts" style="display:none;padding:12px;background:#fef3c7;border-left:4px solid #f59e0b;border-radius:8px;margin-bottom:12px">
<div style="font-size:14px;font-weight:700;color:#92400e;margin-bottom:8px">‚ö†Ô∏è Alerts</div>
<div id="hrAlertsList" style="font-size:14px;color:#78350f"></div>
</div>
</div>
<div id="rateDetectorBars" style="display:none;justify-content:space-around;align-items:flex-end;height:200px;padding:20px 10px;background:#fff;border:2px solid #e5e7eb;border-radius:8px;margin-bottom:16px"></div>
<div id="rateDetectorNone" style="padding:24px;text-align:center;color:#6b7280;background:#f3f4f6;border-radius:8px">
Need at least 2 BP readings to show rate detector
</div>
</div>

<div class="card">
  <div class="hdr">üíß Fluid Intake</div>

  <div id="fluidProgressCard" style="display:none;margin-bottom:16px">
    <div id="fluidSourceSummary" style="font-size:14px;color:#0369a1;margin-bottom:8px"></div>
  </div>

  <div id="noChartDataFluid" style="padding:24px;text-align:center;color:#6b7280;background:#f3f4f6;border-radius:8px;margin-bottom:16px">
    Your fluid entries are listed below. Ask your doctor if you would benefit from a fluid chart view and text us.
  </div>
  <canvas id="fluidChart" style="max-height:400px;display:none"></canvas>
  <div id="fluidLogEntries" style="margin-top:16px"></div>
</div>

<div id="modal" class="modal">
  <div class="modal-content" id="modalContent"></div>
</div>


<!-- Medical Report Modal -->
<div id="reportModal" class="modal" style="display:none">
<div class="modal-content report-modal-content">
<div class="modal-title">üìÑ Generate Medical Report</div>

<p style="text-align:center;color:#6b7280;margin-bottom:20px">
Select the date range for your cardiologist report:
</p>

<div class="date-range-selector">
<button class="date-range-btn active" data-range="30" onclick="selectDateRange(this,'30')">
Last 30 Days
</button>
<button class="date-range-btn" data-range="all" onclick="selectDateRange(this,'all')">
Since Start
</button>
<button class="date-range-btn" data-range="custom" onclick="selectDateRange(this,'custom')">
Custom Range
</button>
</div>

<div id="customDateInputs" style="display:none">
<div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;margin:16px 0">
<div style="flex:1;min-width:140px">
<label style="display:block;font-size:14px;font-weight:600;color:#374151;margin-bottom:6px">üìÖ Start Date</label>
<input type="date" id="reportStartDate" class="modal-input" style="width:100%;box-sizing:border-box">
</div>
<div style="flex:1;min-width:140px">
<label style="display:block;font-size:14px;font-weight:600;color:#374151;margin-bottom:6px">üìÖ End Date</label>
<input type="date" id="reportEndDate" class="modal-input" style="width:100%;box-sizing:border-box">
</div>
</div>
</div>

<div style="text-align:center;margin:24px 0">
<button class="modal-ok" onclick="generateReportPreview()" style="font-size:22px;padding:20px 40px;width:auto;display:inline-block">
üîç Generate Report
</button>
</div>

<div class="report-preview" id="reportPreview">
<em style="color:#9ca3af">No data available for selected date range.</em>
</div>

<div class="report-actions" id="reportActions" style="opacity:0.4;pointer-events:none">
<button class="report-action-btn pdf" onclick="generateTextReport()" disabled>üìÑ Download Report</button>
<button class="report-action-btn excel" onclick="generateSpreadsheetExport()" disabled>üìä Export to Spreadsheet</button>
<button class="report-action-btn print" onclick="printReport()" disabled>üñ®Ô∏è Print Report</button>
</div>

<div class="modal-actions">
<button class="modal-cancel" onclick="closeReportModal()">Close</button>
</div>
</div>
</div>

<!-- Help / About & Privacy Modal -->
<div id="aboutModal" class="modal" style="display:none">
  <div class="modal-content" style="max-width:800px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="modal-title" id="helpModalTitle" style="margin:0">
        Help, About & Privacy
      </div>
      <button onclick="closeHelpModal()" style="background:none;border:none;font-size:28px;cursor:pointer;color:#6b7280;padding:4px 8px;line-height:1" title="Close">‚úï</button>
    </div>

    <!-- Tabs -->
    <div class="hr-tabs" aria-label="Help sections">
      <button type="button" class="hr-tab" data-help-section="welcome">Welcome</button>
      <button type="button" class="hr-tab" data-help-section="getting-started">Getting Started</button>
      <button type="button" class="hr-tab" data-help-section="how-to-use">How to Use</button>
      <button type="button" class="hr-tab" data-help-section="faq">FAQ</button>
      <button type="button" class="hr-tab" data-help-section="privacy">Privacy</button>
      <button type="button" class="hr-tab" data-help-section="data-management">Data Mgmt</button>
      <button type="button" class="hr-tab" data-help-section="known-issues">Known Issues</button>
      <button type="button" class="hr-tab" data-help-section="planned-features">Planned Features</button>
    </div>

    <!-- Body -->
    <div class="modal-body">
      <section class="helpSection" data-section="welcome">
        <h3>Welcome</h3>
        <p>
          ClinBridge helps you log and review blood pressure, heart rate, symptoms,
          activity, and other daily data so you and your cardiology team can see patterns.
        </p>
        <p>
          Use this guide to get started, learn daily workflows, and understand what
          to share with your doctor.
        </p>
      </section>

      <section class="helpSection" data-section="getting-started" hidden>
        <h3>Getting Started ‚Äî Why Settings Come First</h3>
        <p style="font-size:16px;line-height:1.7;color:#374151;margin-bottom:16px">
          ClinBridge is not a generic health app ‚Äî it is a precision monitoring tool that
          adapts to <em>your</em> specific conditions, your doctor's targets, and your daily
          schedule. <strong>None of that happens automatically.</strong> Settings are where
          you tell ClinBridge who you are and what you need. Until Settings are filled in,
          the app operates on generic defaults that may not reflect your care plan at all.
        </p>

        <div style="background:#eff6ff;border-left:4px solid #3b82f6;padding:16px;border-radius:8px;margin-bottom:20px">
          <strong style="font-size:17px">‚öôÔ∏è Step 1 ‚Äî Open Settings before logging anything</strong>
          <p style="margin:8px 0 0 0;font-size:15px;color:#1e40af">Tap <strong>Settings</strong> on the main screen. Work through each section top to bottom. This takes about 3 minutes and unlocks the full power of ClinBridge.</p>
        </div>

        <h4 style="font-size:18px;color:#1e3a5f;margin:20px 0 12px 0">üë§ Patient Profile</h4>
        <p style="font-size:15px;line-height:1.7;color:#374151;margin-bottom:8px">
          Enter your <strong>name</strong> and <strong>date of birth</strong>. These appear on every exported report,
          PDF, and spreadsheet ‚Äî so your cardiologist, nephrologist, or any specialist can
          immediately identify the record as yours. Without this, reports are anonymous and
          may be rejected by a medical office.
        </p>
        <p style="font-size:15px;line-height:1.7;color:#374151;margin-bottom:8px">
          Select your <strong>cardiac conditions</strong>. This is not just a label ‚Äî ClinBridge uses
          your condition profile to decide which warnings to surface, which patterns to flag
          in Advanced Analytics, and how to frame your data in the Doctor's Report. For example,
          if Postprandial Hypotension is selected, the app specifically tracks BP drops after meals
          and calculates your improvement percentage over time. If AFib is selected, heart rate
          variability and irregularity notes gain prominence in your reports.
        </p>

        <h4 style="font-size:18px;color:#1e3a5f;margin:20px 0 12px 0">‚öôÔ∏è App Settings ‚Äî Your Personal Target Ranges</h4>
        <p style="font-size:15px;line-height:1.7;color:#374151;margin-bottom:8px">
          These four ranges are the most important numbers in ClinBridge. Ask your cardiologist
          for your personal targets ‚Äî they differ from textbook normals for most cardiac patients.
        </p>
        <ul style="font-size:15px;line-height:1.8;color:#374151;margin-bottom:12px;padding-left:20px">
          <li><strong>Systolic Range</strong> ‚Äî Every BP reading is evaluated against this. Readings outside range are flagged with a ‚ö†Ô∏è warning dot on charts and counted in your out-of-range summary for doctor reports.</li>
          <li><strong>Diastolic Range</strong> ‚Äî Same as above for the lower number. Both are shown side by side in Advanced Analytics so your cardiologist sees the full picture at a glance.</li>
          <li><strong>Heart Rate Range</strong> ‚Äî Readings outside this window trigger alerts and are highlighted on the HR trend chart. Critical for patients on beta-blockers or with bradycardia/tachycardia history.</li>
          <li><strong>Daily Fluid Range (oz)</strong> ‚Äî ClinBridge tracks your cumulative fluid intake throughout the day and shows a progress bar. When you approach your maximum, the app warns you. For CHF and kidney patients this setting is as important as BP.</li>
        </ul>

        <h4 style="font-size:18px;color:#1e3a5f;margin:20px 0 12px 0">üìã Tracking Features</h4>
        <p style="font-size:15px;line-height:1.7;color:#374151;margin-bottom:8px">
          Turn on only the features your doctor has prescribed. Enabling all features when
          you only need two creates noise. Each toggle you enable adds a tracking button on
          the main screen and unlocks a corresponding chart in Advanced Analytics.
        </p>
        <ul style="font-size:15px;line-height:1.8;color:#374151;margin-bottom:12px;padding-left:20px">
          <li><strong>‚öñÔ∏è Weight Monitoring</strong> ‚Äî Tracks daily weight with automatic change alerts. CHF patients typically weigh daily; a gain of 2‚Äì3 lbs in 24 hours can signal dangerous fluid retention before symptoms appear. Set your alert threshold to match your cardiologist's instructions.</li>
          <li><strong>üíä Symptom Tracking</strong> ‚Äî Log dizziness, fatigue, chest discomfort, shortness of breath, and more. Symptoms are timestamped and correlated with BP readings in the Doctor's Report ‚Äî giving your cardiologist context they cannot get from numbers alone.</li>
          <li><strong>üèÉ Physical Activity</strong> ‚Äî Log exercise type and duration. Activity directly affects BP readings; logging it lets the app and your doctor distinguish exertion-related readings from true trend changes.</li>
        </ul>

        <h4 style="font-size:18px;color:#1e3a5f;margin:20px 0 12px 0">üìÖ Daily Schedule & Events</h4>
        <p style="font-size:15px;line-height:1.7;color:#374151;margin-bottom:8px">
          This is where ClinBridge becomes proactive rather than reactive. Create events for
          medication times, pre-meal BP checks, fluid targets, and any other recurring action
          in your care plan. At the scheduled time, ClinBridge fires an alert ‚Äî on screen,
          with a chime, and with action buttons that let you log directly from the alert.
          No more missed readings. No more forgotten medications.
        </p>
        <p style="font-size:15px;line-height:1.7;color:#374151;margin-bottom:8px">
          For Postprandial Hypotension patients: set a pre-meal event 15 minutes before each
          meal with a fluid reminder. ClinBridge will prompt you to hydrate, then prompt you
          to take a BP reading before eating ‚Äî the protocol that has been shown to reduce
          PPH episode severity.
        </p>

        <h4 style="font-size:18px;color:#1e3a5f;margin:20px 0 12px 0">üîî Notifications</h4>
        <p style="font-size:15px;line-height:1.7;color:#374151;margin-bottom:16px">
          Enable OS notifications so event alerts reach you even when ClinBridge is not
          the active screen. On iPhone, the in-app alert always works when ClinBridge is
          open. For background alerts, install ClinBridge to your Home Screen via the
          Safari Share button.
        </p>

        <div style="background:#f0fdf4;border-left:4px solid #10b981;padding:16px;border-radius:8px;margin-bottom:20px">
          <strong style="font-size:17px">üìã What your doctor gets from a well-configured ClinBridge</strong>
          <ul style="font-size:15px;line-height:1.8;color:#065f46;margin:10px 0 0 0;padding-left:18px">
            <li>A timestamped BP trend over weeks or months ‚Äî not just the reading taken in the office</li>
            <li>Out-of-range readings flagged with context: what you were doing, how you were feeling</li>
            <li>Medication effectiveness scoring based on BP patterns before and after dose times</li>
            <li>Fluid intake correlated with weight changes ‚Äî critical for diuretic management</li>
            <li>PPH episode frequency and severity over time with percentage improvement</li>
            <li>A exportable PDF or spreadsheet formatted for a medical record</li>
          </ul>
        </div>

        <div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:14px 16px;border-radius:8px">
          <strong>The bottom line:</strong> A 3-minute investment in Settings transforms ClinBridge
          from a log book into a clinical-grade monitoring tool that speaks your doctor's language.
        </div>
      </section>

      <section class="helpSection" data-section="how-to-use" hidden>
        <h3>How to Use</h3>
        <ul>
          <li>Use the large buttons to log BP, weight, symptoms, exercise, and fluids.</li>
          <li>Turn features on/off in Settings based on your doctor‚Äôs plan.</li>
          <li>Generate printable or shareable reports from the Report/Analytics tools.</li>
        </ul>
      </section>

      <section class="helpSection" data-section="faq" hidden>
        <h3>FAQ</h3>
        <div id="helpFaqContainer"></div>
      </section>

      <section class="helpSection" data-section="privacy" hidden>
        <h3>About & Privacy</h3>

        <div style="background:linear-gradient(135deg,#10b981,#34d399);padding:20px;border-radius:12px;margin-bottom:20px;color:white">
          <h3 style="margin:0 0 12px 0;font-size:22px">üöÄ New in v9.5.5</h3>
          <ul style="margin:0;padding-left:20px;line-height:1.8">
            <li><strong>Doctor Appointment Tracking</strong> ‚Äî Log, edit, and view all appointments with reminders and doctor notes</li>
            <li><strong>Medication Effectiveness Analysis</strong> ‚Äî Before/after BP comparison with effectiveness scoring</li>
            <li><strong>Procedure Impact Analysis</strong> ‚Äî Track how medical procedures affect your readings over time</li>
            <li><strong>Advanced Analytics Dashboard</strong> ‚Äî Multi-day trend analysis with pattern detection</li>
            <li><strong>Smart Fluid Tracking</strong> ‚Äî Pre-meal hydration reminders with intake logging</li>
            <li><strong>Critical Bug Fixes</strong> ‚Äî Improved data persistence and widget reliability</li>
          </ul>
        </div>

        <div class="privacy-section">
          <div class="privacy-title">üõ°Ô∏è Your Privacy Guarantee</div>

          <div style="margin:20px 0;padding:20px;background:#f9fafb;border-radius:8px">
            <h3 style="margin:0 0 12px 0;color:#1f2937">üìã For Your Doctor Visit</h3>
            <ul style="margin:0;padding-left:20px;color:#4b5563">
              <li>Generate professional medical reports with trends and statistics</li>
              <li>Export data in spreadsheet format for your cardiologist</li>
              <li>Track BP, heart rate, medications, meals, and lifestyle factors</li>
              <li>Detect patterns and correlations in your health data</li>
              <li>Print-ready reports to bring to appointments</li>
            </ul>
          </div>

          <div style="margin:20px 0;padding:20px;background:linear-gradient(135deg,#fef3c7,#fde68a);border-radius:12px;text-align:center">
            <div style="font-size:20px;margin-bottom:8px">‚òï Support ClinBridge</div>
            <p style="margin:0 0 12px 0;color:#78350f;font-size:14px">
              ClinBridge is free and open-source. If it helps you manage your health,
              consider buying the developer a coffee!
            </p>
            <a href="https://paypal.me/studiosommers" target="_blank" rel="noopener noreferrer"
               style="display:inline-block;background:#0070ba;color:white;padding:12px 24px;border-radius:8px;font-size:16px;font-weight:600;text-decoration:none;cursor:pointer">
              üíô Support via PayPal
            </a>
            <p style="margin:8px 0 0 0;font-size:12px;color:#92400e">
              100% optional ‚Äî your health data stays private regardless
            </p>
          </div>

          <div style="margin:20px 0;padding:15px;background:#fef2f2;border-left:4px solid #ef4444;border-radius:8px">
            <p style="margin:0;color:#991b1b;font-size:14px">
              <strong>‚ö†Ô∏è Medical Disclaimer:</strong> This app is not a substitute for professional medical advice. Always consult your healthcare provider for medical decisions.
            </p>
          </div>

          <div class="modal-actions">
            <button class="modal-ok" style="width:100%" onclick="closeAbout()">Got It!</button>
          </div>
        </div>
      </section>

      <!-- Add known-issues section if you plan to populate it -->
      <section class="helpSection" data-section="data-management" hidden>
        <h3>üóÇÔ∏è Data Management</h3>
        <p style="color:#4b5563;margin-bottom:20px">
          Use the tools below to clear your health data stored on this device.
          These actions <strong>cannot be undone</strong>.
        </p>

        <!-- Reset Today -->
        <div style="background:#fffbeb;border:2px solid #f59e0b;border-radius:12px;padding:20px;margin-bottom:20px">
          <h4 style="margin:0 0 8px 0;color:#92400e">üîÑ Reset Today's Data</h4>
          <p style="font-size:15px;color:#78350f;margin:0 0 16px 0">
            Removes only <strong>today's</strong> BP readings, symptoms, meals, activity, dismissed events, and daily plan.
            Your settings, medications, procedures, appointments, and all previous days are kept.
          </p>
          <div id="resetTodayPreview" style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:12px;font-size:14px;color:#92400e;display:none"></div>
          <button onclick="previewResetToday()" class="btn" style="background:#f59e0b;padding:14px;font-size:18px;margin-bottom:0">
            üîç Preview &amp; Reset Today's Data
          </button>
        </div>

        <!-- Delete All -->
        <div style="background:#fef2f2;border:2px solid #ef4444;border-radius:12px;padding:20px;margin-bottom:20px">
          <h4 style="margin:0 0 8px 0;color:#991b1b">‚ö†Ô∏è Delete ALL Data on This Device</h4>
          <p style="font-size:15px;color:#7f1d1d;margin:0 0 16px 0">
            Permanently erases <strong>everything</strong>: all daily readings (every day), settings, medications,
            procedures, appointments, custom symptoms/activities, analytics notes, and reminders.
            The app will return to a fresh-install state.
          </p>
          <div id="deleteAllPreview" style="background:#fee2e2;padding:12px;border-radius:8px;margin-bottom:12px;font-size:14px;color:#991b1b;display:none"></div>
          <button onclick="previewDeleteAll()" class="btn" style="background:#ef4444;padding:14px;font-size:18px;margin-bottom:0">
            üîç Preview &amp; Delete All Data
          </button>
        </div>

        <div style="background:#f0fdf4;border-left:4px solid #22c55e;padding:14px;border-radius:8px;font-size:14px;color:#166534">
          <strong>üí° Tip:</strong> Use "Reset Today" if you entered test data and want a clean start for the day.
          Use "Delete All" only if you want to completely start over or before giving someone else this device.
        </div>
      </section>

      <!-- Add known-issues section if you plan to populate it -->
      <section class="helpSection" data-section="known-issues" hidden>
        <h3>Known Issues</h3>
        <p style="font-size:15px;color:#6b7280;margin-bottom:16px">We track issues openly so you always know the current state of the app.</p>

        <div style="background:#fee2e2;border-left:4px solid #ef4444;padding:14px 16px;border-radius:8px;margin-bottom:12px">
          <strong style="font-size:16px">üîä Audio Alerts ‚Äî iPhone (Safari browser tab)</strong>
          <p style="font-size:14px;margin:6px 0 0 0;color:#7f1d1d">iOS Safari blocks Web Audio until the screen is tapped. Alerts chime correctly when you interact with the app. For reliable background audio, install ClinBridge to your Home Screen. The on-screen visual alert always works regardless.</p>
        </div>

        <div style="background:#fee2e2;border-left:4px solid #ef4444;padding:14px 16px;border-radius:8px;margin-bottom:12px">
          <strong style="font-size:16px">üîî OS Notifications ‚Äî iPhone (Safari browser tab)</strong>
          <p style="font-size:14px;margin:6px 0 0 0;color:#7f1d1d">Apple restricts Web Notifications to apps installed on the Home Screen. In a browser tab, only the in-app alert fires. Install via Safari Share ‚Üí "Add to Home Screen" to unlock full OS notifications.</p>
        </div>

        <div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:14px 16px;border-radius:8px;margin-bottom:12px">
          <strong style="font-size:16px">üìÑ Doctor's Report</strong>
          <p style="font-size:14px;margin:6px 0 0 0;color:#78350f">The Doctor's Report generation feature is temporarily disabled while calculations are being reviewed and validated for clinical accuracy. Export to Excel and Print are available in the meantime.</p>
        </div>

        <div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:14px 16px;border-radius:8px;margin-bottom:12px">
          <strong style="font-size:16px">üèÉ Activity Charts</strong>
          <p style="font-size:14px;margin:6px 0 0 0;color:#78350f">Activity trend charts in the main Summary view are pending an enhancement for richer insights. Activity data in Advanced Analytics works fully.</p>
        </div>

        <div style="background:#f0fdf4;border-left:4px solid #10b981;padding:14px 16px;border-radius:8px;margin-bottom:4px">
          <strong style="font-size:16px">‚úÖ Recently Fixed (v9.5.5)</strong>
          <ul style="font-size:14px;margin:8px 0 0 0;padding-left:18px;color:#065f46;line-height:1.8">
            <li>Advanced Analytics charts now scroll horizontally ‚Äî swipe to pan through all data</li>
            <li>Charts render crisp on iPhone 16 and all Retina / HiDPI displays</li>
            <li>Custom date range inputs now show labeled Start Date / End Date fields on iPhone</li>
            <li>App no longer loads pre-zoomed ‚Äî fits all mobile screens correctly on first open</li>
            <li>Audio context unlocks on first touch so event chimes play on iPhone</li>
          </ul>
        </div>
      </section>

      <section class="helpSection" data-section="planned-features" hidden>
        <h3>Planned Features</h3>
        <p style="font-size:15px;color:#6b7280;margin-bottom:16px">Here is what is coming. Features are prioritized by clinical value and user feedback.</p>

        <div style="background:#eff6ff;border-left:4px solid #3b82f6;padding:14px 16px;border-radius:8px;margin-bottom:12px">
          <strong style="font-size:16px">üìÑ Doctor's Report ‚Äî Full Restoration</strong>
          <p style="font-size:14px;margin:6px 0 0 0;color:#1e40af">Clinically validated PDF report with trend summaries, out-of-range analysis, medication effectiveness scoring, and PPH episode data. Formatted for a medical record and designed to be handed directly to your cardiologist.</p>
        </div>

        <div style="background:#eff6ff;border-left:4px solid #3b82f6;padding:14px 16px;border-radius:8px;margin-bottom:12px">
          <strong style="font-size:16px">üíä Medication Tracker</strong>
          <p style="font-size:14px;margin:6px 0 0 0;color:#1e40af">Log medications with dose and time. Automatically correlate BP readings before and after each medication dose to generate an effectiveness score over weeks and months ‚Äî data your cardiologist cannot easily get any other way.</p>
        </div>

        <div style="background:#eff6ff;border-left:4px solid #3b82f6;padding:14px 16px;border-radius:8px;margin-bottom:12px">
          <strong style="font-size:16px">üå°Ô∏è Barometric Pressure Alerts</strong>
          <p style="font-size:14px;margin:6px 0 0 0;color:#1e40af">Barometric pressure drops correlate with PPH episode severity. ClinBridge will detect significant pressure changes and issue a proactive heads-up so you can adjust hydration and activity before symptoms occur.</p>
        </div>

        <div style="background:#eff6ff;border-left:4px solid #3b82f6;padding:14px 16px;border-radius:8px;margin-bottom:12px">
          <strong style="font-size:16px">üìä Pattern Intelligence</strong>
          <p style="font-size:14px;margin:6px 0 0 0;color:#1e40af">Automatic detection of recurring patterns ‚Äî morning BP spikes, post-meal drops, weekly cycles, and more. Presented as plain-English insights rather than raw data, with suggested questions to raise with your doctor.</p>
        </div>

        <div style="background:#eff6ff;border-left:4px solid #3b82f6;padding:14px 16px;border-radius:8px;margin-bottom:12px">
          <strong style="font-size:16px">üîó Caregiver / Family Sharing</strong>
          <p style="font-size:14px;margin:6px 0 0 0;color:#1e40af">Optional read-only access for a spouse, adult child, or caregiver to view your dashboard and receive alerts ‚Äî without being able to edit your data. Peace of mind for the people who care about you.</p>
        </div>

        <div style="background:#eff6ff;border-left:4px solid #3b82f6;padding:14px 16px;border-radius:8px;margin-bottom:12px">
          <strong style="font-size:16px">üì± Native iPhone & Android Apps</strong>
          <p style="font-size:14px;margin:6px 0 0 0;color:#1e40af">Full native apps with reliable background notifications, HealthKit / Google Fit integration, Apple Watch complications, and wrist-tap logging. No browser required.</p>
        </div>

        <div style="background:#eff6ff;border-left:4px solid #3b82f6;padding:14px 16px;border-radius:8px;margin-bottom:12px">
          <strong style="font-size:16px">‚åö Wearable Integration</strong>
          <p style="font-size:14px;margin:6px 0 0 0;color:#1e40af">Auto-import heart rate and activity data from Apple Watch, Fitbit, and Garmin ‚Äî so you are not re-entering data that your devices already captured.</p>
        </div>

        <div style="background:#eff6ff;border-left:4px solid #3b82f6;padding:14px 16px;border-radius:8px;margin-bottom:12px">
          <strong style="font-size:16px">üçΩÔ∏è Meal Impact Analysis</strong>
          <p style="font-size:14px;margin:6px 0 0 0;color:#1e40af">Correlate meal logs with post-meal BP readings to identify which foods or meal sizes consistently trigger PPH episodes. Over time, builds a personal map of your dietary BP triggers.</p>
        </div>

        <div style="background:#eff6ff;border-left:4px solid #3b82f6;padding:14px 16px;border-radius:8px;margin-bottom:12px">
          <strong style="font-size:16px">üåô Sleep & Recovery Tracking</strong>
          <p style="font-size:14px;margin:6px 0 0 0;color:#1e40af">Log sleep quality and duration. Poor sleep is a major driver of next-day BP irregularities and OSA complications. Correlating sleep quality with BP trends gives your doctor a fuller clinical picture.</p>
        </div>

        <div style="background:#f0fdf4;border-left:4px solid #10b981;padding:14px 16px;border-radius:8px;margin-bottom:4px">
          <strong style="font-size:16px">üí° Have a feature idea?</strong>
          <p style="font-size:14px;margin:6px 0 0 0;color:#065f46">ClinBridge is built by a patient, for patients. If there is something your care plan requires that ClinBridge does not yet do, we want to know. Use the Contact & Feedback section in Settings to send a suggestion directly to the development team.</p>
        </div>
      </section>
    </div> <!-- closes .modal-body -->

  </div> <!-- closes .modal-content -->
</div> <!-- closes #aboutModal -->

<!-- All Procedures List Modal -->
<div id="proceduresListModal" class="modal" style="display:none">
<div class="modal-content" style="max-width:900px">
<div class="modal-title">üè• All Medical Procedures</div>

<div style="margin-bottom:20px">
<div style="display:flex;gap:12px;margin-bottom:12px">
<input type="text" id="procedureSearch" class="modal-input" placeholder="üîç Search by name, category, physician, or facility..." style="flex:1" oninput="filterProcedures()">
<select id="procedureSortOrder" class="modal-input" style="width:auto" onchange="filterProcedures()">
<option value="newest">Newest First</option>
<option value="oldest">Oldest First</option>
</select>
</div>
<div style="display:flex;gap:12px">
<input type="date" id="procedureFilterStart" class="modal-input" placeholder="From Date" onchange="filterProcedures()">
<input type="date" id="procedureFilterEnd" class="modal-input" placeholder="To Date" onchange="filterProcedures()">
<button class="btn" style="background:#6b7280;padding:10px 20px" onclick="clearProcedureFilters()">Clear Filters</button>
</div>
</div>

<div id="proceduresList" style="max-height:500px;overflow-y:auto"></div>

<div class="modal-actions">
<button class="modal-cancel" onclick="closeProceduresListModal()">Close</button>
</div>
</div>
</div>

<!-- All Meals List Modal -->
<div id="mealsListModal" class="modal" style="display:none">
<div class="modal-content" style="max-width:900px">
<div class="modal-title">üçΩÔ∏è All Recorded Meals</div>

<div style="margin-bottom:20px">
<div style="display:flex;gap:12px;margin-bottom:12px">
<input type="text" id="mealSearch" class="modal-input" placeholder="üîç Search by food or ingredients..." style="flex:1" oninput="filterMeals()">
<select id="mealSortOrder" class="modal-input" style="width:auto" onchange="filterMeals()">
<option value="newest">Newest First</option>
<option value="oldest">Oldest First</option>
</select>
</div>
<div style="display:flex;gap:12px">
<input type="date" id="mealFilterStart" class="modal-input" placeholder="From Date" onchange="filterMeals()">
<input type="date" id="mealFilterEnd" class="modal-input" placeholder="To Date" onchange="filterMeals()">
<button class="btn" style="background:#6b7280;padding:10px 20px" onclick="clearMealFilters()">Clear Filters</button>
</div>
</div>

<div id="mealsList" style="max-height:500px;overflow-y:auto"></div>

<div class="modal-actions">
<button class="modal-cancel" onclick="closeMealsListModal()">Close</button>
</div>
</div>
</div>

<!-- HR Detector Modal - UPDATED v8.1.0 -->
<div id="hrDetectorModal" class="modal" style="display:none">
<div class="modal-content" style="max-width:1000px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<h2 style="margin:0;color:#7c3aed;font-size:22px">‚ù§Ô∏è HR Insights v8.1</h2>
<button onclick="closeHRDetector()" style="background:#6b7280;color:white;border:none;padding:8px 16px;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer">‚úï</button>
</div>

<!-- Tab Navigation -->
<div class="hr-tabs">
<button class="hr-tab active" onclick="switchHRTab('quick-stats')" id="tab-quick-stats">üìä Quick Stats</button>
<button class="hr-tab" onclick="switchHRTab('medication')" id="tab-medication">üíä Medication</button>
</div>

<!-- Quick Stats Section -->
<div id="hr-section-quick-stats" style="display:block">
  <!-- Statistics Panel -->
  <div style="background:linear-gradient(135deg,#7c3aed,#a78bfa);padding:12px;border-radius:12px;color:white;margin-bottom:12px">
    <h3 style="margin:0 0 10px 0;font-size:16px">üìä Current Status</h3>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px" id="hrQuickStatsGrid">
      <!-- Will be populated by JavaScript -->
    </div>
  </div>

  <!-- Chart Container -->
  <div style="background:white;padding:20px;border-radius:12px;margin-bottom:12px;border:1px solid #e5e7eb">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
      <h3 style="margin:0;color:#111827;font-size:18px">üìà HR Trend</h3>
      <span id="chartDataInfo" style="font-size:12px;color:#6b7280"></span>
    </div>
    <div style="position:relative;height:250px">
      <canvas id="hrChart"></canvas>
    </div>
  </div>

  <!-- Time-in-Zone Analysis -->
  <div id="timeInZonePanel" style="margin-bottom:12px"></div>

  <!-- Pattern Detection Results -->
  <div id="patternsPanel" style="margin-bottom:12px"></div>

  <!-- Medical Context Correlations -->
  <div id="contextPanel" style="margin-bottom:12px"></div>

  <!-- Export Button -->
  <button onclick="exportHRReport()" style="background:#22c55e;color:white;border:none;padding:12px;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;width:100%;margin-top:4px">üìÑ Export Report</button>
</div>

<!-- Medication Section - PHASE 2 ENABLED -->
<div id="hr-section-medication" style="display:none">
  <!-- Medication Heart Rate Analysis -->
  <div style="background:linear-gradient(135deg,#10b981,#34d399);padding:20px;border-radius:12px;color:white;margin-bottom:20px">
    <h3 style="margin:0 0 12px 0;font-size:20px">üíä Medication Impact on Heart Rate</h3>
    <p style="margin:0;opacity:0.9;font-size:14px">Track how your medications affect your heart rate over time</p>
  </div>

  <!-- Period Selector for Medication Tab -->
  <div style="background:#f9fafb;border:2px solid #e5e7eb;border-radius:10px;padding:16px;margin-bottom:20px">
    <label style="display:block;font-weight:600;font-size:16px;margin-bottom:10px;color:#374151">üìÖ Analysis Period:</label>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px">
      <button onclick="setHRMedPeriod('today')" class="modal-btn" id="hrMedPeriodToday" style="background:#3b82f6;color:#fff">Today</button>
      <button onclick="setHRMedPeriod('week')" class="modal-btn" id="hrMedPeriodWeek">7 Days</button>
      <button onclick="setHRMedPeriod('month')" class="modal-btn" id="hrMedPeriodMonth">30 Days</button>
      <button onclick="setHRMedPeriod('all')" class="modal-btn" id="hrMedPeriodAll">All Time</button>
    </div>
  </div>

  <!-- Medication HR Results -->
  <div id="hrMedicationResults">
    <!-- Populated by JavaScript -->
  </div>

  <!-- Link to Full Dashboard -->
  <div style="text-align:center;margin-top:24px">
    <button onclick="closeHRDetector();openMedicationEffectiveness();" style="background:#10b981;color:white;border:none;padding:16px 32px;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(16,185,129,0.3)">
      üìä Open Full Medication Dashboard
    </button>
  </div>
</div>

</div>
</div>

<!-- === PHASE 2: MEDICATION EFFECTIVENESS MODAL === -->
<div id="medicationEffectivenessModal" class="modal" style="display:none;z-index:5000">
<div class="modal-content" style="max-width:1200px;padding:30px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;border-bottom:3px solid #10b981;padding-bottom:16px">
<h2 style="margin:0;color:#10b981;font-size:32px">üíä Medication Effectiveness Dashboard</h2>
<button onclick="closeMedicationEffectiveness()" style="background:#6b7280;color:white;border:none;padding:12px 24px;border-radius:8px;font-size:18px;font-weight:600;cursor:pointer">‚úï Close</button>
</div>

<!-- Acceptable Ranges from Settings -->
<div style="background:#f0f9ff;border:2px solid #3b82f6;border-radius:12px;padding:20px;margin-bottom:24px">
<h3 style="margin:0 0 12px 0;color:#1e3a8a;font-size:22px">üéØ Your Acceptable Ranges (from Settings)</h3>
<div style="background:#dbeafe;padding:10px;border-radius:6px;margin-bottom:16px;font-size:14px;color:#1e3a8a">
<strong>‚ÑπÔ∏è How scoring works:</strong> Effectiveness measures whether your medication brings readings <em>within</em> your acceptable ranges and moves values in the right direction. Adjust ranges in Settings if needed.
</div>
<div id="medRangeDisplay" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
<!-- Populated by JavaScript -->
</div>
</div>

<!-- Time Period Selector -->
<div style="background:#fef3c7;border:2px solid #f59e0b;border-radius:12px;padding:20px;margin-bottom:24px">
<label style="display:block;font-weight:700;font-size:18px;margin-bottom:12px;color:#92400e">üìÖ Analysis Period:</label>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px">
<button onclick="setMedAnalysisPeriod('today')" class="modal-btn" id="medPeriodToday" style="background:#3b82f6;color:#fff">Today</button>
<button onclick="setMedAnalysisPeriod('week')" class="modal-btn" id="medPeriodWeek">This Week</button>
<button onclick="setMedAnalysisPeriod('month')" class="modal-btn" id="medPeriodMonth">This Month</button>
<button onclick="setMedAnalysisPeriod('all')" class="modal-btn" id="medPeriodAll">All Time</button>
</div>
</div>

<!-- Medication Effectiveness Results -->
<div id="medEffectivenessResults">
<!-- Content populated by JavaScript -->
</div>
</div>
</div>

<!-- === PROCEDURE IMPACT ANALYSIS MODAL === -->
<div id="procedureImpactModal" class="modal" style="display:none;z-index:5000">
<div class="modal-content" style="max-width:1200px;padding:30px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;border-bottom:3px solid #8b5cf6;padding-bottom:16px">
<h2 style="margin:0;color:#8b5cf6;font-size:32px">üè• Procedure Impact Analysis</h2>
<button onclick="closeProcedureImpact()" style="background:#6b7280;color:white;border:none;padding:12px 24px;border-radius:8px;font-size:18px;font-weight:600;cursor:pointer">‚úï Close</button>
</div>

<!-- Procedure Selector -->
<div style="background:#faf5ff;border:2px solid #8b5cf6;border-radius:12px;padding:20px;margin-bottom:24px">
<h3 style="margin:0 0 16px 0;color:#6b21a8;font-size:22px">üìã Select Procedure</h3>
<select id="procedureSelector" class="modal-input" style="font-size:18px;padding:16px">
<option value="">-- Select a procedure to analyze --</option>
<!-- Populated by JavaScript -->
</select>
<div id="procedureDetails" style="display:none;margin-top:16px;padding:16px;background:#fff;border-radius:8px;border:1px solid #e9d5ff">
<!-- Populated by JavaScript -->
</div>
</div>

<!-- Analysis Period Selector -->
<div style="background:#f0f9ff;border:2px solid#3b82f6;border-radius:12px;padding:20px;margin-bottom:24px">
<h3 style="margin:0 0 16px 0;color:#1e3a8a;font-size:22px">üìÖ Analysis Period</h3>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:16px">
<button id="procPeriod7" class="modal-btn" onclick="setProcedurePeriod('7')" style="background:#3b82f6;color:white;font-weight:600">7 Days After</button>
<button id="procPeriod14" class="modal-btn" onclick="setProcedurePeriod('14')" style="background:#e5e7eb;color:#000">14 Days After</button>
<button id="procPeriod30" class="modal-btn" onclick="setProcedurePeriod('30')" style="background:#e5e7eb;color:#000">30 Days After</button>
<button id="procPeriodAll" class="modal-btn" onclick="setProcedurePeriod('all')" style="background:#e5e7eb;color:#000">All Follow-up</button>
</div>
<button onclick="analyzeProcedureImpact()" style="background:#8b5cf6;color:white;border:none;padding:14px 24px;border-radius:8px;font-size:18px;font-weight:600;cursor:pointer;width:100%">üîç Generate Analysis</button>
</div>

<!-- Analysis Results -->
<div id="procedureImpactResults">
<div style="padding:60px;text-align:center;color:#9ca3af">
<div style="font-size:48px;margin-bottom:16px">üè•</div>
<div style="font-size:20px;font-weight:600">Select a procedure above to see recovery analysis</div>
</div>
</div>

</div>
</div>

<!-- Advanced Analytics Dashboard Modal -->
<div id="analyticsDashboardModal" class="modal" style="display:none;z-index:5000">
<div class="modal-content" style="max-width:1200px;padding:20px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<h2 style="margin:0;color:#8b5cf6">üìä Advanced Analytics Dashboard</h2>
<button onclick="closeAnalyticsDashboard()" style="background:#6b7280;color:white;border:none;padding:12px 24px;border-radius:8px;font-size:18px;font-weight:600;cursor:pointer">‚úï</button>
</div>

<!-- Date Range Selector -->
<div style="background:#f9fafb;border-radius:12px;padding:20px;margin-bottom:20px">
<h3 style="margin:0 0 16px 0;color:#374151;font-size:20px">üìÖ Select Analysis Period</h3>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:16px">
<button class="date-range-btn active" data-range="7" onclick="selectAnalyticsRange(this,'7')">Last 7 Days</button>
<button class="date-range-btn" data-range="30" onclick="selectAnalyticsRange(this,'30')">Last 30 Days</button>
<button class="date-range-btn" data-range="90" onclick="selectAnalyticsRange(this,'90')">Last 90 Days</button>
<button class="date-range-btn" data-range="custom" onclick="selectAnalyticsRange(this,'custom')">Custom Range</button>
</div>
<div class="custom-date-inputs" id="analyticsCustomDateInputs" style="display:none">
<div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
<div style="flex:1;min-width:140px">
<label style="display:block;font-size:14px;font-weight:600;color:#374151;margin-bottom:6px">üìÖ Start Date</label>
<input type="date" id="analyticsStartDate" class="modal-input" style="width:100%;box-sizing:border-box">
</div>
<div style="flex:1;min-width:140px">
<label style="display:block;font-size:14px;font-weight:600;color:#374151;margin-bottom:6px">üìÖ End Date</label>
<input type="date" id="analyticsEndDate" class="modal-input" style="width:100%;box-sizing:border-box">
</div>
</div>
</div>
<button onclick="generateAnalytics()" style="background:#8b5cf6;color:white;border:none;padding:14px 24px;border-radius:8px;font-size:18px;font-weight:600;cursor:pointer;width:100%;margin-top:12px">üîç Generate Analysis</button>
</div>

<!-- Doctor's Report Generation Section -->
<div id="doctorReportSection" style="display:none;background:#f0fdf4;border-radius:12px;padding:20px;margin-top:20px;border:2px solid #10b981">
<h3 style="margin:0 0 16px 0;color:#065f46;font-size:22px">ü©∫ Generate Doctor's Report</h3>
<div style="background:#fef3c7;border-radius:8px;padding:16px;margin-bottom:16px;border:1px solid #f59e0b">
<p style="color:#92400e;margin:0;font-size:16px">
<strong>üîí Under Review</strong> ‚Äî The Doctor's Report feature is being audited for clinical accuracy. A fully verified version will be available in v9.6.
</p>
</div>
<button onclick="generateDoctorReport()" style="background:#9ca3af;color:white;border:none;padding:16px 24px;border-radius:8px;font-size:20px;font-weight:700;cursor:pointer;width:100%;margin-top:16px">ü©∫ Preview Coming Soon Notice</button>
</div>

<!-- Summary Statistics Panel -->
<div id="analyticsSummary" style="display:none;background:linear-gradient(135deg,#8b5cf6,#c084fc);padding:24px;border-radius:12px;color:white;margin-bottom:20px">
<h3 style="margin:0 0 16px 0;font-size:24px">üìä Summary Statistics</h3>
<div id="analyticsStatsGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px"></div>
<!-- Show Doctor's Report Button After Analysis -->
<button onclick="showDoctorReportSection()" style="background:white;color:#10b981;border:2px solid white;padding:12px 24px;border-radius:8px;font-size:18px;font-weight:600;cursor:pointer;width:100%;margin-top:20px">ü©∫ Generate Doctor's Report</button>
<!-- Expandable Chart Container -->
<div id="analyticsChartContainer" style="display:none;margin-top:24px;background:white;padding:12px;border-radius:12px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<h4 id="analyticsChartTitle" style="margin:0;color:#374151;font-size:20px"></h4>
<button onclick="closeAnalyticsChart()" style="background:#e5e7eb;color:#374151;border:none;padding:8px 16px;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer">‚úï Close</button>
</div>
<div id="analyticsChartScroller" style="overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;border-radius:8px;background:#f9fafb;"><canvas id="analyticsChart" style="display:block;height:350px;"></canvas></div><div style="text-align:center;margin-top:6px;font-size:12px;color:#9ca3af">&#8592; Swipe to pan &#8594;</div>
<div id="analyticsChartNotes" style="margin-top:16px;padding:12px;background:#f9fafb;border-radius:8px;border-left:4px solid #3b82f6;display:none">
<!-- Out-of-range summary will be inserted here -->
</div>
</div>
</div>

<!-- Multi-Metric Correlation Analysis -->
<div id="correlationPanel" style="display:none;background:white;padding:24px;border-radius:12px;margin-bottom:20px;border:2px solid #e5e7eb">
<h3 style="margin:0 0 16px 0;color:#374151;font-size:22px">üîó Multi-Metric Correlations</h3>
<div id="correlationContent"></div>
</div>

<!-- Trend Analysis -->
<div id="trendPanel" style="display:none;background:white;padding:24px;border-radius:12px;margin-bottom:20px;border:2px solid #e5e7eb">
<h3 style="margin:0 0 16px 0;color:#374151;font-size:22px">üìà Trend Analysis</h3>
<div id="trendContent"></div>
</div>

<!-- Pattern Detection -->
<div id="patternPanel" style="display:none;background:white;padding:24px;border-radius:12px;margin-bottom:20px;border:2px solid #e5e7eb">
<h3 style="margin:0 0 16px 0;color:#374151;font-size:22px">üéØ Pattern Detection</h3>
<div id="patternContent"></div>
</div>

<!-- Phase 6D: Event Analysis -->
<div id="eventPanel" style="display:none;background:white;padding:24px;border-radius:12px;margin-bottom:20px;border:2px solid #e5e7eb">
<h3 style="margin:0 0 16px 0;color:#374151;font-size:22px">üìÖ Analysis by Daily Event</h3>
<div id="eventContent"></div>
</div>

<!-- NEW: Activity Impact on Blood Pressure -->
<div id="activityImpactPanel" style="display:none;background:white;padding:24px;border-radius:12px;margin-bottom:20px;border:2px solid #e5e7eb">
<h3 style="margin:0 0 16px 0;color:#374151;font-size:22px">üèÉ Activity Impact on Blood Pressure</h3>
<div id="activityImpactContent"></div>
</div>

<!-- Weekly/Monthly Breakdown -->
<div id="periodPanel" style="display:none;background:white;padding:24px;border-radius:12px;margin-bottom:20px;border:2px solid #e5e7eb">
<h3 style="margin:0 0 16px 0;color:#374151;font-size:22px">üìÖ Period Breakdown</h3>
<div id="periodContent"></div>
</div>

<!-- Insights & Recommendations -->
<div id="insightsPanel" style="display:none;background:#f0f9ff;padding:24px;border-radius:12px;margin-bottom:20px;border-left:4px solid #3b82f6">
<h3 style="margin:0 0 16px 0;color:#1e40af;font-size:22px">üí° Key Insights</h3>
<div id="insightsContent"></div>
</div>

<!-- Notes Field -->
<div style="background:#fff;padding:20px;border-radius:12px;margin-bottom:20px;border:2px solid #e5e7eb">
<h3 style="margin:0 0 12px 0;color:#374151;font-size:20px">üìù Analysis Notes</h3>
<textarea id="analyticsNotes" style="width:100%;min-height:120px;padding:16px;border:2px solid #e5e7eb;border-radius:8px;font-size:16px;font-family:-apple-system,sans-serif;box-sizing:border-box" placeholder="Add your observations or notes about this analysis period..."></textarea>
<button onclick="saveAnalyticsNotes()" style="background:#10b981;color:white;border:none;padding:12px 24px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;margin-top:12px">üíæ Save Notes</button>
</div>

<!-- Export Options -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
<button onclick="exportAnalyticsPDF()" style="background:#ef4444;color:white;border:none;padding:16px;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer">üìÑ Export as PDF</button>
<button onclick="exportAnalyticsSpreadsheet()" style="background:#10b981;color:white;border:none;padding:16px;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer">üìä Export to Excel</button>
<button onclick="printAnalytics()" style="background:#6b7280;color:white;border:none;padding:16px;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer">üñ®Ô∏è Print Report</button>
</div>
</div>
</div>

<!-- Doctor's Report Display Modal -->
<div id="doctorReportModal" class="modal" style="display:none">
<div class="modal-content" style="max-width:900px;max-height:90vh;overflow-y:auto">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;position:sticky;top:0;background:white;z-index:10;padding-bottom:16px;border-bottom:2px solid #e5e7eb">
<h2 style="margin:0;color:#10b981;font-size:28px">ü©∫ Doctor's Medical Report</h2>
<button onclick="closeDoctorReportModal()" class="no-print" style="background:#6b7280;color:white;border:none;padding:12px 24px;border-radius:8px;font-size:18px;font-weight:600;cursor:pointer">‚úï Close</button>
</div>

<div id="doctorReportContent" class="doctor-report-container">
<!-- Report content will be inserted here -->
</div>

<div class="modal-actions no-print" style="margin-top:24px;padding-top:20px;border-top:2px solid #e5e7eb">
<button onclick="window.print()" style="background:#6b7280;color:white;border:none;padding:16px 24px;border-radius:8px;font-size:18px;font-weight:600;cursor:pointer;flex:1;margin-right:12px">üñ®Ô∏è Print This Report</button>
<button onclick="copyReportToClipboard()" style="background:#3b82f6;color:white;border:none;padding:16px 24px;border-radius:8px;font-size:18px;font-weight:600;cursor:pointer;flex:1">üìã Copy to Clipboard</button>
</div>
</div>
</div>

<!-- Log Medical Procedure Modal -->
<div id="procedureModal" class="modal" style="display:none">
<div class="modal-content">
<div class="modal-title">üè• Log Medical Procedure</div>

<label style="display:block;margin:12px 0 6px 0;font-weight:600;font-size:18px">Date of Procedure:</label>
<input type="date" id="procedureDate" class="modal-input" style="font-size:20px">

<label style="display:block;margin:12px 0 6px 0;font-weight:600;font-size:18px">Time:</label>
<input type="time" id="procedureTime" class="modal-input" style="font-size:20px">

<label style="display:block;margin:12px 0 6px 0;font-weight:600;font-size:18px">Procedure Name/Type:</label>
<input type="text" id="procedureName" class="modal-input" placeholder="e.g., Verithena Injection, Cardiac Catheterization" style="font-size:20px">

<label style="display:block;margin:12px 0 6px 0;font-weight:600;font-size:18px">Category (optional):</label>
<select id="procedureCategory" class="modal-input" style="font-size:20px">
<option value="">-- Select Category (optional) --</option>
<option value="Cardiac">Cardiac Procedure</option>
<option value="Vascular">Vascular Procedure</option>
<option value="Diagnostic">Diagnostic Test</option>
<option value="Surgical">Surgical Procedure</option>
<option value="Other">Other Medical Event</option>
</select>

<label style="display:block;margin:12px 0 6px 0;font-weight:600;font-size:18px">Hospital/Facility (optional):</label>
<input type="text" id="procedureFacility" class="modal-input" placeholder="Hospital or facility name" style="font-size:20px">

<label style="display:block;margin:12px 0 6px 0;font-weight:600;font-size:18px">Physician Name (optional):</label>
<input type="text" id="procedurePhysician" class="modal-input" placeholder="Doctor's name" style="font-size:20px">

<label style="display:block;margin:12px 0 6px 0;font-weight:600;font-size:18px">Notes/Description:</label>
<textarea id="procedureNotes" class="modal-input" rows="4" placeholder="Additional details, findings, or notes" style="font-size:20px"></textarea>

<div class="modal-actions">
<button class="modal-cancel" onclick="closeProcedureModal()">Cancel</button>
<button class="modal-ok" onclick="saveProcedure()">Save Procedure</button>
</div>
</div>
</div>

<!-- Doctor Appointment Modal -->
<div id="appointmentModal" class="modal" style="display:none">
<div class="modal-content" style="max-width:700px">
<div class="modal-title" id="appointmentModalTitle">ü©∫ Log Doctor Appointment</div>

<div style="margin-bottom:20px">
<label class="modal-label">üìÖ Appointment Date *</label>
<input type="date" id="appointmentDate" class="modal-input" required>
</div>

<div style="margin-bottom:20px">
<label class="modal-label">üïê Time (Optional)</label>
<input type="time" id="appointmentTime" class="modal-input">
</div>

<div style="margin-bottom:20px">
<label class="modal-label">üîî Reminder</label>
<select id="appointmentReminder" class="modal-input">
<option value="none">No Reminder</option>
<option value="1day">1 Day Before</option>
<option value="3days">3 Days Before</option>
<option value="1week">1 Week Before</option>
<option value="2weeks">2 Weeks Before</option>
</select>
</div>

<div style="margin-bottom:20px">
<label class="modal-label">üë®‚Äç‚öïÔ∏è Doctor/Specialist Name</label>
<input type="text" id="doctorName" class="modal-input" placeholder="e.g., Dr. Smith, Cardiologist">
</div>

<div style="margin-bottom:20px">
<label class="modal-label">üìã Reason for Visit *</label>
<textarea id="appointmentReason" class="modal-input" rows="3" placeholder="What's the main reason for this appointment?" required></textarea>
</div>

<div style="margin-bottom:20px">
<label class="modal-label">‚ùì Questions for Doctor</label>
<textarea id="appointmentQuestions" class="modal-input" rows="4" placeholder="List any questions you want to ask during the visit...&#10;&#10;‚Ä¢ Question 1&#10;‚Ä¢ Question 2&#10;‚Ä¢ Question 3"></textarea>
</div>

<div style="margin-bottom:20px">
<label class="modal-label">üìù What Doctor Said (Post-Visit Notes)</label>
<textarea id="doctorNotes" class="modal-input" rows="4" placeholder="Add notes after your appointment about what the doctor said, recommendations, prescriptions, follow-up instructions, etc."></textarea>
</div>

<div style="margin-bottom:20px">
<label class="modal-label">üíä Prescriptions Given</label>
<textarea id="prescriptionsGiven" class="modal-input" rows="3" placeholder="List any new prescriptions or changes to existing medications"></textarea>
</div>

<div style="margin-bottom:20px">
<label class="modal-label">üî¨ Tests Ordered</label>
<textarea id="testsOrdered" class="modal-input" rows="2" placeholder="List any lab tests, imaging, or other tests ordered"></textarea>
</div>

<input type="hidden" id="appointmentEditId">

<div class="modal-actions">
<button class="modal-cancel" onclick="closeAppointmentModal()">Cancel</button>
<button class="modal-ok" onclick="saveAppointment()">Save Appointment</button>
</div>
</div>
</div>

<!-- All Appointments List Modal -->
<div id="appointmentsListModal" class="modal" style="display:none">
<div class="modal-content" style="max-width:900px">
<div class="modal-title">ü©∫ All Doctor Appointments</div>

<div style="margin-bottom:20px">
<div style="display:flex;gap:12px;margin-bottom:12px">
<input type="text" id="appointmentSearch" class="modal-input" placeholder="üîç Search by doctor, reason, or notes..." style="flex:1" oninput="filterAppointments()">
<select id="appointmentSortOrder" class="modal-input" style="width:auto" onchange="filterAppointments()">
<option value="newest">Newest First</option>
<option value="oldest">Oldest First</option>
<option value="upcoming">Upcoming First</option>
</select>
</div>
<div style="display:flex;gap:12px">
<input type="date" id="appointmentFilterStart" class="modal-input" placeholder="From Date" onchange="filterAppointments()">
<input type="date" id="appointmentFilterEnd" class="modal-input" placeholder="To Date" onchange="filterAppointments()">
<button class="btn" style="background:#6b7280;padding:10px 20px" onclick="clearAppointmentFilters()">Clear Filters</button>
</div>
</div>

<div id="appointmentsList" style="max-height:500px;overflow-y:auto"></div>

<div class="modal-actions">
<button class="modal-cancel" onclick="closeAppointmentsListModal()">Close</button>
</div>
</div>
</div>

<script>
// Global variables
var M=[],B=[],W=[],S=[],A=[],notes=[],medLog=[],fluidLog=[],procedures=[],dailyFluid=0,dailyPlan=[],medicineList=[],exportedToday=false,dismissedEvents=[];

// Fluid goal injected from a notification ‚Äî consumed (and cleared) by the FIRST
// fluid-capable modal that opens. Zero after first use so it can never double-log.
var pendingEventFluid=0;
var eventFluidLogged=false; // prevents re-arming fluid goal on reminder reshow after it's been saved

// Active Settings-event reminder ‚Äî kept alive until user explicitly dismisses.
// hideModal checks this and reshows the notification after every log save/cancel.
var activeReminderEvt=null;

// ============================================================
// OS-LEVEL WEB NOTIFICATIONS (v9.5.5-WN)
// Sends system-level popup regardless of active tab or window.
// Works on Chrome/Chromebook today; Android Chrome when tab is open.
// ============================================================

/** Request OS notification permission once.
 *  Called on page load (silent check) and from Settings button.
 *  @param {boolean} fromUser  true = called by a button tap (can prompt)
 */
/** Reliable notification status ‚Äî supplements Notification.permission with a
 *  localStorage flag because Chrome's API can return 'default' on file:// URLs
 *  even after the user has tapped Allow.
 */
function getNotifStatus(){
  if(!('Notification' in window)) return 'unsupported';
  if(Notification.permission==='granted') return 'granted';
  if(Notification.permission==='denied'){
    localStorage.removeItem('CLINBRIDGE_NOTIF_GRANTED');
    return 'denied';
  }
  // On file:// origins Chrome returns 'default' even after the user tapped Allow.
  // Use a localStorage flag as a backup for local testing only.
  // On https:// Notification.permission is reliable so this branch is never reached.
  if(location.protocol==='file:'&&localStorage.getItem('CLINBRIDGE_NOTIF_GRANTED')==='true') return 'granted';
  return 'default';
}

/** Turn off ClinBridge notifications.
 *  Note: cannot revoke browser-level permission programmatically ‚Äî
 *  that requires the user to do it via the browser lock icon.
 *  This stops ClinBridge from firing them within the app.
 */
function disableOSNotifications(){
  if(location.protocol==='file:') localStorage.removeItem('CLINBRIDGE_NOTIF_GRANTED');
  openSettings();
}

function requestOSNotificationPermission(fromUser){
  if(!('Notification' in window)){
    if(fromUser)alert('Your browser does not support desktop notifications.\nTry Chrome or Edge for the best experience.');
    return;
  }
  if(getNotifStatus()==='granted'){
    if(fromUser){
      fireOSNotification('‚úÖ ClinBridge Alerts Are On','Reminders are active ‚Äî this is a test notification.','clinbridge-test');
      setTimeout(function(){ openSettings(); },300);
    }
    return;
  }
  if(Notification.permission==='denied'){
    if(fromUser){
      showModal(
        '<div class="modal-title">üîí Notifications Are Blocked</div>'+
        '<div style="background:#fee2e2;border-left:4px solid #ef4444;padding:16px;border-radius:8px;margin-bottom:20px;font-size:17px;line-height:1.7">'+
        'Your browser previously blocked ClinBridge notifications. Here\'s how to fix it:<br><br>'+
        '<strong>1.</strong> Look at the address bar at the top of your browser<br>'+
        '<strong>2.</strong> Click the üîí lock icon on the left side<br>'+
        '<strong>3.</strong> Find <strong>"Notifications"</strong> and change it to <strong>"Allow"</strong><br>'+
        '<strong>4.</strong> Reload this page<br><br>'+
        'After reloading, come back to Settings and tap Enable again.'+
        '</div>'+
        '<button onclick="hideModal();openSettings()" class="modal-ok" style="width:100%">OK, Got It</button>'
      );
    }
    return;
  }
  // Permission is 'default' ‚Äî fire the real OS prompt
  Notification.requestPermission().then(function(result){
    console.log('Notification permission result:',result);
    if(result==='granted'){
      if(location.protocol==='file:') localStorage.setItem('CLINBRIDGE_NOTIF_GRANTED','true');
      fireOSNotification(
        '‚úÖ ClinBridge Alerts Are On',
        'You will now see reminders like this even when watching a video or on another tab.',
        'clinbridge-test'
      );
      setTimeout(function(){ openSettings(); },300);
    } else if(result==='denied'){
      if(location.protocol==='file:') localStorage.removeItem('CLINBRIDGE_NOTIF_GRANTED');
      if(fromUser) setTimeout(function(){ requestOSNotificationPermission(true); },300);
    } else {
      // 'default' ‚Äî Chrome file:// quirk: prompt showed but API didn't update.
      // Assume granted since there was no explicit deny.
      if(location.protocol==='file:'){
        localStorage.setItem('CLINBRIDGE_NOTIF_GRANTED','true');
        fireOSNotification(
          '‚úÖ ClinBridge Alerts Are On',
          'You will now see reminders like this even when watching a video or on another tab.',
          'clinbridge-test'
        );
      }
      setTimeout(function(){ openSettings(); },300);
    }
  });
}

/** Show a plain-language explanation BEFORE triggering the OS permission prompt.
 *  Gives users context so the browser's "Allow / Block" dialog isn't a surprise.
 */
function showNotifPrePrompt(){
  if(!('Notification' in window)||Notification.permission!=='default'){
    // Not in a state where a pre-prompt makes sense ‚Äî go straight to the handler
    requestOSNotificationPermission(true);
    return;
  }
  var html='<div class="modal-title">üîî Turn On Reminders</div>';
  html+='<div style="background:#dbeafe;border-left:4px solid #3b82f6;padding:18px;border-radius:10px;margin-bottom:20px;font-size:18px;line-height:1.8">';
  html+='ClinBridge wants to show you <strong>reminder pop-ups</strong> on your screen ‚Äî even when you\'re watching a video, on another tab, or away from this page.';
  html+='</div>';
  html+='<div style="background:#f0fdf4;border:2px solid #86efac;border-radius:10px;padding:16px;margin-bottom:20px;font-size:17px;line-height:1.8">';
  html+='<strong>What happens next:</strong><br>';
  html+='A small pop-up will appear in the <strong>top-left corner</strong> of your screen asking permission.<br><br>';
  html+='üëâ <strong>Tap "Allow"</strong> to turn on reminders.<br>';
  html+='üëâ Tap "Block" if you do not want reminders.';
  html+='</div>';
  html+='<div style="display:flex;flex-direction:column;gap:12px">';
  html+='<button onclick="hideModal();setTimeout(function(){requestOSNotificationPermission(false);},100)" '+
        'style="width:100%;padding:18px;background:#3b82f6;color:#fff;border:none;border-radius:12px;font-size:20px;font-weight:700;cursor:pointer">'+
        'üîî Yes ‚Äî Turn On Reminders</button>';
  html+='<button onclick="hideModal()" '+
        'style="width:100%;padding:16px;background:#6b7280;color:#fff;border:none;border-radius:12px;font-size:18px;font-weight:600;cursor:pointer">'+
        'Not Right Now</button>';
  html+='</div>';
  showModal(html);
}

/** Fire an OS-level notification. Silent no-op if permission not granted.
 *  @param {string} title
 *  @param {string} body
 *  @param {string} tag   Unique key ‚Äî prevents duplicate bubbles for same event
 */
function fireOSNotification(title, body, tag){
  // iOS Safari in a browser tab does not support Web Notifications API.
  // The in-app visual alert (audioAlertBox) is the primary notification path on iOS.
  if(!('Notification' in window)||getNotifStatus()!=='granted') return;
  try{
    var n=new Notification(title,{
      body: body,
      tag:  tag||'clinbridge-event',
      icon: 'clinbridge-logo.png',
      requireInteraction: true   // Bubble stays visible until user clicks ‚Äî critical for movie/focus scenarios
    });
    n.onclick=function(){
      // Bring the ClinBridge tab to focus when user clicks the OS bubble
      window.focus();
      n.close();
    };
  }catch(e){
    console.warn('OS notification failed:',e);
  }
}

/** Update the permission status badge in Settings (if it's open) */
function updateNotifPermissionUI(){
  var badge=document.getElementById('notifPermBadge');
  if(!badge) return;
  var perm=getNotifStatus();
  var map={
    granted:  {text:'‚úÖ Enabled ‚Äî alerts will appear even on other tabs', color:'#d1fae5', border:'#10b981', textColor:'#065f46'},
    denied:   {text:'üö´ Blocked ‚Äî click the lock icon in your address bar to allow', color:'#fee2e2', border:'#ef4444', textColor:'#991b1b'},
    default:  {text:'‚ö™ Not yet enabled ‚Äî tap the button below to activate', color:'#fef3c7', border:'#f59e0b', textColor:'#92400e'},
    unsupported:{text:'‚ö†Ô∏è Not supported in this browser ‚Äî use Chrome or Edge', color:'#f3f4f6', border:'#9ca3af', textColor:'#374151'}
  };
  var s=map[perm]||map.unsupported;
  badge.style.cssText='padding:12px 16px;border-radius:8px;border-left:4px solid '+s.border+';background:'+s.color+';color:'+s.textColor+';font-size:15px;font-weight:600;margin-bottom:12px';
  badge.textContent=s.text;
  var btn=document.getElementById('notifPermBtn');
  if(btn) btn.style.display=(perm==='granted'||perm==='unsupported')?'none':'block';
}

// ============================================================
// EVENT ACTION BUTTONS ‚Äî shared definition (v9.5.5-EA)
// ============================================================
var EVENT_ACTIONS=[
  {id:'logBP',       label:'üìä Log Blood Pressure',     fn:'logBP()',               color:'#10b981'},
  {id:'logWeight',   label:'‚öñÔ∏è Log Weight',              fn:'logWeight()',           color:'#f97316'},
  {id:'logSymptom',  label:'üíä Log Symptoms',            fn:'logSymptom()',          color:'#ec4899'},
  {id:'logActivity', label:'üèÉ Log Activity',            fn:'logActivity()',         color:'#14b8a6'},
  {id:'logMeal',     label:'üçΩÔ∏è Log Meal',               fn:'logMeal()',             color:'#9333ea'},
  {id:'logFluid',    label:'üíß Log Fluid',               fn:'logFluid()',            color:'#3b82f6'},
  {id:'logMedicine', label:'üíä Log Medicine',            fn:'logMedicine()',         color:'#f97316'},
  {id:'logProcedure',label:'üè• Log Medical Procedure',   fn:'logProcedure()',        color:'#dc2626'},
  {id:'logAppt',     label:'ü©∫ Log Doctor Appointment',  fn:'openAppointmentModal()',color:'#10b981'},
  {id:'addNote',     label:'üìù Add Note',                fn:'addNote()',             color:'#8b5cf6'}
];

/** Build the action-button checklist HTML for event editors.
 *  @param {string[]} selected  Array of action ids that are checked.
 *  @returns {string} HTML string
 */
function renderEventActionCheckboxes(selected){
  selected = selected || ['logFluid'];
  var html='<div style="margin-top:16px;padding:14px;background:#f0f9ff;border-radius:10px;border-left:4px solid #3b82f6">';
  html+='<div style="font-size:15px;font-weight:700;color:#1e40af;margin-bottom:10px">üéØ Notification Action Buttons</div>';
  html+='<div style="font-size:13px;color:#4b5563;margin-bottom:10px">Choose which logging shortcuts appear when this event fires. Dismiss is always present.</div>';
  html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">';
  EVENT_ACTIONS.forEach(function(a){
    var checked=selected.indexOf(a.id)!==-1;
    html+='<label style="display:flex;align-items:center;padding:8px;background:'+(checked?'#dbeafe':'#fff')+';border:2px solid '+(checked?'#3b82f6':'#e5e7eb')+';border-radius:8px;cursor:pointer;gap:8px;font-size:14px;font-weight:600;transition:all 0.2s" onclick="toggleActionCheck(this,\''+a.id+'\')">';
    html+='<input type="checkbox" id="evtAction_'+a.id+'" value="'+a.id+'" '+(checked?'checked':'')+' style="width:18px;height:18px;cursor:pointer;pointer-events:none" />';
    html+='<span>'+a.label+'</span>';
    html+='</label>';
  });
  html+='</div></div>';
  return html;
}

/** Toggle styling on an action checkbox label */
function toggleActionCheck(label,id){
  var cb=document.getElementById('evtAction_'+id);
  cb.checked=!cb.checked;
  label.style.background=cb.checked?'#dbeafe':'#fff';
  label.style.borderColor=cb.checked?'#3b82f6':'#e5e7eb';
}

/** Collect selected action ids from the checkboxes rendered by renderEventActionCheckboxes() */
function collectSelectedActions(){
  var selected=[];
  EVENT_ACTIONS.forEach(function(a){
    var el=document.getElementById('evtAction_'+a.id);
    if(el&&el.checked)selected.push(a.id);
  });
  return selected;
}
var bpChart=null,fluidChart=null;

// Date Filter System (v7.1)
var dateFilterMode='today'; // 'today' or 'all'
var DATA_RETENTION_DAYS=90; // Keep data for 90 days max

// Audio Alert System Variables
var audioContext=null;
var currentAlert=null;
var alertTimeout=null;
var missedAlerts=[];
var firedEvents={}; // Track which events have fired today
// Phase 6C: Smart Reminders
var firedReminders={}; // Track which reminders have been shown today
var reminderCheckInterval=null;

var settings={
fluidMax:64,
fluidMin:40,
fluidMode:'range',
systolicMin:90,
systolicMax:140,
diastolicMin:60,
diastolicMax:90,
hrMin:60,
hrMax:100,
// Phase 1: Patient Profile & Features
patientName:'',
dateOfBirth:'',
conditions:[],
customConditions:[],
features:{
bloodPressure:true,
weight:false,
heartRate:true,
symptoms:false,
exercise:true,
medications:true,
meals:true,
fluids:true,
notes:true
},
reportPreferences:{
bloodPressure:true,
weight:false,
heartRate:true,
symptoms:false,
exercise:true,
medications:true,
meals:true,
fluids:true,
notes:true
},
// Phase 6A: Daily Schedule & Events
dailyEvents:[],
customActivities:[], // NEW: User-defined custom physical activities
// Custom Symptoms
customSymptoms:[]
};

// Report System Variables
var reportDateRange='30';
var reportStartDate='';
var reportEndDate='';

function showModal(html){
document.getElementById('modalContent').innerHTML=html;
document.getElementById('modal').style.display='block';
}

function hideModal(){
document.getElementById('modal').style.display='none';
// If a Settings event reminder is active, reshow it so the user can
// keep tapping action buttons until they explicitly dismiss.
if(activeReminderEvt){
showEventReminder(activeReminderEvt);
}
}

// ---------- Help / Landing Modal ----------

function openHelpModal(section) {
  var about = document.getElementById('aboutModal');
  if (!about) return;

  about.style.display = 'block';
  setHelpSection(section || 'welcome');
}

function closeHelpModal() {
  var about = document.getElementById('aboutModal');
  if (!about) return;
  about.style.display = 'none';
}

function setHelpSection(section) {
  var container = document.getElementById('aboutModal');
  if (!container) return;

  var sections = container.querySelectorAll('.helpSection');
  sections.forEach(function (el) {
    var isMatch = el.getAttribute('data-section') === section;
    el.hidden = !isMatch;
  });

  var tabs = container.querySelectorAll('.hr-tab[data-help-section]');
  tabs.forEach(function (btn) {
    var isMatch = btn.getAttribute('data-help-section') === section;
    btn.classList.toggle('active', isMatch);
    btn.setAttribute('aria-current', isMatch ? 'true' : 'false');
  });

  if (section === 'faq') {
    renderFAQ();
  }
}

// Tab click wiring for Help modal
document.addEventListener('click', function (e) {
  var btn = e.target.closest('.hr-tab[data-help-section]');
  if (!btn) return;

  var section = btn.getAttribute('data-help-section');
  var container = document.getElementById('aboutModal');
  if (!container) return;

  // Show the matching section, hide others
  var sections = container.querySelectorAll('.helpSection');
  sections.forEach(function (el) {
    var isMatch = el.getAttribute('data-section') === section;
    el.hidden = !isMatch;
  });

  // Update tab styles
  var tabs = container.querySelectorAll('.hr-tab[data-help-section]');
  tabs.forEach(function (tab) {
    var isMatch = tab.getAttribute('data-help-section') === section;
    tab.classList.toggle('active', isMatch);
    tab.setAttribute('aria-current', isMatch ? 'true' : 'false');
  });

  // Only render FAQ when that tab is selected
  if (section === 'faq') {
    if (typeof renderFAQ === 'function') {
      renderFAQ();
    }
  }
});
    

function renderFAQ() {
  var container = document.getElementById('helpFaqContainer');
  if (!container) return;

  var faqs = [
    {
      q: 'Is this app a medical device?',
      a: 'ClinBridge is a logging and reporting tool. It does not provide medical diagnosis or treatment decisions.'
    },
    {
      q: 'Where is my data stored?',
      a: 'Your readings are stored in your browser using local storage on this device unless you export or print them.'
    },
    {
      q: 'How do I share data with my doctor?',
      a: 'Use the report and print tools to generate a summary and bring a printout or PDF to your appointment.'
    },
    {
      q: 'What if I change phones or browsers?',
      a: 'Data does not automatically move between devices. Ask about export/import options if needed.'
    }
  ];

  container.innerHTML = '';
  faqs.forEach(function (item) {
    var details = document.createElement('details');
    var summary = document.createElement('summary');
    summary.textContent = item.q;
    var p = document.createElement('p');
    p.textContent = item.a;
    details.appendChild(summary);
    details.appendChild(p);
    container.appendChild(details);
  });
}
    

function openSMSContact(){
var phoneNumber='4696079896';
var isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
if(isMobile){
// Open SMS app on mobile devices
window.location.href='sms:'+phoneNumber;
}else{
// Show instructions for desktop users
var html='<div class="modal-title">üì± Contact via Text Message</div>';
html+='<div style="background:#f0f9ff;border:2px solid #0ea5e9;border-radius:12px;padding:24px;margin:20px 0;text-align:center">';
html+='<div style="font-size:16px;color:#0369a1;margin-bottom:12px">Text this number from your phone:</div>';
html+='<div style="font-size:32px;font-weight:bold;color:#0ea5e9;letter-spacing:2px;margin-bottom:16px">(469) 607-9896</div>';
html+='<div style="font-size:14px;color:#64748b">I\'ll receive your message and can reply directly</div>';
html+='</div>';
html+='<div class="modal-actions"><button class="modal-ok" onclick="hideModal()" style="width:100%">Got it</button></div>';
showModal(html);
}
}

document.getElementById('modal').addEventListener('click',function(e){
if(e.target===this)hideModal();
});

function getTime(){
var d=new Date();
var h=d.getHours();
var m=d.getMinutes();
return (h<10?'0':'')+h+':'+(m<10?'0':'')+m;
}

function logBP(){
var presetFluid=pendingEventFluid; pendingEventFluid=0; // consume ‚Äî prevents double-log
// If active event has a dedicated Log Fluid action, hide fluid field to prevent double-logging
var hasFluidAction=activeReminderEvt&&activeReminderEvt.actions&&activeReminderEvt.actions.indexOf('logFluid')!==-1;
var html='<div class="modal-title">Log Blood Pressure</div>';
html+='<input type="number" id="sys" class="modal-input" placeholder="Systolic (top number)" />';
html+='<input type="number" id="dia" class="modal-input" placeholder="Diastolic (bottom number)" />';
html+='<input type="number" id="hr" class="modal-input" placeholder="Heart Rate (BPM)" />';
if(!hasFluidAction){
html+='<input type="number" id="bpFluid" class="modal-input" placeholder="Fluid with reading (oz, optional)"'+(presetFluid>0?' value="'+presetFluid+'"':'')+' />';
if(presetFluid>0){
html+='<div style="font-size:14px;color:#2563eb;margin:-4px 0 8px 4px;font-weight:600">üìã Pre-filled from event goal ('+presetFluid+' oz) ‚Äî adjust if needed</div>';
}
if(eventFluidLogged&&activeReminderEvt){
html+='<div style="font-size:13px;color:#92400e;background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:8px;margin:-4px 0 8px 0">‚ö†Ô∏è Fluid already logged this event session. Only enter an amount here if this is <strong>additional</strong> fluid.</div>';
}
}else{
html+='<input type="hidden" id="bpFluid" value="0" />';
html+='<div style="font-size:13px;color:#6b7280;margin:4px 0 8px 4px">üíß Fluid will be logged via the Log Fluid action ‚Äî no need to enter it here</div>';
}

// === PHASE 2: MEDICATION TRACKING ===
html+='<div style="background:#f0f9ff;border:2px solid #3b82f6;border-radius:12px;padding:16px;margin:16px 0">';
html+='<div style="font-size:18px;font-weight:700;color:#1e3a8a;margin-bottom:12px">üíä Medication Tracking</div>';
html+='<label style="display:flex;align-items:center;cursor:pointer;margin-bottom:12px">';
html+='<input type="checkbox" id="medRelated" onchange="toggleMedTracking()" style="width:20px;height:20px;margin-right:10px;cursor:pointer" />';
html+='<span style="font-size:16px;font-weight:600">This reading relates to medication</span>';
html+='</label>';
html+='<div id="medTrackingOptions" style="display:none">';
html+='<label style="display:block;margin:12px 0 6px 0;font-weight:600;font-size:16px">Medication:</label>';
html+='<select id="medName" class="modal-input" onchange="onMedSelected()">';
html+='<option value="">-- Select Medication --</option>';
if(medicineList&&medicineList.length>0){
for(var i=0;i<medicineList.length;i++){
html+='<option value="'+medicineList[i].name+'">'+medicineList[i].name+'</option>';
}
}
html+='</select>';
// Med status badge area (populated dynamically)
html+='<div id="medStatusArea" style="display:none;margin-top:10px"></div>';
// Timing buttons
html+='<div id="medTimingSection" style="display:none">';
html+='<label style="display:block;margin:12px 0 6px 0;font-weight:600;font-size:16px">Timing:</label>';
html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
html+='<button type="button" id="timingBefore" onclick="selectMedTiming(\'before\')" style="padding:18px;border:3px solid #bfdbfe;border-radius:12px;font-size:20px;font-weight:600;cursor:pointer;background:#eff6ff;color:#1e3a8a;transition:all 0.2s">üìä Before Med</button>';
html+='<button type="button" id="timingAfter" onclick="selectMedTiming(\'after\')" style="padding:18px;border:3px solid #bbf7d0;border-radius:12px;font-size:20px;font-weight:600;cursor:pointer;background:#f0fdf4;color:#166534;transition:all 0.2s">üìà After Med</button>';
html+='</div>';
// After-med details area (elapsed time, auto-calc)
html+='<div id="afterMedDetails" style="display:none;margin-top:12px"></div>';
// Hours input (manual fallback)
html+='<div id="hoursAfterInput" style="display:none;margin-top:12px">';
html+='<label style="display:block;margin:6px 0;font-weight:600;font-size:16px">Hours after taking medication:</label>';
html+='<input type="number" id="hoursAfterMed" class="modal-input" placeholder="e.g., 1, 2, 3..." min="0" step="0.5" />';
html+='</div>';
html+='</div>';
// Quick-log area for unlogged medications
html+='<div id="quickLogArea" style="display:none;margin-top:12px"></div>';
html+='</div>';
html+='</div>';

// Phase 6B: Add event dropdown
html+=getEventDropdownHTML();
// NEW: Add activity dropdown
html+=getActivityDropdownHTML();
html+='<div class="modal-actions"><button class="modal-cancel" onclick="hideModal()">Cancel</button><button class="modal-ok" onclick="saveBP()">Save</button></div>';
showModal(html);
setTimeout(function(){document.getElementById('sys').focus();},100);
}

// === PHASE 2: MEDICATION TIMING SELECTION ===
var selectedMedTiming='';

function toggleMedTracking(){
var checked=document.getElementById('medRelated').checked;
var options=document.getElementById('medTrackingOptions');
if(checked){
options.style.display='block';
// Reset state
selectedMedTiming='';
document.getElementById('medTimingSection').style.display='none';
document.getElementById('medStatusArea').style.display='none';
document.getElementById('afterMedDetails').style.display='none';
document.getElementById('hoursAfterInput').style.display='none';
document.getElementById('quickLogArea').style.display='none';
// If only one medication, auto-select it
var sel=document.getElementById('medName');
if(sel.options.length===2){
sel.selectedIndex=1;
onMedSelected();
}
}else{
options.style.display='none';
selectedMedTiming='';
document.getElementById('hoursAfterInput').style.display='none';
}
}

function onMedSelected(){
var medName=document.getElementById('medName').value;
var statusArea=document.getElementById('medStatusArea');
var timingSection=document.getElementById('medTimingSection');
var quickLogArea=document.getElementById('quickLogArea');
var afterDetails=document.getElementById('afterMedDetails');

// Reset
statusArea.style.display='none';
timingSection.style.display='none';
quickLogArea.style.display='none';
afterDetails.style.display='none';
selectedMedTiming='';
resetTimingButtons();

if(!medName)return;

// Check if this medication was logged today
var takenEntry=getMedTakenToday(medName);

var html='';
if(takenEntry){
// Medication WAS taken today
var elapsed=getElapsedHours(takenEntry.time);
html+='<div style="background:#dcfce7;border:2px solid #10b981;border-radius:10px;padding:12px;display:flex;align-items:center;gap:10px">';
html+='<span style="font-size:28px">‚úÖ</span>';
html+='<div>';
html+='<div style="font-size:16px;font-weight:700;color:#166534">Taken today at '+takenEntry.time+'</div>';
html+='<div style="font-size:14px;color:#059669">'+elapsed.toFixed(1)+' hours ago'+( takenEntry.timing?' ¬∑ '+takenEntry.timing:'')+'</div>';
html+='</div>';
html+='</div>';
}else{
// Medication was NOT taken today
html+='<div style="background:#fef3c7;border:2px solid #f59e0b;border-radius:10px;padding:12px">';
html+='<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">';
html+='<span style="font-size:28px">‚ö†Ô∏è</span>';
html+='<div style="font-size:16px;font-weight:700;color:#92400e">'+medName+' not logged today</div>';
html+='</div>';
html+='<div style="font-size:14px;color:#92400e;margin-bottom:10px">Did you take it? Log it now for accurate tracking:</div>';
html+='<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">';
html+='<label style="font-size:14px;font-weight:600;color:#92400e">Time taken:</label>';
html+='<input type="time" id="quickLogTime" style="padding:8px 12px;border:2px solid #fbbf24;border-radius:8px;font-size:16px;font-weight:600" value="'+getTime()+'" />';
html+='<button type="button" onclick="quickLogMedFromBP()" style="background:#f59e0b;color:#fff;border:none;padding:10px 16px;border-radius:8px;font-size:15px;font-weight:700;cursor:pointer">‚úì Log It</button>';
html+='</div>';
html+='</div>';
}

statusArea.innerHTML=html;
statusArea.style.display='block';
timingSection.style.display='block';
}

function getMedTakenToday(medName){
// Search medLog for this medication today
for(var i=medLog.length-1;i>=0;i--){
if(medLog[i].medicine===medName){
return medLog[i]; // most recent entry
}
}
return null;
}

function getElapsedHours(timeStr){
// Calculate hours between timeStr (HH:MM) and now
if(!timeStr)return 0;
var parts=timeStr.split(':');
if(parts.length<2)return 0;
var h=parseInt(parts[0],10);
var m=parseInt(parts[1],10);
var now=new Date();
var then=new Date(now.getFullYear(),now.getMonth(),now.getDate(),h,m,0);
var diffMs=now.getTime()-then.getTime();
return Math.max(0,diffMs/(1000*60*60));
}

function quickLogMedFromBP(){
var medName=document.getElementById('medName').value;
var timeInput=document.getElementById('quickLogTime');
if(!medName||!timeInput)return;
var time=timeInput.value;
if(!time){alert('Please enter the time you took the medication');return;}

// Add to medLog
var entry={medicine:medName,timing:'Anytime',time:time};
medLog.push(entry);
saveDailyData();

// Refresh the medicines card on the main page and the status tile
showMedicines();
showTodayZone();

// Refresh the status display
onMedSelected();
}

function selectMedTiming(timing){
selectedMedTiming=timing;
var btnBefore=document.getElementById('timingBefore');
var btnAfter=document.getElementById('timingAfter');
var afterDetails=document.getElementById('afterMedDetails');
var hoursInput=document.getElementById('hoursAfterInput');

// Reset both buttons to unselected
btnBefore.style.background='#eff6ff';
btnBefore.style.color='#1e3a8a';
btnBefore.style.borderColor='#bfdbfe';
btnBefore.innerHTML='üìä Before Med';

btnAfter.style.background='#f0fdf4';
btnAfter.style.color='#166534';
btnAfter.style.borderColor='#bbf7d0';
btnAfter.innerHTML='üìà After Med';

// Apply selected state
if(timing==='before'){
btnBefore.style.background='#1e40af';
btnBefore.style.color='#ffffff';
btnBefore.style.borderColor='#1e40af';
btnBefore.innerHTML='‚úì Before Med';
afterDetails.style.display='none';
hoursInput.style.display='none';
}else if(timing==='after'){
btnAfter.style.background='#166534';
btnAfter.style.color='#ffffff';
btnAfter.style.borderColor='#166534';
btnAfter.innerHTML='‚úì After Med';

// Check if medication was taken today to auto-fill elapsed time
var medName=document.getElementById('medName').value;
var takenEntry=getMedTakenToday(medName);

if(takenEntry){
var elapsed=getElapsedHours(takenEntry.time);
// Auto-fill the hours field
document.getElementById('hoursAfterMed').value=elapsed.toFixed(1);
hoursInput.style.display='block';

// Show auto-calculated info
var aHtml='<div style="background:#dcfce7;border-left:4px solid #10b981;padding:10px 14px;border-radius:6px;font-size:14px;color:#166534">';
aHtml+='‚è±Ô∏è Auto-calculated: <strong>'+elapsed.toFixed(1)+' hours</strong> since '+medName+' at '+takenEntry.time;
aHtml+='</div>';
afterDetails.innerHTML=aHtml;
afterDetails.style.display='block';
}else{
// Med not taken ‚Äî show manual input with note
hoursInput.style.display='block';
var aHtml='<div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:10px 14px;border-radius:6px;font-size:14px;color:#92400e">';
aHtml+='‚ö†Ô∏è '+medName+' hasn\'t been logged today. Please enter hours manually, or scroll up to log it first.';
aHtml+='</div>';
afterDetails.innerHTML=aHtml;
afterDetails.style.display='block';
}
}
}

function resetTimingButtons(){
var btnBefore=document.getElementById('timingBefore');
var btnAfter=document.getElementById('timingAfter');
if(btnBefore){
btnBefore.style.background='#eff6ff';
btnBefore.style.color='#1e3a8a';
btnBefore.style.borderColor='#bfdbfe';
btnBefore.innerHTML='üìä Before Med';
}
if(btnAfter){
btnAfter.style.background='#f0fdf4';
btnAfter.style.color='#166534';
btnAfter.style.borderColor='#bbf7d0';
btnAfter.innerHTML='üìà After Med';
}
}

function saveBP(){
var s=parseInt(document.getElementById('sys').value);
var d=parseInt(document.getElementById('dia').value);
var h=parseInt(document.getElementById('hr').value);
var f=parseInt(document.getElementById('bpFluid').value)||0;
// Phase 6B: Get selected event
var eventId=document.getElementById('eventSelect')?document.getElementById('eventSelect').value:'';
// NEW: Get selected activity and timing
var activityId=document.getElementById('activitySelect')?document.getElementById('activitySelect').value:'';
var activityTiming=selectedActivityTiming;

// === PHASE 2: GET MEDICATION DATA ===
var medRelated=document.getElementById('medRelated')&&document.getElementById('medRelated').checked;
var medicationName='';
var medicationTiming='none';
var hoursAfterMed=0;

if(medRelated){
medicationName=document.getElementById('medName').value;
medicationTiming=selectedMedTiming;
if(medicationTiming==='after'){
hoursAfterMed=parseFloat(document.getElementById('hoursAfterMed').value)||0;
}

// Validate medication data
if(!medicationName){
alert('Please select a medication');
return;
}
if(!medicationTiming||medicationTiming===''){
alert('Please select whether this is Before or After medication');
return;
}
if(medicationTiming==='after'&&hoursAfterMed<=0){
alert('Please enter how many hours after taking medication');
return;
}
}

if(isNaN(s)||isNaN(d)||isNaN(h)||s<40||s>250||d<30||d>150||h<30||h>200){
alert('Please enter valid numbers:\nSystolic: 40-250\nDiastolic: 30-150\nHeart Rate: 30-200');
return;
}
// Validate activity timing
if(activityId&&!activityTiming){
alert('Please select whether this BP reading is Before or After the activity');
return;
}
var reading={s:s,d:d,h:h,t:getTime(),f:f};
if(eventId)reading.eventId=eventId;
// NEW: Add activity link and timing
if(activityId){
reading.activityId=activityId;
reading.activityTiming=activityTiming;
// Update activity's linked BP
var activity=getActivityById(activityId);
if(activity){
if(!activity.linkedBP)activity.linkedBP={before:null,after:null};
activity.linkedBP[activityTiming]=reading.t;
}
}

// === PHASE 2: ADD MEDICATION DATA TO READING ===
if(medRelated){
reading.medicationRelated=true;
reading.medicationTiming=medicationTiming;
reading.medicationName=medicationName;
if(medicationTiming==='after'){
reading.hoursAfterMed=hoursAfterMed;
}
}else{
reading.medicationRelated=false;
reading.medicationTiming='none';
}

B.push(reading);
if(f>0){
dailyFluid+=f;
if(activeReminderEvt) eventFluidLogged=true; // prevent fluid re-arming on reminder reshow
}
saveDailyData();
completeAndCloseModal();
showBP();
renderBPChart();
renderRateDetector();
updateFluid();
renderFluidChart();
updateUpcomingEventsWidget();
checkBPWarnings(s,d,h);
selectedActivityTiming=''; // Reset timing selection
selectedMedTiming=''; // Reset med timing selection
}

function checkBPWarnings(s,d,h){
var warnings=[];
if(s<settings.systolicMin||s>settings.systolicMax){
warnings.push('‚ö†Ô∏è Systolic is '+(s<settings.systolicMin?'LOW':'HIGH'));
}
if(d<settings.diastolicMin||d>settings.diastolicMax){
warnings.push('‚ö†Ô∏è Diastolic is '+(d<settings.diastolicMin?'LOW':'HIGH'));
}
if(h<settings.hrMin||h>settings.hrMax){
warnings.push('‚ö†Ô∏è Heart Rate is '+(h<settings.hrMin?'LOW':'HIGH'));
}
if(warnings.length>0){
alert(warnings.join('\n'));
}
}

// === PHASE 2: UPDATE MEDICATION EFFECTIVENESS QUICK VIEW ===
function updateMedEffectivenessQuickView(){
// Get today's medication readings
var medReadingsToday=B.filter(function(r){
return r.medicationRelated&&r.medicationTiming!=='none';
});

if(medReadingsToday.length===0){
document.getElementById('medEffectivenessCard').style.display='none';
return;
}

document.getElementById('medEffectivenessCard').style.display='block';

function avg(arr,key){if(arr.length===0)return 0;var sum=0;for(var i=0;i<arr.length;i++)sum+=arr[i][key];return Math.round(sum/arr.length);}

// Group by medication name
var byMed={};
medReadingsToday.forEach(function(r){
var name=r.medicationName||'Unknown';
if(!byMed[name])byMed[name]={before:[],after:[]};
if(r.medicationTiming==='before')byMed[name].before.push(r);
else if(r.medicationTiming==='after')byMed[name].after.push(r);
});

var medNames=Object.keys(byMed);
var html='';

// Per-medication summary cards
medNames.forEach(function(medName){
var data=byMed[medName];
var bCnt=data.before.length;
var aCnt=data.after.length;

html+='<div style="background:#fff;border:2px solid #10b981;border-radius:10px;padding:16px;margin-top:12px">';
html+='<div style="font-size:16px;font-weight:700;color:#10b981;margin-bottom:10px">üíä '+medName+'</div>';
html+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px">';

// Before
html+='<div style="background:#eff6ff;padding:10px;border-radius:8px;text-align:center">';
html+='<div style="font-size:12px;color:#1e3a8a;font-weight:600">Before</div>';
if(bCnt>0){
html+='<div style="font-size:20px;font-weight:700;color:#1e3a8a">'+avg(data.before,'s')+'/'+avg(data.before,'d')+'</div>';
html+='<div style="font-size:11px;color:#6b7280">HR '+avg(data.before,'h')+' ¬∑ n='+bCnt+'</div>';
}else{
html+='<div style="font-size:14px;color:#9ca3af">‚Äî</div>';
}
html+='</div>';

// After
html+='<div style="background:#dcfce7;padding:10px;border-radius:8px;text-align:center">';
html+='<div style="font-size:12px;color:#166534;font-weight:600">After</div>';
if(aCnt>0){
html+='<div style="font-size:20px;font-weight:700;color:#166534">'+avg(data.after,'s')+'/'+avg(data.after,'d')+'</div>';
html+='<div style="font-size:11px;color:#6b7280">HR '+avg(data.after,'h')+' ¬∑ n='+aCnt+'</div>';
}else{
html+='<div style="font-size:14px;color:#9ca3af">‚Äî</div>';
}
html+='</div>';

// Delta
if(bCnt>0&&aCnt>0){
var dS=avg(data.after,'s')-avg(data.before,'s');
var dD=avg(data.after,'d')-avg(data.before,'d');
var ok=(dS<=0&&dD<=0);
html+='<div style="background:'+(ok?'#dcfce7':'#fee2e2')+';padding:10px;border-radius:8px;text-align:center">';
html+='<div style="font-size:12px;color:'+(ok?'#166534':'#991b1b')+';font-weight:600">Œî Change</div>';
html+='<div style="font-size:20px;font-weight:700;color:'+(ok?'#10b981':'#ef4444')+'">'+(dS>0?'+':'')+dS+'/'+(dD>0?'+':'')+dD+'</div>';
html+='</div>';
}

html+='</div>'; // grid
html+='</div>'; // card
});

// Overall tip
var totalBefore=medReadingsToday.filter(function(r){return r.medicationTiming==='before';}).length;
var totalAfter=medReadingsToday.filter(function(r){return r.medicationTiming==='after';}).length;

if(totalBefore>0&&totalAfter>0){
var allBefore=medReadingsToday.filter(function(r){return r.medicationTiming==='before';});
var allAfter=medReadingsToday.filter(function(r){return r.medicationTiming==='after';});
var dSys2=avg(allAfter,'s')-avg(allBefore,'s');
var dDia2=avg(allAfter,'d')-avg(allBefore,'d');
var direction=(dSys2<=0&&dDia2<=0)?'decreased':'increased';
var dirIcon=(dSys2<=0&&dDia2<=0)?'‚úÖ':'‚ö†Ô∏è';
html+='<div style="margin-top:12px;padding:12px;background:'+(direction==='decreased'?'#dcfce7':'#fee2e2')+';border-left:4px solid '+(direction==='decreased'?'#10b981':'#ef4444')+';border-radius:6px;font-size:14px;color:'+(direction==='decreased'?'#166534':'#991b1b')+'">';
html+=dirIcon+' <strong>Today:</strong> Overall BP '+direction+' by '+Math.abs(dSys2)+'/'+Math.abs(dDia2)+' mmHg across '+medNames.length+' medication'+(medNames.length>1?'s':'')+'.';
html+='</div>';
}else if(totalBefore>0&&totalAfter===0){
html+='<div style="margin-top:12px;padding:12px;background:#fef3c7;border-left:4px solid #f59e0b;border-radius:6px;font-size:14px;color:#92400e">';
html+='üí° <strong>Tip:</strong> Log a BP reading <em>after</em> taking your medication to see effectiveness!';
html+='</div>';
}else if(totalBefore===0&&totalAfter>0){
html+='<div style="margin-top:12px;padding:12px;background:#fef3c7;border-left:4px solid #f59e0b;border-radius:6px;font-size:14px;color:#92400e">';
html+='üí° <strong>Tip:</strong> Log a BP reading <em>before</em> your next dose for before/after comparison!';
html+='</div>';
}

document.getElementById('medEffectivenessQuickView').innerHTML=html;
}


function showBP(){
var data=getFilteredData();
var bpData=data.bp;
var h='';
for(var i=bpData.length-1;i>=0;i--){
var r=bpData[i];
var sColor=r.s<settings.systolicMin||r.s>settings.systolicMax?'#dc2626':'#16a34a';
var dColor=r.d<settings.diastolicMin||r.d>settings.diastolicMax?'#dc2626':'#16a34a';
var hColor=r.h<settings.hrMin||r.h>settings.hrMax?'#dc2626':'#16a34a';
h+='<div class="reading">';
// Only show edit/delete buttons for today's data
if(dateFilterMode==='today'){
h+='<div style="position:absolute;top:8px;right:8px;display:flex;gap:8px">';
h+='<button onclick="editBP('+i+')" style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:16px;font-weight:600;cursor:pointer">‚úèÔ∏è</button>';
h+='<button onclick="deleteBP('+i+')" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:16px;font-weight:600;cursor:pointer">‚úï</button>';
h+='</div>';
}
// Show date - always show for context
if(dateFilterMode==='all'&&r._date){
h+='<div style="font-size:14px;color:#3b82f6;font-weight:600;margin-bottom:4px">üìÖ '+r._date+'</div>';
}else if(dateFilterMode==='today'){
// Show today's date for confirmation
var todayDate=getTodayKey();
h+='<div style="font-size:14px;color:#10b981;font-weight:600;margin-bottom:4px">üìÖ Today ('+todayDate+')</div>';
}
h+='<div style="font-size:14px;color:#6b7280;margin-bottom:12px">'+r.t+'</div>';
// Phase 6B: Display event tag if present
if(r.eventId){
var evt=getEventById(r.eventId);
if(evt){
h+='<div style="display:inline-block;padding:4px 10px;background:#f0fdf4;border:1px solid #86efac;border-radius:6px;font-size:13px;font-weight:600;color:#166534;margin-bottom:12px">'+evt.icon+' '+evt.name+'</div>';
}
}
// === PHASE 2: DISPLAY MEDICATION INFO ===
if(r.medicationRelated&&r.medicationTiming!=='none'){
var medIcon=r.medicationTiming==='before'?'üìä':'üíä';
var medText=r.medicationTiming==='before'?'Before':'After';
var medBg=r.medicationTiming==='before'?'#eff6ff':'#dcfce7';
var medBorder=r.medicationTiming==='before'?'#3b82f6':'#10b981';
var medColor=r.medicationTiming==='before'?'#1e3a8a':'#166534';
var hoursText=r.hoursAfterMed?' (+'+r.hoursAfterMed+'h)':'';
h+='<div style="display:inline-block;padding:6px 12px;background:'+medBg+';border:2px solid '+medBorder+';border-radius:8px;font-size:14px;font-weight:700;color:'+medColor+';margin-bottom:12px;margin-left:8px">';
h+=medIcon+' '+medText+' Med: <span style="font-weight:600">'+r.medicationName+'</span>'+hoursText;
h+='</div>';
}
// NEW: Display activity link if present
if(r.activityId){
var act=getActivityById(r.activityId);
if(act){
var timingIcon=r.activityTiming==='before'?'üìä':'üìà';
var timingText=r.activityTiming==='before'?'Before':'After';
var timingColor=r.activityTiming==='before'?'#dbeafe':'#fce7f3';
var timingBorder=r.activityTiming==='before'?'#3b82f6':'#ec4899';
h+='<div style="display:inline-block;padding:4px 10px;background:'+timingColor+';border:1px solid '+timingBorder+';border-radius:6px;font-size:13px;font-weight:600;color:#374151;margin-bottom:12px;margin-left:8px">'+timingIcon+' '+timingText+': '+act.activity+'</div>';
}
}
h+='<div class="flex">';
h+='<div><div style="font-size:16px;color:#6b7280">Systolic</div><div class="b" style="font-size:28px;color:'+sColor+'">'+r.s+'</div></div>';
h+='<div><div style="font-size:16px;color:#6b7280">Diastolic</div><div class="b" style="font-size:28px;color:'+dColor+'">'+r.d+'</div></div>';
h+='<div><div style="font-size:16px;color:#6b7280">HR</div><div class="b" style="font-size:28px;color:'+hColor+'">'+r.h+'</div></div>';
h+='</div>';
if(r.f&&r.f>0){
h+='<div class="drop">üíß Fluid: <b>'+r.f+' oz</b></div>';
}
h+='</div>';
}
document.getElementById('bp').innerHTML=h||'<p style="color:#6b7280;text-align:center;font-size:18px">None</p>';
// Show/hide the card based on data
if(B.length>0){
document.getElementById('bpCard').style.display='block';
}else{
document.getElementById('bpCard').style.display='none';
}
// === PHASE 2: UPDATE MEDICATION EFFECTIVENESS QUICK VIEW ===
updateMedEffectivenessQuickView();
}

function deleteBP(i){
if(confirm('Delete this reading?')){
var fluidAmount=B[i].f||0;
if(fluidAmount>0){
dailyFluid-=fluidAmount;
if(dailyFluid<0)dailyFluid=0;
}
B.splice(i,1);
showBP();
renderBPChart();
renderRateDetector();
updateFluid();
renderFluidChart();
saveDailyData();
alert('‚úì Reading deleted');
}
}

function editBP(i){
var entry=B[i];
var html='<div class="modal-title">Edit Blood Pressure Reading</div>';
html+='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Systolic:</label>';
html+='<input type="number" id="editBPSystolic" class="modal-input" value="'+entry.s+'" step="1" min="50" max="250" />';
html+='</div>';
html+='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Diastolic:</label>';
html+='<input type="number" id="editBPDiastolic" class="modal-input" value="'+entry.d+'" step="1" min="30" max="150" />';
html+='</div>';
html+='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Heart Rate (BPM):</label>';
html+='<input type="number" id="editBPHR" class="modal-input" value="'+entry.h+'" step="1" min="30" max="200" />';
html+='</div>';
html+='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Fluid (oz) - optional:</label>';
html+='<input type="number" id="editBPFluid" class="modal-input" value="'+(entry.f||0)+'" step="1" min="0" max="200" />';
html+='</div>';
html+='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Time:</label>';
html+='<input type="time" id="editBPTime" class="modal-input" value="'+entry.t+'" />';
html+='</div>';
// Phase 6B: Event tag editable on edit
html+=getEventDropdownHTML(entry.eventId||'');
// === MEDICATION TRACKING IN EDIT ===
var hasMed=entry.medicationRelated&&entry.medicationTiming&&entry.medicationTiming!=='none';
html+='<div style="background:#f0f9ff;border:2px solid #3b82f6;border-radius:12px;padding:16px;margin:16px 0">';
html+='<div style="font-size:18px;font-weight:700;color:#1e3a8a;margin-bottom:12px">üíä Medication Tracking</div>';
html+='<label style="display:flex;align-items:center;cursor:pointer;margin-bottom:12px">';
html+='<input type="checkbox" id="editMedRelated" onchange="toggleEditMedTracking()" style="width:20px;height:20px;margin-right:10px;cursor:pointer" '+(hasMed?'checked':'')+' />';
html+='<span style="font-size:16px;font-weight:600">This reading relates to medication</span>';
html+='</label>';
html+='<div id="editMedTrackingOptions" style="display:'+(hasMed?'block':'none')+'">';
html+='<label style="display:block;margin:12px 0 6px 0;font-weight:600;font-size:16px">Medication:</label>';
html+='<select id="editMedName" class="modal-input">';
html+='<option value="">-- Select Medication --</option>';
if(medicineList&&medicineList.length>0){
for(var m=0;m<medicineList.length;m++){
var sel=(hasMed&&entry.medicationName===medicineList[m].name)?' selected':'';
html+='<option value="'+medicineList[m].name+'"'+sel+'>'+medicineList[m].name+'</option>';
}
}
// If the medication is not in the current list, add it as an option
if(hasMed&&entry.medicationName){
var found=false;
if(medicineList){for(var mm=0;mm<medicineList.length;mm++){if(medicineList[mm].name===entry.medicationName)found=true;}}
if(!found){html+='<option value="'+entry.medicationName+'" selected>'+entry.medicationName+' (unlisted)</option>';}
}
html+='</select>';
html+='<label style="display:block;margin:12px 0 6px 0;font-weight:600;font-size:16px">Timing:</label>';
html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
var bSel=(hasMed&&entry.medicationTiming==='before')?' selected':'';
var aSel=(hasMed&&entry.medicationTiming==='after')?' selected':'';
html+='<button type="button" id="editTimingBefore" onclick="selectEditMedTiming(\'before\')" style="padding:18px;border:3px solid '+(bSel?'#1e40af':'#bfdbfe')+';border-radius:12px;font-size:20px;font-weight:600;cursor:pointer;background:'+(bSel?'#1e40af':'#eff6ff')+';color:'+(bSel?'#fff':'#1e3a8a')+'">'+(bSel?'‚úì Before Med':'üìä Before Med')+'</button>';
html+='<button type="button" id="editTimingAfter" onclick="selectEditMedTiming(\'after\')" style="padding:18px;border:3px solid '+(aSel?'#166534':'#bbf7d0')+';border-radius:12px;font-size:20px;font-weight:600;cursor:pointer;background:'+(aSel?'#166534':'#f0fdf4')+';color:'+(aSel?'#fff':'#166534')+'">'+(aSel?'‚úì After Med':'üìà After Med')+'</button>';
html+='</div>';
var showHours=(hasMed&&entry.medicationTiming==='after');
html+='<div id="editHoursAfterInput" style="display:'+(showHours?'block':'none')+';margin-top:12px">';
html+='<label style="display:block;margin:6px 0;font-weight:600;font-size:16px">Hours after taking medication:</label>';
html+='<input type="number" id="editHoursAfterMed" class="modal-input" placeholder="e.g., 1, 2, 3..." min="0" step="0.5" value="'+(entry.hoursAfterMed||'')+'" />';
html+='</div>';
html+='</div>';
html+='</div>';

html+='<div class="modal-actions">';
html+='<button class="modal-cancel" onclick="hideModal()">Cancel</button>';
html+='<button class="modal-ok" onclick="saveEditedBP('+i+')">Save Changes</button>';
html+='</div>';
showModal(html);
// Set the edit timing state
editSelectedMedTiming=hasMed?(entry.medicationTiming||''):'';
}

var editSelectedMedTiming='';

function toggleEditMedTracking(){
var checked=document.getElementById('editMedRelated').checked;
document.getElementById('editMedTrackingOptions').style.display=checked?'block':'none';
if(!checked){editSelectedMedTiming='';}
}

function selectEditMedTiming(timing){
editSelectedMedTiming=timing;
var btnB=document.getElementById('editTimingBefore');
var btnA=document.getElementById('editTimingAfter');
btnB.style.background=(timing==='before'?'#1e40af':'#dbeafe');
btnB.style.color=(timing==='before'?'#fff':'#1e3a8a');
btnB.style.borderColor=(timing==='before'?'#1e40af':'#bfdbfe');
btnB.innerHTML=(timing==='before'?'‚úì Before Med':'üìä Before Med');
btnA.style.background=(timing==='after'?'#166534':'#dcfce7');
btnA.style.color=(timing==='after'?'#fff':'#166534');
btnA.style.borderColor=(timing==='after'?'#166534':'#bbf7d0');
btnA.innerHTML=(timing==='after'?'‚úì After Med':'üìà After Med');
document.getElementById('editHoursAfterInput').style.display=(timing==='after'?'block':'none');
}

function saveEditedBP(i){
var systolic=parseInt(document.getElementById('editBPSystolic').value);
var diastolic=parseInt(document.getElementById('editBPDiastolic').value);
var hr=parseInt(document.getElementById('editBPHR').value);
var fluid=parseInt(document.getElementById('editBPFluid').value)||0;
var time=document.getElementById('editBPTime').value;
if(!systolic||systolic<50||systolic>250){
alert('Please enter a valid systolic value (50-250)');
return;
}
if(!diastolic||diastolic<30||diastolic>150){
alert('Please enter a valid diastolic value (30-150)');
return;
}
if(!hr||hr<30||hr>200){
alert('Please enter a valid heart rate (30-200 BPM)');
return;
}
if(!time){
alert('Please enter a valid time');
return;
}

// === MEDICATION DATA FROM EDIT ===
var editMedRelated=document.getElementById('editMedRelated')&&document.getElementById('editMedRelated').checked;
if(editMedRelated){
var editMedName=document.getElementById('editMedName').value;
if(!editMedName){alert('Please select a medication');return;}
if(!editSelectedMedTiming){alert('Please select Before or After medication');return;}
if(editSelectedMedTiming==='after'){
var editHours=parseFloat(document.getElementById('editHoursAfterMed').value)||0;
if(editHours<=0){alert('Please enter hours after taking medication');return;}
}
}

// Update fluid tracking if changed
var oldFluid=B[i].f||0;
if(oldFluid!==fluid){
dailyFluid=dailyFluid-oldFluid+fluid;
if(dailyFluid<0)dailyFluid=0;
}
B[i].s=systolic;
B[i].d=diastolic;
B[i].h=hr;
B[i].f=fluid;
B[i].t=time;
// Phase 6B: Persist event tag change from edit
var editEventId=document.getElementById('eventSelect')?document.getElementById('eventSelect').value:'';
if(editEventId){ B[i].eventId=editEventId; } else { delete B[i].eventId; }

// === SAVE MEDICATION DATA ===
if(editMedRelated){
B[i].medicationRelated=true;
B[i].medicationName=document.getElementById('editMedName').value;
B[i].medicationTiming=editSelectedMedTiming;
if(editSelectedMedTiming==='after'){
B[i].hoursAfterMed=parseFloat(document.getElementById('editHoursAfterMed').value)||0;
}else{
delete B[i].hoursAfterMed;
}
}else{
B[i].medicationRelated=false;
B[i].medicationTiming='none';
delete B[i].medicationName;
delete B[i].hoursAfterMed;
}

saveDailyData();
showBP();
renderBPChart();
renderRateDetector();
updateFluid();
renderFluidChart();
showFluidLog();
completeAndCloseModal();
alert('‚úì BP reading updated');
}

function logMeal(){
  var presetFluid=pendingEventFluid; pendingEventFluid=0; // consume ‚Äî prevents double-log
  var hasFluidAction=activeReminderEvt&&activeReminderEvt.actions&&activeReminderEvt.actions.indexOf('logFluid')!==-1;
  var html='<div class="modal-title">Log Meal</div>';
  html+='<textarea id="meal" class="modal-input" placeholder="What did you eat?" style="min-height:150px;font-size:22px"></textarea>';
  // Only show fluid field if no dedicated Log Fluid action in this event
  if(!hasFluidAction){
  html+='<input type="number" id="mealFluid" class="modal-input" ' +
        'placeholder="Log fluid with this meal (oz, optional)" ' +
        (presetFluid>0?'value="'+presetFluid+'" ':'')+
        'style="font-size:22px;margin-top:12px">';
  if(presetFluid>0){
  html+='<div style="font-size:14px;color:#2563eb;margin:-4px 0 8px 4px;font-weight:600">üìã Pre-filled from event goal ('+presetFluid+' oz) ‚Äî adjust if needed</div>';
  }
  if(eventFluidLogged&&activeReminderEvt){
  html+='<div style="font-size:13px;color:#92400e;background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:8px;margin:-4px 0 8px 0">‚ö†Ô∏è Fluid already logged this event session. Only enter an amount here if this is <strong>additional</strong> fluid.</div>';
  }
  }else{
  html+='<input type="hidden" id="mealFluid" value="0">';
  html+='<div style="font-size:13px;color:#6b7280;margin:4px 0 8px 4px">üíß Fluid will be logged via the Log Fluid action ‚Äî no need to enter it here</div>';
  }
  // Phase 6B: Add event dropdown
  html+=getEventDropdownHTML();
  html+='<div class="modal-actions"><button class="modal-cancel" onclick="hideModal()">Cancel</button><button class="modal-ok" onclick="saveMeal()">Save</button></div>';
  showModal(html);
  setTimeout(function(){document.getElementById('meal').focus();},100);
}

function saveMeal(){
  var m=document.getElementById('meal').value.trim();
  var fluid=parseFloat(document.getElementById('mealFluid').value)||0;
  // Phase 6B: Get selected event
  var eventId=document.getElementById('eventSelect')?document.getElementById('eventSelect').value:'';
  if(!m){
    alert('Please enter meal details');
    return;
  }
  var entry={m:m,t:getTime()};
  if(fluid>0){ entry.mealFluidOz=fluid; if(activeReminderEvt) eventFluidLogged=true; }
  if(eventId) entry.eventId=eventId;
  M.push(entry);
  saveDailyData();
  updateFluid();   // <‚Äî add this line
  completeAndCloseModal();
  showMeals();
  alert('‚úì Meal logged');
}

function logFluid(){
var presetFluid=pendingEventFluid; pendingEventFluid=0; // consume ‚Äî prevents double-log
var html='<div class="modal-title">Log Fluid Intake</div>';
html+='<input type="number" id="fluidAmount" class="modal-input" placeholder="Amount (oz)"'+(presetFluid>0?' value="'+presetFluid+'"':'')+' />';
if(presetFluid>0){
html+='<div style="font-size:14px;color:#2563eb;margin:-4px 0 8px 4px;font-weight:600">üìã Pre-filled from event goal ('+presetFluid+' oz) ‚Äî adjust if needed</div>';
}
// Phase 6B: Add event dropdown
html+=getEventDropdownHTML();
html+='<div style="margin:16px 0;padding:16px;background:#f3f4f6;border-radius:8px;font-size:18px">';
html+='<div style="font-weight:600;margin-bottom:12px">Quick Add:</div>';
html+='<div style="display:flex;gap:8px;flex-wrap:wrap">';
html+='<button onclick="document.getElementById(\'fluidAmount\').value=8" style="padding:12px 20px;border:2px solid #3b82f6;background:#fff;border-radius:8px;font-size:18px;font-weight:600;cursor:pointer;flex:1;min-width:80px">8 oz</button>';
html+='<button onclick="document.getElementById(\'fluidAmount\').value=12" style="padding:12px 20px;border:2px solid #3b82f6;background:#fff;border-radius:8px;font-size:18px;font-weight:600;cursor:pointer;flex:1;min-width:80px">12 oz</button>';
html+='<button onclick="document.getElementById(\'fluidAmount\').value=16" style="padding:12px 20px;border:2px solid #3b82f6;background:#fff;border-radius:8px;font-size:18px;font-weight:600;cursor:pointer;flex:1;min-width:80px">16 oz</button>';
html+='</div>';
html+='</div>';
html+='<div class="modal-actions"><button class="modal-cancel" onclick="hideModal()">Cancel</button><button class="modal-ok" onclick="saveFluid()">Save</button></div>';
showModal(html);
setTimeout(function(){document.getElementById('fluidAmount').focus();},100);
}

function saveFluid(){
var amount=parseInt(document.getElementById('fluidAmount').value);
// Phase 6B: Get selected event
var eventId=document.getElementById('eventSelect')?document.getElementById('eventSelect').value:'';
if(isNaN(amount)||amount<=0){
alert('Please enter a valid amount');
return;
}
dailyFluid+=amount;
var entry={time:getTime(),amount:amount};
if(eventId)entry.eventId=eventId;
fluidLog.push(entry);
saveDailyData();
if(activeReminderEvt) eventFluidLogged=true; // prevent fluid re-arming on reminder reshow
completeAndCloseModal();
updateFluid();
renderFluidChart();
updateUpcomingEventsWidget();
alert('‚úì Fluid logged: '+amount+' oz');
}

function updateFluid(){
  // Recalculate dailyFluid from all sources: BP, standalone fluid, and meals
  dailyFluid = 0;

  // BP fluid (B[i].f)
  for (var i = 0; i < B.length; i++) {
    if (B[i].f && B[i].f > 0) dailyFluid += B[i].f;
  }

  // Standalone fluid entries (fluidLog[i].amount)
  for (var j = 0; j < fluidLog.length; j++) {
    if (fluidLog[j].amount && fluidLog[j].amount > 0) dailyFluid += fluidLog[j].amount;
  }

  // Meal fluid (entry.mealFluidOz on M)
  for (var k = 0; k < M.length; k++) {
    if (M[k].mealFluidOz && M[k].mealFluidOz > 0) dailyFluid += M[k].mealFluidOz;
  }

  var mode=settings.fluidMode||'range';
// Pace projection: hours elapsed since midnight vs 24h day
var now=new Date();
var hoursElapsed=now.getHours()+(now.getMinutes()/60);
var hoursRemaining=Math.max(24-hoursElapsed,0.1);
var projectedTotal=hoursElapsed>0?Math.round((dailyFluid/hoursElapsed)*24):dailyFluid;
var html='<div style="font-size:20px;margin-bottom:12px">üíß Total Today: <span style="font-size:32px;font-weight:bold;color:#1e3a5f">'+dailyFluid+' oz</span></div>';

if(mode==='none'){
// General tracking ‚Äî just show total and pace
html+='<div style="background:#f0f9ff;border-left:4px solid #3b82f6;padding:12px;border-radius:6px;margin-bottom:12px">';
html+='<div style="font-weight:600;color:#1e40af">üìä General Tracking</div>';
html+='<div style="font-size:14px;color:#1e40af;margin-top:4px">Projected daily total at current pace: <strong>'+projectedTotal+' oz</strong></div>';
html+='<div style="font-size:13px;color:#6b7280;margin-top:4px">No doctor target set ‚Äî tracking to establish your baseline</div>';
html+='</div>';
var barColor='#3b82f6';
var percentUsed=Math.min((dailyFluid/80)*100,100);
html+='<div style="font-size:14px;color:#6b7280;margin-bottom:6px">Daily intake (general reference 80 oz)</div>';
html+='<div style="width:100%;height:32px;background:#e5e7eb;border-radius:16px;overflow:hidden">';
html+='<div style="width:'+percentUsed+'%;height:100%;background:'+barColor+';transition:width 0.3s ease"></div>';
html+='</div>';

}else if(mode==='maximum'){
// Maximum only ‚Äî track ceiling
var remaining=settings.fluidMax-dailyFluid;
var percentUsed=Math.min((dailyFluid/settings.fluidMax)*100,100);
var isAboveMax=dailyFluid>settings.fluidMax;
var isNearMax=percentUsed>=80&&!isAboveMax;
var barColor=isAboveMax?'#dc2626':isNearMax?'#f59e0b':'#10b981';
if(isAboveMax){
html+='<div style="background:#fee2e2;border-left:4px solid #ef4444;padding:12px;border-radius:6px;margin-bottom:12px">';
html+='<div style="font-weight:700;color:#991b1b;font-size:17px">üö´ Fluid Limit Exceeded</div>';
html+='<div style="font-size:14px;color:#991b1b;margin-top:4px">Exceeded your '+settings.fluidMax+' oz limit by <strong>'+(dailyFluid-settings.fluidMax)+' oz</strong>. Contact your care team if this happens regularly.</div>';
html+='</div>';
}else if(isNearMax){
html+='<div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:12px;border-radius:6px;margin-bottom:12px">';
html+='<div style="font-weight:600;color:#92400e">‚ö†Ô∏è Approaching Limit</div>';
html+='<div style="font-size:14px;color:#92400e;margin-top:4px"><strong>'+remaining+' oz</strong> remaining before your '+settings.fluidMax+' oz limit. Pace carefully through the rest of the day.</div>';
html+='</div>';
}else{
html+='<div style="background:#d1fae5;border-left:4px solid #10b981;padding:12px;border-radius:6px;margin-bottom:12px">';
html+='<div style="font-weight:600;color:#065f46">‚úì Within Limit</div>';
html+='<div style="font-size:14px;color:#065f46;margin-top:4px"><strong>'+remaining+' oz</strong> remaining of your '+settings.fluidMax+' oz daily maximum</div>';
html+='</div>';
}
// Pace warning for maximum mode
if(!isAboveMax&&projectedTotal>settings.fluidMax){
html+='<div style="background:#fef3c7;border:1px solid #f59e0b;padding:10px 12px;border-radius:6px;margin-bottom:10px;font-size:13px;color:#78350f">';
html+='üìà At your current pace you will reach <strong>'+projectedTotal+' oz</strong> by end of day ‚Äî above your '+settings.fluidMax+' oz limit. Consider slowing intake.';
html+='</div>';
}
html+='<div style="font-size:14px;color:#6b7280;margin-bottom:6px">Daily maximum: '+settings.fluidMax+' oz</div>';
html+='<div style="width:100%;height:32px;background:#e5e7eb;border-radius:16px;overflow:hidden;border:2px solid '+barColor+'">';
html+='<div style="width:'+percentUsed+'%;height:100%;background:'+barColor+';transition:width 0.3s ease"></div>';
html+='</div>';

}else{
// Range mode ‚Äî track min and max
var remaining=settings.fluidMax-dailyFluid;
var percentUsed=Math.min((dailyFluid/settings.fluidMax)*100,100);
var isBelowMin=dailyFluid<settings.fluidMin;
var isAboveMax=dailyFluid>settings.fluidMax;
var barColor=isAboveMax?'#dc2626':isBelowMin?'#f59e0b':'#10b981';
if(isBelowMin){
html+='<div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:12px;border-radius:6px;margin-bottom:12px">';
html+='<div style="font-weight:600;color:#92400e">‚ö†Ô∏è Below Minimum</div>';
html+='<div style="font-size:14px;color:#92400e;margin-top:4px">Need <strong>'+(settings.fluidMin-dailyFluid)+' more oz</strong> to reach your '+settings.fluidMin+' oz minimum goal</div>';
html+='</div>';
// Pace warning ‚Äî will you make it?
if(projectedTotal<settings.fluidMin){
html+='<div style="background:#fee2e2;border:1px solid #ef4444;padding:10px 12px;border-radius:6px;margin-bottom:10px;font-size:13px;color:#7f1d1d">';
html+='üìâ At current pace you will reach only <strong>'+projectedTotal+' oz</strong> today ‚Äî below your '+settings.fluidMin+' oz minimum. Consider drinking sooner.';
html+='</div>';
}
}else if(isAboveMax){
html+='<div style="background:#fee2e2;border-left:4px solid #ef4444;padding:12px;border-radius:6px;margin-bottom:12px">';
html+='<div style="font-weight:700;color:#991b1b">üö´ Above Maximum</div>';
html+='<div style="font-size:14px;color:#991b1b;margin-top:4px">Exceeded your '+settings.fluidMax+' oz limit by <strong>'+(dailyFluid-settings.fluidMax)+' oz</strong></div>';
html+='</div>';
}else{
html+='<div style="background:#d1fae5;border-left:4px solid #10b981;padding:12px;border-radius:6px;margin-bottom:12px">';
html+='<div style="font-weight:600;color:#065f46">‚úì Within Target Range</div>';
html+='<div style="font-size:14px;color:#065f46;margin-top:4px"><strong>'+remaining+' oz</strong> remaining before your '+settings.fluidMax+' oz maximum</div>';
html+='</div>';
}
html+='<div style="font-size:14px;color:#6b7280;margin-bottom:6px">Target range: '+settings.fluidMin+' ‚Äì '+settings.fluidMax+' oz</div>';
html+='<div style="width:100%;height:32px;background:#e5e7eb;border-radius:16px;overflow:hidden;border:2px solid '+barColor+'">';
html+='<div style="width:'+percentUsed+'%;height:100%;background:'+barColor+';transition:width 0.3s ease"></div>';
html+='</div>';
}
updateRecentFluid();
showFluidLog();
document.getElementById('recent-fluid').innerHTML=html;
}

function showFluidLog(){
  // Collect all fluid entries from BP readings, standalone fluid logs, and meals
  var allFluidEntries = [];

  // 1) Add fluid from BP readings (array B)
  for (var i = 0; i < B.length; i++) {
    if (B[i].f > 0) {
      allFluidEntries.push({
        time: B[i].t,
        amount: B[i].f,
        source: 'bp',
        index: i,
        eventId: B[i].eventId
      });
    }
  }

  // 2) Add standalone fluid entries (array fluidLog)
  for (var j = 0; j < fluidLog.length; j++) {
    allFluidEntries.push({
      time: fluidLog[j].time,
      amount: fluidLog[j].amount,
      source: 'fluid',
      index: j,
      eventId: fluidLog[j].eventId
    });
  }

  // 3) NEW: add fluid that was logged with meals (array M)
  // Adjust property names if your meal fluid field is named differently.
  for (var k = 0; k < M.length; k++) {
    if (M[k].mealFluidOz && M[k].mealFluidOz > 0) {
      allFluidEntries.push({
        time: M[k].time || M[k].t,   // use whichever you actually store
        amount: M[k].mealFluidOz,
        source: 'meal',
        index: k,
        eventId: M[k].eventId
      });
    }
  }

  // Sort by time (most recent first)
  allFluidEntries.sort(function(a,b){
    return b.time.localeCompare(a.time);
  });

  var html = '';
  if (allFluidEntries.length > 0) {
    html = '<div style="margin-top:16px;padding-top:16px;border-top:2px solid #e5e7eb">';
    html += '<div style="font-size:18px;font-weight:600;margin-bottom:12px;color:#374151">Fluid Log Entries:</div>';

    for (var i = 0; i < allFluidEntries.length; i++) {
      var entry = allFluidEntries[i];

      // icon/text/background by source
      var sourceIcon, sourceText, sourceBg, sourceBorder;
      if (entry.source === 'bp') {
        sourceIcon = 'ü©∫';
        sourceText = 'BP Check';
        sourceBg = '#eff6ff';
        sourceBorder = '#3b82f6';
      } else if (entry.source === 'meal') {
        sourceIcon = 'üçΩÔ∏è';
        sourceText = 'Meal';
        sourceBg = '#fef9c3';
        sourceBorder = '#eab308';
      } else {
        sourceIcon = 'üíß';
        sourceText = 'Fluid Log';
        sourceBg = '#f0f9ff';
        sourceBorder = '#0ea5e9';
      }

      html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border:2px solid #e5e7eb;border-radius:8px;margin-bottom:8px;background:#fff">';
      html += '<div style="flex:1">';
      html += '<div style="font-size:14px;color:#6b7280">' + entry.time + '</div>';
      html += '<div style="display:inline-block;padding:2px 8px;background:' + sourceBg + ';border:1px solid ' + sourceBorder + ';border-radius:4px;font-size:11px;font-weight:600;color:' + sourceBorder + ';margin:4px 0">' + sourceIcon + ' ' + sourceText + '</div>';

      // Display event tag if present
      if (entry.eventId) {
        var evt = getEventById(entry.eventId);
        if (evt) {
          html += ' <div style="display:inline-block;padding:2px 8px;background:#f0fdf4;border:1px solid #86efac;border-radius:4px;font-size:11px;font-weight:600;color:#166534;margin:4px 0">' + evt.icon + ' ' + evt.name + '</div>';
        }
      }

      html += '<br><div style="font-size:20px;font-weight:600;color:#0ea5e9">' + entry.amount + ' oz</div>';

      // Info message for BP-linked entries
      if (entry.source === 'bp') {
        html += '<div style="display:flex;align-items:center;gap:6px;margin-top:6px;padding:6px 10px;background:#fef3c7;border:1px solid #fbbf24;border-radius:4px">';
        html += '<span style="font-size:14px">‚ÑπÔ∏è</span>';
        html += '<span style="font-size:12px;color:#92400e;font-weight:500">To edit this fluid amount, edit the BP reading above</span>';
        html += '</div>';
      }

      html += '</div>';
      html += '<div style="display:flex;gap:8px">';

      // Only standalone fluid entries are editable from here
      if (entry.source === 'fluid') {
        html += '<button onclick="editFluidEntry(' + entry.index + ')" style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-size:14px;font-weight:600;cursor:pointer">‚úèÔ∏è Edit</button>';
      }

      // Delete handler differs by source
      if (entry.source === 'fluid') {
        html += '<button onclick="deleteFluidEntry(' + entry.index + ')" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-size:14px;font-weight:600;cursor:pointer">‚úï Delete</button>';
      } else if (entry.source === 'bp') {
        html += '<button onclick="deleteFluidFromBP(' + entry.index + ')" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-size:14px;font-weight:600;cursor:pointer">‚úï Delete</button>';
      } else if (entry.source === 'meal') {
  html += '<button onclick="deleteMealFluid(' + entry.index + ')" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-size:14px;font-weight:600;cursor:pointer">‚úï Delete</button>';
}


      html += '</div>';
      html += '</div>';
    }

    html += '</div>';
  }

  document.getElementById('fluidLogEntries').innerHTML = html;
}


function deleteFluidEntry(index){
if(confirm('Delete this fluid entry?')){
var entry=fluidLog[index];
dailyFluid-=entry.amount;
if(dailyFluid<0)dailyFluid=0;
fluidLog.splice(index,1);
saveDailyData();
updateFluid();
showFluidLog();
renderFluidChart();
alert('‚úì Fluid entry deleted');
}
}

function deleteFluidFromBP(bpIndex){
if(confirm('Remove fluid data from this BP reading?')){
if(B[bpIndex] && B[bpIndex].f>0){
dailyFluid-=B[bpIndex].f;
if(dailyFluid<0)dailyFluid=0;
B[bpIndex].f=0;
saveDailyData();
updateFluid();
showBP();
showFluidLog();
renderFluidChart();
alert('‚úì Fluid data removed from BP reading');
}
}
}
    function deleteMealFluid(index){
  if (!confirm('Remove fluid amount from this meal?')) return;
  if (!M[index]) return;

  // Clear just the fluid for that meal
  M[index].mealFluidOz = 0;

  saveDailyData();
  updateFluid();
  showFluidLog();
  renderFluidChart();
  alert('‚úì Meal fluid removed');
}


function editFluidEntry(index){
var entry=fluidLog[index];
var html='<div class="modal-title">Edit Fluid Entry</div>';
html+='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Amount (oz):</label>';
html+='<input type="number" id="editFluidAmount" class="modal-input" value="'+entry.amount+'" step="1" min="1" max="200" />';
html+='</div>';
html+='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Time:</label>';
html+='<input type="time" id="editFluidTime" class="modal-input" value="'+entry.time+'" />';
html+='</div>';
html+='<div class="modal-actions">';
html+='<button class="modal-cancel" onclick="hideModal()">Cancel</button>';
html+='<button class="modal-ok" onclick="saveEditedFluidEntry('+index+')">Save Changes</button>';
html+='</div>';
showModal(html);
}

function saveEditedFluidEntry(index){
var newAmount=parseInt(document.getElementById('editFluidAmount').value);
var newTime=document.getElementById('editFluidTime').value;
if(!newAmount||newAmount<=0){
alert('Please enter a valid amount');
return;
}
if(!newTime){
alert('Please enter a valid time');
return;
}
var oldAmount=fluidLog[index].amount;
dailyFluid=dailyFluid-oldAmount+newAmount;
if(dailyFluid<0)dailyFluid=0;
fluidLog[index].amount=newAmount;
fluidLog[index].time=newTime;
saveDailyData();
updateFluid();
showFluidLog();
renderFluidChart();
hideModal();
alert('‚úì Fluid entry updated');
}

// === WEIGHT TRACKING (Phase 2) ===

function logWeight(){
var html='<div class="modal-title">Log Weight</div>';
html+='<input type="number" id="weightValue" class="modal-input" placeholder="Enter weight" step="0.1" />';
html+='<div style="display:flex;gap:12px;margin:16px 0">';
html+='<button id="unitLbs" onclick="selectWeightUnit(\'lbs\')" class="modal-btn selected" style="flex:1">lbs</button>';
html+='<button id="unitKg" onclick="selectWeightUnit(\'kg\')" class="modal-btn" style="flex:1">kg</button>';
html+='</div>';
html+='<input type="text" id="weightNotes" class="modal-input" placeholder="Notes (optional)" />';
html+='<div class="modal-actions"><button class="modal-cancel" onclick="hideModal()">Cancel</button><button class="modal-ok" onclick="saveWeight()">Save</button></div>';
showModal(html);
// Set default unit from settings
if(settings.weightUnit){
selectWeightUnit(settings.weightUnit);
}
setTimeout(function(){document.getElementById('weightValue').focus();},100);
}

var selectedWeightUnit='lbs';

function selectWeightUnit(unit){
selectedWeightUnit=unit;
document.getElementById('unitLbs').classList.remove('selected');
document.getElementById('unitKg').classList.remove('selected');
document.getElementById('unit'+unit.charAt(0).toUpperCase()+unit.slice(1)).classList.add('selected');
}

function saveWeight(){
var weight=parseFloat(document.getElementById('weightValue').value);
var notes=document.getElementById('weightNotes').value.trim();
if(!weight||weight<=0||weight>1000){
alert('Please enter a valid weight (0-1000)');
return;
}
// Convert to lbs for consistent storage
var weightLbs=weight;
if(selectedWeightUnit==='kg'){
weightLbs=weight*2.20462;
}
W.push({w:weightLbs,unit:selectedWeightUnit,display:weight,t:getTime(),notes:notes});
saveDailyData();
completeAndCloseModal();
showWeight();
renderWeightChart();
checkWeightAlert();
alert('‚úì Weight logged: '+weight+' '+selectedWeightUnit);
}

function showWeight(){
if(!settings.features||!settings.features.weight)return;
var data=getFilteredData();
var weightData=data.weight||W;
var h='';
for(var i=weightData.length-1;i>=0;i--){
var r=weightData[i];
var displayWeight=r.display||r.w;
var displayUnit=r.unit||'lbs';
h+='<div class="reading">';
// Only show edit/delete buttons for today's data
if(dateFilterMode==='today'){
h+='<div style="position:absolute;top:8px;right:8px;display:flex;gap:8px">';
h+='<button onclick="editWeight('+i+')" style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:16px;font-weight:600;cursor:pointer">‚úèÔ∏è</button>';
h+='<button onclick="deleteWeight('+i+')" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:16px;font-weight:600;cursor:pointer">‚úï</button>';
h+='</div>';
}
// Show date
if(dateFilterMode==='all'&&r._date){
h+='<div style="font-size:14px;color:#3b82f6;font-weight:600;margin-bottom:4px">üìÖ '+r._date+'</div>';
}else if(dateFilterMode==='today'){
var todayDate=getTodayKey();
h+='<div style="font-size:14px;color:#10b981;font-weight:600;margin-bottom:4px">üìÖ Today ('+todayDate+')</div>';
}
h+='<div style="font-size:14px;color:#6b7280;margin-bottom:12px">'+r.t+'</div>';
h+='<div class="flex">';
h+='<div style="flex:1"><div style="font-size:16px;color:#6b7280">Weight</div><div class="b" style="font-size:32px;color:#f97316">'+displayWeight.toFixed(1)+' '+displayUnit+'</div></div>';
// Show change from previous
if(i<weightData.length-1){
var prevWeight=weightData[i+1].w;
var change=r.w-prevWeight;
var changeAbs=Math.abs(change);
if(changeAbs>=0.1){
var arrow=change>0?'‚Üë':'‚Üì';
var color=change>0?'#ef4444':'#10b981';
h+='<div style="flex:1"><div style="font-size:16px;color:#6b7280">Change</div><div style="font-size:24px;font-weight:700;color:'+color+'">'+arrow+' '+changeAbs.toFixed(1)+' lbs</div></div>';
}
}
h+='</div>';
if(r.notes){
h+='<div class="drop">üìù '+r.notes+'</div>';
}
h+='</div>';
}
document.getElementById('weight').innerHTML=h||'<p style="color:#6b7280;text-align:center;font-size:18px">No weight entries yet</p>';
}

function deleteWeight(i){
if(confirm('Delete this weight entry?')){
W.splice(i,1);
showWeight();
renderWeightChart();
checkWeightAlert();
saveDailyData();
alert('‚úì Weight entry deleted');
}
}

function editWeight(i){
var entry=W[i];
var displayWeight=entry.display||entry.w;
var displayUnit=entry.unit||'lbs';
var html='<div class="modal-title">Edit Weight Entry</div>';
html+='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Weight:</label>';
html+='<input type="number" id="editWeightValue" class="modal-input" value="'+displayWeight+'" step="0.1" min="1" max="999" />';
html+='</div>';
html+='<div style="display:flex;gap:12px;margin-bottom:16px">';
html+='<button class="modal-btn '+(displayUnit==='lbs'?'selected':'')+'" onclick="document.querySelectorAll(\'.modal-btn\').forEach(function(b){b.classList.remove(\'selected\');});this.classList.add(\'selected\');document.getElementById(\'editWeightUnit\').value=\'lbs\';">Pounds (lbs)</button>';
html+='<button class="modal-btn '+(displayUnit==='kg'?'selected':'')+'" onclick="document.querySelectorAll(\'.modal-btn\').forEach(function(b){b.classList.remove(\'selected\');});this.classList.add(\'selected\');document.getElementById(\'editWeightUnit\').value=\'kg\';">Kilograms (kg)</button>';
html+='</div>';
html+='<input type="hidden" id="editWeightUnit" value="'+displayUnit+'" />';
html+='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Time:</label>';
html+='<input type="time" id="editWeightTime" class="modal-input" value="'+entry.t+'" />';
html+='</div>';
html+='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Notes (optional):</label>';
html+='<textarea id="editWeightNotes" class="modal-input" rows="3" placeholder="Any notes about this weigh-in...">'+(entry.notes||'')+'</textarea>';
html+='</div>';
html+='<div class="modal-actions">';
html+='<button class="modal-cancel" onclick="hideModal()">Cancel</button>';
html+='<button class="modal-ok" onclick="saveEditedWeight('+i+')">Save Changes</button>';
html+='</div>';
showModal(html);
}

function saveEditedWeight(i){
var newWeight=parseFloat(document.getElementById('editWeightValue').value);
var newUnit=document.getElementById('editWeightUnit').value;
var newTime=document.getElementById('editWeightTime').value;
var newNotes=document.getElementById('editWeightNotes').value.trim();
if(!newWeight||newWeight<=0){
alert('Please enter a valid weight');
return;
}
if(!newTime){
alert('Please enter a valid time');
return;
}
// Convert to lbs for storage if kg was selected
var weightInLbs=newUnit==='kg'?(newWeight*2.20462):newWeight;
W[i].w=weightInLbs;
W[i].display=newWeight;
W[i].unit=newUnit;
W[i].t=newTime;
W[i].notes=newNotes;
saveDailyData();
showWeight();
renderWeightChart();
checkWeightAlert();
hideModal();
alert('‚úì Weight entry updated');
}

function checkWeightAlert(){
if(W.length<2)return;
var sorted=W.slice().sort(function(a,b){
return new Date('2000-01-01 '+a.t)-new Date('2000-01-01 '+b.t);
});
var latest=sorted[sorted.length-1];
var previous=sorted[sorted.length-2];
var change=latest.w-previous.w;
var changeAbs=Math.abs(change);
var threshold=settings.weightAlertThreshold||3;
var alertDiv=document.getElementById('weightAlert');
if(changeAbs>=threshold){
var direction=change>0?'gained':'lost';
var emoji=change>0?'‚ö†Ô∏è':'‚ÑπÔ∏è';
var cssClass=changeAbs>=5?'critical':'';
var html='<div class="weight-alert '+cssClass+'">';
html+=emoji+' <strong>Weight Change Alert:</strong> You\'ve '+direction+' '+changeAbs.toFixed(1)+' lbs since your last weigh-in.';
if(changeAbs>=5){
html+='<br><strong>Consider contacting your healthcare provider.</strong>';
}
html+='</div>';
alertDiv.innerHTML=html;
}else{
alertDiv.innerHTML='';
}
}

function renderWeightChart(){
if(!settings.features||!settings.features.weight)return;
var data=getFilteredData();
var weightData=data.weight||W;
if(weightData.length<2){
document.getElementById('noChartDataWeight').style.display='block';
document.getElementById('weightChart').style.display='none';
return;
}
document.getElementById('noChartDataWeight').style.display='none';
document.getElementById('weightChart').style.display='block';
var canvas=document.getElementById('weightChart');
var dpr=window.devicePixelRatio||1;
var logW=canvas.offsetWidth||canvas.parentElement.clientWidth||300;
var logH=400;
canvas.width=logW*dpr;canvas.height=logH*dpr;
canvas.style.width=logW+'px';canvas.style.height=logH+'px';
var ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
var w=logW;var h=logH;
var pad=60;
ctx.clearRect(0,0,w,h);
// Sort by time
var sorted=weightData.slice().sort(function(a,b){
return new Date('2000-01-01 '+a.t)-new Date('2000-01-01 '+b.t);
});
var weights=sorted.map(function(e){return e.w;});
var minWeight=Math.min.apply(null,weights);
var maxWeight=Math.max.apply(null,weights);
var range=maxWeight-minWeight||10;
// Draw axes
ctx.strokeStyle='#e5e7eb';
ctx.lineWidth=2;
ctx.beginPath();
ctx.moveTo(pad,h-pad);
ctx.lineTo(w-pad,h-pad);
ctx.moveTo(pad,pad);
ctx.lineTo(pad,h-pad);
ctx.stroke();
// Plot data
ctx.strokeStyle='#f97316';
ctx.fillStyle='#f97316';
ctx.lineWidth=3;
var xStep=(w-2*pad)/(sorted.length-1);
ctx.beginPath();
for(var i=0;i<sorted.length;i++){
var x=pad+i*xStep;
var y=h-pad-((sorted[i].w-minWeight)/range)*(h-2*pad);
if(i===0){
ctx.moveTo(x,y);
}else{
ctx.lineTo(x,y);
}
ctx.fillRect(x-4,y-4,8,8);
}
ctx.stroke();
// Draw trend line
var sumX=0,sumY=0,sumXY=0,sumX2=0;
for(var i=0;i<sorted.length;i++){
sumX+=i;
sumY+=sorted[i].w;
sumXY+=i*sorted[i].w;
sumX2+=i*i;
}
var n=sorted.length;
var slope=(n*sumXY-sumX*sumY)/(n*sumX2-sumX*sumX);
var intercept=(sumY-slope*sumX)/n;
ctx.strokeStyle='#3b82f6';
ctx.lineWidth=2;
ctx.setLineDash([5,5]);
ctx.beginPath();
var trendY1=intercept;
var trendY2=slope*(n-1)+intercept;
var y1=h-pad-((trendY1-minWeight)/range)*(h-2*pad);
var y2=h-pad-((trendY2-minWeight)/range)*(h-2*pad);
ctx.moveTo(pad,y1);
ctx.lineTo(w-pad,y2);
ctx.stroke();
ctx.setLineDash([]);
// Labels
ctx.fillStyle='#374151';
ctx.font='14px sans-serif';
ctx.textAlign='right';
ctx.fillText(maxWeight.toFixed(0),pad-5,pad+5);
ctx.fillText(minWeight.toFixed(0),pad-5,h-pad+5);
// Trend indicator
var trendDirection=slope>0.1?'‚Üë Gaining':slope<-0.1?'‚Üì Losing':'‚Üí Stable';
var trendColor=slope>0.1?'#ef4444':slope<-0.1?'#10b981':'#6b7280';
ctx.fillStyle=trendColor;
ctx.font='bold 16px sans-serif';
ctx.textAlign='center';
ctx.fillText('Trend: '+trendDirection,w/2,pad-10);
}

// === SYMPTOM TRACKING (Phase 3A) ===

var selectedSymptom='';
var selectedSeverity=0;

// Predefined symptom list (read-only)
var PREDEFINED_SYMPTOMS=[
'Shortness of Breath',
'Chest Pain/Discomfort',
'Swelling (Legs/Feet/Ankles)',
'Fatigue/Weakness',
'Dizziness/Lightheadedness',
'Rapid/Irregular Heartbeat',
'Persistent Cough',
'Nausea',
'Confusion/Mental Fog'
];

// Get merged symptom list (predefined + custom)
function getSymptomList(){
var customSymptoms=settings.customSymptoms||[];
return PREDEFINED_SYMPTOMS.concat(customSymptoms).sort();
}

function logSymptom(){
var symptomList=getSymptomList();
var html='<div class="modal-title">Log Symptom</div>';
html+='<label style="display:block;font-size:18px;font-weight:600;margin-bottom:8px">Select Symptom:</label>';
html+='<select id="symptomSelect" class="modal-input" style="font-size:20px" onchange="handleSymptomSelect()">';
html+='<option value="">-- Choose Symptom --</option>';
for(var i=0;i<symptomList.length;i++){
html+='<option value="'+symptomList[i]+'">'+symptomList[i]+'</option>';
}
html+='<option value="__NEW__">‚ûï Add New Symptom...</option>';
html+='</select>';
html+='<div id="newSymptomInput" style="display:none;margin-top:12px">';
html+='<label style="display:block;font-size:18px;font-weight:600;margin-bottom:8px">New Symptom Name:</label>';
html+='<input type="text" id="newSymptomName" class="modal-input" placeholder="e.g., Severe headaches, Vision changes..." style="font-size:20px" />';
html+='</div>';
html+='<label style="display:block;font-size:18px;font-weight:600;margin:16px 0 8px 0">Severity (1=Mild, 10=Severe):</label>';
html+='<div class="severity-selector">';
for(var i=1;i<=10;i++){
html+='<button type="button" class="severity-btn" id="severity'+i+'" onclick="selectSeverity('+i+')">'+i+'</button>';
}
html+='</div>';
html+='<input type="text" id="symptomNotes" class="modal-input" placeholder="Additional notes (optional)" style="margin-top:12px" />';

// Related Condition dropdown
var allConditions=(settings.conditions||[]).concat(
  (settings.customConditions||[]).filter(function(c){return (settings.conditions||[]).indexOf(c)<0;})
);
if(allConditions.length>0){
html+='<label style="display:block;font-size:18px;font-weight:600;margin:16px 0 8px 0">Related Condition (Optional):</label>';
html+='<select id="symptomCondition" class="modal-input" style="font-size:18px">';
html+='<option value="">-- Select Condition --</option>';
allConditions.forEach(function(c){html+='<option value="'+c+'">'+c+'</option>';});
html+='</select>';
}

// Related Activity dropdown ‚Äî all of today's activities
if(settings.features&&settings.features.exercise&&A.length>0){
html+='<label style="display:block;font-size:18px;font-weight:600;margin:16px 0 8px 0">Related Activity (Optional):</label>';
html+='<select id="symptomActivity" class="modal-input" style="font-size:18px">';
html+='<option value="">-- Select Activity --</option>';
var sortedA=A.slice().sort(function(a,b){return b.t>a.t?1:-1;});
sortedA.forEach(function(act){
html+='<option value="'+(act.id||act.t)+'">'+act.activity+' @ '+act.t+(act.duration?' ('+act.duration+' min)':'')+'</option>';
});
html+='</select>';
}

// Expected checkbox
html+='<div style="margin:16px 0;padding:12px;background:#f0f9ff;border:2px solid #3b82f6;border-radius:8px">';
html+='<label style="display:flex;align-items:center;cursor:pointer">';
html+='<input type="checkbox" id="symptomExpected" style="width:20px;height:20px;margin-right:10px;cursor:pointer" />';
html+='<div style="flex:1">';
html+='<span style="font-size:16px;font-weight:600;color:#1e3a8a">Expected symptom for my condition</span>';
html+='<div style="font-size:13px;color:#6b7280;margin-top:4px">Check this if this symptom is a known side effect or typical for your diagnosis</div>';
html+='</div>';
html+='</label>';
html+='</div>';

// Event dropdown
html+=getEventDropdownHTML();
html+='<div class="modal-actions"><button class="modal-cancel" onclick="hideModal()">Cancel</button><button class="modal-ok" onclick="saveSymptom()">Save</button></div>';
showModal(html);
setTimeout(function(){document.getElementById('symptomSelect').focus();},100);
}

function handleSymptomSelect(){
var select=document.getElementById('symptomSelect');
var newInput=document.getElementById('newSymptomInput');
if(select.value==='__NEW__'){
newInput.style.display='block';
setTimeout(function(){document.getElementById('newSymptomName').focus();},100);
}else{
newInput.style.display='none';
}
}

function selectSeverity(level){
selectedSeverity=level;
// Clear all selections
for(var i=1;i<=10;i++){
var btn=document.getElementById('severity'+i);
if(btn){
btn.classList.remove('selected');
btn.classList.remove('severity-low');
btn.classList.remove('severity-medium');
btn.classList.remove('severity-high');
}
}
// Select the clicked button
var selectedBtn=document.getElementById('severity'+level);
if(selectedBtn){
selectedBtn.classList.add('selected');
if(level<=3)selectedBtn.classList.add('severity-low');
else if(level<=6)selectedBtn.classList.add('severity-medium');
else selectedBtn.classList.add('severity-high');
}
}

function showSymptomError(msg){
// Remove any previous error
var prev=document.getElementById('symptomErrorBanner');
if(prev)prev.remove();
var banner=document.createElement('div');
banner.id='symptomErrorBanner';
banner.style.cssText='background:#fee2e2;border-left:4px solid #ef4444;color:#991b1b;padding:12px 16px;border-radius:8px;font-size:16px;font-weight:600;margin:8px 0';
banner.textContent='‚ö†Ô∏è '+msg;
// Insert at top of modal content
var content=document.getElementById('modalContent');
if(content) content.insertBefore(banner,content.firstChild);
// Scroll modal to top so user sees the error
var modal=document.querySelector('.modal');
if(modal) modal.scrollTop=0;
}

function saveSymptom(){
var symptom=document.getElementById('symptomSelect').value;
var notes=document.getElementById('symptomNotes').value.trim();
// Handle new symptom creation
if(symptom==='__NEW__'){
var newSymptom=document.getElementById('newSymptomName').value.trim();
if(!newSymptom){
showSymptomError('Please enter a name for the new symptom');
document.getElementById('newSymptomName').focus();
return;
}
// Add to custom symptoms list
if(!settings.customSymptoms){
settings.customSymptoms=[];
}
// Check if already exists
var allSymptoms=getSymptomList();
if(allSymptoms.indexOf(newSymptom)!==-1){
showSymptomError('This symptom already exists in your list');
return;
}
settings.customSymptoms.push(newSymptom);
// Persist just the settings object directly ‚Äî do NOT call saveSettings()
// because saveSettings() reads Settings-modal form fields and closes the modal
try{ localStorage.setItem('BP_TRACKER_SETTINGS',JSON.stringify(settings)); }catch(e){}
symptom=newSymptom;
}
if(!symptom){
showSymptomError('Please select a symptom from the list');
return;
}
if(selectedSeverity===0){
showSymptomError('Please select a severity level (1‚Äì10) ‚Äî scroll up to see the severity buttons');
return;
}
var severity=selectedSeverity;
var isExpected=document.getElementById('symptomExpected')?document.getElementById('symptomExpected').checked:false;
var eventId=document.getElementById('eventSelect')?document.getElementById('eventSelect').value:'';
var conditionLinked=document.getElementById('symptomCondition')?document.getElementById('symptomCondition').value:'';
var activityLinked=document.getElementById('symptomActivity')?document.getElementById('symptomActivity').value:'';
// Also store the activity display name so it renders correctly even after reload
var activityLinkedName='';
if(activityLinked){
var matchedAct=A.find(function(a){return(a.id||a.t)===activityLinked;});
if(matchedAct) activityLinkedName=(matchedAct.activity||matchedAct.type||'Activity')+' @ '+(matchedAct.t||'');
}
S.push({
symptom:symptom,
severity:severity,
t:getTime(),
notes:notes,
expected:isExpected,
event:eventId,
condition:conditionLinked,
activityRef:activityLinked,
activityName:activityLinkedName
});
saveDailyData();
completeAndCloseModal();
showSymptoms();
renderSymptomChart();
showTodayZone();
selectedSeverity=0;
// Always make sure the card is visible after a successful save
var sc=document.getElementById('symptomCard');
if(sc) sc.style.display='block';
// Brief toast confirmation
var toast=document.createElement('div');
toast.textContent='‚úì Symptom logged: '+symptom+' (Severity: '+severity+'/10)';
toast.style.cssText='position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#10b981;color:#fff;padding:14px 24px;border-radius:10px;font-size:17px;font-weight:600;z-index:999999;box-shadow:0 4px 12px rgba(0,0,0,0.2);pointer-events:none';
document.body.appendChild(toast);
setTimeout(function(){toast.remove();},2800);
}

function showSymptoms(){
if(!settings.features||!settings.features.symptoms)return;
var data=getFilteredData();
var symptomData=data.symptoms||S;
var h='';
for(var i=symptomData.length-1;i>=0;i--){
var r=symptomData[i];
var severityColor=r.severity<=3?'#10b981':r.severity<=6?'#f59e0b':'#ef4444';
var severityLabel=r.severity<=3?'Mild':r.severity<=6?'Moderate':'Severe';
h+='<div class="reading">';
// Only show edit/delete buttons for today's data
if(dateFilterMode==='today'){
h+='<div style="position:absolute;top:8px;right:8px;display:flex;gap:8px">';
h+='<button onclick="editSymptom('+i+')" style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:16px;font-weight:600;cursor:pointer">‚úèÔ∏è</button>';
h+='<button onclick="deleteSymptom('+i+')" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:16px;font-weight:600;cursor:pointer">‚úï</button>';
h+='</div>';
}
// Show date
if(dateFilterMode==='all'&&r._date){
h+='<div style="font-size:14px;color:#3b82f6;font-weight:600;margin-bottom:4px">üìÖ '+r._date+'</div>';
}else if(dateFilterMode==='today'){
var todayDate=getTodayKey();
h+='<div style="font-size:14px;color:#10b981;font-weight:600;margin-bottom:4px">üìÖ Today ('+todayDate+')</div>';
}
h+='<div style="font-size:14px;color:#6b7280;margin-bottom:12px">'+r.t+'</div>';
h+='<div class="flex" style="align-items:center">';
h+='<div style="flex:1">';
h+='<div style="font-size:20px;font-weight:700;color:#ec4899">'+r.symptom+'</div>';
// Phase 2: Show expected/unexpected badge
if(r.expected===true){
h+='<div style="display:inline-block;margin-top:6px;padding:4px 10px;background:#d1fae5;border:1px solid#10b981;border-radius:6px;font-size:13px;font-weight:600;color:#065f46">‚úì Expected</div>';
}else if(r.expected===false){
h+='<div style="display:inline-block;margin-top:6px;padding:4px 10px;background:#fee2e2;border:1px solid #ef4444;border-radius:6px;font-size:13px;font-weight:600;color:#991b1b">‚ö† Unexpected</div>';
}
h+='</div>';
h+='<div style="text-align:right">';
h+='<div style="font-size:14px;color:#6b7280">Severity</div>';
h+='<div style="font-size:32px;font-weight:700;color:'+severityColor+'">'+r.severity+'<span style="font-size:16px">/10</span></div>';
h+='<div style="font-size:14px;color:'+severityColor+';font-weight:600">'+severityLabel+'</div>';
h+='</div>';
h+='</div>';
if(r.notes){
h+='<div class="drop">üìù '+r.notes+'</div>';
}
// Show linked condition if present
if(r.condition){
h+='<div class="drop" style="background:#fdf4ff;border-left:3px solid #a855f7">';
h+='<strong style="color:#7e22ce">üè• Condition:</strong> '+r.condition;
h+='</div>';
}
// Show linked activity if present
if(r.activityRef){
var actDisplay=r.activityName||'';
if(!actDisplay){
var linkedAct=A.find(function(a){return(a.id||a.t)===r.activityRef;});
if(linkedAct) actDisplay=(linkedAct.activity||linkedAct.type||'Activity')+' @ '+(linkedAct.t||'');
}
if(actDisplay){
h+='<div class="drop" style="background:#f0fdf4;border-left:3px solid #10b981">';
h+='<strong style="color:#065f46">üèÉ Activity:</strong> '+actDisplay;
h+='</div>';
}
}
// Show linked event if present
if(r.event){
var linkedEvent=getEventById(r.event);
if(linkedEvent){
h+='<div class="drop" style="background:#e0e7ff;border-left:3px solid #6366f1">';
h+='<strong style="color:#4338ca">üîó Related Event:</strong> '+linkedEvent.icon+' '+linkedEvent.name;
if(linkedEvent.time){
h+=' ('+linkedEvent.time+')';
}
h+='</div>';
}
}
h+='</div>';
}
document.getElementById('symptom').innerHTML =
  h || '<p style="color:#6b7280;text-align:center;font-size:18px">No symptoms logged today</p>';

// Card visibility: always show if feature is enabled (let user see "none logged" state)
// Hide only if feature is explicitly off
var featureOn = settings.features && settings.features.symptoms;
if(featureOn){
  document.getElementById('symptomCard').style.display = 'block';
} else {
  document.getElementById('symptomCard').style.display = 'none';
}
}


function openSymptomReview(){
  var html = '<div class="modal-title">Symptom Review for Doctor</div>';

  // Search + filter controls
  html += '<div style="margin-bottom:12px">';
  html += '<input type="text" id="symptomSearchBox" class="modal-input" placeholder="üîç Search by keyword (e.g. knee, dizziness...)" style="font-size:16px;margin-bottom:10px" oninput="renderSymptomReviewList()" />';
  html += '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">';
  html += '<button onclick="setSymptomReviewFilter(\'all\')" id="srfAll" style="padding:6px 14px;font-size:13px;border-radius:999px;border:2px solid #3b82f6;background:#3b82f6;color:#fff;cursor:pointer;font-weight:600">All</button>';
  html += '<button onclick="setSymptomReviewFilter(\'severe\')" id="srfSevere" style="padding:6px 14px;font-size:13px;border-radius:999px;border:1px solid #f97316;background:white;color:#c2410c;cursor:pointer">Severe 7‚Äì10</button>';
  html += '<button onclick="setSymptomReviewFilter(\'unexpected\')" id="srfUnexpected" style="padding:6px 14px;font-size:13px;border-radius:999px;border:1px solid #ef4444;background:white;color:#b91c1c;cursor:pointer">Unexpected</button>';
  html += '<button onclick="setSymptomReviewFilter(\'today\')" id="srfToday" style="padding:6px 14px;font-size:13px;border-radius:999px;border:1px solid #10b981;background:white;color:#065f46;cursor:pointer">Today</button>';
  html += '</div>';
  html += '<div style="display:flex;gap:8px;align-items:center">';
  html += '<label style="font-size:14px;color:#374151;font-weight:600;white-space:nowrap">Date range:</label>';
  html += '<input type="date" id="srDateFrom" class="modal-input" style="font-size:14px;padding:8px;flex:1" oninput="renderSymptomReviewList()" />';
  html += '<span style="color:#6b7280">to</span>';
  html += '<input type="date" id="srDateTo" class="modal-input" style="font-size:14px;padding:8px;flex:1" oninput="renderSymptomReviewList()" />';
  html += '<button onclick="document.getElementById(\'srDateFrom\').value=\'\';document.getElementById(\'srDateTo\').value=\'\';renderSymptomReviewList();" style="padding:8px 12px;font-size:13px;border:1px solid #d1d5db;border-radius:8px;background:white;cursor:pointer">Clear</button>';
  html += '</div>';
  html += '</div>';

  html += '<div id="symptomReviewList" style="max-height:380px;overflow-y:auto;margin-top:4px;"></div>';
  html += '<div class="modal-actions"><button class="modal-ok" onclick="hideModal()">Close</button></div>';

  showModal(html);
  symptomReviewFilter = 'all';
  setTimeout(renderSymptomReviewList, 50);
}

var symptomReviewFilter = 'all';

function setSymptomReviewFilter(mode){
  symptomReviewFilter = mode;
  // Update button styles
  ['All','Severe','Unexpected','Today'].forEach(function(f){
    var btn=document.getElementById('srf'+f);
    if(!btn)return;
    var active=(mode===f.toLowerCase());
    btn.style.background=active?'#3b82f6':'white';
    btn.style.color=active?'#fff':(f==='Severe'?'#c2410c':f==='Unexpected'?'#b91c1c':f==='Today'?'#065f46':'#111827');
    btn.style.border=active?'2px solid #3b82f6':(f==='Severe'?'1px solid #f97316':f==='Unexpected'?'1px solid #ef4444':f==='Today'?'1px solid #10b981':'1px solid #9ca3af');
    btn.style.fontWeight=active?'600':'400';
  });
  renderSymptomReviewList();
}

function renderSymptomReviewList(){
  var container = document.getElementById('symptomReviewList');
  if(!container) return;

  // Gather all symptom data (historical + today)
  var allSymptoms = [];
  var todayKey = getTodayKey();

  // Historical ‚Äî skip today and non-date keys (DAILY_DATA, SETTINGS, PROCEDURES, etc.)
  for(var key in localStorage){
    if(!key.startsWith('BP_TRACKER_')) continue;
    var dateKey=key.replace('BP_TRACKER_','');
    if(dateKey===todayKey) continue;
    if(dateKey==='DAILY_DATA'||dateKey==='SETTINGS'||dateKey==='PROCEDURES'||dateKey==='MEDICINE_LIST') continue;
    if(!/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) continue; // must be a real date
    try{
      var d=JSON.parse(localStorage.getItem(key));
      if(d.symptoms) d.symptoms.forEach(function(s,i){
        allSymptoms.push(Object.assign({},s,{_date:dateKey,_source:'history',_histIdx:i,_histKey:key}));
      });
    }catch(e){}
  }
  // Today's in-memory ‚Äî include index for edit/delete
  S.forEach(function(s,i){
    allSymptoms.push(Object.assign({},s,{_date:todayKey,_source:'today',_todayIdx:i}));
  });

  // Sort newest date first, then by time descending within same date
  allSymptoms.sort(function(a,b){
    if(b._date!==a._date) return b._date>a._date?1:-1;
    return (b.t||'')>(a.t||'')?1:-1;
  });

  var keyword=(document.getElementById('symptomSearchBox')||{}).value||'';
  keyword=keyword.toLowerCase().trim();
  var dateFrom=(document.getElementById('srDateFrom')||{}).value||'';
  var dateTo=(document.getElementById('srDateTo')||{}).value||'';
  var todayKey=getTodayKey();

  var filtered=allSymptoms.filter(function(s){
    if(symptomReviewFilter==='severe'&&s.severity<7) return false;
    if(symptomReviewFilter==='unexpected'&&s.expected) return false;
    if(symptomReviewFilter==='today'&&s._date!==todayKey) return false;
    if(dateFrom&&s._date<dateFrom) return false;
    if(dateTo&&s._date>dateTo) return false;
    if(keyword){
      var searchable=((s.symptom||'')+' '+(s.notes||'')+' '+(s.condition||'')+(s.activityRef||'')).toLowerCase();
      if(searchable.indexOf(keyword)<0) return false;
    }
    return true;
  });

  if(filtered.length===0){
    container.innerHTML='<p style="color:#6b7280;font-size:14px;margin-top:8px;text-align:center">No symptoms match this search/filter.</p>';
    return;
  }

  var html='';
  filtered.forEach(function(s,idx){
    var sevColor=s.severity<=3?'#10b981':s.severity<=6?'#f59e0b':'#ef4444';
    html+='<div style="border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin-bottom:8px;background:#fff">';
    html+='<div style="display:flex;justify-content:space-between;align-items:flex-start">';
    html+='<div style="flex:1">';
    html+='<div style="font-weight:700;font-size:16px;color:#1f2937">'+s.symptom+'</div>';
    html+='<div style="font-size:12px;color:#6b7280;margin-top:2px">üìÖ '+s._date+' &nbsp;‚è∞ '+(s.t||'--')+'</div>';
    if(s.notes) html+='<div style="font-size:13px;color:#374151;margin-top:4px">üìù '+s.notes+'</div>';
    if(s.condition) html+='<div style="font-size:12px;color:#7e22ce;margin-top:3px">üè• '+s.condition+'</div>';
    if(s.activityRef){
      var actDisplay=s.activityName||'';
      if(!actDisplay){
        var act=A.find(function(a){return(a.id||a.t)===s.activityRef;});
        if(act) actDisplay=(act.activity||act.type||'Activity')+' @ '+(act.t||'');
      }
      if(actDisplay) html+='<div style="font-size:12px;color:#065f46;margin-top:3px">üèÉ '+actDisplay+'</div>';
    }
    html+='<div style="margin-top:6px">';
    html+='<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:12px;font-weight:600;background:'+(s.expected?'#d1fae5':'#fee2e2')+';color:'+(s.expected?'#065f46':'#991b1b')+'">'+(s.expected?'‚úì Expected':'‚ö† Unexpected')+'</span>';
    html+='</div>';
    html+='</div>';
    html+='<div style="display:flex;flex-direction:column;align-items:center;gap:6px;min-width:64px;margin-left:10px">';
    html+='<div style="text-align:center"><div style="font-size:26px;font-weight:700;color:'+sevColor+'">'+s.severity+'</div><div style="font-size:10px;color:#6b7280">/10</div></div>';
    if(s._source==='today'){
      html+='<button onclick="hideModal();editSymptom('+s._todayIdx+')" style="width:100%;padding:5px 6px;font-size:12px;font-weight:600;border:none;border-radius:6px;background:#3b82f6;color:#fff;cursor:pointer">‚úèÔ∏è Edit</button>';
      html+='<button onclick="deleteSymptomFromReview('+s._todayIdx+')" style="width:100%;padding:5px 6px;font-size:12px;font-weight:600;border:none;border-radius:6px;background:#ef4444;color:#fff;cursor:pointer">‚úï Del</button>';
    }else{
      html+='<div style="font-size:10px;color:#9ca3af;text-align:center">Historical</div>';
    }
    html+='</div>';
    html+='</div>';
    html+='</div>';
  });

  container.innerHTML=html;
}
    
function deleteSymptomFromReview(i){
if(confirm('Delete this symptom entry?')){
S.splice(i,1);
showSymptoms();
renderSymptomChart();
saveDailyData();
showTodayZone();
renderSymptomReviewList(); // refresh the review list in place
}
}

function deleteSymptom(i){
if(confirm('Delete this symptom entry?')){
S.splice(i,1);
showSymptoms();
renderSymptomChart();
saveDailyData();
alert('‚úì Symptom entry deleted');
}
}

function editSymptom(i){
var entry=S[i];
if(!entry){ return; }
var symptomList=getSymptomList();
var html='<div class="modal-title">Edit Symptom</div>';
html+='<label style="display:block;font-size:18px;font-weight:600;margin-bottom:8px">Symptom:</label>';
html+='<select id="editSymptomType" class="modal-input" style="width:100%">';
var found=false;
for(var j=0;j<symptomList.length;j++){
var sel=symptomList[j]===entry.symptom?' selected':'';
if(sel) found=true;
html+='<option value="'+symptomList[j]+'"'+sel+'>'+symptomList[j]+'</option>';
}
if(!found&&entry.symptom){
html+='<option value="'+entry.symptom+'" selected>'+entry.symptom+'</option>';
}
html+='</select>';
html+='<label style="display:block;font-size:18px;font-weight:600;margin:16px 0 8px 0">Severity (1‚Äì10):</label>';
html+='<div class="severity-selector">';
for(var j=1;j<=10;j++){
var isSelected=j===entry.severity;
var severityClass=j<=3?'severity-low':(j<=6?'severity-medium':'severity-high');
html+='<button class="severity-btn '+(isSelected?severityClass+' selected':'')+'" onclick="selectEditSeverity('+j+',this)">'+j+'</button>';
}
html+='</div>';
html+='<input type="hidden" id="editSymptomSeverity" value="'+entry.severity+'" />';
html+='<label style="display:block;font-size:18px;font-weight:600;margin:16px 0 8px 0">Time:</label>';
html+='<input type="time" id="editSymptomTime" class="modal-input" value="'+( entry.t||'')+'" />';
html+='<label style="display:block;font-size:18px;font-weight:600;margin:16px 0 8px 0">Notes (optional):</label>';
html+='<textarea id="editSymptomNotes" class="modal-input" rows="3" placeholder="Additional details...">'+(entry.notes||'')+'</textarea>';
var allConditions=(settings.conditions||[]).concat(
  (settings.customConditions||[]).filter(function(c){return (settings.conditions||[]).indexOf(c)<0;})
);
if(allConditions.length>0){
html+='<label style="display:block;font-size:18px;font-weight:600;margin:16px 0 8px 0">Related Condition (Optional):</label>';
html+='<select id="editSymptomCondition" class="modal-input" style="font-size:18px">';
html+='<option value="">-- Select Condition --</option>';
allConditions.forEach(function(c){
html+='<option value="'+c+'"'+( c===entry.condition?' selected':'')+'>'+c+'</option>';
});
html+='</select>';
}
html+='<div style="margin:16px 0;padding:12px;background:#f0f9ff;border:2px solid #3b82f6;border-radius:8px">';
html+='<label style="display:flex;align-items:center;cursor:pointer">';
html+='<input type="checkbox" id="editSymptomExpected" style="width:20px;height:20px;margin-right:10px;cursor:pointer"'+(entry.expected?' checked':'')+' />';
html+='<span style="font-size:16px;font-weight:600;color:#1e3a8a">Expected symptom for my condition</span>';
html+='</label>';
html+='</div>';
html+=getEventDropdownHTML(entry.event||'')+'<div class="modal-actions"><button class="modal-cancel" onclick="hideModal()">Cancel</button><button class="modal-ok" onclick="saveEditedSymptomEntry('+i+')">Save Changes</button></div>';
showModal(html);
}

function selectEditSeverity(level,btn){
var allBtns=document.querySelectorAll('.severity-btn');
allBtns.forEach(function(b){
b.classList.remove('selected','severity-low','severity-medium','severity-high');
});
var severityClass=level<=3?'severity-low':(level<=6?'severity-medium':'severity-high');
btn.classList.add('selected',severityClass);
document.getElementById('editSymptomSeverity').value=level;
}

function saveEditedSymptomEntry(i){
var symptomType=document.getElementById('editSymptomType').value;
var severity=parseInt(document.getElementById('editSymptomSeverity').value);
var time=document.getElementById('editSymptomTime').value;
var notes=document.getElementById('editSymptomNotes').value.trim();
var eventId=document.getElementById('eventSelect')?document.getElementById('eventSelect').value:'';
var condition=document.getElementById('editSymptomCondition')?document.getElementById('editSymptomCondition').value:'';
var isExpected=document.getElementById('editSymptomExpected')?document.getElementById('editSymptomExpected').checked:false;
if(!symptomType){ showSymptomError('Please select a symptom'); return; }
if(!severity||severity<1||severity>10){ showSymptomError('Please select a severity (1‚Äì10)'); return; }
if(!time){ showSymptomError('Please enter a valid time'); return; }
S[i].symptom=symptomType;
S[i].severity=severity;
S[i].t=time;
S[i].notes=notes;
S[i].event=eventId;
S[i].condition=condition;
S[i].expected=isExpected;
saveDailyData();
showSymptoms();
renderSymptomChart();
showTodayZone();
completeAndCloseModal();
var toast=document.createElement('div');
toast.textContent='‚úì Symptom updated';
toast.style.cssText='position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#10b981;color:#fff;padding:14px 24px;border-radius:10px;font-size:17px;font-weight:600;z-index:999999;box-shadow:0 4px 12px rgba(0,0,0,0.2);pointer-events:none';
document.body.appendChild(toast);
setTimeout(function(){toast.remove();},2500);
}


function renderSymptomChart(){
if(!settings.features||!settings.features.symptoms)return;
var data=getFilteredData();
var symptomData=data.symptoms||S;
if(symptomData.length<2){
document.getElementById('noChartDataSymptom').style.display='block';
document.getElementById('symptomChart').style.display='none';
return;
}
document.getElementById('noChartDataSymptom').style.display='none';
document.getElementById('symptomChart').style.display='block';
var canvas=document.getElementById('symptomChart');
var dpr=window.devicePixelRatio||1;
var logW=canvas.offsetWidth||canvas.parentElement.clientWidth||300;
var logH=400;
canvas.width=logW*dpr;canvas.height=logH*dpr;
canvas.style.width=logW+'px';canvas.style.height=logH+'px';
var ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
var w=logW;var h=logH;
var pad=60;
ctx.clearRect(0,0,w,h);
// Sort by time
var sorted=symptomData.slice().sort(function(a,b){
return new Date('2000-01-01 '+a.t)-new Date('2000-01-01 '+b.t);
});
// Draw axes
ctx.strokeStyle='#e5e7eb';
ctx.lineWidth=2;
ctx.beginPath();
ctx.moveTo(pad,h-pad);
ctx.lineTo(w-pad,h-pad);
ctx.moveTo(pad,pad);
ctx.lineTo(pad,h-pad);
ctx.stroke();
// Draw severity zones
ctx.fillStyle='rgba(16,185,129,0.1)';
ctx.fillRect(pad,h-pad-(3/10)*(h-2*pad),w-2*pad,(3/10)*(h-2*pad));
ctx.fillStyle='rgba(245,158,11,0.1)';
ctx.fillRect(pad,h-pad-(6/10)*(h-2*pad),w-2*pad,(3/10)*(h-2*pad));
ctx.fillStyle='rgba(239,68,68,0.1)';
ctx.fillRect(pad,pad,w-2*pad,(4/10)*(h-2*pad));
// Plot data
ctx.strokeStyle='#ec4899';
ctx.fillStyle='#ec4899';
ctx.lineWidth=3;
var xStep=(w-2*pad)/(sorted.length-1);
ctx.beginPath();
for(var i=0;i<sorted.length;i++){
var x=pad+i*xStep;
var y=h-pad-(sorted[i].severity/10)*(h-2*pad);
if(i===0){
ctx.moveTo(x,y);
}else{
ctx.lineTo(x,y);
}
// Color code the point
var pointColor=sorted[i].severity<=3?'#10b981':sorted[i].severity<=6?'#f59e0b':'#ef4444';
ctx.fillStyle=pointColor;
ctx.fillRect(x-5,y-5,10,10);
ctx.fillStyle='#ec4899';
}
ctx.stroke();
// Labels
ctx.fillStyle='#374151';
ctx.font='14px sans-serif';
ctx.textAlign='right';
ctx.fillText('10',pad-5,pad+5);
ctx.fillText('5',pad-5,h-pad-(5/10)*(h-2*pad)+5);
ctx.fillText('1',pad-5,h-pad+5);
// Zone labels
ctx.textAlign='left';
ctx.fillStyle='#10b981';
ctx.font='bold 12px sans-serif';
ctx.fillText('Mild (1-3)',pad+5,h-pad-10);
ctx.fillStyle='#f59e0b';
ctx.fillText('Moderate (4-6)',pad+5,h-pad-(4.5/10)*(h-2*pad));
ctx.fillStyle='#ef4444';
ctx.fillText('Severe (7-10)',pad+5,pad+15);
}

// ===== ACTIVITY/EXERCISE TRACKING (PHASE 3B) =====
// Default activity types (can be extended by user in settings)
var defaultActivityTypes=[
'Walking',
'Running',
'Cycling',
'Swimming',
'Yoga',
'Weight Training',
'Sports',
'Manual Work',
'Other'
];

// Function to get all activity types (default + custom)
function getActivityTypes(){
var types=[...defaultActivityTypes];
if(settings.customActivities&&settings.customActivities.length>0){
// Add custom activities
types=types.concat(settings.customActivities);
}
return types;
}

// Keep activityTypes variable for backwards compatibility
var activityTypes=defaultActivityTypes;

var selectedExertion='';
var activityTimerInterval=null;
var activityStartTime=null;
var activityElapsedSeconds=0;

function logActivity(){
var html='<div class="modal-title">Log Activity/Exercise</div>';
html+='<label style="display:block;font-size:18px;font-weight:600;margin-bottom:8px">Activity Type:</label>';
html+='<select id="activitySelect" class="modal-input" style="font-size:20px" onchange="handleActivitySelection()">';
html+='<option value="">-- Choose Activity --</option>';
var allActivityTypes=getActivityTypes();
// Separate default and custom activities
var customActivities=settings.customActivities||[];
// Add default activities
for(var i=0;i<defaultActivityTypes.length;i++){
html+='<option value="'+defaultActivityTypes[i]+'">'+defaultActivityTypes[i]+'</option>';
}
// Add separator if there are custom activities
if(customActivities.length>0){
html+='<option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>';
// Add custom activities
for(var i=0;i<customActivities.length;i++){
html+='<option value="'+customActivities[i]+'">'+customActivities[i]+'</option>';
}
}
// Add "Add New Activity" option
html+='<option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>';
html+='<option value="__ADD_NEW__">‚ûï Add New Activity...</option>';
html+='</select>';
// Add Manage Activities button
if(customActivities.length>0){
html+='<button type="button" onclick="openActivityManager()" style="margin-top:8px;padding:8px 12px;background:#6b7280;color:white;border:none;border-radius:6px;font-size:14px;cursor:pointer;width:100%">‚öôÔ∏è Manage Custom Activities</button>';
}
html+='<div id="manualWorkDesc" style="display:none;margin-top:12px">';
html+='<input type="text" id="workDescription" class="modal-input" placeholder="Describe manual work (e.g., gardening, moving boxes)" />';
html+='</div>';
html+='<label style="display:block;font-size:18px;font-weight:600;margin:16px 0 8px 0">Duration:</label>';
html+='<div style="display:flex;gap:12px;margin-bottom:16px">';
html+='<button type="button" class="modal-btn" id="manualTimeBtn" onclick="selectTimeMode(\'manual\')">Manual Entry</button>';
html+='<button type="button" class="modal-btn" id="timerBtn" onclick="selectTimeMode(\'timer\')">Use Timer</button>';
html+='</div>';
html+='<div id="manualTimeInput" style="display:none">';
html+='<input type="number" id="durationMinutes" class="modal-input" placeholder="Duration (minutes)" min="1" />';
html+='</div>';
html+='<div id="timerDisplay" style="display:none;text-align:center;padding:20px;background:#f0fdf4;border-radius:12px;margin-bottom:16px">';
html+='<div id="bpBeforeStatus" style="margin-bottom:12px;padding:8px;background:#dbeafe;border-radius:6px;font-size:14px;font-weight:600;color:#1e40af;display:none"></div>';
html+='<button type="button" id="takeBPBeforeBtn" class="modal-btn" onclick="takeBPBeforeActivity()" style="background:#3b82f6;color:#fff;margin-bottom:12px;display:none">üìä Take BP Before Activity</button>';
html+='<div id="timerTime" style="font-size:48px;font-weight:bold;color:#10b981;font-family:monospace">00:00</div>';
html+='<button type="button" id="timerStartBtn" class="modal-btn" onclick="startActivityTimer()" style="background:#10b981;color:#fff;margin-top:12px">Start Timer</button>';
html+='<button type="button" id="timerStopBtn" class="modal-btn" onclick="stopActivityTimer()" style="background:#ef4444;color:#fff;margin-top:12px;display:none">‚èπ STOP</button>';
html+='</div>';
html+='<label style="display:block;font-size:18px;font-weight:600;margin:16px 0 8px 0">Exertion Level:</label>';
html+='<div style="display:flex;gap:12px;margin-bottom:16px">';
html+='<button type="button" class="modal-btn" id="exertionLight" onclick="selectExertion(\'Light\')">Light</button>';
html+='<button type="button" class="modal-btn" id="exertionModerate" onclick="selectExertion(\'Moderate\')">Moderate</button>';
html+='<button type="button" class="modal-btn" id="exertionVigorous" onclick="selectExertion(\'Vigorous\')">Vigorous</button>';
html+='</div>';
html+='<input type="text" id="activityNotes" class="modal-input" placeholder="Additional notes (optional)" />';
html+='<div class="modal-actions"><button class="modal-cancel" onclick="cancelActivityLog()">Cancel</button><button class="modal-ok" onclick="saveActivity()">Save</button></div>';
showModal(html);
setTimeout(function(){
document.getElementById('activitySelect').focus();
},100);
}

// NEW: Handle activity selection including "Add New"
function handleActivitySelection(){
var select=document.getElementById('activitySelect');
var desc=document.getElementById('manualWorkDesc');
if(select.value==='__ADD_NEW__'){
// Add new activity
var activityName=prompt('Enter new activity name:');
if(!activityName||!activityName.trim()){
select.value=''; // Reset selection
return;
}
activityName=activityName.trim();
// Check if already exists
if(!settings.customActivities)settings.customActivities=[];
if(defaultActivityTypes.includes(activityName)){
alert('This activity already exists in the default list');
select.value='';
return;
}
if(settings.customActivities.includes(activityName)){
alert('This custom activity already exists');
select.value='';
return;
}
// Add it
settings.customActivities.push(activityName);
// Save custom activities directly (don't call saveSettings - we're not in settings modal!)
localStorage.setItem('BP_TRACKER_SETTINGS',JSON.stringify(settings));
// Refresh the modal to show new activity
logActivity();
// Set the newly added activity as selected
setTimeout(function(){
document.getElementById('activitySelect').value=activityName;
},100);
}else if(select.value==='Manual Work'){
desc.style.display='block';
}else{
desc.style.display='none';
}
}

function selectTimeMode(mode){
var manualBtn=document.getElementById('manualTimeBtn');
var timerBtn=document.getElementById('timerBtn');
var manualInput=document.getElementById('manualTimeInput');
var timerDisplay=document.getElementById('timerDisplay');
var bpBeforeBtn=document.getElementById('takeBPBeforeBtn');

console.log('selectTimeMode called with mode:',mode);

// Ensure elements exist
if(!manualBtn||!timerBtn||!manualInput||!timerDisplay){
console.error('Timer mode elements not found',{manualBtn:!!manualBtn,timerBtn:!!timerBtn,manualInput:!!manualInput,timerDisplay:!!timerDisplay});
return;
}

manualBtn.classList.remove('selected');
timerBtn.classList.remove('selected');
if(mode==='manual'){
manualBtn.classList.add('selected');
manualInput.style.display='block';
timerDisplay.style.display='none';
stopActivityTimer();
console.log('Switched to manual mode');
}else{
timerBtn.classList.add('selected');
manualInput.style.display='none';
timerDisplay.style.display='block';
if(bpBeforeBtn)bpBeforeBtn.style.display='block';
console.log('Switched to timer mode, timer display:',timerDisplay.style.display);
}
}

function startActivityTimer(){
if(activityTimerInterval){
console.log('Timer already running');
return;
}
activityStartTime=Date.now()-(activityElapsedSeconds*1000);
console.log('Starting timer, elapsed seconds:',activityElapsedSeconds);
document.getElementById('timerStartBtn').style.display='none';
document.getElementById('timerStopBtn').style.display='block';
activityTimerInterval=setInterval(function(){
var elapsed=Math.floor((Date.now()-activityStartTime)/1000);
activityElapsedSeconds=elapsed;
var mins=Math.floor(elapsed/60);
var secs=elapsed%60;
document.getElementById('timerTime').textContent=(mins<10?'0':'')+mins+':'+(secs<10?'0':'')+secs;
},100);
}

function stopActivityTimer(){
if(activityTimerInterval){
clearInterval(activityTimerInterval);
activityTimerInterval=null;
console.log('Timer stopped, total elapsed seconds:',activityElapsedSeconds,'minutes:',Math.floor(activityElapsedSeconds/60));
}
var startBtn=document.getElementById('timerStartBtn');
var stopBtn=document.getElementById('timerStopBtn');
if(startBtn)startBtn.style.display='block';
if(stopBtn)stopBtn.style.display='none';
}

function selectExertion(level){
selectedExertion=level;
document.getElementById('exertionLight').classList.remove('selected');
document.getElementById('exertionModerate').classList.remove('selected');
document.getElementById('exertionVigorous').classList.remove('selected');
document.getElementById('exertion'+level).classList.add('selected');
}

// NEW: Store current activity info for BP linking
var currentActivityForBP=null;
var bpBeforeReading=null;

// NEW: Take BP before activity
function takeBPBeforeActivity(){
// Store current activity info temporarily
var activityType=document.getElementById('activitySelect').value;
if(!activityType){
alert('Please select an activity type first');
return;
}
currentActivityForBP={
type:activityType,
timing:'before'
};
// Open BP modal in a new context
hideModal();
setTimeout(function(){
logBPForActivity('before');
},300);
}

// NEW: Take BP after activity (called when activity is saved)
function takeBPAfterActivity(activityId){
currentActivityForBP={
activityId:activityId,
timing:'after'
};
setTimeout(function(){
if(confirm('Would you like to take your blood pressure after this activity?')){
logBPForActivity('after');
}else{
currentActivityForBP=null;
}
},500);
}

// NEW: Log BP with automatic activity linking
function logBPForActivity(timing){
var html='<div class="modal-title">Log Blood Pressure - '+(timing==='before'?'Before':'After')+' Activity</div>';
html+='<input type="number" id="sys" class="modal-input" placeholder="Systolic (top number)" />';
html+='<input type="number" id="dia" class="modal-input" placeholder="Diastolic (bottom number)" />';
html+='<input type="number" id="hr" class="modal-input" placeholder="Heart Rate (BPM)" />';
html+='<div class="modal-actions">';
html+='<button class="modal-cancel" onclick="cancelBPForActivity()">Cancel</button>';
html+='<button class="modal-ok" onclick="saveBPForActivity()">Save</button>';
html+='</div>';
showModal(html);
setTimeout(function(){document.getElementById('sys').focus();},100);
}

// NEW: Save BP with activity link
function saveBPForActivity(){
var s=parseInt(document.getElementById('sys').value);
var d=parseInt(document.getElementById('dia').value);
var h=parseInt(document.getElementById('hr').value);
if(isNaN(s)||isNaN(d)||isNaN(h)||s<40||s>250||d<30||d>150||h<30||h>200){
alert('Please enter valid numbers:\nSystolic: 40-250\nDiastolic: 30-150\nHeart Rate: 30-200');
return;
}
var reading={s:s,d:d,h:h,t:getTime(),f:0};
// Add activity link
if(currentActivityForBP){
if(currentActivityForBP.timing==='before'){
bpBeforeReading=reading;
hideModal();
// Reopen activity modal
setTimeout(function(){
logActivity();
// Restore form state with longer delay to ensure DOM is ready
setTimeout(function(){
// Set activity type
var activitySelect=document.getElementById('activitySelect');
if(activitySelect){
activitySelect.value=currentActivityForBP.type;
}
// Switch to timer mode explicitly
var timerBtn=document.getElementById('timerBtn');
if(timerBtn){
timerBtn.click(); // Use click to ensure full event handling
}
// Wait for mode switch to complete, then show BP status
setTimeout(function(){
var bpStatus=document.getElementById('bpBeforeStatus');
var bpBtn=document.getElementById('takeBPBeforeBtn');
if(bpStatus){
bpStatus.textContent='‚úì BP Before: '+s+'/'+d;
bpStatus.style.display='block';
}
if(bpBtn){
bpBtn.style.display='none';
}
currentActivityForBP=null;
},200);
},400);
},300);
}else{
// After activity - link to saved activity
reading.activityId=currentActivityForBP.activityId;
reading.activityTiming='after';
var activity=getActivityById(currentActivityForBP.activityId);
if(activity){
if(!activity.linkedBP)activity.linkedBP={before:null,after:null};
activity.linkedBP.after=reading.t;
}
B.push(reading);
saveDailyData();
completeAndCloseModal();
showBP();
renderBPChart();
checkBPWarnings(s,d,h);
currentActivityForBP=null;
alert('‚úì Blood pressure logged after activity: '+s+'/'+d+' mmHg');
}
}
}

// NEW: Cancel BP for activity
function cancelBPForActivity(){
hideModal();
if(currentActivityForBP&&currentActivityForBP.timing==='before'){
// Reopen activity modal
setTimeout(function(){
logActivity();
currentActivityForBP=null;
},300);
}else{
currentActivityForBP=null;
}
}

function cancelActivityLog(){
stopActivityTimer();
activityElapsedSeconds=0;
activityStartTime=null;
selectedExertion='';
completeAndCloseModal();
}

function saveActivity(){
var activity=document.getElementById('activitySelect').value;
var notes=document.getElementById('activityNotes').value.trim();
if(!activity){
alert('Please select an activity type');
return;
}
var workDesc='';
if(activity==='Manual Work'){
workDesc=document.getElementById('workDescription').value.trim();
if(!workDesc){
alert('Please describe the manual work');
return;
}
}
var duration=0;
var manualInput=document.getElementById('durationMinutes');
var timerDisplay=document.getElementById('timerDisplay');

// Check which mode is active based on display visibility
var isTimerMode=timerDisplay&&timerDisplay.style.display==='block';
var isManualMode=manualInput&&manualInput.parentElement&&manualInput.parentElement.style.display==='block';

console.log('Duration check - Timer mode:',isTimerMode,'Manual mode:',isManualMode,'Elapsed seconds:',activityElapsedSeconds);

if(isTimerMode){
// Timer mode - use elapsed seconds
duration=Math.floor(activityElapsedSeconds/60);
console.log('Timer mode duration:',duration,'minutes');
if(duration<=0){
alert('Please start the timer and let it run, then click STOP before saving.\n\nTimer shows: '+Math.floor(activityElapsedSeconds)+' seconds');
return;
}
}else if(isManualMode){
// Manual mode - get from input
duration=parseInt(manualInput.value);
if(!duration||duration<=0){
alert('Please enter a valid duration in minutes');
return;
}
}else{
// No mode clearly selected - try to detect from content
if(activityElapsedSeconds>0){
// Has timer data, use it
duration=Math.floor(activityElapsedSeconds/60);
if(duration<=0){
alert('Timer ran for less than 1 minute. Please run timer for at least 1 minute.');
return;
}
console.log('Fallback: Using timer duration:',duration,'minutes');
}else if(manualInput&&manualInput.value){
// Has manual input
duration=parseInt(manualInput.value);
if(!duration||duration<=0){
alert('Please enter a valid duration in minutes');
return;
}
console.log('Fallback: Using manual duration:',duration,'minutes');
}else{
alert('Please select a duration method:\n1. Click "Use Timer" and run the timer\n2. Click "Manual Entry" and enter minutes');
return;
}
}
if(!selectedExertion){
alert('Please select an exertion level');
return;
}
var activityName=activity;
if(activity==='Manual Work'){
activityName=activity+' ('+workDesc+')';
}
// Generate unique ID for activity
var activityId='act_'+Date.now()+'_'+Math.floor(Math.random()*1000);
A.push({
id:activityId,
activity:activityName,
duration:duration,
exertion:selectedExertion,
t:getTime(),
startTime:getTime(),
notes:notes,
linkedBP:{before:null,after:null}
});
// Save BP before reading if it exists
if(bpBeforeReading){
bpBeforeReading.activityId=activityId;
bpBeforeReading.activityTiming='before';
B.push(bpBeforeReading);
// Update activity's linked BP
A[A.length-1].linkedBP.before=bpBeforeReading.t;
bpBeforeReading=null;
}
saveDailyData();
stopActivityTimer();
activityElapsedSeconds=0;
activityStartTime=null;
selectedExertion='';
completeAndCloseModal();
showActivities();
renderActivityChart();
showBP();
alert('‚úì Activity logged: '+activityName+' ('+duration+' min, '+selectedExertion+' exertion)');
// Prompt for BP after
takeBPAfterActivity(activityId);
}

function showActivities(){
if(!settings.features||!settings.features.exercise)return;
var data=getFilteredData();
var activityData=data.activities||A;
var h='';
for(var i=activityData.length-1;i>=0;i--){
var r=activityData[i];
var exertionColor=r.exertion==='Light'?'#10b981':r.exertion==='Moderate'?'#f59e0b':'#ef4444';
h+='<div class="reading">';
if(dateFilterMode==='today'){
h+='<div style="position:absolute;top:8px;right:8px;display:flex;gap:8px">';
h+='<button onclick="editActivity('+i+')" style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:16px;font-weight:600;cursor:pointer">‚úèÔ∏è</button>';
h+='<button onclick="deleteActivity('+i+')" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:16px;font-weight:600;cursor:pointer">‚úï</button>';
h+='</div>';
}
if(dateFilterMode==='all'&&r._date){
h+='<div style="font-size:14px;color:#3b82f6;font-weight:600;margin-bottom:4px">üìÖ '+r._date+'</div>';
}else if(dateFilterMode==='today'){
var todayDate=getTodayKey();
h+='<div style="font-size:14px;color:#10b981;font-weight:600;margin-bottom:4px">üìÖ Today ('+todayDate+')</div>';
}
h+='<div style="font-size:14px;color:#6b7280;margin-bottom:12px">'+r.t+'</div>';
h+='<div class="flex" style="align-items:center">';
h+='<div style="flex:1"><div style="font-size:20px;font-weight:700;color:#14b8a6">'+r.activity+'</div></div>';
h+='<div style="text-align:right">';
h+='<div style="font-size:14px;color:#6b7280">Duration</div>';
h+='<div style="font-size:24px;font-weight:bold;color:#14b8a6">'+r.duration+' min</div>';
h+='</div>';
h+='</div>';
h+='<div style="margin-top:12px;padding:12px;background:#f0fdf4;border-left:4px solid '+exertionColor+';border-radius:6px">';
h+='<div style="font-size:16px;font-weight:600;color:'+exertionColor+'">'+r.exertion+' Exertion</div>';
h+='</div>';
if(r.notes){
h+='<div style="margin-top:12px;padding:12px;background:#f3f4f6;border-radius:6px;font-size:16px;color:#374151"><strong>Notes:</strong> '+r.notes+'</div>';
}
h+='</div>';
}
document.getElementById('activity').innerHTML=h||'<div style="padding:24px;text-align:center;color:#6b7280;background:#f3f4f6;border-radius:8px">No activities logged yet</div>';
// Show/hide the card based on data
if(A.length>0){
document.getElementById('activityCard').style.display='block';
}else{
document.getElementById('activityCard').style.display='none';
}
}

function deleteActivity(i){
if(confirm('Delete this activity entry?')){
A.splice(i,1);
saveDailyData();
showActivities();
renderActivityChart();
}
}

function editActivity(i){
var entry=A[i];
var html='<div class="modal-title">Edit Activity</div>';
html+='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Activity Type:</label>';
html+='<input type="text" id="editActivityType" class="modal-input" value="'+(entry.activity||'')+'" placeholder="e.g., Walking, Running" />';
html+='</div>';
html+='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Duration (minutes):</label>';
html+='<input type="number" id="editActivityDuration" class="modal-input" value="'+(entry.duration||'')+'" step="1" min="1" max="999" />';
html+='</div>';
html+='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Exertion Level:</label>';
html+='<select id="editActivityExertion" class="modal-input">';
var exertions=['Light','Moderate','Vigorous'];
for(var j=0;j<exertions.length;j++){
html+='<option value="'+exertions[j]+'"'+(exertions[j]===entry.exertion?' selected':'')+'>'+exertions[j]+'</option>';
}
html+='</select>';
html+='</div>';
html+='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Time:</label>';
html+='<input type="time" id="editActivityTime" class="modal-input" value="'+(entry.t||'')+'" />';
html+='</div>';
html+='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Notes (optional):</label>';
html+='<textarea id="editActivityNotes" class="modal-input" rows="3" placeholder="How did you feel?">'+(entry.notes||'')+'</textarea>';
html+='</div>';
html+='<div class="modal-actions">';
html+='<button class="modal-cancel" onclick="hideModal()">Cancel</button>';
html+='<button class="modal-ok" onclick="saveEditedActivity('+i+')">Save Changes</button>';
html+='</div>';
showModal(html);
}

function saveEditedActivity(i){
var activityType=document.getElementById('editActivityType').value.trim();
var duration=parseInt(document.getElementById('editActivityDuration').value);
var exertion=document.getElementById('editActivityExertion').value;
var time=document.getElementById('editActivityTime').value;
var notes=document.getElementById('editActivityNotes').value.trim();
if(!activityType){
alert('Please enter activity type');
return;
}
if(!duration||duration<1){
alert('Please enter a valid duration');
return;
}
if(!time){
alert('Please enter a valid time');
return;
}
A[i].activity=activityType;
A[i].duration=duration;
A[i].exertion=exertion;
A[i].t=time;
A[i].notes=notes;
saveDailyData();
showActivities();
renderActivityChart();
completeAndCloseModal();
alert('‚úì Activity entry updated');
}

function renderActivityChart(){
if(!settings.features||!settings.features.exercise)return;
var data=getFilteredData();
var activityData=data.activities||A;
if(activityData.length<2){
document.getElementById('activityChart').style.display='none';
document.getElementById('noChartDataActivity').style.display='block';
return;
}
document.getElementById('activityChart').style.display='block';
document.getElementById('noChartDataActivity').style.display='none';
var canvas=document.getElementById('activityChart');
var dpr=window.devicePixelRatio||1;
var logW=canvas.offsetWidth||canvas.parentElement.clientWidth||300;
var logH=400;
canvas.width=logW*dpr;canvas.height=logH*dpr;
canvas.style.width=logW+'px';canvas.style.height=logH+'px';
var ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
var w=logW;var h=logH;
var pad=60;
ctx.clearRect(0,0,w,h);
var sorted=activityData.slice().sort(function(a,b){
return new Date('2000-01-01 '+a.t)-new Date('2000-01-01 '+b.t);
});
var maxDuration=Math.max.apply(Math,sorted.map(function(a){return a.duration;}));
maxDuration=Math.ceil(maxDuration/10)*10;
ctx.strokeStyle='#e5e7eb';
ctx.lineWidth=2;
ctx.beginPath();
ctx.moveTo(pad,h-pad);
ctx.lineTo(w-pad,h-pad);
ctx.moveTo(pad,pad);
ctx.lineTo(pad,h-pad);
ctx.stroke();
var xStep=(w-2*pad)/(sorted.length);
for(var i=0;i<sorted.length;i++){
var x=pad+(i+0.5)*xStep;
var barHeight=(sorted[i].duration/maxDuration)*(h-2*pad);
var y=h-pad-barHeight;
var barColor=sorted[i].exertion==='Light'?'#10b981':sorted[i].exertion==='Moderate'?'#f59e0b':'#ef4444';
ctx.fillStyle=barColor;
ctx.fillRect(x-xStep*0.3,y,xStep*0.6,barHeight);
ctx.fillStyle='#374151';
ctx.font='bold 14px sans-serif';
ctx.textAlign='center';
ctx.fillText(sorted[i].duration,x,y-5);
}
ctx.fillStyle='#374151';
ctx.font='14px sans-serif';
ctx.textAlign='right';
ctx.fillText(maxDuration+' min',pad-5,pad+5);
ctx.fillText('0 min',pad-5,h-pad+5);
ctx.textAlign='center';
for(var i=0;i<sorted.length;i++){
var x=pad+(i+0.5)*xStep;
ctx.save();
ctx.translate(x,h-pad+15);
ctx.rotate(-Math.PI/4);
ctx.textAlign='right';
ctx.fillText(sorted[i].t,0,0);
ctx.restore();
}
}

function updateRecentFluid(){
var now=new Date();
var ninetyMinAgo=new Date(now.getTime()-90*60000);
var recentEntries=[];
for(var i=0;i<B.length;i++){
if(B[i].f>0){
var timeParts=B[i].t.split(':');
var entryTime=new Date();
entryTime.setHours(parseInt(timeParts[0]),parseInt(timeParts[1]),0,0);
if(entryTime>=ninetyMinAgo){
recentEntries.push({time:B[i].t,amount:B[i].f});
}
}
}
for(var i=0;i<fluidLog.length;i++){
var timeParts=fluidLog[i].time.split(':');
var entryTime=new Date();
entryTime.setHours(parseInt(timeParts[0]),parseInt(timeParts[1]),0,0);
if(entryTime>=ninetyMinAgo){
recentEntries.push({time:fluidLog[i].time,amount:fluidLog[i].amount});
}
}
if(recentEntries.length>0){
recentEntries.sort(function(a,b){return b.time.localeCompare(a.time);});
var total=0;
for(var i=0;i<recentEntries.length;i++){
total+=recentEntries[i].amount;
}
var html='üïê Last 90 min: <span style="color:#3b82f6;font-size:24px;font-weight:bold">'+total+' oz</span>';
if(recentEntries.length<=3){
html+='<div style="margin-top:8px">';
for(var i=0;i<recentEntries.length;i++){
html+='<div style="font-size:20px;color:#374151;padding:4px 0"><span style="font-weight:bold">'+recentEntries[i].time+'</span> ‚Äî '+recentEntries[i].amount+' oz</div>';
}
html+='</div>';
}
document.getElementById('recent-fluid').innerHTML=html;
}else{
document.getElementById('recent-fluid').innerHTML='üïê Last 90 min: <span style="color:#6b7280;font-size:24px;font-weight:bold">0 oz</span><br><span style="font-size:16px;color:#6b7280">No fluid in last 90 minutes</span>';
}
}

// === PLAN MY DAY ===

function planMyDay(){
var html='<div class="modal-title">Plan My Day</div>';
html+='<div style="font-size:15px;color:#4b5563;margin-bottom:16px;padding:12px;background:#f0f9ff;border-radius:8px;border-left:4px solid #3b82f6">';
html+='<strong>Your daily schedule at a glance.</strong> Events created in Settings are your permanent templates. Use this screen to customize <em>today\'s</em> plan ‚Äî adjust times, change fluid amounts, or add one-off events without changing your saved templates. Great for:';
html+='<div style="margin-top:8px;font-size:14px;color:#374151;line-height:1.6">';
html+='‚Ä¢ <strong>Fluid planning</strong> ‚Äî set hydration targets around meals &amp; meds<br>';
html+='‚Ä¢ <strong>Schedule changes</strong> ‚Äî shift event times for today only<br>';
html+='‚Ä¢ <strong>Reminders</strong> ‚Äî get alerts before meals, meds, or appointments</div>';
html+='</div>';

if(dailyPlan.length>0){
// Sort events chronologically by time
var sortedPlan=dailyPlan.slice().sort(function(a,b){
if(!a.time&&!b.time)return 0;
if(!a.time)return 1;
if(!b.time)return -1;
return a.time.localeCompare(b.time);
});

html+='<div style="max-height:300px;overflow-y:auto;margin-bottom:16px">';
for(var i=0;i<sortedPlan.length;i++){
var e=sortedPlan[i];
// Find original index for edit/delete
var originalIndex=dailyPlan.indexOf(e);
html+='<div style="background:#fff;border:2px solid #e5e7eb;padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">';
html+='<div style="flex:1"><div style="font-weight:bold;font-size:18px">'+e.name+'</div>';
html+='<div style="font-size:14px;color:#6b7280">'+e.amount+'oz'+(e.time?' at '+e.time:'')+'</div></div>';
html+='<div style="display:flex;gap:8px">';
html+='<button onclick="editEvent('+originalIndex+')" style="background:#3b82f6;color:#fff;border:none;padding:8px 12px;border-radius:6px;font-size:14px;cursor:pointer;font-weight:600">Edit</button>';
html+='<button onclick="deleteEvent('+originalIndex+')" style="background:#ef4444;color:#fff;border:none;padding:8px 12px;border-radius:6px;font-size:14px;cursor:pointer;font-weight:600">‚úï</button>';
html+='</div>';
html+='</div>';
}
html+='</div>';
var total=0;
for(var i=0;i<dailyPlan.length;i++)total+=dailyPlan[i].amount;
html+='<div style="padding:12px;background:#d1fae5;border-radius:8px;margin-bottom:16px;font-size:16px;font-weight:bold">Total Planned: '+total+' oz</div>';
}else{
html+='<div style="padding:20px;text-align:center;color:#6b7280;background:#f3f4f6;border-radius:8px;margin-bottom:16px">No events planned yet</div>';
}

html+='<button class="modal-btn selected" onclick="addEvent()">+ Add Event</button>';
html+='<div class="modal-actions"><button class="modal-cancel" onclick="hideModal()">Done</button></div>';
showModal(html);
}

function addEvent(){
var html='<div class="modal-title">Add Event</div>';
html+='<input type="text" id="eventName" class="modal-input" placeholder="Event name (e.g., Breakfast, Pre-meal Water)" />';
html+='<input type="number" id="eventAmount" class="modal-input" placeholder="Fluid amount in oz (0 if none)" />';
html+='<label style="display:block;font-size:14px;font-weight:600;color:#374151;margin:8px 0 4px 0">‚è∞ Event Time (optional)</label>';
html+='<input type="time" id="eventTime" class="modal-input" placeholder="Time (optional)" />';
html+='<div style="margin:16px 0;padding:12px;background:#f3f4f6;border-radius:8px">';
html+='<label style="display:flex;align-items:center;margin-bottom:8px;font-size:16px;cursor:pointer">';
html+='<input type="checkbox" id="eventNotify" checked style="width:20px;height:20px;margin-right:12px;cursor:pointer" />';
html+='<span>üì¨ Enable notification</span>';
html+='</label>';
html+='<label style="display:flex;align-items:center;font-size:16px;cursor:pointer">';
html+='<input type="checkbox" id="eventSound" checked style="width:20px;height:20px;margin-right:12px;cursor:pointer" />';
html+='<span>üîî Play audible sound</span>';
html+='</label>';

html+='<div style="margin-top:12px;font-size:15px;">';
html+='<label style="display:block;font-weight:600;margin-bottom:4px">Advance reminder (minutes):</label>';
html+='<input type="number" id="eventAdvance" class="modal-input" min="0" max="240" step="5" value="0" />';
html+='<div style="font-size:13px;color:#6b7280;margin-top:4px">Use 0 for no advance reminder.</div>';
html+='<label style="display:flex;align-items:center;margin-top:8px;cursor:pointer;font-size:15px">';
html+='<input type="checkbox" id="eventAtTime" checked style="width:18px;height:18px;margin-right:8px;cursor:pointer" />';
html+='<span>Remind at event time</span>';
html+='</label>';
html+='</div>'; // end inner box
html+='</div>'; // end gray panel

html+=renderEventActionCheckboxes(['logFluid']);
html+='<div class="modal-actions"><button class="modal-cancel" onclick="planMyDay()">Cancel</button><button class="modal-ok" onclick="saveEvent()">Add</button></div>';

showModal(html);
setTimeout(function(){document.getElementById('eventName').focus();},100);
}

function saveEvent(){
var name=document.getElementById('eventName').value.trim();
var amountVal=document.getElementById('eventAmount').value.trim();
var amount=(amountVal==='')?0:parseInt(amountVal);
var time=document.getElementById('eventTime').value;
var notify=document.getElementById('eventNotify').checked;
var sound=document.getElementById('eventSound').checked;
var advance=parseInt(document.getElementById('eventAdvance').value)||0;
var atTime=document.getElementById('eventAtTime').checked;

if(!name){
alert('Please enter an event name');
return;
}
if(isNaN(amount)||amount<0){
alert('Please enter a valid amount (0 or more oz)');
return;
}

dailyPlan.push({
  name:name,
  amount:amount,
  time:time,
  notify:notify,
  sound:sound,
  advanceMinutes:advance,
  remindAtTime:atTime,
  actions:collectSelectedActions()
});

savePlan();
updateNextEvent();
updateUpcomingEventsWidget();
planMyDay();
}


function deleteEvent(index){
if(confirm('Delete this event?')){
dailyPlan.splice(index,1);
savePlan();
updateNextEvent();
updateUpcomingEventsWidget();
planMyDay();
}
}

function editEvent(index){
if(index<0||index>=dailyPlan.length)return;
var event=dailyPlan[index];
var html='<div class="modal-title">Edit Event</div>';
html+='<input type="text" id="eventName" class="modal-input" placeholder="Event name (e.g., Breakfast, Pre-meal Water)" value="'+event.name+'" />';
html+='<input type="number" id="eventAmount" class="modal-input" placeholder="Fluid amount in oz (0 if none)" value="'+event.amount+'" />';
html+='<label style="display:block;font-size:14px;font-weight:600;color:#374151;margin:8px 0 4px 0">‚è∞ Event Time (optional)</label>';
html+='<input type="time" id="eventTime" class="modal-input" placeholder="Time (optional)" value="'+(event.time||'')+'" />';
html+='<div style="margin:16px 0;padding:12px;background:#f3f4f6;border-radius:8px">';
html+='<label style="display:flex;align-items:center;margin-bottom:8px;font-size:16px;cursor:pointer">';
html+='<input type="checkbox" id="eventNotify" '+(event.notify!==false?'checked':'')+' style="width:20px;height:20px;margin-right:12px;cursor:pointer" />';
html+='<span>üì¨ Enable notification</span>';
html+='</label>';
html+='<label style="display:flex;align-items:center;font-size:16px;cursor:pointer">';
html+='<input type="checkbox" id="eventSound" '+(event.sound!==false?'checked':'')+' style="width:20px;height:20px;margin-right:12px;cursor:pointer" />';
html+='<span>üîî Play audible sound</span>';
html+='</label>';

var adv = (event.advanceMinutes != null ? event.advanceMinutes : 0);
var atTime = (event.remindAtTime !== false);

html+='<div style="margin-top:12px;font-size:15px;">';
html+='<label style="display:block;font-weight:600;margin-bottom:4px">Advance reminder (minutes):</label>';
html+='<input type="number" id="eventAdvance" class="modal-input" min="0" max="240" step="5" value="'+adv+'" />';
html+='<div style="font-size:13px;color:#6b7280;margin-top:4px">Use 0 for no advance reminder.</div>';
html+='<label style="display:flex;align-items:center;margin-top:8px;cursor:pointer;font-size:15px">';
html+='<input type="checkbox" id="eventAtTime" '+(atTime?'checked':'')+' style="width:18px;height:18px;margin-right:8px;cursor:pointer" />';
html+='<span>Remind at event time</span>';
html+='</label>';
html+='</div>'; // end inner box
html+='</div>'; // end gray panel

var existingActions=event.actions||(event.amount>0?['logFluid']:[]);
html+=renderEventActionCheckboxes(existingActions);

html+='<input type="hidden" id="editEventIndex" value="'+index+'" />';
html+='<div class="modal-actions"><button class="modal-cancel" onclick="planMyDay()">Cancel</button><button class="modal-ok" onclick="updateEvent()">Save Changes</button></div>';

showModal(html);
setTimeout(function(){document.getElementById('eventName').focus();},100);
}

function updateEvent(){
var index=parseInt(document.getElementById('editEventIndex').value);
var name=document.getElementById('eventName').value.trim();
var amountVal=document.getElementById('eventAmount').value.trim();
var amount=(amountVal==='')?0:parseInt(amountVal);
var time=document.getElementById('eventTime').value;
var notify=document.getElementById('eventNotify').checked;
var sound=document.getElementById('eventSound').checked;
var advance=parseInt(document.getElementById('eventAdvance').value)||0;
var atTime=document.getElementById('eventAtTime').checked;

if(!name){
alert('Please enter an event name');
return;
}
if(isNaN(amount)||amount<0){
alert('Please enter a valid amount (0 or more oz)');
return;
}

dailyPlan[index]={
  name:name,
  amount:amount,
  time:time,
  notify:notify,
  sound:sound,
  advanceMinutes:advance,
  remindAtTime:atTime,
  actions:collectSelectedActions()
};

savePlan();
updateNextEvent();
updateUpcomingEventsWidget();
planMyDay();
}


function updateNextEvent(){
// Merge both event sources
var allEvents=[];
if(settings.dailyEvents&&settings.dailyEvents.length>0){
for(var i=0;i<settings.dailyEvents.length;i++){
var evt=settings.dailyEvents[i];
allEvents.push({name:evt.name,icon:evt.icon||'üìã',time:evt.time||'',fluidGoal:evt.fluidGoal||0,reminderEnabled:evt.reminderEnabled||false,amount:evt.fluidGoal||0});
}
}
if(dailyPlan&&dailyPlan.length>0){
for(var j=0;j<dailyPlan.length;j++){
var pe=dailyPlan[j];
allEvents.push({name:pe.name,icon:'üìã',time:pe.time||'',fluidGoal:pe.amount||0,reminderEnabled:pe.notify||pe.sound||false,amount:pe.amount||0});
}
}

if(allEvents.length===0){
document.getElementById('next-event').style.display='none';
return;
}

var now=new Date();
var currentHour=now.getHours();
var currentMin=now.getMinutes();
var currentTimeInMin=currentHour*60+currentMin;

var nextEvent=null;
var minTimeDiff=9999;

// Priority 1: Find the nearest current or future event (diff >= -5 minutes)
for(var k=0;k<allEvents.length;k++){
var event=allEvents[k];
if(!event.time)continue;
var parts=event.time.split(':');
var eventHour=parseInt(parts[0]);
var eventMin=parseInt(parts[1]);
var eventTimeInMin=eventHour*60+eventMin;
var diff=eventTimeInMin-currentTimeInMin;
// Current (within last 5 min) or future ‚Äî pick the nearest one
if(diff>=-5&&diff<minTimeDiff){
minTimeDiff=diff;
nextEvent=event;
}
}

// Priority 2: If nothing current/future, show the most recently passed event (up to 30 min ago)
if(!nextEvent){
var bestPastDiff=-9999;
for(var k2=0;k2<allEvents.length;k2++){
var event2=allEvents[k2];
if(!event2.time)continue;
var parts2=event2.time.split(':');
var eH=parseInt(parts2[0]);
var eM=parseInt(parts2[1]);
var eTM=eH*60+eM;
var diff2=eTM-currentTimeInMin;
// Recently passed: between -30 and -5 minutes ‚Äî pick the MOST RECENT (closest to 0)
if(diff2>=-30&&diff2<-5&&diff2>bestPastDiff){
bestPastDiff=diff2;
nextEvent=event2;
minTimeDiff=diff2;
}
}
}

if(nextEvent){
// Build countdown string
var timeStr='';
var bannerLabel='Next:';
if(minTimeDiff>=-5&&minTimeDiff<=0){
timeStr='<span style="color:#dc2626;font-size:28px;font-weight:700">NOW!</span>';
bannerLabel='Current:';
}else if(minTimeDiff<-5){
var minsAgo=Math.abs(Math.floor(minTimeDiff));
timeStr='<span style="color:#f59e0b;font-size:28px;font-weight:700">'+minsAgo+' min ago</span>';
bannerLabel='Recent:';
}else if(minTimeDiff<60){
timeStr='<span style="color:#059669;font-size:28px;font-weight:700">in '+Math.floor(minTimeDiff)+' min</span>';
}else{
var hrs=Math.floor(minTimeDiff/60);
var mins=minTimeDiff%60;
timeStr='<span style="color:#0284c7;font-size:28px;font-weight:700">in '+hrs+'h '+mins+'m</span>';
}
// Senior-friendly large fonts
var html='<div style="line-height:1.4">';
html+='<div style="font-size:26px;font-weight:600;color:#1e3a8a;margin-bottom:8px">';
html+='üíß '+bannerLabel+' <span style="font-size:30px">'+nextEvent.icon+' '+nextEvent.name+'</span></div>';
html+='<div style="font-size:24px;color:#1e40af">';
html+=nextEvent.time+' ‚Äî '+timeStr;
html+='</div>';
if(nextEvent.fluidGoal>0){
html+='<div style="font-size:22px;color:#0284c7;margin-top:8px">';
html+='Goal: <strong>'+nextEvent.fluidGoal+' oz</strong>';
if(nextEvent.reminderEnabled){
html+=' ‚Ä¢ <span style="color:#10b981">üîî Reminder On</span>';
}
html+='</div>';
}
html+='</div>';
document.getElementById('next-event').innerHTML=html;
document.getElementById('next-event').style.display='block';
}else{
// All events complete
document.getElementById('next-event').innerHTML='<div style="font-size:26px;color:#059669">‚úì All events complete for today!</div>';
document.getElementById('next-event').style.display='block';
}
}

function isEventCompleted(event){
// Check if fluid was logged within 30 minutes before or after the event time
if(!event.time)return false;
var parts=event.time.split(':');
var eventHour=parseInt(parts[0]);
var eventMin=parseInt(parts[1]);
var eventTimeInMin=eventHour*60+eventMin;

for(var i=0;i<fluidLog.length;i++){
var logParts=fluidLog[i].time.split(':');
var logHour=parseInt(logParts[0]);
var logMin=parseInt(logParts[1]);
var logTimeInMin=logHour*60+logMin;
var timeDiff=Math.abs(logTimeInMin-eventTimeInMin);
// If logged within 30 minutes of event time, consider it completed
if(timeDiff<=30&&fluidLog[i].amount>=event.amount*0.8){
return true;
}
}
return false;
}

function isEventDismissed(event){
// Check if this specific event (by time and name) has been dismissed today
for(var i=0;i<dismissedEvents.length;i++){
if(dismissedEvents[i].time===event.time&&dismissedEvents[i].name===event.name){
return true;
}
}
return false;
}

function dismissOverdueEvent(eventTime,eventName){
// Add to dismissed list
dismissedEvents.push({time:eventTime,name:eventName});
// Save to localStorage
try{
localStorage.setItem('dismissedEvents_'+getTodayKey(),JSON.stringify(dismissedEvents));
}catch(e){
console.error('Failed to save dismissed events');
}
// Refresh the widget
updateUpcomingEventsWidget();
}

function updateUpcomingEventsWidget(){
var widget=document.getElementById('upcoming-events-widget');
// Merge both event sources: settings.dailyEvents + dailyPlan
var allEvents=[];

// Add settings.dailyEvents (structured events from Settings)
if(settings.dailyEvents&&settings.dailyEvents.length>0){
for(var i=0;i<settings.dailyEvents.length;i++){
var evt=settings.dailyEvents[i];
allEvents.push({
name:evt.name,
icon:evt.icon||'üìã',
time:evt.time||'',
fluidGoal:evt.fluidGoal||0,
reminderEnabled:evt.reminderEnabled||false,
actions:evt.actions||[],
source:'settings'
});
}
}

// Add dailyPlan events (from Plan My Day)
if(dailyPlan&&dailyPlan.length>0){
for(var j=0;j<dailyPlan.length;j++){
var pe=dailyPlan[j];
allEvents.push({
name:pe.name,
icon:'üìã',
time:pe.time||'',
fluidGoal:pe.amount||0,
reminderEnabled:pe.notify||pe.sound||false,
actions:pe.actions||[],
source:'plan'
});
}
}

if(allEvents.length===0){
widget.style.display='none';
return;
}

var now=new Date();
var currentHour=now.getHours();
var currentMin=now.getMinutes();
var currentTimeInMin=currentHour*60+currentMin;

// Collect upcoming events
var upcoming=[];

for(var k=0;k<allEvents.length;k++){
var event=allEvents[k];
if(!event.time)continue;
var parts=event.time.split(':');
var eventHour=parseInt(parts[0]);
var eventMin=parseInt(parts[1]);
var eventTimeInMin=eventHour*60+eventMin;
var diff=eventTimeInMin-currentTimeInMin;

// Show events from 15 min past to 6 hours ahead
if(diff>=-15&&diff<=360){
upcoming.push({event:event,diff:diff});
}
}

// Sort by soonest first
upcoming.sort(function(a,b){return a.diff-b.diff;});

if(upcoming.length===0){
widget.style.display='none';
return;
}

// Build HTML with SENIOR-FRIENDLY large fonts
var html='<div style="padding:20px;background:#dbeafe;border:2px solid #3b82f6;border-radius:12px">';
html+='<div style="font-size:26px;font-weight:700;color:#1e40af;margin-bottom:16px">üìÖ Today\'s Upcoming Events</div>';

// Show up to 4 upcoming events
for(var i=0;i<Math.min(upcoming.length,4);i++){
var e=upcoming[i].event;
var minsDiff=upcoming[i].diff;
var timeStr='';
var timeColor='';

if(minsDiff<0){
timeStr='<span style="color:#dc2626;font-size:24px;font-weight:700">NOW!</span>';
timeColor='#dc2626';
}else if(minsDiff<60){
timeStr='<span style="color:#059669;font-size:24px;font-weight:700">in '+Math.floor(minsDiff)+' min</span>';
timeColor='#059669';
}else{
var hrs=Math.floor(minsDiff/60);
var mins=minsDiff%60;
timeStr='<span style="color:#0284c7;font-size:24px;font-weight:700">in '+hrs+'h '+mins+'m</span>';
timeColor='#0284c7';
}

html+='<div style="padding:16px;background:white;border-radius:10px;margin-bottom:12px;border:2px solid #bfdbfe">';
html+='<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">';
html+='<span style="font-size:48px">'+e.icon+'</span>';
html+='<div style="flex:1">';
html+='<div style="font-size:28px;font-weight:700;color:#1e3a8a">'+e.name+'</div>';
html+='<div style="font-size:22px;color:#3b82f6;font-weight:600">'+e.time+'</div>';
html+='</div>';
html+='</div>';
html+='<div style="font-size:20px;color:#1e40af;margin-top:8px">'+timeStr+'</div>';
if(e.fluidGoal>0){
html+='<div style="font-size:20px;color:#0284c7;margin-top:8px">';
html+='üíß Fluid Goal: <strong>'+e.fluidGoal+' oz</strong>';
html+='</div>';
}
if(e.reminderEnabled){
html+='<div style="font-size:18px;color:#10b981;margin-top:6px">üîî Reminder Enabled</div>';
}else{
html+='<div style="font-size:18px;color:#9ca3af;margin-top:6px">üîï No Reminder</div>';
}
html+='</div>';
}

html+='</div>';
widget.innerHTML=html;
widget.style.display='block';
}

function savePlan(){
try{
localStorage.setItem('dailyPlan',JSON.stringify(dailyPlan));
}catch(e){
console.error('Failed to save plan');
}
}

function loadPlan(){
try{
var saved=localStorage.getItem('dailyPlan');
if(saved){
dailyPlan=JSON.parse(saved);
updateNextEvent();
updateUpcomingEventsWidget();
}
}catch(e){
console.error('Failed to load plan');
}
}

// === AUDIO ALERT SYSTEM ===

function initializeAudioContext(){
if(!audioContext){
var AudioCtx=window.AudioContext||window.webkitAudioContext;
if(AudioCtx){
audioContext=new AudioCtx();
console.log('Audio context initialized, state:',audioContext.state);
}else{
console.warn('Web Audio API not supported');
}
}
}

// iOS Safari suspends AudioContext until a user gesture ‚Äî unlock it on first touch/click
function unlockAudioContext(){
if(!audioContext){initializeAudioContext();}
if(audioContext&&audioContext.state==='suspended'){
audioContext.resume().then(function(){
console.log('AudioContext resumed by user gesture');
});
}
}
document.addEventListener('touchstart',unlockAudioContext,{once:false,passive:true});
document.addEventListener('click',unlockAudioContext,{once:false,passive:true});

function playMedicalAlertChime(){
initializeAudioContext();
if(!audioContext)return;
// iOS: always resume before scheduling notes ‚Äî no-op on other platforms
if(audioContext.state==='suspended'){
audioContext.resume();
}

// Senior-optimized audio (v9.5.5-SA):
// ‚Ä¢ C4/E4/G4 at 261‚Äì392 Hz ‚Äî one octave lower than before.
//   Age-related hearing loss (presbycusis) hits high frequencies first;
//   the 250‚Äì500 Hz range is the most reliable for aging ears.
// ‚Ä¢ Triangle oscillator ‚Äî richer harmonic content than sine, cuts through
//   background noise (TV, music) without being harsh.
// ‚Ä¢ Gain raised from 0.4 ‚Üí 0.75 ‚Äî noticeably louder.
// ‚Ä¢ Sequence plays 3 times with a 400ms pause between repeats so a
//   distracted user has multiple chances to notice it.

function playTone(frequency,duration,startTime){
  var osc=audioContext.createOscillator();
  var gain=audioContext.createGain();
  osc.type='triangle';
  osc.frequency.setValueAtTime(frequency,startTime);
  // Envelope: fast attack, hold, smooth release
  gain.gain.setValueAtTime(0,startTime);
  gain.gain.linearRampToValueAtTime(0.75,startTime+0.06);
  gain.gain.setValueAtTime(0.75,startTime+duration-0.08);
  gain.gain.linearRampToValueAtTime(0,startTime+duration);
  osc.connect(gain);
  gain.connect(audioContext.destination);
  osc.start(startTime);
  osc.stop(startTime+duration);
}

// C4 ‚Üí E4 ‚Üí G4 (major triad, lower octave, longer notes)
var notes=[
  {freq:261.63,dur:0.40},  // C4
  {freq:329.63,dur:0.40},  // E4
  {freq:392.00,dur:0.55}   // G4 ‚Äî held longer for emphasis
];

// Play 3 times so a distracted user has multiple chances to notice
var sequenceDuration=notes.reduce(function(t,n){return t+n.dur+0.06;},0); // ~1.47s
var pauseBetween=0.40; // 400ms silence between repeats

for(var rep=0;rep<3;rep++){
  var now=audioContext.currentTime+(rep*(sequenceDuration+pauseBetween));
  notes.forEach(function(note){
    playTone(note.freq,note.dur,now);
    now+=note.dur+0.06;
  });
}

console.log('Senior-optimized alert chime played (3√ó)');
}

function triggerAudioAlert(eventName,eventAmount,eventObj){
// Show visual alert
document.getElementById('audioAlertEventName').textContent=eventName+(eventAmount>0?' ('+eventAmount+' oz)':'');

// Build action buttons ‚Äî use saved actions, or legacy default of logBP + logFluid
var actionsEl=document.getElementById('audioAlertActions');
actionsEl.innerHTML='';
var actions=(eventObj&&eventObj.actions&&eventObj.actions.length)?eventObj.actions:['logBP','logFluid'];
actions.forEach(function(id){
  var def=EVENT_ACTIONS.find(function(a){return a.id===id;});
  if(!def)return;
  var btn=document.createElement('button');
  btn.textContent=def.label;
  btn.style.cssText='background:'+def.color+';color:#fff;border:none;padding:14px;border-radius:12px;font-size:18px;font-weight:600;cursor:pointer;width:100%';
  // No stopAudioAlert() ‚Äî box stays visible so user can tap multiple buttons
  btn.onclick=function(){eval(def.fn);};
  actionsEl.appendChild(btn);
});

document.getElementById('audioAlertBox').style.display='block';

// Arm the fluid goal so the first fluid-capable modal that opens gets pre-populated
pendingEventFluid=(eventObj&&eventObj.amount>0)?eventObj.amount:(eventAmount>0?eventAmount:0);

// Fire OS-level notification ‚Äî visible even on other tabs or during video playback
fireOSNotification(
  'üîî '+eventName,
  (eventAmount>0?'üíß '+eventAmount+' oz  ‚Ä¢  ':'')+'Tap to open ClinBridge',
  'clinbridge-audio-'+(eventName||'event').replace(/\s+/g,'_')
);

// Haptic feedback ‚Äî iOS Taptic Engine (works even when audio is blocked)
if(navigator.vibrate){navigator.vibrate([200,100,200,100,400]);}

// Play audio
playMedicalAlertChime();

// No auto-dismiss ‚Äî notification stays until user taps "Done ‚Äî Dismiss"
}

function stopAudioAlert(){
// Hide visual alert
document.getElementById('audioAlertBox').style.display='none';
pendingEventFluid=0; // cancelled ‚Äî don't carry fluid goal into manual opens
}

function addMissedAlert(eventName){
missedAlerts.push({name:eventName,time:getTime()});
updateMissedAlertBadge();
}

function updateMissedAlertBadge(){
if(missedAlerts.length>0){
var text='üîî '+missedAlerts.length+' alert'+(missedAlerts.length>1?'s':'')+' sounded';
document.getElementById('missedAlertText').textContent=text;
document.getElementById('missedAlertBadge').style.display='block';
}else{
document.getElementById('missedAlertBadge').style.display='none';
}
}

function dismissMissedAlert(){
var alertText='Alerts that sounded:\n\n';
for(var i=0;i<missedAlerts.length;i++){
alertText+=missedAlerts[i].time+' - '+missedAlerts[i].name+'\n';
}
alert(alertText);
missedAlerts=[];
updateMissedAlertBadge();
}

function checkScheduledAlerts(){
if(dailyPlan.length===0)return;

var now=new Date();
var currentTime=getTime();
var today=now.toDateString();

// Reset fired events at midnight
if(!firedEvents.date||firedEvents.date!==today){
firedEvents={date:today};
console.log('Reset fired events for new day:',today);
}

for(var i=0;i<dailyPlan.length;i++){
  var event=dailyPlan[i];
  if(!event.time||event.sound===false)continue;

  // Normalize settings
  var advance = event.advanceMinutes||0;
  var remindAtTime = (event.remindAtTime!==false); // default true

  // Build keys so advance and at-time can each fire once
  var baseKey = event.time+'_'+event.name;
  var advanceKey = baseKey+'_adv';
  var atTimeKey  = baseKey+'_at';

  // Compute time string for advance reminder, if any
  var advanceTime = null;
  if(advance>0){
    var parts = event.time.split(':'); // "HH:MM"
    if(parts.length===2){
      var h = parseInt(parts[0],10);
      var m = parseInt(parts[1],10);
      if(!isNaN(h)&&!isNaN(m)){
        var advDate = new Date(now.getFullYear(),now.getMonth(),now.getDate(),h,m,0,0);
        advDate.setMinutes(advDate.getMinutes()-advance);
        var ah = advDate.getHours().toString().padStart(2,'0');
        var am = advDate.getMinutes().toString().padStart(2,'0');
        advanceTime = ah+':'+am;
      }
    }
  }

  // Advance reminder
  if(advanceTime && currentTime===advanceTime && !firedEvents[advanceKey]){
    console.log('Advance reminder:',event.name,'at',currentTime,'(advance',advance,'min)');
    triggerAudioAlert(event.name,event.amount,event);
    firedEvents[advanceKey]=true;
    continue; // avoid double-firing in same minute
  }

  // At-time reminder
  if(remindAtTime && currentTime===event.time && !firedEvents[atTimeKey]){
    console.log('Event triggered:',event.name,'at',event.time);
    triggerAudioAlert(event.name,event.amount,event);
    firedEvents[atTimeKey]=true;
  }
}
}


function u(){
document.getElementById('t').innerHTML=new Date().toLocaleString();
updateFluid();
updateNextEvent();
updateUpcomingEventsWidget();
checkScheduledAlerts();
}
setInterval(u,1000);u();updateFluid();

function showMeals(){
var data=getFilteredData();
var mealsData=data.meals;
var h='';
for(var i=0;i<mealsData.length;i++){
h+='<div style="padding:16px;border:2px solid #e5e7eb;border-radius:8px;margin-bottom:12px;position:relative;font-size:18px">';
// Only show edit/delete buttons for today's data
if(dateFilterMode==='today'){
h+='<div style="position:absolute;top:8px;right:8px;display:flex;gap:8px">';
h+='<button onclick="editMeal('+i+')" style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:16px;font-weight:600;cursor:pointer">‚úèÔ∏è</button>';
h+='<button onclick="deleteMeal('+i+')" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:16px;font-weight:600;cursor:pointer">‚úï</button>';
h+='</div>';
}
// Show date - always show for context
if(dateFilterMode==='all'&&mealsData[i]._date){
h+='<div style="font-size:14px;color:#3b82f6;font-weight:600;margin-bottom:4px">üìÖ '+mealsData[i]._date+'</div>';
}else if(dateFilterMode==='today'){
var todayDate=getTodayKey();
h+='<div style="font-size:14px;color:#10b981;font-weight:600;margin-bottom:4px">üìÖ Today ('+todayDate+')</div>';
}
h+='<div style="font-size:14px;color:#6b7280;margin-bottom:8px">'+mealsData[i].t+'</div>';
// Phase 6B: Display event tag if present
if(mealsData[i].eventId){
var evt=getEventById(mealsData[i].eventId);
if(evt){
h+='<div style="display:inline-block;padding:4px 10px;background:#f0fdf4;border:1px solid #86efac;border-radius:6px;font-size:13px;font-weight:600;color:#166534;margin-bottom:8px">'+evt.icon+' '+evt.name+'</div><br>';
}
}
h+='<div style="font-weight:bold;font-size:20px">'+mealsData[i].m+'</div>';
h+='</div>';
}
document.getElementById('meals').innerHTML=h||'<p style="color:#6b7280;text-align:center;font-size:18px">None</p>';
// Show/hide the card based on data
if(M.length>0){
document.getElementById('mealsCard').style.display='block';
}else{
document.getElementById('mealsCard').style.display='none';
}
}

function deleteMeal(i){
if(confirm('Delete this meal?')){
M.splice(i,1);
showMeals();
saveDailyData();
alert('‚úì Meal deleted');
}
}

function editMeal(i){
var entry=M[i];
var html='<div class="modal-title">Edit Meal</div>';
html+='<label style="display:block;font-size:18px;font-weight:600;margin-bottom:8px">Meal Description:</label>';
html+='<textarea id="editMealDesc" class="modal-input" rows="3" placeholder="What did you eat?">'+(entry.m||'')+'</textarea>';
html+='<label style="display:block;font-size:18px;font-weight:600;margin:16px 0 8px 0">Time:</label>';
html+='<input type="time" id="editMealTime" class="modal-input" value="'+entry.t+'" />';
// Phase 6B: Event tag editable on edit
html+=getEventDropdownHTML(entry.eventId||'');
html+='<div class="modal-actions"><button class="modal-cancel" onclick="hideModal()">Cancel</button><button class="modal-ok" onclick="saveEditedMeal('+i+')">Save Changes</button></div>';
showModal(html);
}

function saveEditedMeal(i){
var desc=document.getElementById('editMealDesc').value.trim();
var time=document.getElementById('editMealTime').value;
if(!desc){
alert('Please enter a meal description');
return;
}
if(!time){
alert('Please enter a valid time');
return;
}
// Phase 6B: Persist event tag change from edit
var eventId=document.getElementById('eventSelect')?document.getElementById('eventSelect').value:'';
M[i].m=desc;
M[i].t=time;
if(eventId){ M[i].eventId=eventId; } else { delete M[i].eventId; }
saveDailyData();
showMeals();
completeAndCloseModal();
alert('‚úì Meal entry updated');
}

function showMedicines(){
var data=getFilteredData();
var medicinesData=data.medicines;
var h='';
if(medicinesData.length===0){
h='<p style="color:#6b7280;text-align:center;font-size:18px">None logged today</p>';
}else{
for(var i=medicinesData.length-1;i>=0;i--){
var entry=medicinesData[i];
h+='<div style="padding:16px;border:2px solid #e5e7eb;border-radius:8px;margin-bottom:12px;position:relative;font-size:18px">';
// Only show edit/delete buttons for today's data
if(dateFilterMode==='today'){
h+='<div style="position:absolute;top:8px;right:8px;display:flex;gap:8px">';
h+='<button onclick="editMedLog('+i+')" style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:16px;font-weight:600;cursor:pointer">‚úèÔ∏è</button>';
h+='<button onclick="deleteMedLog('+i+')" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:16px;font-weight:600;cursor:pointer">‚úï</button>';
h+='</div>';
}
// Show date - always show for context
if(dateFilterMode==='all'&&entry._date){
h+='<div style="font-size:14px;color:#3b82f6;font-weight:600;margin-bottom:4px">üìÖ '+entry._date+'</div>';
}else if(dateFilterMode==='today'){
var todayDate=getTodayKey();
h+='<div style="font-size:14px;color:#10b981;font-weight:600;margin-bottom:4px">üìÖ Today ('+todayDate+')</div>';
}
h+='<div style="font-size:14px;color:#6b7280;margin-bottom:8px">'+entry.time+'</div>';
// Phase 6B: Display event tag if present
if(entry.eventId){
var evt=getEventById(entry.eventId);
if(evt){
h+='<div style="display:inline-block;padding:4px 10px;background:#f0fdf4;border:1px solid #86efac;border-radius:6px;font-size:13px;font-weight:600;color:#166534;margin-bottom:8px">'+evt.icon+' '+evt.name+'</div><br>';
}
}
h+='<div style="font-weight:bold;font-size:20px;color:#f97316">'+entry.medicine+'</div>';
h+='<div style="font-size:16px;color:#6b7280;margin-top:4px">'+entry.timing+'</div>';
// Show fluid intake if present
if(entry.fluid){
h+='<div style="margin-top:8px;padding:8px;background:#dbeafe;border-left:3px solid #3b82f6;border-radius:4px;font-size:15px;color:#1e40af">';
h+='üíß Fluid: '+entry.fluid+' oz';
h+='</div>';
}
h+='</div>';
}
}
document.getElementById('medicines').innerHTML=h;
// Show/hide the card based on data
if(medLog.length>0){
document.getElementById('medicinesCard').style.display='block';
}else{
document.getElementById('medicinesCard').style.display='none';
}
}

function showNotes(){
var data=getFilteredData();
var notesData=data.notes;
var h='';
if(notesData.length===0){
h='<p style="color:#6b7280;text-align:center;font-size:18px">No notes for today</p>';
}else{
for(var i=notesData.length-1;i>=0;i--){
var note=notesData[i];
h+='<div style="padding:16px;border:2px solid #e5e7eb;border-radius:8px;margin-bottom:12px;position:relative;font-size:18px">';
// Only show edit/delete buttons for today's data
if(dateFilterMode==='today'){
h+='<div style="position:absolute;top:8px;right:8px;display:flex;gap:8px">';
h+='<button onclick="editNote('+i+')" style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:16px;font-weight:600;cursor:pointer">Edit</button>';
h+='<button onclick="deleteNote('+i+')" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:16px;font-weight:600;cursor:pointer">‚úï</button>';
h+='</div>';
}
// Show date - always show for context
if(dateFilterMode==='all'&&note._date){
h+='<div style="font-size:14px;color:#3b82f6;font-weight:600;margin-bottom:4px">üìÖ '+note._date+'</div>';
}else if(dateFilterMode==='today'){
var todayDate=getTodayKey();
h+='<div style="font-size:14px;color:#10b981;font-weight:600;margin-bottom:4px">üìÖ Today ('+todayDate+')</div>';
}
h+='<div style="font-size:14px;color:#6b7280;margin-bottom:8px">'+note.time+'</div>';
// Phase 6B: Display event tag if present
if(note.eventId){
var evt=getEventById(note.eventId);
if(evt){
h+='<div style="display:inline-block;padding:4px 10px;background:#f0fdf4;border:1px solid #86efac;border-radius:6px;font-size:13px;font-weight:600;color:#166534;margin-bottom:8px">'+evt.icon+' '+evt.name+'</div><br>';
}
}
h+='<div style="font-size:18px;white-space:pre-wrap;padding-right:'+(dateFilterMode==='today'?'120px':'0')+'">'+note.text+'</div>';
h+='</div>';
}
}
document.getElementById('notes').innerHTML=h;
// Show/hide the card based on data
if(notes.length>0){
document.getElementById('notesCard').style.display='block';
}else{
document.getElementById('notesCard').style.display='none';
}
}

function addNote(){
var html='<div class="modal-title">Add Note</div>';
html+='<textarea id="noteText" class="modal-input" placeholder="Enter your note..." style="min-height:200px;font-size:20px"></textarea>';
// Phase 6B: Add event dropdown
html+=getEventDropdownHTML();
html+='<div class="modal-actions"><button class="modal-cancel" onclick="hideModal()">Cancel</button><button class="modal-ok" onclick="saveNote()">Save</button></div>';
showModal(html);
setTimeout(function(){document.getElementById('noteText').focus();},100);
}

function saveNote(){
var text=document.getElementById('noteText').value.trim();
// Phase 6B: Get selected event
var eventId=document.getElementById('eventSelect')?document.getElementById('eventSelect').value:'';
if(!text){
alert('Please enter a note');
return;
}
var note={text:text,time:getTime()};
if(eventId)note.eventId=eventId;
notes.push(note);
saveDailyData();
completeAndCloseModal();
showNotes();
alert('‚úì Note added');
}

function editNote(index){
if(index<0||index>=notes.length)return;
var note=notes[index];
var html='<div class="modal-title">Edit Note</div>';
html+='<textarea id="noteText" class="modal-input" style="min-height:200px;font-size:20px">'+note.text+'</textarea>';
// Phase 6B: Add event dropdown with current selection
html+=getEventDropdownHTML(note.eventId);
html+='<input type="hidden" id="noteIndex" value="'+index+'" />';
html+='<div class="modal-actions"><button class="modal-cancel" onclick="showNotes();hideModal()">Cancel</button><button class="modal-ok" onclick="updateNote()">Save</button></div>';
showModal(html);
setTimeout(function(){document.getElementById('noteText').focus();},100);
}

function updateNote(){
var index=parseInt(document.getElementById('noteIndex').value);
var text=document.getElementById('noteText').value.trim();
// Phase 6B: Get selected event
var eventId=document.getElementById('eventSelect')?document.getElementById('eventSelect').value:'';
if(!text){
alert('Please enter a note');
return;
}
notes[index].text=text;
// Update or remove eventId
if(eventId){
notes[index].eventId=eventId;
}else{
delete notes[index].eventId;
}
saveDailyData();
completeAndCloseModal();
showNotes();
alert('‚úì Note updated');
}

function deleteNote(index){
if(confirm('Delete this note?')){
notes.splice(index,1);
saveDailyData();
showNotes();
alert('‚úì Note deleted');
}
}

function logMedicine(){
var presetFluid=pendingEventFluid; pendingEventFluid=0; // consume ‚Äî prevents double-log
var hasFluidAction=activeReminderEvt&&activeReminderEvt.actions&&activeReminderEvt.actions.indexOf('logFluid')!==-1;
var html='<div class="modal-title">Log Medicine</div>';
if(medicineList.length===0){
html+='<div style="padding:20px;background:#fef3c7;border-radius:8px;margin-bottom:16px;text-align:center">';
html+='<div style="font-size:18px;color:#92400e;margin-bottom:12px">No medicines in your list</div>';
html+='<button onclick="hideModal();manageMedicines();" style="background:#fbbf24;color:#fff;padding:12px 24px;border:none;border-radius:8px;font-size:18px;font-weight:600;cursor:pointer">Add Medicines</button>';
html+='</div>';
html+='<div class="modal-actions"><button class="modal-cancel" onclick="hideModal()">Close</button></div>';
showModal(html);
return;
}
html+='<div style="margin-bottom:8px;font-size:16px;color:#6b7280">Select medications (you can select multiple):</div>';
html+='<div id="selectedCount" style="margin-bottom:16px;padding:8px;background:#e0f2fe;border-radius:8px;font-size:16px;font-weight:600;color:#0369a1;text-align:center">0 selected</div>';
html+='<div style="max-height:300px;overflow-y:auto;margin-bottom:16px;border:2px solid #e5e7eb;border-radius:8px;padding:8px">';
for(var i=0;i<medicineList.length;i++){
var med=medicineList[i];
var medName=typeof med==='string'?med:med.name;
var medFreq=typeof med==='object'&&med.frequency?med.frequency:'';
var medMonthInterval=typeof med==='object'&&med.monthInterval?med.monthInterval:null;
var scheduleNote='';
if(medFreq==='once')scheduleNote=' (Daily)';
else if(medFreq==='twice')scheduleNote=' (2x daily)';
else if(medFreq==='three_times')scheduleNote=' (3x daily)';
else if(medFreq==='four_times')scheduleNote=' (4x daily)';
else if(medFreq==='as_needed')scheduleNote=' (PRN)';
else if(medFreq==='weekly')scheduleNote=' (Weekly)';
else if(medFreq==='monthly')scheduleNote=' (Monthly)';
else if(medFreq==='custom_months')scheduleNote=' (Every '+(medMonthInterval||'X')+' months)';
html+='<label style="display:flex;align-items:center;padding:12px;margin:4px 0;background:#f9fafb;border-radius:8px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background=\'#f3f4f6\'" onmouseout="this.style.background=\'#f9fafb\'">';
html+='<input type="checkbox" class="medCheckbox" value="'+medName+'" onchange="updateSelectedCount()" style="width:20px;height:20px;margin-right:12px;cursor:pointer">';
html+='<span style="font-size:18px;font-weight:500">'+medName+'<span style="font-size:14px;color:#6b7280">'+scheduleNote+'</span></span>';
html+='</label>';
}
html+='</div>';
html+='<div style="margin-bottom:16px;font-size:18px;font-weight:600">When did you take them?</div>';
html+='<button class="modal-btn" onclick="selectTiming(\'Before Food\')">Before Food</button>';
html+='<button class="modal-btn" onclick="selectTiming(\'After Food\')">After Food</button>';
html+='<button class="modal-btn" onclick="selectTiming(\'With Food\')">With Food</button>';
html+='<button class="modal-btn" onclick="selectTiming(\'Anytime\')">Anytime</button>';
html+='<input type="hidden" id="medTiming" value="" />';
// Add fluid intake field
if(!hasFluidAction){
html+='<label style="display:block;font-size:18px;font-weight:600;margin:16px 0 8px 0">Fluid with medication (oz, optional):</label>';
html+='<input type="number" id="medFluid" class="modal-input" placeholder="e.g., 8" min="0" step="0.5"'+(presetFluid>0?' value="'+presetFluid+'"':'')+' />';
if(presetFluid>0){
html+='<div style="font-size:14px;color:#2563eb;margin:-4px 0 8px 4px;font-weight:600">üìã Pre-filled from event goal ('+presetFluid+' oz) ‚Äî adjust if needed</div>';
}
if(eventFluidLogged&&activeReminderEvt){
html+='<div style="font-size:13px;color:#92400e;background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:8px;margin:-4px 0 8px 0">‚ö†Ô∏è Fluid already logged this event session. Only enter an amount here if this is <strong>additional</strong> fluid.</div>';
}
}else{
html+='<input type="hidden" id="medFluid" value="0">';
html+='<div style="font-size:13px;color:#6b7280;margin:16px 0 8px 4px">üíß Fluid will be logged via the Log Fluid action ‚Äî no need to enter it here</div>';
}
// Phase 6B: Add event dropdown
html+=getEventDropdownHTML();
html+='<div class="modal-actions"><button class="modal-cancel" onclick="hideModal()">Cancel</button><button class="modal-ok" onclick="saveMedicine()">Save</button></div>';
showModal(html);
}

function selectTiming(timing){
document.getElementById('medTiming').value=timing;
var btns=document.querySelectorAll('.modal-btn');
for(var i=0;i<btns.length;i++){
btns[i].classList.remove('selected');
}
event.target.classList.add('selected');
}

function updateSelectedCount(){
var checkboxes=document.querySelectorAll('.medCheckbox:checked');
var count=checkboxes.length;
var countDiv=document.getElementById('selectedCount');
if(count===0){
countDiv.textContent='0 selected';
countDiv.style.background='#e0f2fe';
countDiv.style.color='#0369a1';
}else if(count===1){
countDiv.textContent='1 medication selected';
countDiv.style.background='#dbeafe';
countDiv.style.color='#1e40af';
}else{
countDiv.textContent=count+' medications selected';
countDiv.style.background='#bfdbfe';
countDiv.style.color='#1e3a8a';
}
}

function saveMedicine(){
var checkboxes=document.querySelectorAll('.medCheckbox:checked');
var selectedMeds=[];
for(var i=0;i<checkboxes.length;i++){
selectedMeds.push(checkboxes[i].value);
}
var timing=document.getElementById('medTiming').value;
// Get fluid intake
var fluid=document.getElementById('medFluid')?document.getElementById('medFluid').value:'';
// Phase 6B: Get selected event
var eventId=document.getElementById('eventSelect')?document.getElementById('eventSelect').value:'';
if(selectedMeds.length===0){
alert('Please select at least one medicine');
return;
}
if(!timing){
alert('Please select timing');
return;
}
var currentTime=getTime();
for(var i=0;i<selectedMeds.length;i++){
var entry={medicine:selectedMeds[i],timing:timing,time:currentTime};
if(eventId)entry.eventId=eventId;
if(fluid){entry.fluid=fluid; if(i===0&&activeReminderEvt)eventFluidLogged=true;}
medLog.push(entry);
}
saveDailyData();
completeAndCloseModal();
showMedicines();
if(selectedMeds.length===1){
alert('‚úì Medicine logged');
}else{
alert('‚úì '+selectedMeds.length+' medicines logged');
}
}

function deleteMedLog(index){
if(confirm('Delete this medicine log?')){
medLog.splice(index,1);
saveDailyData();
showMedicines();
alert('‚úì Medicine log deleted');
}
}

function editMedLog(index){
var entry=medLog[index];
var html='<div class="modal-title">Edit Medicine Entry</div>';
html+='<label style="display:block;font-size:18px;font-weight:600;margin-bottom:8px">Medicine Name:</label>';
html+='<input type="text" id="editMedName" class="modal-input" value="'+(entry.medicine||'')+'" placeholder="Medicine name" />';
html+='<label style="display:block;font-size:18px;font-weight:600;margin:16px 0 8px 0">Time:</label>';
html+='<input type="time" id="editMedTime" class="modal-input" value="'+(entry.time||'')+'" />';
html+='<label style="display:block;font-size:18px;font-weight:600;margin:16px 0 8px 0">Timing:</label>';
html+='<select id="editMedTiming" class="modal-input">';
var timings=['Before Food','After Food','With Food','Empty Stomach','Anytime'];
for(var i=0;i<timings.length;i++){
html+='<option value="'+timings[i]+'"'+(timings[i]===entry.timing?' selected':'')+'>'+timings[i]+'</option>';
}
html+='</select>';
html+='<label style="display:block;font-size:18px;font-weight:600;margin:16px 0 8px 0">Fluid with medication (oz, optional):</label>';
html+='<input type="number" id="editMedFluid" class="modal-input" value="'+(entry.fluid||'')+'" placeholder="e.g., 8" min="0" step="0.5" />';
html+='<div class="modal-actions"><button class="modal-cancel" onclick="hideModal()">Cancel</button><button class="modal-ok" onclick="saveEditedMedLog('+index+')">Save Changes</button></div>';
showModal(html);
}

function saveEditedMedLog(index){
var name=document.getElementById('editMedName').value.trim();
var time=document.getElementById('editMedTime').value;
var timing=document.getElementById('editMedTiming').value;
var fluid=document.getElementById('editMedFluid')?document.getElementById('editMedFluid').value:'';
if(!name){
alert('Please enter medicine name');
return;
}
if(!time){
alert('Please enter a valid time');
return;
}
medLog[index].medicine=name;
medLog[index].time=time;
medLog[index].timing=timing;
if(fluid){
medLog[index].fluid=fluid;
}else{
delete medLog[index].fluid;
}
saveDailyData();
showMedicines();
completeAndCloseModal();
alert('‚úì Medicine entry updated');
}

function manageMedicines(){
var html='<div class="modal-title">Manage Medicines</div>';
html+='<div style="margin-bottom:16px">';
html+='<button class="modal-btn selected" onclick="addNewMedicine()">+ Add New Medicine</button>';
if(medicineList.length>0){
html+='<button class="modal-btn" onclick="copyAllMedicines()">üìã Copy All Medicines</button>';
html+='<button class="modal-btn" onclick="showPasteMedicines()">üì• Paste Medicine List</button>';
}else{
html+='<button class="modal-btn" onclick="showPasteMedicines()">üì• Paste Medicine List</button>';
}
html+='</div>';
if(medicineList.length>0){
html+='<div style="max-height:400px;overflow-y:auto;margin-bottom:16px">';
for(var i=0;i<medicineList.length;i++){
var med=medicineList[i];
// Handle old format (strings) and new format (objects)
var medName=typeof med==='string'?med:med.name;
var medFreq=typeof med==='object'&&med.frequency?med.frequency:'Not set';
var medTimes=typeof med==='object'&&med.times?med.times.join(', '):'Not set';
var medMonthInterval=typeof med==='object'&&med.monthInterval?med.monthInterval:null;
var freqLabel=medFreq;
if(medFreq==='once')freqLabel='Once daily';
else if(medFreq==='twice')freqLabel='Twice daily';
else if(medFreq==='three_times')freqLabel='3 times daily';
else if(medFreq==='four_times')freqLabel='4 times daily';
else if(medFreq==='as_needed')freqLabel='As needed (PRN)';
else if(medFreq==='weekly')freqLabel='Once weekly';
else if(medFreq==='monthly')freqLabel='Once monthly';
else if(medFreq==='custom_months')freqLabel='Every '+(medMonthInterval||'X')+' months';
html+='<div style="padding:14px;background:#f9fafb;border:2px solid #e5e7eb;border-radius:10px;margin-bottom:10px">';
html+='<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">';
html+='<div style="flex:1">';
html+='<div style="font-size:19px;font-weight:700;color:#111827;margin-bottom:4px">'+medName+'</div>';
html+='<div style="font-size:14px;color:#6b7280">';
html+='<span style="font-weight:600">Schedule:</span> '+freqLabel;
if(medFreq!=='as_needed'&&medFreq!=='Not set'&&medFreq!=='weekly'&&medFreq!=='monthly'&&medFreq!=='custom_months'){
html+=' ('+medTimes+')';
}
html+='</div>';
html+='</div>';
html+='<div style="display:flex;gap:6px">';
html+='<button onclick="editMedicine('+i+')" style="background:#3b82f6;color:#fff;border:none;padding:8px 14px;border-radius:6px;font-size:14px;cursor:pointer;font-weight:600">‚úèÔ∏è Edit</button>';
html+='<button onclick="deleteMedicine('+i+')" style="background:#ef4444;color:#fff;border:none;padding:8px 14px;border-radius:6px;font-size:14px;cursor:pointer;font-weight:600">‚úï</button>';
html+='</div>';
html+='</div>';
html+='</div>';
}
html+='</div>';
}else{
html+='<div style="padding:20px;text-align:center;color:#6b7280;background:#f3f4f6;border-radius:8px;margin-bottom:16px">No medicines added yet</div>';
}
html+='<div class="modal-actions"><button class="modal-cancel" onclick="hideModal()">Done</button></div>';
showModal(html);
}

function addNewMedicine(){
var html='<div class="modal-title">Add New Medicine</div>';
html+='<label style="display:block;font-size:16px;font-weight:600;margin:12px 0 8px 0;color:#374151">Medicine Name:</label>';
html+='<input type="text" id="newMedName" class="modal-input" placeholder="e.g., Lisinopril 10mg" />';
html+='<label style="display:block;font-size:16px;font-weight:600;margin:16px 0 8px 0;color:#374151">How often do you take this?</label>';
html+='<select id="medFrequency" class="modal-input" onchange="updateTimeOptions()" style="font-size:18px">';
html+='<option value="">-- Select Frequency --</option>';
html+='<option value="as_needed">As needed (PRN) - Only when required</option>';
html+='<optgroup label="Daily Schedules">';
html+='<option value="once">Once daily</option>';
html+='<option value="twice">Twice daily</option>';
html+='<option value="three_times">3 times daily</option>';
html+='<option value="four_times">4 times daily</option>';
html+='</optgroup>';
html+='<optgroup label="Weekly & Monthly">';
html+='<option value="weekly">Once weekly</option>';
html+='<option value="monthly">Once monthly</option>';
html+='<option value="custom_months">Every X months (custom)</option>';
html+='</optgroup>';
html+='</select>';
html+='<div id="customMonthsInput" style="display:none;margin-top:12px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin:8px 0;color:#374151">How many months between doses?</label>';
html+='<input type="number" id="monthInterval" class="modal-input" min="1" max="12" placeholder="e.g., 3 for every 3 months" style="font-size:18px" />';
html+='</div>';
html+='<div id="timesSection" style="display:none">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin:16px 0 8px 0;color:#374151">What time(s) of day?</label>';
html+='<div id="timeCheckboxes" style="display:grid;grid-template-columns:1fr 1fr;gap:10px"></div>';
html+='</div>';
html+='<div class="modal-actions"><button class="modal-cancel" onclick="manageMedicines()">Cancel</button><button class="modal-ok" onclick="saveNewMedicine()">Add Medicine</button></div>';
showModal(html);
setTimeout(function(){document.getElementById('newMedName').focus();},100);
}

function editMedicine(index){
var med=medicineList[index];
var medName=typeof med==='string'?med:med.name;
var medFreq=typeof med==='object'&&med.frequency?med.frequency:'';
var medTimes=typeof med==='object'&&med.times?med.times:[];
var medMonthInterval=typeof med==='object'&&med.monthInterval?med.monthInterval:3;
var html='<div class="modal-title">Edit Medicine</div>';
html+='<label style="display:block;font-size:16px;font-weight:600;margin:12px 0 8px 0;color:#374151">Medicine Name:</label>';
html+='<input type="text" id="editMedName" class="modal-input" value="'+medName+'" />';
html+='<label style="display:block;font-size:16px;font-weight:600;margin:16px 0 8px 0;color:#374151">How often do you take this?</label>';
html+='<select id="medFrequency" class="modal-input" onchange="updateTimeOptions()" style="font-size:18px">';
html+='<option value="">-- Select Frequency --</option>';
html+='<option value="as_needed" '+(medFreq==='as_needed'?'selected':'')+'>As needed (PRN) - Only when required</option>';
html+='<optgroup label="Daily Schedules">';
html+='<option value="once" '+(medFreq==='once'?'selected':'')+'>Once daily</option>';
html+='<option value="twice" '+(medFreq==='twice'?'selected':'')+'>Twice daily</option>';
html+='<option value="three_times" '+(medFreq==='three_times'?'selected':'')+'>3 times daily</option>';
html+='<option value="four_times" '+(medFreq==='four_times'?'selected':'')+'>4 times daily</option>';
html+='</optgroup>';
html+='<optgroup label="Weekly & Monthly">';
html+='<option value="weekly" '+(medFreq==='weekly'?'selected':'')+'>Once weekly</option>';
html+='<option value="monthly" '+(medFreq==='monthly'?'selected':'')+'>Once monthly</option>';
html+='<option value="custom_months" '+(medFreq==='custom_months'?'selected':'')+'>Every X months (custom)</option>';
html+='</optgroup>';
html+='</select>';
html+='<div id="customMonthsInput" style="display:'+(medFreq==='custom_months'?'block':'none')+';margin-top:12px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin:8px 0;color:#374151">How many months between doses?</label>';
html+='<input type="number" id="monthInterval" class="modal-input" min="1" max="12" value="'+medMonthInterval+'" placeholder="e.g., 3 for every 3 months" style="font-size:18px" />';
html+='</div>';
html+='<div id="timesSection" style="display:'+(medFreq&&medFreq!=='as_needed'&&medFreq!=='weekly'&&medFreq!=='monthly'&&medFreq!=='custom_months'?'block':'none')+'">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin:16px 0 8px 0;color:#374151">What time(s) of day?</label>';
html+='<div id="timeCheckboxes" style="display:grid;grid-template-columns:1fr 1fr;gap:10px"></div>';
html+='</div>';
html+='<div class="modal-actions"><button class="modal-cancel" onclick="manageMedicines()">Cancel</button><button class="modal-ok" onclick="saveEditedMedicine('+index+')">Save Changes</button></div>';
showModal(html);
// Pre-populate time checkboxes if editing
setTimeout(function(){
updateTimeOptions();
medTimes.forEach(function(time){
var checkbox=document.querySelector('input[value="'+time+'"]');
if(checkbox)checkbox.checked=true;
});
},100);
}

function updateTimeOptions(){
var freq=document.getElementById('medFrequency').value;
var timesSection=document.getElementById('timesSection');
var checkboxesDiv=document.getElementById('timeCheckboxes');
var customMonthsInput=document.getElementById('customMonthsInput');
// Show/hide custom months input
if(customMonthsInput){
customMonthsInput.style.display=freq==='custom_months'?'block':'none';
}
// Hide time selection for these frequencies
if(!freq||freq==='as_needed'||freq==='weekly'||freq==='monthly'||freq==='custom_months'){
timesSection.style.display='none';
return;
}
timesSection.style.display='block';
var times=['morning','afternoon','evening','bedtime'];
var timesNeeded=0;
if(freq==='once')timesNeeded=1;
else if(freq==='twice')timesNeeded=2;
else if(freq==='three_times')timesNeeded=3;
else if(freq==='four_times')timesNeeded=4;
var html='<div style="grid-column:1/-1;padding:10px;background:#dbeafe;border-radius:6px;font-size:14px;color:#1e40af;margin-bottom:8px">';
html+='<b>Select '+timesNeeded+' time'+(timesNeeded>1?'s':'')+':</b> Check exactly '+timesNeeded+' box'+(timesNeeded>1?'es':'')+' below';
html+='</div>';
times.forEach(function(time){
var icon=time==='morning'?'üåÖ':time==='afternoon'?'‚òÄÔ∏è':time==='evening'?'üåÜ':'üåô';
html+='<label style="display:flex;align-items:center;padding:12px;background:#f9fafb;border:2px solid #e5e7eb;border-radius:8px;cursor:pointer;font-size:16px">';
html+='<input type="checkbox" value="'+time+'" style="width:20px;height:20px;margin-right:10px;cursor:pointer" />';
html+=icon+' '+time.charAt(0).toUpperCase()+time.slice(1);
html+='</label>';
});
checkboxesDiv.innerHTML=html;
}

function saveNewMedicine(){
var name=document.getElementById('newMedName').value.trim();
var frequency=document.getElementById('medFrequency').value;
if(!name){
alert('Please enter medicine name');
return;
}
if(!frequency){
alert('Please select how often you take this medicine');
return;
}
var times=[];
var monthInterval=null;
// Handle custom month interval
if(frequency==='custom_months'){
var monthIntervalInput=document.getElementById('monthInterval');
monthInterval=parseInt(monthIntervalInput.value);
if(!monthInterval||monthInterval<1||monthInterval>12){
alert('Please enter a valid number of months (1-12)');
return;
}
}
// Only require time selection for daily frequencies
if(frequency!=='as_needed'&&frequency!=='weekly'&&frequency!=='monthly'&&frequency!=='custom_months'){
var checkboxes=document.querySelectorAll('#timeCheckboxes input[type="checkbox"]:checked');
checkboxes.forEach(function(cb){
times.push(cb.value);
});
var expectedTimes=frequency==='once'?1:frequency==='twice'?2:frequency==='three_times'?3:4;
if(times.length!==expectedTimes){
alert('Please select exactly '+expectedTimes+' time'+(expectedTimes>1?'s':'')+' of day');
return;
}
}
// Check if medicine already exists
var exists=medicineList.some(function(m){
var mName=typeof m==='string'?m:m.name;
return mName.toLowerCase()===name.toLowerCase();
});
if(exists){
alert('This medicine is already in your list');
return;
}
var medObject={
name:name,
frequency:frequency,
times:times
};
if(monthInterval){
medObject.monthInterval=monthInterval;
}
medicineList.push(medObject);
medicineList.sort(function(a,b){
var aName=typeof a==='string'?a:a.name;
var bName=typeof b==='string'?b:b.name;
return aName.localeCompare(bName);
});
saveMedicineList();
manageMedicines();
alert('‚úì Medicine added with schedule');
}

function saveEditedMedicine(index){
var name=document.getElementById('editMedName').value.trim();
var frequency=document.getElementById('medFrequency').value;
if(!name){
alert('Please enter medicine name');
return;
}
if(!frequency){
alert('Please select how often you take this medicine');
return;
}
var times=[];
var monthInterval=null;
// Handle custom month interval
if(frequency==='custom_months'){
var monthIntervalInput=document.getElementById('monthInterval');
monthInterval=parseInt(monthIntervalInput.value);
if(!monthInterval||monthInterval<1||monthInterval>12){
alert('Please enter a valid number of months (1-12)');
return;
}
}
// Only require time selection for daily frequencies
if(frequency!=='as_needed'&&frequency!=='weekly'&&frequency!=='monthly'&&frequency!=='custom_months'){
var checkboxes=document.querySelectorAll('#timeCheckboxes input[type="checkbox"]:checked');
checkboxes.forEach(function(cb){
times.push(cb.value);
});
var expectedTimes=frequency==='once'?1:frequency==='twice'?2:frequency==='three_times'?3:4;
if(times.length!==expectedTimes){
alert('Please select exactly '+expectedTimes+' time'+(expectedTimes>1?'s':'')+' of day');
return;
}
}
var medObject={
name:name,
frequency:frequency,
times:times
};
if(monthInterval){
medObject.monthInterval=monthInterval;
}
medicineList[index]=medObject;
saveMedicineList();
manageMedicines();
alert('‚úì Medicine updated');
}

function deleteMedicine(index){
if(confirm('Delete '+medicineList[index]+'?')){
medicineList.splice(index,1);
saveMedicineList();
manageMedicines();
}
}

function showPasteMedicines(){
var html='<div class="modal-title">Paste Medicine List</div>';
html+='<div style="margin:16px 0;padding:12px;background:#fef3c7;border-radius:8px;font-size:16px">Paste your medicine list below (one per line)</div>';
html+='<textarea id="pasteArea" class="modal-input" placeholder="Paste medicines here..." style="min-height:250px;font-family:monospace;font-size:18px"></textarea>';
html+='<div class="modal-actions"><button class="modal-cancel" onclick="manageMedicines()">Cancel</button><button class="modal-ok" onclick="processPaste()">Import</button></div>';
showModal(html);
setTimeout(function(){document.getElementById('pasteArea').focus();},100);
}

function copyAllMedicines(){
if(medicineList.length===0){
alert('No medicines to copy. Add some medicines first.');
return;
}
var copyText=medicineList.join('\n');
if(navigator.clipboard&&navigator.clipboard.writeText){
navigator.clipboard.writeText(copyText).then(function(){
alert('‚úì Copied '+medicineList.length+' medicines to clipboard!\n\nNow:\n1. Download new tracker version\n2. Open it\n3. Go to Manage Medicines\n4. Click "Paste Medicine List"\n5. Paste (Ctrl+V)');
}).catch(function(){
showCopyTextFallback(copyText);
});
}else{
showCopyTextFallback(copyText);
}
}

function showCopyTextFallback(text){
var html='<div class="modal-title">Copy Your Medicines</div>';
html+='<div style="margin:16px 0;padding:12px;background:#fef3c7;border-radius:8px;font-size:16px">Select all text below and copy (Ctrl+C)</div>';
html+='<textarea readonly class="modal-input" style="min-height:250px;font-family:monospace;font-size:16px">'+text+'</textarea>';
html+='<div class="modal-actions"><button class="modal-ok" onclick="hideModal()">Close</button></div>';
showModal(html);
setTimeout(function(){
var ta=document.querySelectorAll('textarea')[0];
if(ta){ta.select();}
},100);
}

function processPaste(){
var textarea=document.getElementById('pasteArea');
var content=textarea.value;
if(!content||!content.trim()){
alert('Please paste your medicine list first');
return;
}
var lines=content.split('\n').map(function(line){return line.trim();}).filter(function(line){return line.length>0;});
if(lines.length===0){
alert('No medicines found in pasted text');
return;
}
var added=0;
for(var i=0;i<lines.length;i++){
if(medicineList.indexOf(lines[i])===-1){
medicineList.push(lines[i]);
added++;
}
}
medicineList.sort();
saveMedicineList();
completeAndCloseModal();
if(added>0){
alert('‚úì Added '+added+' medicine(s)!\n\nTotal medicines: '+medicineList.length);
}else{
alert('All medicines were already in your list.\n\nTotal medicines: '+medicineList.length);
}
}

function saveMedicineList(){
try{
// Save to multiple keys for redundancy
localStorage.setItem('BP_TRACKER_MEDICINES',JSON.stringify(medicineList));
localStorage.setItem('medicineList',JSON.stringify(medicineList));
// Also save timestamp to verify freshness
localStorage.setItem('BP_TRACKER_LAST_SAVE',new Date().toISOString());
}catch(e){
console.error('Failed to save medicines:',e);
}
}

function loadMedicineList(){
try{
// Try primary key first
var saved=localStorage.getItem('BP_TRACKER_MEDICINES');
// Fallback to old key
if(!saved){
saved=localStorage.getItem('medicineList');
// If found on old key, migrate it
if(saved){
localStorage.setItem('BP_TRACKER_MEDICINES',saved);
}
}
if(saved){
medicineList=JSON.parse(saved);
console.log('Loaded',medicineList.length,'medicines from storage');
}
}catch(e){
console.error('Failed to load medicines:',e);
}
}

// ===== SYMPTOM MANAGEMENT FUNCTIONS =====

function manageSymptoms(){
var customSymptoms=settings.customSymptoms||[];
var html='<div class="modal-title">ü©∫ Manage Symptoms</div>';
html+='<p style="margin-bottom:16px;color:#6b7280;font-size:16px">Manage your custom symptom list. Predefined symptoms cannot be edited.</p>';
html+='<div style="margin-bottom:16px">';
html+='<button class="modal-btn selected" onclick="addNewSymptom()">+ Add New Symptom</button>';
html+='</div>';
// Show predefined symptoms (read-only)
html+='<div style="margin-bottom:20px">';
html+='<h3 style="font-size:18px;font-weight:700;color:#374151;margin-bottom:12px">üìã Predefined Symptoms (Read-only)</h3>';
html+='<div style="max-height:200px;overflow-y:auto;background:#f9fafb;border:2px solid #e5e7eb;border-radius:8px;padding:12px">';
for(var i=0;i<PREDEFINED_SYMPTOMS.length;i++){
html+='<div style="padding:10px;background:white;border:1px solid #e5e7eb;border-radius:6px;margin-bottom:8px;font-size:16px;color:#6b7280">';
html+='<span style="margin-right:8px">‚Ä¢</span>'+PREDEFINED_SYMPTOMS[i];
html+='</div>';
}
html+='</div>';
html+='</div>';
// Show custom symptoms (editable)
html+='<div>';
html+='<h3 style="font-size:18px;font-weight:700;color:#374151;margin-bottom:12px">‚úèÔ∏è Your Custom Symptoms</h3>';
if(customSymptoms.length>0){
html+='<div style="max-height:250px;overflow-y:auto">';
for(var i=0;i<customSymptoms.length;i++){
html+='<div style="padding:12px;background:#f0fdf4;border:2px solid #86efac;border-radius:8px;margin-bottom:10px">';
html+='<div style="display:flex;justify-content:space-between;align-items:center">';
html+='<div style="flex:1;font-size:17px;font-weight:600;color:#166534">'+customSymptoms[i]+'</div>';
html+='<div style="display:flex;gap:6px">';
html+='<button onclick="editCustomSymptom('+i+')" style="background:#3b82f6;color:#fff;border:none;padding:8px 14px;border-radius:6px;font-size:14px;cursor:pointer;font-weight:600">‚úèÔ∏è Edit</button>';
html+='<button onclick="deleteCustomSymptom('+i+')" style="background:#ef4444;color:#fff;border:none;padding:8px 14px;border-radius:6px;font-size:14px;cursor:pointer;font-weight:600">‚úï</button>';
html+='</div>';
html+='</div>';
html+='</div>';
}
html+='</div>';
}else{
html+='<div style="padding:20px;text-align:center;color:#6b7280;background:#f3f4f6;border-radius:8px">No custom symptoms added yet</div>';
}
html+='</div>';
html+='<div class="modal-actions" style="margin-top:20px"><button class="modal-cancel" onclick="hideModal()">Done</button></div>';
showModal(html);
}

function addNewSymptom(){
var html='<div class="modal-title">Add New Symptom</div>';
html+='<label style="display:block;font-size:16px;font-weight:600;margin:12px 0 8px 0;color:#374151">Symptom Name:</label>';
html+='<input type="text" id="newSymptomNameInput" class="modal-input" placeholder="e.g., Severe headaches, Vision changes, Night sweats..." />';
html+='<p style="margin:12px 0;color:#6b7280;font-size:14px">üí° Tip: Be specific so your doctor can easily identify patterns</p>';
html+='<div class="modal-actions"><button class="modal-cancel" onclick="manageSymptoms()">Cancel</button><button class="modal-ok" onclick="saveNewSymptom()">Add Symptom</button></div>';
showModal(html);
setTimeout(function(){document.getElementById('newSymptomNameInput').focus();},100);
}

function saveNewSymptom(){
var symptomName=document.getElementById('newSymptomNameInput').value.trim();
if(!symptomName){
alert('Please enter a symptom name');
document.getElementById('newSymptomNameInput').focus();
return;
}
// Check if already exists
var allSymptoms=getSymptomList();
if(allSymptoms.indexOf(symptomName)!==-1){
alert('This symptom already exists in your list');
return;
}
// Add to custom symptoms
if(!settings.customSymptoms){
settings.customSymptoms=[];
}
settings.customSymptoms.push(symptomName);
saveSettings();
// Go back to manage screen so user can see their new entry
manageSymptoms();
// Toast confirmation
var toast=document.createElement('div');
toast.textContent='‚úì "'+symptomName+'" added to your symptom list';
toast.style.cssText='position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#10b981;color:#fff;padding:14px 24px;border-radius:10px;font-size:17px;font-weight:600;z-index:999999;box-shadow:0 4px 12px rgba(0,0,0,0.2);pointer-events:none';
document.body.appendChild(toast);
setTimeout(function(){toast.remove();},3000);
}

function editCustomSymptom(index){
var customSymptoms=settings.customSymptoms||[];
var symptom=customSymptoms[index];
var html='<div class="modal-title">Edit Symptom</div>';
html+='<label style="display:block;font-size:16px;font-weight:600;margin:12px 0 8px 0;color:#374151">Symptom Name:</label>';
html+='<input type="text" id="editSymptomNameInput" class="modal-input" value="'+symptom+'" />';
html+='<div class="modal-actions"><button class="modal-cancel" onclick="manageSymptoms()">Cancel</button><button class="modal-ok" onclick="saveEditedSymptom('+index+')">Save Changes</button></div>';
showModal(html);
setTimeout(function(){
var input=document.getElementById('editSymptomNameInput');
input.focus();
input.select();
},100);
}

function saveEditedSymptom(index){
var newName=document.getElementById('editSymptomNameInput').value.trim();
if(!newName){
alert('Please enter a symptom name');
document.getElementById('editSymptomNameInput').focus();
return;
}
var customSymptoms=settings.customSymptoms||[];
var oldName=customSymptoms[index];
// Check if new name already exists (and it's not the same symptom)
var allSymptoms=getSymptomList();
if(newName!==oldName&&allSymptoms.indexOf(newName)!==-1){
alert('This symptom name already exists');
return;
}
// Update the symptom name
customSymptoms[index]=newName;
settings.customSymptoms=customSymptoms;
saveSettings();
alert('‚úì Symptom updated: '+newName);
manageSymptoms();
}

function deleteCustomSymptom(index){
var customSymptoms=settings.customSymptoms||[];
var symptom=customSymptoms[index];
if(confirm('Delete this symptom?\n\n"'+symptom+'"\n\nPast logs with this symptom will still show the symptom name, but it won\'t appear in the list for new entries.')){
customSymptoms.splice(index,1);
settings.customSymptoms=customSymptoms;
saveSettings();
alert('‚úì Symptom deleted: '+symptom);
manageSymptoms();
}
}

// ========== MEDICAL PROCEDURES FUNCTIONS ==========

function logProcedure(){
var modal=document.getElementById('procedureModal');
// Set default to today's date and current time
var now=new Date();
document.getElementById('procedureDate').value=now.toISOString().split('T')[0];
document.getElementById('procedureTime').value=now.toTimeString().slice(0,5);
// Clear other fields
document.getElementById('procedureName').value='';
document.getElementById('procedureCategory').value='';
document.getElementById('procedureFacility').value='';
document.getElementById('procedurePhysician').value='';
document.getElementById('procedureNotes').value='';
modal.style.display='block';
}

function closeProcedureModal(){
var modal=document.getElementById('procedureModal');
modal.style.display='none';
// Clear editing index if set
delete modal.dataset.editingIndex;
}

function saveProcedure(){
var date=document.getElementById('procedureDate').value;
var time=document.getElementById('procedureTime').value;
var name=document.getElementById('procedureName').value.trim();
var category=document.getElementById('procedureCategory').value;
var facility=document.getElementById('procedureFacility').value.trim();
var physician=document.getElementById('procedurePhysician').value.trim();
var notes=document.getElementById('procedureNotes').value.trim();

if(!date){
alert('Please select a date');
return;
}
if(!time){
alert('Please select a time');
return;
}
if(!name){
alert('Please enter the procedure name/type');
return;
}

var procedure={
date:date,
time:time,
name:name,
category:category,
facility:facility,
physician:physician,
notes:notes,
timestamp:new Date(date+' '+time).toISOString()
};

// Check if we're editing an existing procedure
var modal=document.getElementById('procedureModal');
var editingIndex=modal.dataset.editingIndex;

if(editingIndex!==undefined&&editingIndex!==''){
// Update existing procedure
procedures[parseInt(editingIndex)]=procedure;
delete modal.dataset.editingIndex;
alert('‚úì Medical procedure updated');
}else{
// Add new procedure
procedures.push(procedure);
alert('‚úì Medical procedure logged');
}

saveProcedures();
closeProcedureModal();
showProcedures();
}

function saveProcedures(){
try{
localStorage.setItem('BP_TRACKER_PROCEDURES',JSON.stringify(procedures));
console.log('Procedures saved to localStorage');
}catch(e){
console.error('Failed to save procedures:',e);
}
}

function showProcedures(){
// Display procedures in the readings section
var container=document.getElementById('proceduresDisplay');
if(!container){
// Create container if it doesn't exist
var cardSection=document.getElementById('bpCard');
if(cardSection){
container=document.createElement('div');
container.id='proceduresDisplay';
container.style.marginTop='16px';
cardSection.parentNode.insertBefore(container,cardSection);
}
}
if(!container)return;

if(procedures.length===0){
container.innerHTML='';
container.style.display='none';
return;
}

// Sort procedures by date/time (most recent first)
var sorted=[...procedures].sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));

var html='<div class="card"><div class="hdr" style="display:flex;justify-content:space-between;align-items:center"><span>üè• Medical Procedures</span><button class="btn" style="background:#dc2626;padding:8px 16px;font-size:14px" onclick="viewAllProcedures()">View All</button></div>';
for(var i=0;i<sorted.length;i++){
var proc=sorted[i];
var procDate=new Date(proc.timestamp);
var dateStr=procDate.toLocaleDateString();
var timeStr=procDate.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

html+='<div class="reading" style="border-left:4px solid #dc2626">';
html+='<div style="position:absolute;top:8px;right:8px;display:flex;gap:8px">';
html+='<button onclick="editProcedure('+i+')" style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:16px;font-weight:600;cursor:pointer">‚úèÔ∏è</button>';
html+='<button onclick="deleteProcedure('+i+')" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:16px;font-weight:600;cursor:pointer">‚úï</button>';
html+='</div>';
html+='<div style="font-size:20px;font-weight:700;color:#dc2626;margin-bottom:8px">'+proc.name+'</div>';
html+='<div><span class="b">Date:</span> '+dateStr+' at '+timeStr+'</div>';
if(proc.category){
html+='<div><span class="b">Category:</span> '+proc.category+'</div>';
}
if(proc.facility){
html+='<div><span class="b">Facility:</span> '+proc.facility+'</div>';
}
if(proc.physician){
html+='<div><span class="b">Physician:</span> '+proc.physician+'</div>';
}
if(proc.notes){
html+='<div style="margin-top:8px;padding:12px;background:#fef2f2;border-radius:6px">';
html+='<span class="b">Notes:</span> '+proc.notes;
html+='</div>';
}
html+='</div>';
}
html+='</div>';
container.innerHTML=html;
container.style.display='block';
}

function deleteProcedure(index){
if(confirm('Delete this medical procedure?')){
var sorted=[...procedures].sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
var procToDelete=sorted[index];
var actualIndex=procedures.findIndex(p=>p.timestamp===procToDelete.timestamp);
if(actualIndex!==-1){
procedures.splice(actualIndex,1);
saveProcedures();
showProcedures();
alert('‚úì Procedure deleted');
}
}
}

function editProcedure(index){
// Get the procedure from sorted list
var sorted=[...procedures].sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
var procToEdit=sorted[index];
var actualIndex=procedures.findIndex(p=>p.timestamp===procToEdit.timestamp);

if(actualIndex===-1){
alert('Error: Procedure not found');
return;
}

// Open modal and populate with existing data
var modal=document.getElementById('procedureModal');
var procDate=new Date(procToEdit.timestamp);
document.getElementById('procedureDate').value=procDate.toISOString().split('T')[0];
document.getElementById('procedureTime').value=procDate.toTimeString().slice(0,5);
document.getElementById('procedureName').value=procToEdit.name||'';
document.getElementById('procedureCategory').value=procToEdit.category||'';
document.getElementById('procedureFacility').value=procToEdit.facility||'';
document.getElementById('procedurePhysician').value=procToEdit.physician||'';
document.getElementById('procedureNotes').value=procToEdit.notes||'';

// Store the index we're editing
modal.dataset.editingIndex=actualIndex;

modal.style.display='block';
}

// ========== END MEDICAL PROCEDURES FUNCTIONS ==========

function saveDailyData(){
try{
var dailyData={
meals:M,
bp:B,
weight:W,
symptoms:S,
activities:A,
fluid:fluidLog,
medLog:medLog,
notes:notes,
dailyFluid:dailyFluid,
exportedToday:exportedToday,
timestamp:new Date().toISOString()
};
// Save with date-based key for historical tracking
var dateKey='BP_TRACKER_'+getTodayKey();
localStorage.setItem(dateKey,JSON.stringify(dailyData));
// Also save to main key for backward compatibility
localStorage.setItem('BP_TRACKER_DAILY_DATA',JSON.stringify(dailyData));
console.log('Daily data saved to localStorage with key:',dateKey);
// Phase 4: Update today's zone after data changes
setTimeout(showTodayZone,100);
}catch(e){
console.error('Failed to save daily data:',e);
}
}

function loadDailyData(){
try{
// Run cleanup first to remove data older than 90 days
cleanupOldData();

// First, check if there's old data in the main key that needs to be migrated
var oldData=localStorage.getItem('BP_TRACKER_DAILY_DATA');
if(oldData){
try{
var parsed=JSON.parse(oldData);
if(parsed.timestamp){
var oldDate=new Date(parsed.timestamp);
var oldDateKey=oldDate.getFullYear()+'-'+('0'+(oldDate.getMonth()+1)).slice(-2)+'-'+('0'+oldDate.getDate()).slice(-2);
var dateSpecificKey='BP_TRACKER_'+oldDateKey;
// Save old data with its proper date key
localStorage.setItem(dateSpecificKey,oldData);
console.log('Migrated old data to',dateSpecificKey);
// Clear the old main key after migration
localStorage.removeItem('BP_TRACKER_DAILY_DATA');
}
}catch(e){
console.error('Failed to migrate old data:',e);
}
}

// Now load today's data
var todayKey='BP_TRACKER_'+getTodayKey();
var saved=localStorage.getItem(todayKey);

if(saved){
var data=JSON.parse(saved);
// Double-check that this data is actually from today
var dataDate=new Date(data.timestamp);
var dataDateKey=dataDate.getFullYear()+'-'+('0'+(dataDate.getMonth()+1)).slice(-2)+'-'+('0'+dataDate.getDate()).slice(-2);
var expectedKey=getTodayKey();
if(dataDateKey===expectedKey){
M=data.meals||[];
B=data.bp||[];
W=data.weight||[];
S=data.symptoms||[];
A=data.activities||[];
fluidLog=data.fluid||[];
medLog=data.medLog||[];
notes=data.notes||[];
dailyFluid=data.dailyFluid||0;
exportedToday=data.exportedToday||false;
console.log('Loaded today\'s data from',data.timestamp);
}else{
// Data in today's key is from wrong date - clear it and start fresh
console.log('Data in today\'s key was from wrong date ('+dataDateKey+' vs '+expectedKey+') - starting fresh');
M=[];
B=[];
W=[];
S=[];
A=[];
fluidLog=[];
medLog=[];
notes=[];
dailyFluid=0;
exportedToday=false;
}
}else{
// No data for today yet - start fresh
console.log('No data for today yet - starting fresh');
M=[];
B=[];
W=[];
S=[];
A=[];
fluidLog=[];
medLog=[];
notes=[];
dailyFluid=0;
exportedToday=false;
}

// Load dismissed events for today
var dismissedSaved=localStorage.getItem('dismissedEvents_'+getTodayKey());
if(dismissedSaved){
dismissedEvents=JSON.parse(dismissedSaved);
}else{
dismissedEvents=[];
}
}catch(e){
console.error('Failed to load daily data:',e);
}
}

function loadProcedures(){
try{
var saved=localStorage.getItem('BP_TRACKER_PROCEDURES');
if(saved){
procedures=JSON.parse(saved);
}else{
procedures=[];
}
}catch(e){
console.error('Failed to load procedures:',e);
procedures=[];
}
}

// ===== PHASE 4: ZONE SYSTEM (Green/Yellow/Red Day Classification) =====

function calculateDailyZone(dateKey){
// Calculate zone for a specific date
// GREEN = Good day, YELLOW = Caution, RED = Alert
try{
var saved=localStorage.getItem('BP_TRACKER_'+dateKey);
if(!saved)return null;
var data=JSON.parse(saved);
var bp=data.B||[];
var symptoms=data.S||[];
var medLog=data.medLog||[];
// Start at GREEN
var zone='green';
var reasons=[];
// Check BP readings
if(bp.length>0){
var totalSys=0,totalDia=0,totalHR=0,hrCount=0;
bp.forEach(r=>{
totalSys+=r.s;
totalDia+=r.d;
if(r.h){
totalHR+=r.h;
hrCount++;
}
});
var avgSys=totalSys/bp.length;
var avgDia=totalDia/bp.length;
var avgHR=hrCount>0?totalHR/hrCount:0;

// Check for HIGH BP readings (above settings maximum)
var highBPCount=0;
var veryHighBPCount=0;
bp.forEach(r=>{
if(r.s>settings.systolicMax||r.d>settings.diastolicMax){
highBPCount++;
// Very high threshold: 20 points above max
if(r.s>settings.systolicMax+20||r.d>settings.diastolicMax+20){
veryHighBPCount++;
if(reasons.indexOf('Very high BP reading ('+r.s+'/'+r.d+')')===-1){
reasons.push('Very high BP reading ('+r.s+'/'+r.d+')');
}
}
}
});

// Set zone based on HIGH BP
if(veryHighBPCount>0){
zone='red';
}else if(highBPCount>0){
// If average is also high, it's red; otherwise yellow
if(avgSys>settings.systolicMax||avgDia>settings.diastolicMax){
zone='red';
reasons.push('Elevated BP (avg '+Math.round(avgSys)+'/'+Math.round(avgDia)+')');
}else{
if(zone==='green')zone='yellow';
if(highBPCount===1){
reasons.push('1 high BP reading detected');
}else{
reasons.push(highBPCount+' high BP readings detected');
}
}
}

// Check for LOW BP readings (below settings minimum)
var lowBPCount=0;
bp.forEach(r=>{
if(r.s<settings.systolicMin||r.d<settings.diastolicMin){
lowBPCount++;
}
});
if(lowBPCount>0){
if(zone==='green')zone='yellow';
if(lowBPCount===1){
reasons.push('Low BP reading detected (below '+settings.systolicMin+'/'+settings.diastolicMin+')');
}else{
reasons.push(lowBPCount+' low BP readings (below '+settings.systolicMin+'/'+settings.diastolicMin+')');
}
}

// Check HEART RATE readings
if(hrCount>0){
var highHRCount=0;
var lowHRCount=0;
bp.forEach(r=>{
if(r.h){
if(r.h>settings.hrMax){
highHRCount++;
}
if(r.h<settings.hrMin){
lowHRCount++;
}
}
});

// High heart rate
if(highHRCount>0){
if(avgHR>settings.hrMax+20){
zone='red';
reasons.push('Very high heart rate (avg '+Math.round(avgHR)+' BPM)');
}else if(avgHR>settings.hrMax){
if(zone==='green')zone='yellow';
reasons.push('Elevated heart rate (avg '+Math.round(avgHR)+' BPM)');
}else{
if(zone==='green')zone='yellow';
if(highHRCount===1){
reasons.push('1 high heart rate reading');
}else{
reasons.push(highHRCount+' high heart rate readings');
}
}
}

// Low heart rate
if(lowHRCount>0){
if(avgHR<settings.hrMin-20){
zone='red';
reasons.push('Very low heart rate (avg '+Math.round(avgHR)+' BPM)');
}else if(avgHR<settings.hrMin){
if(zone==='green')zone='yellow';
reasons.push('Low heart rate (avg '+Math.round(avgHR)+' BPM)');
}else{
if(zone==='green')zone='yellow';
if(lowHRCount===1){
reasons.push('1 low heart rate reading');
}else{
reasons.push(lowHRCount+' low heart rate readings');
}
}
}
}
}
// Check symptoms - unexpected symptoms are concerning
if(symptoms.length>0){
var unexpectedCount=0;
var severeUnexpectedCount=0;
symptoms.forEach(s=>{
if(s.expected!==true){
unexpectedCount++;
if(s.severity>=7){
severeUnexpectedCount++;
}
}
});
if(severeUnexpectedCount>0){
zone='red';
reasons.push(severeUnexpectedCount+' severe unexpected symptom(s)');
}else if(unexpectedCount>0){
if(zone==='green')zone='yellow';
reasons.push(unexpectedCount+' unexpected symptom(s)');
}
}
// Check medication adherence (if medicines are set up) - TIME-AWARE
if(medicineList.length>0){
// Determine current time for the date being calculated
var currentTime;
var isToday=dateKey===getTodayKey();
if(isToday){
// For today, use actual current time
var now=new Date();
currentTime=('0'+now.getHours()).slice(-2)+':'+('0'+now.getMinutes()).slice(-2);
}else{
// For past days, use end of day (23:59) - all medicines should be taken
currentTime='23:59';
}
var currentMinutes=timeToMinutes(currentTime);
// Count medicines that are DUE by current time
var medicinesDue=0;
var medicinesDueList=[];
medicineList.forEach(function(med){
var medName=typeof med==='string'?med:med.name;
var medTimes=typeof med==='object'&&med.times?med.times:[];
var medFreq=typeof med==='object'&&med.frequency?med.frequency:'';
// Skip as-needed, weekly, monthly (not tracked by daily adherence)
if(medFreq==='as_needed'||medFreq==='weekly'||medFreq==='monthly'||medFreq==='custom_months'){
return;
}
// Check if any scheduled time has passed
if(medTimes&&medTimes.length>0){
medTimes.forEach(function(medTime){
var medMinutes=timeToMinutes(medTime);
if(medMinutes<=currentMinutes){
medicinesDue++;
medicinesDueList.push(medName);
}
});
}else{
// No times set - count medicine as due if end of day
if(currentMinutes>=timeToMinutes('23:00')){
medicinesDue++;
medicinesDueList.push(medName);
}
}
});
// Count medicines taken
var medicinesTaken=new Set();
medLog.forEach(m=>medicinesTaken.add(m.medicine));
// Calculate adherence based on medicines DUE
if(medicinesDue>0){
var adherenceRate=(medicinesTaken.size/medicinesDue)*100;
if(adherenceRate<50){
if(zone!=='red')zone='yellow';
var missed=medicinesDue-medicinesTaken.size;
reasons.push('Low medication adherence ('+Math.round(adherenceRate)+'%, '+missed+' missed)');
}else if(adherenceRate<80&&medicinesDue>=2){
// Only show moderate adherence if at least 2 medicines are due
if(zone==='green')zone='yellow';
reasons.push('Moderate medication adherence ('+Math.round(adherenceRate)+'%)');
}
}
}
return{zone:zone,reasons:reasons,date:dateKey};
}catch(e){
console.error('Error calculating zone for',dateKey,':',e);
return null;
}
}

function getTodayZone(){
var todayKey=getTodayKey();
return calculateDailyZone(todayKey);
}

function getZoneColor(zone){
if(zone==='green')return'#10b981';
if(zone==='yellow')return'#f59e0b';
if(zone==='red')return'#ef4444';
return'#6b7280';
}

function getZoneLabel(zone){
if(zone==='green')return'Good Day';
if(zone==='yellow')return'Caution';
if(zone==='red')return'Alert';
return'No Data';
}

function getZoneIcon(zone){
if(zone==='green')return'‚úì';
if(zone==='yellow')return'‚ö†';
if(zone==='red')return'üö®';
return'‚Äî';
}

function showTodayZone(){
// Display today's zone status + full daily activity summary
var zoneData=getTodayZone();
var zoneDiv=document.getElementById('todayZone');
if(!zoneDiv)return;

// ‚îÄ‚îÄ Zone badge (green / yellow / red) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var color='#6b7280'; var label='No Data'; var icon='‚Äî';
if(zoneData){
  color=getZoneColor(zoneData.zone);
  label=getZoneLabel(zoneData.zone);
  icon=getZoneIcon(zoneData.zone);
}

// ‚îÄ‚îÄ Activity counts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var bpCount   = B ? B.length : 0;
var mealCount = M ? M.length : 0;

// Total fluid entries (standalone fluidLog + BP fluid entries + meal fluid)
var fluidEntries = (fluidLog ? fluidLog.length : 0)
                 + (B ? B.filter(function(r){return r.f>0;}).length : 0)
                 + (M ? M.filter(function(m){return m.mealFluidOz>0;}).length : 0);

// Unique medicines taken today (by name, de-dup)
var medsSet = {};
if(medLog){ medLog.forEach(function(e){ if(e.medicine) medsSet[e.medicine]=true; }); }
var medsCount = Object.keys(medsSet).length;

// ‚îÄ‚îÄ Option C: Event completion ‚Äî data-linked OR dismissed ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Build a Set of every eventId that appears in today's logged entries
// (B, fluidLog, M, medLog, notes, S all support eventId)
var loggedEventIds = {};
if(B)         B.forEach(function(r){ if(r.eventId) loggedEventIds[r.eventId]=true; });
if(fluidLog)  fluidLog.forEach(function(r){ if(r.eventId) loggedEventIds[r.eventId]=true; });
if(M)         M.forEach(function(r){ if(r.eventId) loggedEventIds[r.eventId]=true; });
if(medLog)    medLog.forEach(function(r){ if(r.eventId) loggedEventIds[r.eventId]=true; });
if(notes)     notes.forEach(function(r){ if(r.eventId) loggedEventIds[r.eventId]=true; });
if(S)         S.forEach(function(r){ if(r.event)   loggedEventIds[r.event]=true; });

// Collect all scheduled events from BOTH sources, deduplicated by name+time
var scheduledEvents = {};
if(settings.dailyEvents){
  settings.dailyEvents.forEach(function(evt){
    var key = evt.name + '|' + (evt.time||'');
    scheduledEvents[key] = { id: evt.id, name: evt.name, time: evt.time||'' };
  });
}
if(dailyPlan){
  dailyPlan.forEach(function(pe){
    var key = pe.name + '|' + (pe.time||'');
    if(!scheduledEvents[key]){
      // Plan event not in settings ‚Äî look up matching settings event by name to get id
      var matchEvt = settings.dailyEvents
        ? settings.dailyEvents.find(function(e){ return e.name === pe.name; })
        : null;
      scheduledEvents[key] = { id: matchEvt ? matchEvt.id : null, name: pe.name, time: pe.time||'' };
    }
  });
}

var eventsTotal = 0, eventsDone = 0;
Object.keys(scheduledEvents).forEach(function(key){
  var evt = scheduledEvents[key];
  eventsTotal++;
  // Done if: (a) a log entry carries this event's id, OR (b) reminder was dismissed
  var linkedByData    = evt.id && loggedEventIds[evt.id];
  var linkedByDismiss = isEventDismissed({ time: evt.time, name: evt.name });
  if(linkedByData || linkedByDismiss) eventsDone++;
});

// ‚îÄ‚îÄ Build HTML ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var html='<div style="background:'+color+'15;border:3px solid '+color+';border-radius:14px;padding:16px 20px;margin-bottom:16px">';

// Row 1: zone badge + zone label
html+='<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:12px">';
html+='<div style="font-size:22px;font-weight:800;color:'+color+'">'+icon+' Today\'s Status: '+label+'</div>';
// Show date
var todayDisp=(function(){
  var d=new Date();
  return d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
})();
html+='<div style="font-size:14px;color:#6b7280;font-weight:600">'+todayDisp+'</div>';
html+='</div>';

// Row 2: activity summary tiles
html+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:8px;margin-bottom:'+((zoneData&&zoneData.reasons.length>0)?'12px':'0')+'">';

// helper: one tile
function tile(icon,count,label,accentColor){
  return '<div style="background:#fff;border:2px solid '+accentColor+'40;border-radius:10px;padding:10px 6px;text-align:center">'
       +'<div style="font-size:22px;font-weight:800;color:'+accentColor+'">'+count+'</div>'
       +'<div style="font-size:11px;color:#6b7280;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+icon+' '+label+'</div>'
       +'</div>';
}

var weightCount   = W ? W.length : 0;
var symptomCount  = S ? S.length : 0;
var activityCount = A ? A.length : 0;

html+=tile('üìä', bpCount,         'BP Readings',  '#10b981');
html+=tile('üíß', fluidEntries,    'Fluid Entries', '#3b82f6');
html+=tile('üçΩÔ∏è', mealCount,      'Meals',         '#f59e0b');
html+=tile('üíä', medsCount,       'Meds Taken',    '#f97316');
if(settings.enableWeight   !== false) html+=tile('‚öñÔ∏è', weightCount,   'Weight',      '#0ea5e9');
if(settings.enableSymptoms !== false) html+=tile('ü©∫', symptomCount,  'Symptoms',    '#ec4899');
if(settings.enableActivity !== false) html+=tile('üèÉ', activityCount, 'Activities',  '#14b8a6');
if(eventsTotal>0){
  html+=tile('‚úÖ', eventsDone+'/'+eventsTotal, 'Events Done', '#8b5cf6');
}
html+='</div>';

// Row 3: zone reasons (warnings / caution notes)
if(zoneData&&zoneData.reasons.length>0){
  html+='<div style="background:#fff;border-radius:8px;padding:10px 12px;font-size:13px;color:#374151">';
  zoneData.reasons.forEach(function(r){
    html+='<div style="margin-top:3px">‚Ä¢ '+r+'</div>';
  });
  html+='</div>';
}

html+='</div>';
zoneDiv.innerHTML=html;
zoneDiv.style.display='block';
}

// ===== FLUID GREEN ZONE SYSTEM =====

function detectWakeBedTimes(){
// Auto-detect typical wake and bed times from historical data
// Look at last 14 days of logs to find patterns
var now=new Date();
var twoWeeksAgo=new Date(now.getTime()-(14*24*60*60*1000));
var firstTimes=[];
var lastTimes=[];
// Scan historical data
for(var i=0;i<localStorage.length;i++){
var key=localStorage.key(i);
if(key&&key.startsWith('BP_TRACKER_')&&key!=='BP_TRACKER_DAILY_DATA'){
try{
var dateStr=key.replace('BP_TRACKER_','');
var dateParts=dateStr.split('-');
if(dateParts.length===3){
var dataDate=new Date(parseInt(dateParts[0]),parseInt(dateParts[1])-1,parseInt(dateParts[2]));
if(dataDate>=twoWeeksAgo&&dataDate<=now){
var saved=localStorage.getItem(key);
if(saved){
var data=JSON.parse(saved);
// Find earliest activity (BP, meal, fluid, etc.)
var dayTimes=[];
if(data.B)data.B.forEach(r=>dayTimes.push(r.t));
if(data.meals)data.meals.forEach(r=>dayTimes.push(r.time));
if(data.fluid)data.fluid.forEach(r=>dayTimes.push(r.time));
if(data.medLog)data.medLog.forEach(r=>dayTimes.push(r.time));
if(dayTimes.length>0){
dayTimes.sort();
firstTimes.push(dayTimes[0]);
lastTimes.push(dayTimes[dayTimes.length-1]);
}
}
}
}
}catch(e){
// Skip invalid entries
}
}
}
// Calculate averages
var avgWake='06:00';
var avgBed='22:00';
if(firstTimes.length>=3){
// Convert times to minutes, average, convert back
var totalMinutes=0;
firstTimes.forEach(t=>{
var parts=t.split(':');
totalMinutes+=parseInt(parts[0])*60+parseInt(parts[1]);
});
var avgMinutes=Math.round(totalMinutes/firstTimes.length);
var hours=Math.floor(avgMinutes/60);
var mins=avgMinutes%60;
avgWake=('0'+hours).slice(-2)+':'+('0'+mins).slice(-2);
}
if(lastTimes.length>=3){
var totalMinutes=0;
lastTimes.forEach(t=>{
var parts=t.split(':');
totalMinutes+=parseInt(parts[0])*60+parseInt(parts[1]);
});
var avgMinutes=Math.round(totalMinutes/lastTimes.length);
var hours=Math.floor(avgMinutes/60);
var mins=avgMinutes%60;
avgBed=('0'+hours).slice(-2)+':'+('0'+mins).slice(-2);
}
return{wake:avgWake,bed:avgBed};
}

function timeToMinutes(timeStr){
// Convert "HH:MM" to minutes since midnight
var parts=timeStr.split(':');
return parseInt(parts[0])*60+parseInt(parts[1]);
}

function calculateFluidTargets(){
// Calculate green zone targets (min/max) throughout the day
// Returns array of {time, min, max} points
var targets=[];
// Check if user has daily events set up
if(settings.dailyEvents&&settings.dailyEvents.length>0){
// Event-based targets
var cumulative=0;
var sortedEvents=settings.dailyEvents.slice().sort((a,b)=>{
return timeToMinutes(a.time||'12:00')-timeToMinutes(b.time||'12:00');
});
sortedEvents.forEach(event=>{
if(event.fluidGoal&&event.fluidGoal>0){
cumulative+=event.fluidGoal;
targets.push({
time:event.time,
min:cumulative*0.8,
max:cumulative*1.2
});
}
});
}else{
// Time-based targets (linear distribution)
var wakeBed=detectWakeBedTimes();
var wakeMinutes=timeToMinutes(wakeBed.wake);
var bedMinutes=timeToMinutes(wakeBed.bed);
if(bedMinutes<wakeMinutes)bedMinutes+=24*60; // Handle past midnight
var wakingMinutes=bedMinutes-wakeMinutes;
// Create targets at 2-hour intervals
for(var h=0;h<=wakingMinutes;h+=120){
var minutes=wakeMinutes+h;
var hours=Math.floor(minutes/60)%24;
var mins=minutes%60;
var timeStr=('0'+hours).slice(-2)+':'+('0'+mins).slice(-2);
var percentComplete=h/wakingMinutes;
targets.push({
time:timeStr,
min:settings.fluidMin*percentComplete,
max:settings.fluidMax*percentComplete
});
}
// Add final target at bedtime
targets.push({
time:wakeBed.bed,
min:settings.fluidMin,
max:settings.fluidMax
});
}
return targets;
}

function cleanupOldData(){
// Remove data older than DATA_RETENTION_DAYS (90 days)
try{
var today=new Date();
var cutoffDate=new Date(today.getTime()-(DATA_RETENTION_DAYS*24*60*60*1000));
var keysToRemove=[];
for(var i=0;i<localStorage.length;i++){
var key=localStorage.key(i);
if(key&&key.startsWith('BP_TRACKER_')&&key!=='BP_TRACKER_DAILY_DATA'){
// Extract date from key format: BP_TRACKER_YYYY-MM-DD
var dateStr=key.replace('BP_TRACKER_','');
if(dateStr.match(/^\d{4}-\d{2}-\d{2}$/)){
var keyDate=new Date(dateStr);
if(keyDate<cutoffDate){
keysToRemove.push(key);
}
}
}
}
// Remove old keys
keysToRemove.forEach(function(key){
localStorage.removeItem(key);
console.log('Cleaned up old data:',key);
});
if(keysToRemove.length>0){
console.log('Removed',keysToRemove.length,'old data entries (older than',DATA_RETENTION_DAYS,'days)');
}
}catch(e){
console.error('Failed to cleanup old data:',e);
}
}

function getTodayKey(){
var d=new Date();
var year=d.getFullYear();
var month=('0'+(d.getMonth()+1)).slice(-2);
var day=('0'+d.getDate()).slice(-2);
return year+'-'+month+'-'+day;
}

// Date Filter Functions (v7.1)
function setDateFilter(mode){
dateFilterMode=mode;
// Update button states
var buttons=document.querySelectorAll('.date-filter-btn');
buttons.forEach(function(btn){
btn.classList.remove('active');
});
if(mode==='today'){
buttons[0].classList.add('active');
// Update headers to show "Today's"
document.getElementById('bpHeader').textContent='üìä Today\'s Blood Pressure';
document.getElementById('mealsHeader').textContent='üçΩÔ∏è Meals';
document.getElementById('medicinesHeader').textContent='üíä Medicines Taken';
document.getElementById('notesHeader').textContent='üìù Notes';
if(document.getElementById('weightHeader'))document.getElementById('weightHeader').textContent='‚öñÔ∏è Weight Tracking';
if(document.getElementById('symptomHeader'))document.getElementById('symptomHeader').textContent='üíä Symptom Tracking';
if(document.getElementById('activityHeader'))document.getElementById('activityHeader').textContent='üèÉ Activity/Exercise Tracking';
}else{
buttons[1].classList.add('active');
// Update headers to show "All History"
document.getElementById('bpHeader').textContent='üìä Blood Pressure History (90 Days)';
document.getElementById('mealsHeader').textContent='üçΩÔ∏è Meals History (90 Days)';
document.getElementById('medicinesHeader').textContent='üíä Medicines History (90 Days)';
document.getElementById('notesHeader').textContent='üìù Notes History (90 Days)';
if(document.getElementById('weightHeader'))document.getElementById('weightHeader').textContent='‚öñÔ∏è Weight History (90 Days)';
if(document.getElementById('symptomHeader'))document.getElementById('symptomHeader').textContent='üíä Symptom History (90 Days)';
if(document.getElementById('activityHeader'))document.getElementById('activityHeader').textContent='üèÉ Activity History (90 Days)';
}
// Refresh all displays
refreshAllDisplays();
}

function getAllHistoricalData(){
// Load all data from localStorage within the 90-day window
var allBP=[];
var allWeight=[];
var allSymptoms=[];
var allActivities=[];
var allMeals=[];
var allMedicines=[];
var allNotes=[];
var today=new Date();
today.setHours(23,59,59,999); // Set to end of today for comparison
var todayKey=getTodayKey();
var cutoffDate=new Date(today.getTime()-(DATA_RETENTION_DAYS*24*60*60*1000));
cutoffDate.setHours(0,0,0,0); // Set to start of cutoff day

console.log('===== getAllHistoricalData START =====');
console.log('DEBUG getAllHistoricalData: todayKey=', todayKey);
console.log('DEBUG getAllHistoricalData: today=', today.toISOString());
console.log('DEBUG getAllHistoricalData: cutoffDate=', cutoffDate.toISOString());
console.log('DEBUG getAllHistoricalData: DATA_RETENTION_DAYS=', DATA_RETENTION_DAYS);
console.log('DEBUG getAllHistoricalData: localStorage.length=', localStorage.length);

// First, add today's current session data
console.log('Current session data: B.length=', B.length, 'W.length=', W.length);
if(B.length>0){
B.forEach(function(item){
var copy=Object.assign({},item,{_date:todayKey});
allBP.push(copy);
});
}
if(W.length>0){
W.forEach(function(item){
var copy=Object.assign({},item,{_date:todayKey});
allWeight.push(copy);
});
}
if(S.length>0){
S.forEach(function(item){
var copy=Object.assign({},item,{_date:todayKey});
allSymptoms.push(copy);
});
}
if(A.length>0){
A.forEach(function(item){
var copy=Object.assign({},item,{_date:todayKey});
allActivities.push(copy);
});
}
if(M.length>0){
M.forEach(function(item){
var copy=Object.assign({},item,{_date:todayKey});
allMeals.push(copy);
});
}
if(medLog.length>0){
medLog.forEach(function(item){
var copy=Object.assign({},item,{_date:todayKey});
allMedicines.push(copy);
});
}
if(notes.length>0){
notes.forEach(function(item){
var copy=Object.assign({},item,{_date:todayKey});
allNotes.push(copy);
});
}
// Then load historical data from localStorage - check both old and new key formats
var keysFound=0;
var keysProcessed=0;
var keysSkipped=0;
try{
console.log('DEBUG: Scanning localStorage keys...');
for(var i=0;i<localStorage.length;i++){
var key=localStorage.key(i);
if(key.startsWith('BP_TRACKER')){
console.log('DEBUG: Found BP_TRACKER key:', key);
keysFound++;
}
// Check for new BP_TRACKER_ format
if(key&&key.startsWith('BP_TRACKER_')&&key!=='BP_TRACKER_DAILY_DATA'){
var dateStr=key.replace('BP_TRACKER_','');
console.log('DEBUG: Checking key:', key, 'dateStr:', dateStr);
// Skip today since we already added current session data
if(dateStr===todayKey){
console.log('DEBUG: Skipping today\'s key');
keysSkipped++;
continue;
}
if(dateStr.match(/^\d{4}-\d{2}-\d{2}$/)){
// Parse date in local timezone to avoid UTC conversion issues
var parts=dateStr.split('-');
var keyDate=new Date(parseInt(parts[0]),parseInt(parts[1])-1,parseInt(parts[2]));
keyDate.setHours(0,0,0,0);
console.log('DEBUG: Processing key:', key);
console.log('DEBUG:   dateStr:', dateStr);
console.log('DEBUG:   keyDate:', keyDate);
console.log('DEBUG:   keyDate.toISOString():', keyDate.toISOString());
console.log('DEBUG:   cutoffDate:', cutoffDate);
console.log('DEBUG:   today:', today);
console.log('DEBUG:   keyDate.getTime():', keyDate.getTime());
console.log('DEBUG:   cutoffDate.getTime():', cutoffDate.getTime());
console.log('DEBUG:   today.getTime():', today.getTime());
console.log('DEBUG:   keyDate >= cutoffDate?', keyDate >= cutoffDate, '(', keyDate.getTime(), '>=', cutoffDate.getTime(), ')');
console.log('DEBUG:   keyDate <= today?', keyDate <= today, '(', keyDate.getTime(), '<=', today.getTime(), ')');
var passesFilter = true; // TEMPORARILY DISABLED FOR TESTING
console.log('DEBUG:   PASSES FILTER? (FORCED TRUE FOR TESTING)', passesFilter);
if(passesFilter){
keysProcessed++;
console.log('DEBUG: Loading data from', key);
var saved=localStorage.getItem(key);
if(saved){
var data=JSON.parse(saved);
console.log('DEBUG: Data loaded, bp entries:', data.bp?data.bp.length:0);
// Add date info to each item - handle both property name formats
if(data.bp){
console.log('DEBUG: Adding',data.bp.length,'BP readings from',key);
data.bp.forEach(function(item){
item._date=dateStr;
allBP.push(item);
});
console.log('DEBUG: allBP.length is now',allBP.length);
}else{
console.log('DEBUG: No bp property in data for key',key);
console.log('DEBUG: Data properties:',Object.keys(data));
}
if(data.weight){
data.weight.forEach(function(item){
item._date=dateStr;
allWeight.push(item);
});
}
if(data.symptoms){
data.symptoms.forEach(function(item){
item._date=dateStr;
allSymptoms.push(item);
});
}
if(data.activities){
data.activities.forEach(function(item){
item._date=dateStr;
allActivities.push(item);
});
}
if(data.meals){
data.meals.forEach(function(item){
item._date=dateStr;
allMeals.push(item);
});
}
if(data.medLog){
data.medLog.forEach(function(item){
item._date=dateStr;
allMedicines.push(item);
});
}
if(data.notes){
data.notes.forEach(function(item){
item._date=dateStr;
allNotes.push(item);
});
}
}
}
}
}
// ALSO check for old data- format (backward compatibility)
else if(key&&key.startsWith('data-')){
var dateStr2=key.replace('data-','');
if(dateStr2===todayKey)continue;
if(dateStr2.match(/^\d{4}-\d{2}-\d{2}$/)){
// Parse date in local timezone to avoid UTC conversion issues
var parts2=dateStr2.split('-');
var keyDate2=new Date(parseInt(parts2[0]),parseInt(parts2[1])-1,parseInt(parts2[2]));
keyDate2.setHours(0,0,0,0);
if(keyDate2>=cutoffDate&&keyDate2<=today){
var saved2=localStorage.getItem(key);
if(saved2){
var data2=JSON.parse(saved2);
// Old format used capital letters B, W, S, A, M
if(data2.B){
data2.B.forEach(function(item){
item._date=dateStr2;
allBP.push(item);
});
}
if(data2.W){
data2.W.forEach(function(item){
item._date=dateStr2;
allWeight.push(item);
});
}
if(data2.S){
data2.S.forEach(function(item){
item._date=dateStr2;
allSymptoms.push(item);
});
}
if(data2.A){
data2.A.forEach(function(item){
item._date=dateStr2;
allActivities.push(item);
});
}
if(data2.M){
data2.M.forEach(function(item){
item._date=dateStr2;
allMeals.push(item);
});
}
if(data2.medLog){
data2.medLog.forEach(function(item){
item._date=dateStr2;
allMedicines.push(item);
});
}
if(data2.notes){
data2.notes.forEach(function(item){
item._date=dateStr2;
allNotes.push(item);
});
}
}
}
}
}
}
}catch(e){
console.error('Failed to load historical data:',e);
}
console.log('===== LOCALSTORAGE SCAN SUMMARY =====');
console.log('Keys found:', typeof keysFound !== 'undefined' ? keysFound : 'N/A');
console.log('Keys processed (within date range):', typeof keysProcessed !== 'undefined' ? keysProcessed : 'N/A');
console.log('Keys skipped (today):', typeof keysSkipped !== 'undefined' ? keysSkipped : 'N/A');
console.log('Total BP readings in allBP array:', allBP.length);
// Filter procedures within date range
var allProcedures=[];
if(procedures&&procedures.length>0){
procedures.forEach(function(proc){
if(proc.timestamp){
var procDate=new Date(proc.timestamp);
procDate.setHours(0,0,0,0);
if(procDate>=cutoffDate&&procDate<=today){
allProcedures.push(proc);
}
}
});
}
console.log('Historical data loaded:',allBP.length,'BP readings,',allWeight.length,'weight entries,',allProcedures.length,'procedures');
return{bp:allBP,weight:allWeight,symptoms:allSymptoms,activities:allActivities,meals:allMeals,medicines:allMedicines,notes:allNotes,procedures:allProcedures};
}

function getFilteredData(){
if(dateFilterMode==='today'){
return{bp:B,weight:W,symptoms:S,activities:A,meals:M,medicines:medLog,notes:notes,procedures:procedures||[]};
}else{
return getAllHistoricalData();
}
}

function refreshAllDisplays(){
showBP();
showWeight();
showSymptoms();
showActivities();
showMeals();
showMedicines();
showNotes();
renderBPChart();
renderRateDetector();
renderWeightChart();
renderSymptomChart();
renderActivityChart();
showTodayZone(); // keep daily summary in sync
}

function openSettings(){
var html='<div class="modal-title">Settings & Configuration</div>';

// Phase 1: Patient Profile Section
html+='<div class="settings-section">';
html+='<div class="settings-section-title"><span>üë§</span><span>Patient Profile</span></div>';
html+='<label class="settings-label">Patient Name</label>';
html+='<input type="text" id="settingPatientName" class="settings-input" value="'+(settings.patientName||'')+'" placeholder="Enter patient name" />';
html+='<label class="settings-label">Date of Birth</label>';
html+='<input type="date" id="settingDOB" class="settings-input" value="'+(settings.dateOfBirth||'')+'" />';
html+='<label class="settings-label">Cardiac Conditions (select all that apply)</label>';
html+='<div class="condition-grid" id="conditionGrid">';
var conditionCategories={
'Heart Function & Structure':[
'Congestive Heart Failure (CHF)',
'Diastolic Dysfunction',
'Systolic Dysfunction',
'Cardiomyopathy',
'Heart Valve Disease'
],
'Rhythm Disorders':[
'Atrial Fibrillation (AFib)',
'Arrhythmia/Palpitations',
'Sick Sinus Syndrome (SSS)',
'Bradycardia',
'Tachycardia'
],
'Coronary & Vascular':[
'Coronary Artery Disease (CAD)',
'Peripheral Artery Disease (PAD)',
'Venous Insufficiency',
'History of TIA/Stroke'
],
'Blood Pressure & Metabolic':[
'Hypertension (HTN)',
'Postprandial Hypotension',
'Orthostatic Hypotension',
'Dyslipidemia',
'Diabetes Type 2',
'Obstructive Sleep Apnea (OSA)',
'Other'
]
};
for(var category in conditionCategories){
html+='<div class="condition-category">'+category+'</div>';
conditionCategories[category].forEach(function(c){
var isSelected=(settings.conditions||[]).indexOf(c)>=0;
html+='<button class="condition-btn'+(isSelected?' selected':'')+'" onclick="toggleConditionBtn(this,\''+c.replace(/'/g,"\\'")+'\')"">'+c+'</button>';
});
}
html+='</div>';

// Custom Conditions section
html+='<div id="customConditionsSection" style="margin-top:16px;padding:16px;background:#f9fafb;border-radius:8px;border:2px dashed #d1d5db">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px;color:#374151">‚úèÔ∏è Custom Conditions (up to 5)</label>';
html+='<div id="customConditionsList">';
var customConds=settings.customConditions||[];
for(var ci=0;ci<customConds.length;ci++){
var isCustomSelected=(settings.conditions||[]).indexOf(customConds[ci])>=0;
html+='<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px" data-custom-idx="'+ci+'">';
html+='<button class="condition-btn'+(isCustomSelected?' selected':'')+'" style="flex:1;margin:0" onclick="toggleConditionBtn(this,\''+customConds[ci].replace(/'/g,"\\'")+'\')"">'+customConds[ci]+'</button>';
html+='<button onclick="removeCustomCondition('+ci+')" style="background:#ef4444;color:white;border:none;border-radius:6px;padding:6px 12px;font-size:14px;font-weight:600;cursor:pointer" title="Remove">‚úï</button>';
html+='</div>';
}
html+='</div>';
if(customConds.length<5){
html+='<div style="display:flex;gap:8px;margin-top:8px">';
html+='<input type="text" id="newCustomCondition" class="modal-input" placeholder="Type a custom condition..." style="flex:1;margin:0;font-size:16px" maxlength="60" onkeydown="if(event.key===\'Enter\')addCustomCondition()">';
html+='<button onclick="addCustomCondition()" style="background:#10b981;color:white;border:none;border-radius:8px;padding:10px 16px;font-size:16px;font-weight:600;cursor:pointer;white-space:nowrap">+ Add</button>';
html+='</div>';
}else{
html+='<div style="text-align:center;color:#6b7280;font-size:14px;margin-top:8px">Maximum 5 custom conditions reached</div>';
}
html+='</div>';

html+='</div>';

// Original Settings Section
html+='<div class="settings-section">';
html+='<div class="settings-section-title"><span>‚öôÔ∏è</span><span>App Settings</span></div>';
html+='<div style="margin-bottom:20px">';
html+='<label style="display:block;font-size:18px;font-weight:600;margin-bottom:8px">üíß Daily Fluid Tracking Mode</label>';
html+='<p style="font-size:14px;color:#6b7280;margin-bottom:12px">Select the mode your doctor has prescribed. If no recommendation has been made, choose General Tracking.</p>';
var fMode=settings.fluidMode||'range';
html+='<div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px">';
html+='<label style="display:flex;align-items:flex-start;padding:14px;border:2px solid '+(fMode==='none'?'#3b82f6':'#e2e8f0')+';border-radius:10px;background:'+(fMode==='none'?'#eff6ff':'white')+';cursor:pointer;gap:12px">';
html+='<input type="radio" name="fluidMode" value="none" '+(fMode==='none'?'checked':'')+' style="margin-top:3px;width:18px;height:18px" onchange="updateFluidModeUI()">';
html+='<div><div style="font-size:17px;font-weight:600">üìä General Tracking Only</div><div style="font-size:13px;color:#6b7280;margin-top:2px">No daily target ‚Äî just track what you drink. Good for establishing a baseline before your doctor sets a goal.</div></div>';
html+='</label>';
html+='<label style="display:flex;align-items:flex-start;padding:14px;border:2px solid '+(fMode==='maximum'?'#3b82f6':'#e2e8f0')+';border-radius:10px;background:'+(fMode==='maximum'?'#eff6ff':'white')+';cursor:pointer;gap:12px">';
html+='<input type="radio" name="fluidMode" value="maximum" '+(fMode==='maximum'?'checked':'')+' style="margin-top:3px;width:18px;height:18px" onchange="updateFluidModeUI()">';
html+='<div><div style="font-size:17px;font-weight:600">üö´ Daily Maximum (Do Not Exceed)</div><div style="font-size:13px;color:#6b7280;margin-top:2px">For CHF, kidney disease, or fluid overload history. App alerts you as you approach the ceiling.</div></div>';
html+='</label>';
html+='<label style="display:flex;align-items:flex-start;padding:14px;border:2px solid '+(fMode==='range'?'#3b82f6':'#e2e8f0')+';border-radius:10px;background:'+(fMode==='range'?'#eff6ff':'white')+';cursor:pointer;gap:12px">';
html+='<input type="radio" name="fluidMode" value="range" '+(fMode==='range'?'checked':'')+' style="margin-top:3px;width:18px;height:18px" onchange="updateFluidModeUI()">';
html+='<div><div style="font-size:17px;font-weight:600">‚ÜîÔ∏è Daily Range (Min & Max)</div><div style="font-size:13px;color:#6b7280;margin-top:2px">For PPH, dysautonomia, or when your doctor set both a minimum and maximum intake goal.</div></div>';
html+='</label>';
html+='</div>';
html+='<div id="fluidMaxSection" style="display:'+(fMode==='none'?'none':'block')+'">';
html+='<div style="display:flex;gap:12px">';
html+='<div id="fluidMinWrapper" style="flex:1;display:'+(fMode==='range'?'block':'none')+'">';
html+='<label style="display:block;font-size:14px;color:#6b7280;margin-bottom:4px">Minimum (oz)</label>';
html+='<input type="number" id="settingFluidMin" class="modal-input" value="'+settings.fluidMin+'" placeholder="Min" />';
html+='</div>';
html+='<div style="flex:1">';
html+='<label style="display:block;font-size:14px;color:#6b7280;margin-bottom:4px">'+(fMode==='maximum'?'Maximum (oz) ‚Äî Do Not Exceed':'Maximum (oz)')+'</label>';
html+='<input type="number" id="settingFluidMax" class="modal-input" value="'+settings.fluidMax+'" placeholder="Max" />';
html+='</div>';
html+='</div>';
html+='</div>';
html+='</div>';
html+='<div style="margin-bottom:20px">';
html+='<label style="display:block;font-size:18px;font-weight:600;margin-bottom:8px">Systolic Range</label>';
html+='<div style="display:flex;gap:12px">';
html+='<input type="number" id="settingSysMin" class="modal-input" placeholder="Min" value="'+settings.systolicMin+'" style="flex:1" />';
html+='<input type="number" id="settingSysMax" class="modal-input" placeholder="Max" value="'+settings.systolicMax+'" style="flex:1" />';
html+='</div>';
html+='</div>';
html+='<div style="margin-bottom:20px">';
html+='<label style="display:block;font-size:18px;font-weight:600;margin-bottom:8px">Diastolic Range</label>';
html+='<div style="display:flex;gap:12px">';
html+='<input type="number" id="settingDiaMin" class="modal-input" placeholder="Min" value="'+settings.diastolicMin+'" style="flex:1" />';
html+='<input type="number" id="settingDiaMax" class="modal-input" placeholder="Max" value="'+settings.diastolicMax+'" style="flex:1" />';
html+='</div>';
html+='</div>';
html+='<div style="margin-bottom:20px">';
html+='<label style="display:block;font-size:18px;font-weight:600;margin-bottom:8px">Heart Rate Range</label>';
html+='<div style="display:flex;gap:12px">';
html+='<input type="number" id="settingHrMin" class="modal-input" placeholder="Min" value="'+settings.hrMin+'" style="flex:1" />';
html+='<input type="number" id="settingHrMax" class="modal-input" placeholder="Max" value="'+settings.hrMax+'" style="flex:1" />';
html+='</div>';
html+='</div>';
html+='</div>'; // Close App Settings section

// Phase 2: Feature Toggles Section
html+='<div class="settings-section">';
html+='<div class="settings-section-title"><span>üìã</span><span>Tracking Features</span></div>';
html+='<p style="font-size:16px;color:#64748b;margin-bottom:16px">Enable features prescribed by your doctor:</p>';
html+='<div style="display:flex;flex-direction:column;gap:12px">';
html+='<label style="display:flex;align-items:center;padding:14px;border:2px solid #e2e8f0;border-radius:10px;background:white;cursor:pointer">';
html+='<input type="checkbox" id="featureWeight" style="width:20px;height:20px;margin-right:12px;cursor:pointer" '+(settings.features&&settings.features.weight?'checked':'')+' />';
html+='<span style="font-size:18px;font-weight:600">‚öñÔ∏è Weight Monitoring</span>';
html+='</label>';
html+='<label style="display:flex;align-items:center;padding:14px;border:2px solid #e2e8f0;border-radius:10px;background:white;cursor:pointer">';
html+='<input type="checkbox" id="featureSymptoms" style="width:20px;height:20px;margin-right:12px;cursor:pointer" '+(settings.features&&settings.features.symptoms?'checked':'')+' />';
html+='<span style="font-size:18px;font-weight:600">üíä Symptom Tracking</span>';
html+='</label>';
html+='<label style="display:flex;align-items:center;padding:14px;border:2px solid #e2e8f0;border-radius:10px;background:white;cursor:pointer">';
html+='<input type="checkbox" id="featureExercise" style="width:20px;height:20px;margin-right:12px;cursor:pointer" '+(settings.features&&settings.features.exercise?'checked':'')+' />';
html+='<span style="font-size:18px;font-weight:600">üèÉ Physical Activity/Exercise</span>';
html+='</label>';
html+='</div>';

// Weight Settings (only show if weight is enabled)
html+='<div id="weightSettingsSection" style="margin-top:20px;display:'+(settings.features&&settings.features.weight?'block':'none')+'">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Preferred Weight Unit</label>';
html+='<div style="display:flex;gap:12px;margin-bottom:16px">';
var weightUnit=settings.weightUnit||'lbs';
html+='<button type="button" onclick="selectSettingWeightUnit(\'lbs\')" id="settingUnitLbs" class="modal-btn" style="flex:1;'+(weightUnit==='lbs'?'background:#3b82f6;color:#fff':'')+'">lbs</button>';
html+='<button type="button" onclick="selectSettingWeightUnit(\'kg\')" id="settingUnitKg" class="modal-btn" style="flex:1;'+(weightUnit==='kg'?'background:#3b82f6;color:#fff':'')+'">kg</button>';
html+='</div>';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Weight Change Alert Threshold (lbs)</label>';
html+='<input type="number" id="settingWeightThreshold" class="modal-input" value="'+(settings.weightAlertThreshold||3)+'" step="0.5" placeholder="3.0" />';
html+='<p style="font-size:14px;color:#64748b;margin-top:4px">Alert when weight changes by this amount or more</p>';
html+='</div>';

html+='</div>';

// OS Notifications Section
html+='<div class="settings-section" style="border-left-color:#3b82f6">';
html+='<div class="settings-section-title"><span>üîî</span><span>OS Notifications</span></div>';
html+='<p style="font-size:16px;color:#64748b;margin-bottom:12px">Enable system-level alerts that appear even when you\'re watching a video, on another tab, or have ClinBridge in the background. <strong>Strongly recommended for all users.</strong></p>';

// iOS Safari detection ‚Äî show plain-language install-to-Home-Screen instruction
(function(){
  var isIOS=/iPhone|iPad|iPod/i.test(navigator.userAgent);
  var isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  var notifUnsupported=!('Notification' in window);
  if(isIOS&&(isSafari||notifUnsupported)){
    html+='<div style="background:#fef3c7;border-left:4px solid #f59e0b;padding:14px 16px;border-radius:8px;margin-bottom:14px;font-size:15px;line-height:1.6;color:#78350f">';
    html+='<strong>üì± iPhone &amp; iPad Users:</strong> When ClinBridge is open, event alerts will appear as a <strong>red pop-up on screen with a chime</strong> ‚Äî this works now without any setup.';
    html+='<br><br>For alerts when ClinBridge is in the background or another app is open, install to your Home Screen: tap the <strong>Share ‚¨Ü</strong> button in Safari ‚Üí <strong>"Add to Home Screen"</strong> ‚Üí reopen from the Home Screen icon.';
    html+='</div>';
  }
})();

// Build badge inline at render time ‚Äî uses getNotifStatus() which checks both
// Notification.permission AND localStorage backup for file:// URL reliability
(function(){
  var perm=getNotifStatus();
  var map={
    granted:    {text:'‚úÖ Enabled ‚Äî alerts will appear even on other tabs', bg:'#d1fae5', border:'#10b981', color:'#065f46'},
    denied:     {text:'üö´ Blocked ‚Äî tap below for instructions to fix this', bg:'#fee2e2', border:'#ef4444', color:'#991b1b'},
    default:    {text:'‚ö™ Not yet enabled ‚Äî tap the button below to activate', bg:'#fef3c7', border:'#f59e0b', color:'#92400e'},
    unsupported:{text:'‚ö†Ô∏è Not supported in this browser ‚Äî use Chrome or Edge', bg:'#f3f4f6', border:'#9ca3af', color:'#374151'}
  };
  var s=map[perm]||map.unsupported;
  html+='<div id="notifPermBadge" style="padding:12px 16px;border-radius:8px;border-left:4px solid '+s.border+';background:'+s.bg+';color:'+s.color+';font-size:15px;font-weight:600;margin-bottom:12px">'+s.text+'</div>';
  var showBtn=(perm!=='granted'&&perm!=='unsupported');
  html+='<button id="notifPermBtn" type="button" onclick="showNotifPrePrompt()" style="width:100%;padding:16px;background:#3b82f6;color:#fff;border:none;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;margin-top:4px;display:'+(showBtn?'block':'none')+'">üîî Enable OS Notifications</button>';
  html+='<button id="notifOffBtn" type="button" onclick="disableOSNotifications()" style="width:100%;padding:14px;background:#6b7280;color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-top:8px;display:'+(perm==='granted'?'block':'none')+'">üîï Turn Off Notifications</button>';
})();
html+='</div>';

// Phase 6A: Daily Schedule & Events Section
html+='<div class="settings-section">';
html+='<div class="settings-section-title"><span>üìÖ</span><span>Daily Schedule & Events</span></div>';
html+='<p style="font-size:16px;color:#64748b;margin-bottom:16px">Define your daily routine for personalized tracking and reminders</p>';
html+='<div style="margin-bottom:20px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:12px">Quick Start Templates:</label>';
html+='<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">';
html+='<button type="button" onclick="loadEventTemplate(\'standard\')" class="modal-btn" style="font-size:14px">üìã Standard</button>';
html+='<button type="button" onclick="loadEventTemplate(\'meal\')" class="modal-btn" style="font-size:14px">üçΩÔ∏è Meal-Based</button>';
html+='<button type="button" onclick="loadEventTemplate(\'medication\')" class="modal-btn" style="font-size:14px">üíä Medication</button>';
html+='<button type="button" onclick="loadEventTemplate(\'athletic\')" class="modal-btn" style="font-size:14px">üèÉ Athletic</button>';
html+='<button type="button" onclick="loadEventTemplate(\'shift\')" class="modal-btn" style="font-size:14px">üåô Shift Work</button>';
html+='<button type="button" onclick="loadEventTemplate(\'custom\')" class="modal-btn" style="font-size:14px">‚úèÔ∏è Custom</button>';
html+='</div>';
html+='</div>';
html+='<div style="margin-bottom:20px">';
html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">';
html+='<label style="font-size:16px;font-weight:600">Your Daily Events:</label>';
html+='<button type="button" onclick="addDailyEvent()" class="modal-btn" style="background:#10b981;color:white;padding:8px 16px;font-size:14px">+ Add Event</button>';
html+='</div>';
html+='<div id="dailyEventsList" style="max-height:300px;overflow-y:auto"></div>';
html+='</div>';
html+='</div>';

// NEW: Custom Physical Activities Section
if(settings.features&&settings.features.exercise){
html+='<div class="settings-section">';
html+='<div class="settings-section-title"><span>üèÉ</span><span>Custom Physical Activities</span></div>';
html+='<p style="font-size:16px;color:#64748b;margin-bottom:16px">Add your own activity types for more personalized tracking</p>';

html+='<div style="margin-bottom:20px">';
html+='<label style="font-size:16px;font-weight:600;margin-bottom:12px;display:block">Default Activities</label>';
html+='<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px">';
defaultActivityTypes.forEach(function(activity){
html+='<div style="padding:8px 14px;background:#e5e7eb;border-radius:6px;font-size:14px;color:#374151">'+activity+'</div>';
});
html+='</div>';
html+='<p style="font-size:14px;color:#6b7280;margin-bottom:16px">These default activities cannot be edited or removed</p>';
html+='</div>';

html+='<div style="margin-bottom:20px">';
html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">';
html+='<label style="font-size:16px;font-weight:600">Your Custom Activities:</label>';
html+='<button type="button" onclick="addCustomActivity()" class="modal-btn" style="background:#10b981;color:white;padding:8px 16px;font-size:14px">+ Add Activity</button>';
html+='</div>';

if(!settings.customActivities||settings.customActivities.length===0){
html+='<div id="customActivitiesList" style="padding:20px;background:#f9fafb;border-radius:8px;text-align:center;color:#6b7280">No custom activities yet. Click "+ Add Activity" to create your own!</div>';
}else{
html+='<div id="customActivitiesList" style="display:flex;flex-direction:column;gap:8px">';
settings.customActivities.forEach(function(activity,index){
html+='<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:white;border:1px solid #e5e7eb;border-radius:8px">';
html+='<span style="font-size:16px;font-weight:500">'+activity+'</span>';
html+='<div style="display:flex;gap:8px">';
html+='<button onclick="editCustomActivity('+index+')" style="background:#3b82f6;color:white;border:none;border-radius:6px;padding:6px 12px;font-size:14px;cursor:pointer">‚úèÔ∏è Edit</button>';
html+='<button onclick="deleteCustomActivity('+index+')" style="background:#ef4444;color:white;border:none;border-radius:6px;padding:6px 12px;font-size:14px;cursor:pointer">‚úï Delete</button>';
html+='</div>';
html+='</div>';
});
html+='</div>';
}
html+='</div>';
html+='</div>';
}

// Contact & Feedback Section
html+='<div class="settings-section">';
html+='<div class="settings-section-title"><span>üì±</span><span>Contact & Feedback</span></div>';
html+='<p style="font-size:16px;color:#64748b;margin-bottom:16px">Questions or suggestions about ClinBridge?</p>';
html+='<div style="background:#f8fafc;border:2px solid #e2e8f0;border-radius:12px;padding:20px;margin-bottom:16px">';
html+='<div style="text-align:center;margin-bottom:16px">';
html+='<div style="font-size:16px;font-weight:600;color:#475569;margin-bottom:8px">Text Message</div>';
html+='<div style="font-size:24px;font-weight:bold;color:#0ea5e9;letter-spacing:1px">(469) 607-9896</div>';
html+='</div>';
html+='<button onclick="openSMSContact()" class="modal-btn" style="background:#0ea5e9;color:white;font-size:18px">üì± Send Text Message</button>';
html+='</div>';
html+='<p style="font-size:14px;color:#64748b;text-align:center">For bugs and feature requests, please use <a href="https://github.com/yourusername/bp-tracker/issues" target="_blank" style="color:#0ea5e9;text-decoration:underline">GitHub Issues</a></p>';
html+='</div>';

html+='<div class="modal-actions"><button class="modal-cancel" onclick="hideModal()">Cancel</button><button class="modal-ok" onclick="saveSettings()">Save</button></div>';
showModal(html);

// Initialize weight unit selection
settingWeightUnit=settings.weightUnit||'lbs';

// Add event listener for weight feature toggle
setTimeout(function(){
var weightCheckbox=document.getElementById('featureWeight');
var weightSettings=document.getElementById('weightSettingsSection');
if(weightCheckbox&&weightSettings){
weightCheckbox.addEventListener('change',function(){
weightSettings.style.display=this.checked?'block':'none';
});
}
},100);
// Phase 6A: Render daily events list after DOM is ready
setTimeout(function(){
renderDailyEventsList();
},150);
}

function saveSettings(){
// Phase 1: Save patient profile
settings.patientName=document.getElementById('settingPatientName').value||'';
settings.dateOfBirth=document.getElementById('settingDOB').value||'';
// Conditions are saved via toggleConditionBtn

// Phase 2: Save feature toggles
if(!settings.features)settings.features={};
settings.features.weight=document.getElementById('featureWeight').checked;
settings.features.symptoms=document.getElementById('featureSymptoms').checked;
settings.features.exercise=document.getElementById('featureExercise').checked;

// Phase 2: Save weight-specific settings
if(document.getElementById('settingWeightThreshold')){
settings.weightAlertThreshold=parseFloat(document.getElementById('settingWeightThreshold').value)||3;
}
// Weight unit is saved via selectSettingWeightUnit

// Original settings
settings.fluidMin=parseInt(document.getElementById('settingFluidMin').value)||40;
settings.fluidMax=parseInt(document.getElementById('settingFluidMax').value)||64;
var fluidModeEl=document.querySelector('input[name="fluidMode"]:checked');
settings.fluidMode=fluidModeEl?fluidModeEl.value:'range';
settings.systolicMin=parseInt(document.getElementById('settingSysMin').value)||90;
settings.systolicMax=parseInt(document.getElementById('settingSysMax').value)||140;
settings.diastolicMin=parseInt(document.getElementById('settingDiaMin').value)||60;
settings.diastolicMax=parseInt(document.getElementById('settingDiaMax').value)||90;
settings.hrMin=parseInt(document.getElementById('settingHrMin').value)||60;
settings.hrMax=parseInt(document.getElementById('settingHrMax').value)||100;
try{
localStorage.setItem('BP_TRACKER_SETTINGS',JSON.stringify(settings));
}catch(e){
console.error('Failed to save settings');
}
completeAndCloseModal();
applyFeatureVisibility();
updateFluid();
showBP();
showWeight();
showSymptoms();
renderBPChart();
renderWeightChart();
renderSymptomChart();
renderFluidChart();
showSaveNotification();
}

var settingWeightUnit='lbs';

function selectSettingWeightUnit(unit){
settingWeightUnit=unit;
settings.weightUnit=unit;
document.getElementById('settingUnitLbs').style.background=unit==='lbs'?'#3b82f6':'#e5e7eb';
document.getElementById('settingUnitLbs').style.color=unit==='lbs'?'#fff':'#000';
document.getElementById('settingUnitKg').style.background=unit==='kg'?'#3b82f6':'#e5e7eb';
document.getElementById('settingUnitKg').style.color=unit==='kg'?'#fff':'#000';
}

function applyFeatureVisibility(){
// Show/hide weight button and card based on settings
if(settings.features&&settings.features.weight){
document.getElementById('weightBtn').style.display='block';
document.getElementById('weightCard').style.display='block';
}else{
document.getElementById('weightBtn').style.display='none';
document.getElementById('weightCard').style.display='none';
}
// Show/hide symptom button and card based on settings
if(settings.features&&settings.features.symptoms){
document.getElementById('symptomBtn').style.display='block';
document.getElementById('symptomCard').style.display='block';
}else{
document.getElementById('symptomBtn').style.display='none';
document.getElementById('symptomCard').style.display='none';
}
// Show/hide activity button and card based on settings
if(settings.features&&settings.features.exercise){
document.getElementById('activityBtn').style.display='block';
document.getElementById('activityCard').style.display='block';
}else{
document.getElementById('activityBtn').style.display='none';
document.getElementById('activityCard').style.display='none';
}
}

function showSaveNotification(){
var notif=document.getElementById('saveNotification');
if(notif){
notif.style.display='block';
setTimeout(function(){notif.style.display='none';},3000);
}else{
alert('‚úì Settings saved');
}
}

function toggleConditionBtn(btn,condition){
if(!settings.conditions)settings.conditions=[];
var idx=settings.conditions.indexOf(condition);
if(idx>=0){
settings.conditions.splice(idx,1);
btn.classList.remove('selected');
}else{
settings.conditions.push(condition);
btn.classList.add('selected');
}
}

function loadSettings(){
try{
var saved=localStorage.getItem('BP_TRACKER_SETTINGS');
if(saved){
var loaded=JSON.parse(saved);
settings.fluidMin=loaded.fluidMin||40;
settings.fluidMax=loaded.fluidMax||64;
settings.fluidMode=loaded.fluidMode||'range';
settings.systolicMin=loaded.systolicMin||90;
settings.systolicMax=loaded.systolicMax||140;
settings.diastolicMin=loaded.diastolicMin||60;
settings.diastolicMax=loaded.diastolicMax||90;
settings.hrMin=loaded.hrMin||60;
settings.hrMax=loaded.hrMax||100;
// Phase 1: Load patient profile
settings.patientName=loaded.patientName||'';
settings.dateOfBirth=loaded.dateOfBirth||'';
settings.conditions=loaded.conditions||[];
settings.customConditions=loaded.customConditions||[];
settings.features=loaded.features||settings.features;
settings.reportPreferences=loaded.reportPreferences||settings.reportPreferences;
settings.dailyEvents=loaded.dailyEvents||[];
settings.customSymptoms=loaded.customSymptoms||[];
}
}catch(e){
console.error('Failed to load settings');
}
}

// ================== PHASE 6A: DAILY SCHEDULE & EVENTS ==================
// Event templates and management system

// Phase 6B: Helper function to generate event dropdown
function getEventDropdownHTML(selectedEventId){
if(!settings.dailyEvents||settings.dailyEvents.length===0){
return ''; // No events defined, return empty
}
let html='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px;color:#374151">Related Event (Optional)</label>';
html+='<select id="eventSelect" class="modal-input" style="font-size:16px">';
html+='<option value="">-- Select Event --</option>';
settings.dailyEvents.forEach(evt=>{
const selected=evt.id===selectedEventId?' selected':'';
html+='<option value="'+evt.id+'"'+selected+'>'+evt.icon+' '+evt.name+(evt.time?' ('+evt.time+')':'')+'</option>';
});
html+='</select>';
html+='</div>';
return html;
}

function getEventById(eventId){
if(!eventId||!settings.dailyEvents)return null;
return settings.dailyEvents.find(evt=>evt.id===eventId);
}

// NEW: Get recent activities (within last 2 hours) for BP linking
function getRecentActivities(){
var recentActivities=[];
var now=new Date();
var currentTime=now.getHours()*60+now.getMinutes();
var twoHoursAgo=currentTime-120;

// Get today's activities
A.forEach(activity=>{
if(!activity.t)return;
var timeParts=activity.t.split(':');
var activityMinutes=parseInt(timeParts[0])*60+parseInt(timeParts[1]);
// Check if within last 2 hours
if(activityMinutes>=twoHoursAgo&&activityMinutes<=currentTime){
recentActivities.push(activity);
}
});

return recentActivities.sort((a,b)=>{
var aTime=a.t.split(':');
var bTime=b.t.split(':');
return (parseInt(bTime[0])*60+parseInt(bTime[1]))-(parseInt(aTime[0])*60+parseInt(aTime[1]));
});
}

// NEW: Get activity dropdown HTML for BP modal
function getActivityDropdownHTML(selectedActivityId,selectedTiming){
if(!settings.features||!settings.features.exercise){
return ''; // Exercise feature not enabled
}
var recentActivities=getRecentActivities();
if(recentActivities.length===0){
return ''; // No recent activities
}
let html='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px;color:#374151">Related Physical Activity (Optional)</label>';
html+='<select id="activitySelect" class="modal-input" style="font-size:16px" onchange="toggleActivityTiming()">';
html+='<option value="">-- Select Activity --</option>';
recentActivities.forEach(act=>{
const selected=act.id===selectedActivityId?' selected':'';
var timeAgo=getTimeAgo(act.t);
html+='<option value="'+act.id+'"'+selected+'>'+act.activity+' ('+act.t+' - '+timeAgo+')</option>';
});
html+='</select>';
html+='</div>';
// Activity timing selection (before/after)
html+='<div id="activityTimingDiv" style="margin-bottom:16px;display:none">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px;color:#374151">BP Timing</label>';
html+='<div style="display:flex;gap:12px">';
html+='<button type="button" id="timingBefore" onclick="selectActivityTiming(\'before\')" style="flex:1;padding:18px;border:3px solid #bfdbfe;border-radius:12px;font-size:20px;font-weight:600;cursor:pointer;background:#eff6ff;color:#1e3a8a;transition:all 0.2s">üìä Before Activity</button>';
html+='<button type="button" id="timingAfter" onclick="selectActivityTiming(\'after\')" style="flex:1;padding:18px;border:3px solid #bbf7d0;border-radius:12px;font-size:20px;font-weight:600;cursor:pointer;background:#f0fdf4;color:#166534;transition:all 0.2s">üìà After Activity</button>';
html+='</div>';
html+='</div>';
return html;
}

// NEW: Helper to calculate time ago
function getTimeAgo(timeStr){
var now=new Date();
var currentMinutes=now.getHours()*60+now.getMinutes();
var timeParts=timeStr.split(':');
var activityMinutes=parseInt(timeParts[0])*60+parseInt(timeParts[1]);
var diffMinutes=currentMinutes-activityMinutes;
if(diffMinutes<60)return diffMinutes+' min ago';
var hours=Math.floor(diffMinutes/60);
var mins=diffMinutes%60;
return hours+'h '+(mins>0?mins+'m':'')+'ago';
}

// NEW: Get activity by ID
function getActivityById(activityId){
if(!activityId)return null;
return A.find(act=>act.id===activityId);
}

// NEW: Toggle activity timing display
var selectedActivityTiming='';
function toggleActivityTiming(){
var sel=document.getElementById('activitySelect');
var timingDiv=document.getElementById('activityTimingDiv');
if(sel&&sel.value){
timingDiv.style.display='block';
}else{
timingDiv.style.display='none';
selectedActivityTiming='';
}
}

function selectActivityTiming(timing){
selectedActivityTiming=timing;
var btnBefore=document.getElementById('timingBefore');
var btnAfter=document.getElementById('timingAfter');
if(!btnBefore||!btnAfter)return;
// Reset both to unselected state
btnBefore.style.background='#eff6ff';
btnBefore.style.color='#1e3a8a';
btnBefore.style.borderColor='#bfdbfe';
btnBefore.innerHTML='üìä Before Activity';
btnAfter.style.background='#f0fdf4';
btnAfter.style.color='#166534';
btnAfter.style.borderColor='#bbf7d0';
btnAfter.innerHTML='üìà After Activity';
// Apply selected state with checkmark
if(timing==='before'){
btnBefore.style.background='#1e40af';
btnBefore.style.color='#fff';
btnBefore.style.borderColor='#1e3a8a';
btnBefore.innerHTML='‚úì Before Activity';
}else{
btnAfter.style.background='#166534';
btnAfter.style.color='#fff';
btnAfter.style.borderColor='#14532d';
btnAfter.innerHTML='‚úì After Activity';
}
}

function getEventTemplates(){
return{
standard:[
{name:'Wake Up',icon:'‚òÄÔ∏è',time:'06:00',fluidGoal:12,reminderEnabled:true},
{name:'Morning',icon:'üåÖ',time:'09:00',fluidGoal:8,reminderEnabled:true},
{name:'Afternoon',icon:'‚òÄÔ∏è',time:'14:00',fluidGoal:8,reminderEnabled:true},
{name:'Evening',icon:'üåÜ',time:'18:00',fluidGoal:8,reminderEnabled:true},
{name:'Bedtime',icon:'üåô',time:'22:00',fluidGoal:6,reminderEnabled:true}
],
meal:[
{name:'Wake Up',icon:'‚òÄÔ∏è',time:'06:00',fluidGoal:12,reminderEnabled:true},
{name:'Breakfast',icon:'üç≥',time:'07:30',fluidGoal:8,reminderEnabled:true},
{name:'Morning Snack',icon:'üçé',time:'10:00',fluidGoal:6,reminderEnabled:false},
{name:'Lunch',icon:'ü•ó',time:'12:30',fluidGoal:8,reminderEnabled:true},
{name:'Afternoon Snack',icon:'üç™',time:'15:00',fluidGoal:6,reminderEnabled:false},
{name:'Dinner',icon:'üçΩÔ∏è',time:'18:30',fluidGoal:8,reminderEnabled:true},
{name:'Evening Snack',icon:'üçø',time:'20:00',fluidGoal:4,reminderEnabled:false},
{name:'Bedtime',icon:'üåô',time:'22:00',fluidGoal:6,reminderEnabled:true}
],
medication:[
{name:'Morning Medications',icon:'üíä',time:'06:00',fluidGoal:8,reminderEnabled:true},
{name:'Noon Medications',icon:'üíä',time:'12:00',fluidGoal:8,reminderEnabled:true},
{name:'Evening Medications',icon:'üíä',time:'18:00',fluidGoal:8,reminderEnabled:true},
{name:'Bedtime Medications',icon:'üíä',time:'22:00',fluidGoal:8,reminderEnabled:true}
],
athletic:[
{name:'Morning',icon:'üåÖ',time:'06:00',fluidGoal:12,reminderEnabled:true},
{name:'Pre-Workout',icon:'üèÉ',time:'08:00',fluidGoal:10,reminderEnabled:true},
{name:'Post-Workout',icon:'üíß',time:'10:00',fluidGoal:12,reminderEnabled:true},
{name:'Recovery',icon:'üßò',time:'14:00',fluidGoal:8,reminderEnabled:true},
{name:'Evening',icon:'üåÜ',time:'18:00',fluidGoal:8,reminderEnabled:true},
{name:'Bedtime',icon:'üåô',time:'22:00',fluidGoal:6,reminderEnabled:true}
],
shift:[
{name:'Clock In',icon:'üïê',time:'',fluidGoal:8,reminderEnabled:true},
{name:'Break 1',icon:'‚òï',time:'',fluidGoal:6,reminderEnabled:true},
{name:'Lunch',icon:'üçΩÔ∏è',time:'',fluidGoal:8,reminderEnabled:true},
{name:'Break 2',icon:'‚òï',time:'',fluidGoal:6,reminderEnabled:true},
{name:'Clock Out',icon:'üè†',time:'',fluidGoal:8,reminderEnabled:true},
{name:'Sleep Prep',icon:'üåô',time:'',fluidGoal:6,reminderEnabled:true}
],
custom:[]
};
}

function loadEventTemplate(templateName){
const templates=getEventTemplates();
const template=templates[templateName]||[];
if(templateName==='custom'){
if(confirm('Clear all events and start fresh?')){
settings.dailyEvents=[];
renderDailyEventsList();
}
return;
}
const message=settings.dailyEvents.length>0?'This will replace your current events. Continue?':'Load the '+templateName+' template?';
if(confirm(message)){
settings.dailyEvents=template.map((evt,idx)=>({
id:'evt_'+(Date.now()+idx),
name:evt.name,
icon:evt.icon,
time:evt.time,
fluidGoal:evt.fluidGoal,
reminderEnabled:evt.reminderEnabled,
order:idx+1
}));
renderDailyEventsList();
}
}

function renderDailyEventsList(){
const listEl=document.getElementById('dailyEventsList');
if(!listEl)return;
if(settings.dailyEvents.length===0){
listEl.innerHTML='<div style="padding:20px;text-align:center;color:#9ca3af;background:#f9fafb;border-radius:8px;border:2px dashed #e5e7eb">No events defined yet. Use a template or add your own!</div>';
return;
}
// Sort by order
settings.dailyEvents.sort((a,b)=>a.order-b.order);
let html='';
settings.dailyEvents.forEach((evt,idx)=>{
html+='<div style="padding:12px;background:#f9fafb;border:2px solid #e5e7eb;border-radius:8px;margin-bottom:8px">';
html+='<div style="display:flex;justify-content:space-between;align-items:center">';
html+='<div style="flex:1">';
html+='<div style="font-size:18px;font-weight:600;color:#111827">'+evt.icon+' '+evt.name+'</div>';
html+='<div style="font-size:13px;color:#6b7280;margin-top:4px">';
if(evt.time)html+='Time: '+evt.time+' ‚Ä¢ ';
if(evt.fluidGoal)html+='Fluid: '+evt.fluidGoal+' oz ‚Ä¢ ';
html+='Reminder: '+(evt.reminderEnabled?'‚úì On':'‚úó Off');
html+='</div>';
html+='</div>';
html+='<div style="display:flex;gap:6px">';
html+='<button onclick="moveEvent('+idx+',\'up\')" style="background:#6b7280;color:#fff;border:none;border-radius:6px;padding:6px 10px;font-size:16px;cursor:pointer" '+(idx===0?'disabled':'')+'>‚Üë</button>';
html+='<button onclick="moveEvent('+idx+',\'down\')" style="background:#6b7280;color:#fff;border:none;border-radius:6px;padding:6px 10px;font-size:16px;cursor:pointer" '+(idx===settings.dailyEvents.length-1?'disabled':'')+'>‚Üì</button>';
html+='<button onclick="editDailyEvent('+idx+')" style="background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:14px;cursor:pointer">‚úèÔ∏è</button>';
html+='<button onclick="deleteDailyEvent('+idx+')" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 12px;font-size:14px;cursor:pointer">‚úï</button>';
html+='</div>';
html+='</div>';
html+='</div>';
});
listEl.innerHTML=html;
}

function moveEvent(idx,direction){
if(direction==='up'&&idx>0){
const temp=settings.dailyEvents[idx];
settings.dailyEvents[idx]=settings.dailyEvents[idx-1];
settings.dailyEvents[idx-1]=temp;
}else if(direction==='down'&&idx<settings.dailyEvents.length-1){
const temp=settings.dailyEvents[idx];
settings.dailyEvents[idx]=settings.dailyEvents[idx+1];
settings.dailyEvents[idx+1]=temp;
}
// Update order numbers
settings.dailyEvents.forEach((evt,i)=>evt.order=i+1);
renderDailyEventsList();
}

function addDailyEvent(){
showEventEditor(-1,{
id:'evt_'+Date.now(),
name:'',
icon:'üìÖ',
time:'',
fluidGoal:8,
reminderEnabled:true,
order:settings.dailyEvents.length+1
});
}

function editDailyEvent(idx){
showEventEditor(idx,settings.dailyEvents[idx]);
}

function deleteDailyEvent(idx){
if(confirm('Delete this event?')){
settings.dailyEvents.splice(idx,1);
// Update order numbers
settings.dailyEvents.forEach((evt,i)=>evt.order=i+1);
renderDailyEventsList();
}
}

function showEventEditor(idx,evt){
const isNew=idx===-1;
const iconOptions=['‚òÄÔ∏è','üåÖ','üåÜ','üåô','üç≥','ü•ó','üçΩÔ∏è','üçé','üç™','üçø','üíä','üèÉ','üíß','üßò','‚òï','üïê','üè†','üìÖ','‚è∞','üìä','üíâ','ü©∫','üè•'];
let html='<div style="max-width:500px;margin:0 auto">';
html+='<div class="modal-title">'+(isNew?'Add New Event':'Edit Event')+'</div>';
html+='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Event Name</label>';
html+='<input type="text" id="eventName" class="modal-input" value="'+evt.name+'" placeholder="e.g., Breakfast" />';
html+='</div>';
html+='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Icon</label>';
html+='<div style="display:grid;grid-template-columns:repeat(8,1fr);gap:6px">';
iconOptions.forEach(icon=>{
html+='<button type="button" onclick="selectEventIcon(\''+icon+'\')" class="event-icon-btn" data-icon="'+icon+'" style="padding:8px;background:'+(evt.icon===icon?'#3b82f6':'#f3f4f6')+';color:'+(evt.icon===icon?'#fff':'#000')+';border:2px solid #e5e7eb;border-radius:6px;font-size:20px;cursor:pointer">'+icon+'</button>';
});
html+='</div>';
html+='<input type="hidden" id="eventIcon" value="'+evt.icon+'" />';
html+='</div>';
html+='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Time (Optional)</label>';
html+='<input type="time" id="eventTime" class="modal-input" value="'+evt.time+'" />';
html+='<p style="font-size:13px;color:#6b7280;margin-top:4px">Leave empty for flexible timing</p>';
html+='</div>';
html+='<div style="margin-bottom:16px">';
html+='<label style="display:block;font-size:16px;font-weight:600;margin-bottom:8px">Fluid Goal (oz)</label>';
html+='<input type="number" id="eventFluidGoal" class="modal-input" value="'+(evt.fluidGoal||'')+'" placeholder="8" />';
html+='</div>';
html+='<div style="margin-bottom:16px">';
html+='<label style="display:flex;align-items:center;cursor:pointer">';
html+='<input type="checkbox" id="eventReminder" style="width:20px;height:20px;margin-right:10px;cursor:pointer" '+(evt.reminderEnabled?'checked':'')+' />';
html+='<span style="font-size:16px;font-weight:600">Enable Reminder</span>';
html+='</label>';
html+='</div>';
html+=renderEventActionCheckboxes(evt.actions||['logFluid']);
html+='<div class="modal-actions">';
html+='<button class="modal-cancel" onclick="renderDailyEventsList();hideModal();openSettings()">Cancel</button>';
html+='<button class="modal-ok" onclick="saveEventEditor('+idx+',\''+evt.id+'\')">Save</button>';
html+='</div>';
html+='</div>';
showModal(html);
}

function selectEventIcon(icon){
document.getElementById('eventIcon').value=icon;
document.querySelectorAll('.event-icon-btn').forEach(btn=>{
btn.style.background=btn.dataset.icon===icon?'#3b82f6':'#f3f4f6';
btn.style.color=btn.dataset.icon===icon?'#fff':'#000';
});
}

function saveEventEditor(idx,eventId){
const name=document.getElementById('eventName').value.trim();
if(!name){
alert('Please enter an event name');
return;
}
const eventData={
id:eventId,
name:name,
icon:document.getElementById('eventIcon').value,
time:document.getElementById('eventTime').value,
fluidGoal:parseInt(document.getElementById('eventFluidGoal').value)||0,
reminderEnabled:document.getElementById('eventReminder').checked,
actions:collectSelectedActions(),
order:idx===-1?settings.dailyEvents.length+1:settings.dailyEvents[idx].order
};
if(idx===-1){
settings.dailyEvents.push(eventData);
}else{
settings.dailyEvents[idx]=eventData;
}
completeAndCloseModal();
openSettings();
}

// NEW: Custom Activity Management Functions
function addCustomActivity(){
var activityName=prompt('Enter custom activity name:');
if(!activityName||!activityName.trim()){
return;
}
activityName=activityName.trim();
// Check if already exists
if(!settings.customActivities)settings.customActivities=[];
if(defaultActivityTypes.includes(activityName)){
alert('This activity already exists in the default list');
return;
}
if(settings.customActivities.includes(activityName)){
alert('This custom activity already exists');
return;
}
settings.customActivities.push(activityName);
saveSettings();
openSettings();
alert('‚úì Custom activity "'+activityName+'" added!');
}

function editCustomActivity(index){
if(!settings.customActivities||!settings.customActivities[index]){
return;
}
var currentName=settings.customActivities[index];
var newName=prompt('Edit activity name:',currentName);
if(!newName||!newName.trim()){
return;
}
newName=newName.trim();
if(newName===currentName){
return; // No change
}
// Check if new name conflicts
if(defaultActivityTypes.includes(newName)){
alert('This activity name conflicts with a default activity');
return;
}
if(settings.customActivities.includes(newName)){
alert('This custom activity name already exists');
return;
}
settings.customActivities[index]=newName;
saveSettings();
openSettings();
alert('‚úì Activity renamed to "'+newName+'"');
}

function deleteCustomActivity(index){
if(!settings.customActivities||!settings.customActivities[index]){
return;
}
var activityName=settings.customActivities[index];
if(!confirm('Delete custom activity "'+activityName+'"?\n\nNote: Existing activity logs will not be deleted.')){
return;
}
settings.customActivities.splice(index,1);
saveSettings();
openSettings();
alert('‚úì Custom activity "'+activityName+'" deleted');
}

// NEW: Open activity manager modal (from Log Activity screen)
function openActivityManager(){
var customActivities=settings.customActivities||[];
if(customActivities.length===0){
alert('No custom activities yet. Use "‚ûï Add New Activity..." to create one.');
return;
}

var html='<div class="modal-title">Manage Custom Activities</div>';
html+='<p style="color:#6b7280;font-size:16px;margin-bottom:16px">Edit or delete your custom activities. Default activities cannot be modified.</p>';

html+='<div style="display:flex;flex-direction:column;gap:12px">';
customActivities.forEach(function(activity,index){
html+='<div style="display:flex;justify-content:space-between;align-items:center;padding:16px;background:#f9fafb;border:2px solid #e5e7eb;border-radius:8px">';
html+='<span style="font-size:18px;font-weight:600;color:#374151">'+activity+'</span>';
html+='<div style="display:flex;gap:8px">';
html+='<button onclick="editCustomActivityFromModal('+index+')" style="background:#3b82f6;color:white;border:none;border-radius:6px;padding:8px 16px;font-size:14px;font-weight:600;cursor:pointer">‚úèÔ∏è Edit</button>';
html+='<button onclick="deleteCustomActivityFromModal('+index+')" style="background:#ef4444;color:white;border:none;border-radius:6px;padding:8px 16px;font-size:14px;font-weight:600;cursor:pointer">‚úï Delete</button>';
html+='</div>';
html+='</div>';
});
html+='</div>';

html+='<div class="modal-actions">';
html+='<button class="modal-cancel" onclick="hideModal();logActivity()">Back to Activity</button>';
html+='</div>';

showModal(html);
}

// NEW: Edit activity from manager modal
function editCustomActivityFromModal(index){
if(!settings.customActivities||!settings.customActivities[index]){
return;
}
var currentName=settings.customActivities[index];
var newName=prompt('Edit activity name:',currentName);
if(!newName||!newName.trim()){
return;
}
newName=newName.trim();
if(newName===currentName){
return;
}
// Check conflicts
if(defaultActivityTypes.includes(newName)){
alert('This activity name conflicts with a default activity');
return;
}
if(settings.customActivities.includes(newName)){
alert('This custom activity name already exists');
return;
}
settings.customActivities[index]=newName;
// Save custom activities directly (we're in activity manager modal, not settings)
localStorage.setItem('BP_TRACKER_SETTINGS',JSON.stringify(settings));
openActivityManager(); // Refresh manager
alert('‚úì Activity renamed to "'+newName+'"');
}

// NEW: Delete activity from manager modal
function deleteCustomActivityFromModal(index){
if(!settings.customActivities||!settings.customActivities[index]){
return;
}
var activityName=settings.customActivities[index];
if(!confirm('Delete custom activity "'+activityName+'"?\n\nNote: Existing activity logs will not be deleted.')){
return;
}
settings.customActivities.splice(index,1);
// Save custom activities directly (we're in activity manager modal, not settings)
localStorage.setItem('BP_TRACKER_SETTINGS',JSON.stringify(settings));
if(settings.customActivities.length===0){
// No more custom activities, return to log activity
hideModal();
logActivity();
alert('‚úì Custom activity "'+activityName+'" deleted');
}else{
openActivityManager(); // Refresh manager
alert('‚úì Custom activity "'+activityName+'" deleted');
}
}

// ================== PHASE 6C: SMART REMINDERS ==================
// Event-based reminder system for fluids, medications, and BP readings

function initReminderSystem(){
// Load fired reminders from localStorage
loadFiredReminders();
// Start reminder checking (every minute)
if(reminderCheckInterval){
clearInterval(reminderCheckInterval);
}
reminderCheckInterval=setInterval(checkEventReminders,60000); // Check every minute
// Check immediately on init (after 5 seconds)
setTimeout(checkEventReminders,5000);
console.log('‚úì Reminder system initialized');
}

function loadFiredReminders(){
try{
var today=getTodayKey();
var saved=localStorage.getItem('BP_TRACKER_FIRED_REMINDERS');
if(saved){
firedReminders=JSON.parse(saved);
// Clean old dates (only keep today)
var cleaned={};
if(firedReminders[today]){
cleaned[today]=firedReminders[today];
}
firedReminders=cleaned;
}else{
firedReminders={};
}
// Initialize today if not exists
if(!firedReminders[today]){
firedReminders[today]={};
}
}catch(e){
console.error('Failed to load fired reminders',e);
firedReminders={};
var today=getTodayKey();
firedReminders[today]={};
}
}

function saveFiredReminders(){
try{
localStorage.setItem('BP_TRACKER_FIRED_REMINDERS',JSON.stringify(firedReminders));
}catch(e){
console.error('Failed to save fired reminders',e);
}
}

function checkEventReminders(){
if(!settings.dailyEvents||settings.dailyEvents.length===0)return;
var now=new Date();
var currentTime=now.getHours()*60+now.getMinutes(); // Minutes since midnight
var today=getTodayKey();
// Initialize today's fired reminders
if(!firedReminders[today]){
firedReminders[today]={};
}
settings.dailyEvents.forEach(function(evt){
// Skip if reminder not enabled
if(!evt.reminderEnabled)return;
// Skip if no time set
if(!evt.time)return;
// Parse event time (HH:MM format)
var parts=evt.time.split(':');
if(parts.length!==2)return;
var eventHour=parseInt(parts[0]);
var eventMin=parseInt(parts[1]);
var eventTime=eventHour*60+eventMin;
// Check if it's time for this reminder (within current minute)
var timeDiff=currentTime-eventTime;
if(timeDiff>=0&&timeDiff<1){
// It's time! Check if we haven't fired this reminder yet
var reminderKey=evt.id+'_'+eventHour+'_'+eventMin;
if(!firedReminders[today][reminderKey]){
showEventReminder(evt);
firedReminders[today][reminderKey]=true;
saveFiredReminders();
console.log('‚úì Fired reminder for:',evt.name);
}
}
});
}

function showEventReminder(evt){
// Build reminder content
var reminderParts=[];
if(evt.fluidGoal&&evt.fluidGoal>0){
reminderParts.push('üíß Fluid Goal: <strong>'+evt.fluidGoal+' oz</strong>');
}
reminderParts.push('‚è∞ Time: <strong>'+evt.time+'</strong>');
// Create reminder notification
var html='<div style="background:white;padding:28px;border-radius:16px;max-width:420px;margin:40px auto;border:4px solid #10b981;box-shadow:0 10px 40px rgba(16,185,129,0.3)">';
html+='<div style="font-size:64px;text-align:center;margin-bottom:16px">'+evt.icon+'</div>';
html+='<div style="font-size:28px;font-weight:700;color:#111827;text-align:center;margin-bottom:8px">'+evt.name+'</div>';
html+='<div style="font-size:16px;color:#6b7280;text-align:center;margin-bottom:20px;line-height:1.6">'+reminderParts.join('<br>')+'</div>';

// Determine action buttons: use evt.actions if set (new events),
// else legacy fallback ‚Äî always show logBP + logFluid as the safe default
var actions=[];
if(evt.actions&&evt.actions.length>0){
  actions=evt.actions;
}else{
  // Legacy event (created before actions system): default to the two most
  // time-critical actions for a cardiac patient at any reminder event
  actions=['logBP','logFluid'];
}

// Render action buttons
if(actions.length>0){
  html+='<div style="display:flex;flex-direction:column;gap:10px;margin-bottom:12px">';
  actions.forEach(function(id){
    var def=EVENT_ACTIONS.find(function(a){return a.id===id;});
    if(!def)return;
    // No dismissReminder() ‚Äî notification stays alive and reshows after each log
    html+='<button onclick="'+def.fn+'" style="background:'+def.color+';color:#fff;border:none;padding:14px;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;width:100%">'+def.label+'</button>';
  });
  html+='</div>';
}

// Always-present dismiss button
html+='<button onclick="dismissReminder()" style="width:100%;background:#6b7280;color:white;border:none;padding:14px;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer">‚úì Done ‚Äî Dismiss</button>';
html+='</div>';

// Arm the active reminder BEFORE showModal so hideModal can reshow if needed
// Reset fluid-logged flag only on a fresh event fire (not a reshow)
if(activeReminderEvt!==evt){ eventFluidLogged=false; }
activeReminderEvt=evt;
// Arm the fluid goal ‚Äî only if fluid hasn't already been saved this event session
// (prevents duplicate fluid logging when event has multiple log actions)
pendingEventFluid=(!eventFluidLogged&&evt.fluidGoal&&evt.fluidGoal>0)?evt.fluidGoal:0;
// Fire OS-level notification ‚Äî visible even on other tabs or during video playback
fireOSNotification(
  'üîî '+evt.name,
  (evt.fluidGoal>0?'üíß Fluid goal: '+evt.fluidGoal+' oz  ‚Ä¢  ':'')+'‚è∞ '+evt.time+'  ‚Ä¢  Tap to open ClinBridge',
  'clinbridge-evt-'+evt.id
);
showModal(html);
// Use the same senior-optimized chime as the audio alert box
playMedicalAlertChime();
}

function dismissReminder(){
pendingEventFluid=0;
activeReminderEvt=null; // clear BEFORE hideModal so it doesn't reshow
hideModal();
}

// Use this instead of hideModal() in all save/complete actions so a pending
// event reminder doesn't immediately hijack the close
function completeAndCloseModal(){
// Do NOT clear activeReminderEvt here ‚Äî we want the event reminder to reshow
// after each individual log action so multi-action events work correctly.
// Only dismissReminder() should clear activeReminderEvt.
hideModal();
}

function openSyncBackup(){
var html='<div class="modal-title">üîÑ Device Sync & Backup</div>';
html+='<div style="background:#f0f9ff;border:2px solid #0ea5e9;border-radius:12px;padding:16px;margin-bottom:16px">';
html+='<div style="font-size:16px;color:#0369a1;margin-bottom:12px;font-weight:600">üì± How Device Sync Works</div>';
html+='<div style="font-size:15px;color:#374151;line-height:1.6"><strong>ClinBridge does not sync automatically.</strong> Each device keeps its own separate copy of your data. To move data between devices, you manually export from one and import to the other.<br><br>';
html+='<strong>Recommended:</strong> Pick one device as your primary logging device and use it consistently. Only transfer when needed ‚Äî such as when updating the app or preparing for a doctor appointment.</div>';
html+='</div>';
html+='<div style="background:#f0fdf4;border:1px solid #16a34a;border-radius:8px;padding:12px;font-size:14px;color:#14532d;margin-bottom:16px">';
html+='üìã <strong>Step by step:</strong><br>1. Tap <strong>Export ALL Data</strong> on your current device<br>2. Email the backup file to yourself<br>3. Open the email on your other device<br>4. Open ClinBridge ‚Üí tap <strong>Import All Data</strong><br>5. Your data will be identical on both devices at that moment</div>';
html+='<button onclick="exportAllData()" style="width:100%;background:#7c3aed;color:#fff;border:none;padding:16px;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;margin-bottom:12px">üíæ Export ALL Data<br><span style="font-size:13px;font-weight:400;opacity:0.85">Save a full backup of everything to your device</span></button>';
html+='<button onclick="importAllData()" style="width:100%;background:#059669;color:#fff;border:none;padding:16px;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;margin-bottom:12px">üì• Import All Data<br><span style="font-size:13px;font-weight:400;opacity:0.85">Restore from a backup file ‚Äî replaces current data</span></button>';
html+='<div style="background:#faf5ff;border:2px solid #8b5cf6;border-radius:12px;padding:16px;margin-bottom:16px">';
html+='<div style="font-size:16px;color:#6d28d9;margin-bottom:8px;font-weight:600">üîÆ Coming in a Future Version</div>';
html+='<div style="font-size:15px;color:#374151;line-height:1.6"><strong>Automatic cloud sync is on our roadmap.</strong> A future version of ClinBridge will allow you to create a free account so your data syncs automatically across all your devices in real time ‚Äî no manual exporting needed.<br><br>When that feature launches, your existing data will be fully transferable to the new system. We will announce it clearly in the app before making any changes.</div>';
html+='</div>';
html+='<div style="background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:12px;font-size:13px;color:#92400e;margin-bottom:16px">‚ö†Ô∏è <strong>Tip:</strong> Export regularly to keep a backup. If you clear your browser data, your ClinBridge data will be lost without a backup.</div>';
html+='<div class="modal-actions"><button class="modal-cancel" onclick="hideModal()">Close</button></div>';
showModal(html);
}

function exportAllData(){
var allData={};
for(var i=0;i<localStorage.length;i++){
var key=localStorage.key(i);
allData[key]=localStorage.getItem(key);
}
var json=JSON.stringify(allData,null,2);
var blob=new Blob([json],{type:'application/json'});
var url=URL.createObjectURL(blob);
var a=document.createElement('a');
a.href=url;
a.download='ClinBridge_Backup_'+new Date().toISOString().slice(0,10)+'.json';
a.click();
URL.revokeObjectURL(url);
alert('‚úÖ Backup saved!\n\nEmail this file to yourself, then open ClinBridge on your other device and tap "Device Sync & Backup" ‚Üí "Import All Data".');
}

function importAllData(){
if(!confirm('‚ö†Ô∏è Import All Data\n\nThis will REPLACE all current data on this device with the data from your backup file.\n\nMake sure you are importing the correct file.\n\nDo you want to continue?')){return;}
var input=document.createElement('input');
input.type='file';
input.accept='.json';
input.onchange=function(e){
var file=e.target.files[0];
if(!file)return;
var reader=new FileReader();
reader.onload=function(ev){
try{
var allData=JSON.parse(ev.target.result);
var count=0;
Object.keys(allData).forEach(function(k){
localStorage.setItem(k,allData[k]);
count++;
});
alert('‚úÖ '+count+' items imported successfully!\n\nClinBridge will now reload with your data.');
location.reload();
}catch(err){
alert('‚ùå Import failed. Make sure you selected a valid ClinBridge backup file.');
}
};
reader.readAsText(file);
};
input.click();
}

function exportData(){
if(B.length===0&&M.length===0&&medLog.length===0&&fluidLog.length===0&&notes.length===0){
alert('No data to export');
return;
}

// Create tab-separated format with header (TSV works better for pasting)
var tsv='Date\tType\tTime\tMeal Timing\tSystolic\tDiastolic\tPulse\tBarometric\tPre-Fluid\tDROP_Sys\tDROP_Dia\tFluid_Amount\tMedicine\tNote\n';
var today=new Date().toLocaleDateString('en-US');

// Process BP readings with DROP calculations
for(var i=0;i<B.length;i++){
var timing='';
var dropSys='';
var dropDia='';
var preFluid='';
var barometric='';
var mealType='';
if(B[i].meal){
timing=B[i].meal+' '+B[i].type;
mealType=B[i].meal;
}else if(B[i].type){
timing=B[i].type;
}
if(B[i].f>0){
preFluid=B[i].f;
}
// Calculate DROP values for "post" readings
if(B[i].type==='post'){
// Find the most recent "pre" reading for the same meal
for(var j=i-1;j>=0;j--){
if(B[j].meal===mealType&&B[j].type==='pre'){
dropSys=B[i].s-B[j].s;
dropDia=B[i].d-B[j].d;
break;
}
}
}
tsv+=today+'\tBP\t'+B[i].t+'\t'+timing+'\t'+B[i].s+'\t'+B[i].d+'\t'+B[i].h+'\t'+barometric+'\t'+preFluid+'\t'+dropSys+'\t'+dropDia+'\t\t\t\n';
}

// Process meals
for(var i=0;i<M.length;i++){
tsv+=today+'\tMeal\t'+M[i].t+'\t'+M[i].m+'\t\t\t\t\t\t\t\t\t\t\n';
}

// Process fluid log
for(var i=0;i<fluidLog.length;i++){
tsv+=today+'\tFluid\t'+fluidLog[i].time+'\t\t\t\t\t\t\t\t\t'+fluidLog[i].amount+'\t\t\n';
}

// Process medicines
for(var i=0;i<medLog.length;i++){
tsv+=today+'\tMedicine\t'+medLog[i].time+'\t'+medLog[i].timing+'\t\t\t\t\t\t\t\t\t'+medLog[i].medicine+'\t\n';
}

// Process notes
for(var i=0;i<notes.length;i++){
tsv+=today+'\tNote\t'+notes[i].time+'\t\t\t\t\t\t\t\t\t\t\t'+notes[i].text+'\n';
}

// Copy to clipboard
navigator.clipboard.writeText(tsv).then(function(){
exportedToday=true;
saveDailyData();
alert('‚úì Data copied to clipboard\nReady to paste into spreadsheet');
}).catch(function(err){
console.error('Failed to copy:',err);
alert('Failed to copy to clipboard. Please try again.');
});
}

function renderBPChart(){
if(B.length<2){
document.getElementById('noChartData').style.display='block';
document.getElementById('bpChart').style.display='none';
return;
}
document.getElementById('noChartData').style.display='none';
document.getElementById('bpChart').style.display='block';
var times=[];
var systolic=[];
var diastolic=[];
var hr=[];
for(var i=0;i<B.length;i++){
times.push(B[i].t);
systolic.push(B[i].s);
diastolic.push(B[i].d);
hr.push(B[i].h);
}
var ctx=document.getElementById('bpChart').getContext('2d');
if(bpChart){
bpChart.destroy();
}
bpChart=new Chart(ctx,{
type:'line',
devicePixelRatio:window.devicePixelRatio||1,
data:{
labels:times,
datasets:[
{
label:'Systolic',
data:systolic,
borderColor:'#dc2626',
backgroundColor:'rgba(220,38,38,0.1)',
tension:0.3,
borderWidth:3,
yAxisID:'y'
},
{
label:'Diastolic',
data:diastolic,
borderColor:'#2563eb',
backgroundColor:'rgba(37,99,235,0.1)',
tension:0.3,
borderWidth:3,
yAxisID:'y'
},
{
label:'Heart Rate',
data:hr,
borderColor:'#16a34a',
backgroundColor:'rgba(22,163,74,0.1)',
tension:0.3,
borderWidth:3,
yAxisID:'y1'
}
]
},
options:{
responsive:true,
maintainAspectRatio:false,
interaction:{
mode:'index',
intersect:false
},
plugins:{
legend:{
display:true,
position:'top',
labels:{
font:{size:16},
usePointStyle:true
}
},
tooltip:{
mode:'index',
intersect:false,
titleFont:{size:16},
bodyFont:{size:14}
},
annotation:{
annotations:{
systolicMin:{
type:'line',
yMin:settings.systolicMin,
yMax:settings.systolicMin,
borderColor:'rgba(220,38,38,0.3)',
borderWidth:2,
borderDash:[5,5],
yScaleID:'y'
},
systolicMax:{
type:'line',
yMin:settings.systolicMax,
yMax:settings.systolicMax,
borderColor:'rgba(220,38,38,0.3)',
borderWidth:2,
borderDash:[5,5],
yScaleID:'y'
},
diastolicMin:{
type:'line',
yMin:settings.diastolicMin,
yMax:settings.diastolicMin,
borderColor:'rgba(37,99,235,0.3)',
borderWidth:2,
borderDash:[5,5],
yScaleID:'y'
},
diastolicMax:{
type:'line',
yMin:settings.diastolicMax,
yMax:settings.diastolicMax,
borderColor:'rgba(37,99,235,0.3)',
borderWidth:2,
borderDash:[5,5],
yScaleID:'y'
}
}
}
},
scales:{
y:{
type:'linear',
display:true,
position:'left',
title:{
display:true,
text:'Blood Pressure (mmHg)',
font:{size:14,weight:'bold'}
},
grid:{
color:'rgba(0,0,0,0.05)'
},
ticks:{
font:{size:14}
}
},
y1:{
type:'linear',
display:true,
position:'right',
title:{
display:true,
text:'Heart Rate (BPM)',
font:{size:14,weight:'bold'}
},
grid:{
drawOnChartArea:false
},
ticks:{
font:{size:14}
}
},
x:{
ticks:{
font:{size:14}
},
grid:{
color:'rgba(0,0,0,0.05)'
}
}
}
}
});
}

function renderRateDetector(){
var card=document.getElementById('rateDetectorCard');
if(B.length<2){
if(card)card.style.display='none';
document.getElementById('rateDetectorBars').style.display='none';
document.getElementById('rateDetectorNone').style.display='block';
document.getElementById('hrInsightsPanel').style.display='none';
return;
}
// Filter readings with HR data
var hrReadings=B.filter(function(r){return r.h>0;});
if(hrReadings.length===0){
if(card)card.style.display='none';
document.getElementById('rateDetectorBars').style.display='none';
document.getElementById('rateDetectorNone').style.display='block';
document.getElementById('hrInsightsPanel').style.display='none';
return;
}
if(card)card.style.display='block';
document.getElementById('rateDetectorBars').style.display='flex';
document.getElementById('rateDetectorNone').style.display='none';
document.getElementById('hrInsightsPanel').style.display='block';

var readings=[];
for(var i=0;i<hrReadings.length;i++){
readings.push({time:hrReadings[i].t,hr:hrReadings[i].h,rate:0});
}

// Calculate statistics
var hrs=readings.map(function(r){return r.hr;});
var minHR=Math.min.apply(null,hrs);
var maxHR=Math.max.apply(null,hrs);
var avgHR=hrs.reduce(function(a,b){return a+b;},0)/hrs.length;

// Calculate zones
var lowCount=hrs.filter(function(hr){return hr<60;}).length;
var normalCount=hrs.filter(function(hr){return hr>=60&&hr<=100;}).length;
var highCount=hrs.filter(function(hr){return hr>100;}).length;
var total=hrs.length;

document.getElementById('hrAvg').textContent=avgHR.toFixed(0);
document.getElementById('hrRange').textContent=minHR+' / '+maxHR;
document.getElementById('hrZoneLow').textContent=((lowCount/total)*100).toFixed(0)+'%';
document.getElementById('hrZoneNormal').textContent=((normalCount/total)*100).toFixed(0)+'%';
document.getElementById('hrZoneHigh').textContent=((highCount/total)*100).toFixed(0)+'%';

// Calculate trend (comparing first half vs second half)
var half=Math.floor(hrs.length/2);
var firstHalfAvg=hrs.slice(0,half).reduce(function(a,b){return a+b;},0)/half;
var secondHalfAvg=hrs.slice(half).reduce(function(a,b){return a+b;},0)/(hrs.length-half);
var trendDiff=secondHalfAvg-firstHalfAvg;
var trendIcon='‚Üí';
var trendColor='#6b7280';
var trendText='Stable';
if(trendDiff>3){
trendIcon='‚Üë';
trendColor='#ef4444';
trendText='+'+(trendDiff.toFixed(1))+' BPM';
}else if(trendDiff<-3){
trendIcon='‚Üì';
trendColor='#3b82f6';
trendText=(trendDiff.toFixed(1))+' BPM';
}
document.getElementById('hrTrend').innerHTML='<span style="color:'+trendColor+'">'+trendIcon+'</span>';
document.getElementById('hrTrendText').textContent=trendText;
document.getElementById('hrTrendText').style.color=trendColor;

// Detect alerts
var alerts=[];
if(minHR<50){
alerts.push('Very low heart rate detected ('+minHR+' BPM)');
}
if(maxHR>120){
alerts.push('Very high heart rate detected ('+maxHR+' BPM)');
}
// Check for rapid changes
for(var i=1;i<readings.length;i++){
var change=Math.abs(readings[i].hr-readings[i-1].hr);
if(change>=20){
alerts.push('Rapid HR change: '+readings[i-1].hr+'‚Üí'+readings[i].hr+' BPM at '+readings[i].time);
}
}
// Check for sustained abnormality
if(lowCount>=3||highCount>=3){
if(lowCount>=3)alerts.push('Sustained low HR in '+lowCount+' readings');
if(highCount>=3)alerts.push('Sustained high HR in '+highCount+' readings');
}

if(alerts.length>0){
document.getElementById('hrAlerts').style.display='block';
var alertsHTML='';
for(var i=0;i<alerts.length;i++){
alertsHTML+='<div style="margin-bottom:4px">‚Ä¢ '+alerts[i]+'</div>';
}
document.getElementById('hrAlertsList').innerHTML=alertsHTML;
}else{
document.getElementById('hrAlerts').style.display='none';
}

// Calculate rate of change
for(var i=1;i<readings.length;i++){
readings[i].rate=readings[i].hr-readings[i-1].hr;
}
// Find max absolute rate for scaling
var maxRate=0;
for(var i=0;i<readings.length;i++){
var absRate=Math.abs(readings[i].rate);
if(absRate>maxRate)maxRate=absRate;
}
// Generate bars with improved colors based on zones
var html='';
for(var i=0;i<readings.length;i++){
var r=readings[i];
var absRate=Math.abs(r.rate);
var heightPercent=maxRate>0?(absRate/maxRate)*100:0;
// Color based on HR zone
var barColor='#10b981'; // Normal green
if(r.hr<60)barColor='#3b82f6'; // Low blue
else if(r.hr>100)barColor='#ef4444'; // High red
// Change color intensity based on rate direction
var changeColor=r.rate>0?'#ef4444':'#3b82f6';
// Container
html+='<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end">';
// Change label
if(absRate>0){
html+='<div style="font-size:12px;font-weight:bold;color:'+changeColor+';margin-bottom:4px">'+(r.rate>0?'+':'')+r.rate+'</div>';
}
// HR value with zone color
html+='<div style="font-size:16px;font-weight:700;color:'+barColor+';margin-bottom:2px">'+r.hr+'</div>';
// Bar
if(r.rate!==0){
html+='<div style="width:90%;background:'+changeColor+';height:'+heightPercent+'%;min-height:4px;border-radius:3px 3px 0 0;border:1px solid '+(r.rate>0?'#dc2626':'#2563eb')+';opacity:0.8"></div>';
}else{
html+='<div style="width:90%;height:4px;background:#e5e7eb;border-radius:3px"></div>';
}
// Time label
html+='<div style="font-size:11px;font-weight:600;color:#374151;margin-top:4px">'+r.time.substring(0,5)+'</div>';
html+='</div>';
}
document.getElementById('rateDetectorBars').innerHTML=html;
}

function renderFluidChart(){
// Collect all fluid entries (from BP logs and standalone logs)
// Collect all fluid entries (from BP logs, standalone logs, and meals)
var allFluid=[];

// 1) BP fluid
for (var i = 0; i < B.length; i++) {
  if (B[i].f > 0) {
    allFluid.push({ time: B[i].t, amount: B[i].f });
  }
}

// 2) Standalone fluid entries
for (var j = 0; j < fluidLog.length; j++) {
  if (fluidLog[j].amount > 0) {
    allFluid.push({ time: fluidLog[j].time, amount: fluidLog[j].amount });
  }
}

// 3) Meal fluid (M[k].mealFluidOz)
for (var k = 0; k < M.length; k++) {
  if (M[k].mealFluidOz && M[k].mealFluidOz > 0) {
    allFluid.push({ time: M[k].time || M[k].t, amount: M[k].mealFluidOz });
  }
}

if(allFluid.length===0){
document.getElementById('fluidChart').style.display='none';
document.getElementById('noChartDataFluid').style.display='block';
document.getElementById('fluidProgressCard').style.display='none';
return;
}
document.getElementById('fluidChart').style.display='none';
document.getElementById('noChartDataFluid').style.display='none';
document.getElementById('fluidProgressCard').style.display='block';

    // NEW: show how many fluid entries came from each source
var bpCount = 0;
var mealCount = 0;
var logCount = 0;

for (var i = 0; i < B.length; i++) {
  if (B[i].f && B[i].f > 0) bpCount++;
}
for (var j = 0; j < fluidLog.length; j++) {
  if (fluidLog[j].amount && fluidLog[j].amount > 0) logCount++;
}
for (var k = 0; k < M.length; k++) {
  if (M[k].mealFluidOz && M[k].mealFluidOz > 0) mealCount++;
}

var totalCount = bpCount + mealCount + logCount;
var summaryText = "Fluid entries today: " + totalCount +
  " (" + bpCount + " from BP readings, " +
  mealCount + " from meals, " +
  logCount + " stand-alone logs).";

var summaryDiv = document.getElementById("fluidSourceSummary");
if (summaryDiv) {
  summaryDiv.textContent = summaryText;
}


// Sort by time
    return;
allFluid.sort(function(a,b){return a.time.localeCompare(b.time);});
// Build cumulative data
var times=[];
var cumulative=[];
var running=0;
for(var i=0;i<allFluid.length;i++){
running+=allFluid[i].amount;
times.push(allFluid[i].time);
cumulative.push(running);
}

// Get fluid targets (green zone)
var targets=calculateFluidTargets();

// Build green zone data arrays
var greenZoneMin=[];
var greenZoneMax=[];
var greenZoneTimes=[];

// Interpolate green zone for all time points
targets.forEach(function(target){
greenZoneTimes.push(target.time);
greenZoneMin.push(target.min);
greenZoneMax.push(target.max);
});

// Determine user's status relative to green zone
var currentTime=new Date();
var currentTimeStr=('0'+currentTime.getHours()).slice(-2)+':'+('0'+currentTime.getMinutes()).slice(-2);
var currentMinutes=timeToMinutes(currentTimeStr);
// Find expected range at current time
var expectedMin=0;
var expectedMax=0;
for(var i=0;i<targets.length-1;i++){
var t1Minutes=timeToMinutes(targets[i].time);
var t2Minutes=timeToMinutes(targets[i+1].time);
if(currentMinutes>=t1Minutes&&currentMinutes<=t2Minutes){
// Interpolate
var progress=(currentMinutes-t1Minutes)/(t2Minutes-t1Minutes);
expectedMin=targets[i].min+(targets[i+1].min-targets[i].min)*progress;
expectedMax=targets[i].max+(targets[i+1].max-targets[i].max)*progress;
break;
}
}
if(expectedMax===0&&targets.length>0){
expectedMax=targets[targets.length-1].max;
expectedMin=targets[targets.length-1].min;
}

// Calculate status
var statusText='';
var statusColor='#6b7280';
if(running>=expectedMin&&running<=expectedMax){
statusText='‚úì On Track';
statusColor='#10b981';
}else if(running<expectedMin){
var behind=Math.round(expectedMin-running);
statusText='‚ö† Behind by ~'+behind+' oz';
statusColor='#f59e0b';
}else{
statusText='üéâ Ahead of Schedule';
statusColor='#10b981';
}

// Update progress card
document.getElementById('fluidProgressCard').innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;padding:16px;background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%);border-radius:8px;border:2px solid #bae6fd"><div><div style="font-size:14px;color:#0369a1;font-weight:600;margin-bottom:4px">Total Fluid Intake</div><div style="font-size:32px;font-weight:700;color:'+statusColor+'">'+running+' oz</div><div style="font-size:14px;color:'+statusColor+';font-weight:600">'+statusText+'</div></div><div style="text-align:right"><div style="font-size:14px;color:#0369a1;margin-bottom:4px">Target Range</div><div style="font-size:20px;font-weight:700;color:#6b7280">'+Math.round(expectedMin)+'-'+Math.round(expectedMax)+' oz</div><div style="font-size:12px;color:#6b7280">at current time</div></div></div>';

var ctx=document.getElementById('fluidChart').getContext('2d');
if(fluidChart){
fluidChart.destroy();
}

// Create gradient for actual intake line
var gradient=ctx.createLinearGradient(0,0,0,400);
gradient.addColorStop(0,'rgba(20,184,166,0.3)');
gradient.addColorStop(1,'rgba(20,184,166,0.05)');

fluidChart=new Chart(ctx,{
type:'line',
devicePixelRatio:window.devicePixelRatio||1,
data:{
labels:times,
datasets:[
// Green zone max boundary
{
label:'Target Maximum',
data:greenZoneMax.map(function(val,idx){
var time=greenZoneTimes[idx];
return{x:time,y:val};
}),
borderColor:'rgba(16,185,129,0.4)',
backgroundColor:'transparent',
fill:'+1',
tension:0.3,
borderWidth:2,
pointRadius:0,
borderDash:[5,5]
},
// Green zone min boundary
{
label:'Target Minimum',
data:greenZoneMin.map(function(val,idx){
var time=greenZoneTimes[idx];
return{x:time,y:val};
}),
borderColor:'rgba(16,185,129,0.4)',
backgroundColor:'rgba(16,185,129,0.15)',
fill:false,
tension:0.3,
borderWidth:2,
pointRadius:0,
borderDash:[5,5]
},
// User's actual intake
{
label:'Your Actual Intake',
data:cumulative,
borderColor:'#14b8a6',
backgroundColor:gradient,
fill:true,
tension:0.4,
borderWidth:3,
pointRadius:6,
pointHoverRadius:8,
pointBackgroundColor:'#fff',
pointBorderColor:'#14b8a6',
pointBorderWidth:2,
pointHoverBackgroundColor:'#14b8a6',
pointHoverBorderColor:'#fff',
pointHoverBorderWidth:3
}
]
},
options:{
responsive:true,
maintainAspectRatio:false,
interaction:{
mode:'index',
intersect:false
},
layout:{
padding:{
top:10,
bottom:5,
left:5,
right:5
}
},
plugins:{
legend:{
display:true,
position:'top',
labels:{
font:{size:14,weight:'600'},
usePointStyle:true,
padding:12,
color:'#374151',
filter:function(item){
// Show all legend items
return true;
}
}
},
tooltip:{
mode:'index',
intersect:false,
backgroundColor:'rgba(0,0,0,0.8)',
titleFont:{size:16,weight:'bold'},
bodyFont:{size:14},
padding:12,
cornerRadius:8,
displayColors:true,
callbacks:{
title:function(tooltipItems){
return 'Time: '+tooltipItems[0].label;
},
label:function(context){
if(context.datasetIndex===2){
// Actual intake
var idx=context.dataIndex;
var added=idx<allFluid.length?allFluid[idx].amount:0;
return 'Total: '+context.parsed.y.toFixed(1)+' oz (added: '+added+' oz)';
}else{
// Target lines
var label=context.dataset.label||'';
return label+': '+context.parsed.y.toFixed(1)+' oz';
}
}
}
}
},
scales:{
y:{
beginAtZero:true,
max:Math.max(settings.fluidMax+10,running+10),
grid:{
color:'rgba(0,0,0,0.06)',
lineWidth:1
},
ticks:{
font:{size:14,weight:'500'},
color:'#6b7280',
callback:function(value){
return value+' oz';
}
},
title:{
display:true,
text:'Fluid Intake (oz)',
font:{size:16,weight:'bold'},
color:'#374151',
padding:{top:0,bottom:10}
}
},
x:{
type:'category',
ticks:{
font:{size:13,weight:'500'},
color:'#6b7280',
maxRotation:45,
minRotation:0
},
grid:{
color:'rgba(0,0,0,0.04)',
display:true
},
title:{
display:true,
text:'Time of Day',
font:{size:14,weight:'600'},
color:'#374151',
padding:{top:10,bottom:0}
}
}
},
animation:{
duration:800,
easing:'easeInOutQuart'
}
}
});
}

// ========================================
// HR RATE DETECTOR IMPLEMENTATION
// ========================================

var hrChart=null;

function openHRDetector(){
const hrReadings=B.filter(r=>r.h && r.h>0).map(r=>({...r,hr:r.h}));
if(hrReadings.length===0){
alert('No heart rate data available. Please add blood pressure readings with heart rate measurements.');
return;
}
document.getElementById('hrDetectorModal').style.display='block';
setTimeout(()=>analyzeHeartRate(hrReadings),50);
}

function closeHRDetector(){
document.getElementById('hrDetectorModal').style.display='none';
if(hrChart){
hrChart.destroy();
hrChart=null;
}
}

function switchHRTab(tabName){
// Hide all sections
document.getElementById('hr-section-quick-stats').style.display='none';
document.getElementById('hr-section-medication').style.display='none';

// Remove active class from all tabs
document.getElementById('tab-quick-stats').classList.remove('active');
document.getElementById('tab-medication').classList.remove('active');

// Show selected section and activate tab
document.getElementById('hr-section-'+tabName).style.display='block';
document.getElementById('tab-'+tabName).classList.add('active');

// === PHASE 2: Populate medication tab when opened ===
if(tabName==='medication'){
setHRMedPeriod('today'); // Initialize with today's data
}
}

function calculateHRStats(readings){
const hrs=readings.map(r=>r.hr).filter(hr=>hr>0);
if(hrs.length===0)return null;
const min=Math.min(...hrs);
const max=Math.max(...hrs);
const avg=hrs.reduce((a,b)=>a+b,0)/hrs.length;
const range=max-min;
const variance=hrs.reduce((sum,hr)=>sum+Math.pow(hr-avg,2),0)/hrs.length;
const stdDev=Math.sqrt(variance);
const cv=(stdDev/avg)*100;
return{min,max,avg,range,stdDev,cv};
}

function calculateTimeInZones(readings){
const zones={
bradycardia:0,
normal:0,
tachycardia:0
};
readings.forEach(r=>{
if(r.hr<60)zones.bradycardia++;
else if(r.hr<=100)zones.normal++;
else zones.tachycardia++;
});
const total=readings.length;
return{
bradycardia:{count:zones.bradycardia,percent:(zones.bradycardia/total*100).toFixed(1)},
normal:{count:zones.normal,percent:(zones.normal/total*100).toFixed(1)},
tachycardia:{count:zones.tachycardia,percent:(zones.tachycardia/total*100).toFixed(1)}
};
}

function detectPatterns(readings){
const patterns=[];
const severeBrady=readings.filter(r=>r.hr<50);
if(severeBrady.length>0){
patterns.push({
type:'severe_bradycardia',
severity:'high',
count:severeBrady.length,
readings:severeBrady
});
}
for(let i=1;i<readings.length;i++){
const change=Math.abs(readings[i].hr-readings[i-1].hr);
if(change>=20){
patterns.push({
type:'rapid_change',
severity:'medium',
from:readings[i-1].hr,
to:readings[i].hr,
change:change,
timestamp:readings[i].t
});
}
}
let abnormalStreak=0;
let streakStart=-1;
for(let i=0;i<readings.length;i++){
const hr=readings[i].hr;
if(hr<60||hr>100){
if(abnormalStreak===0)streakStart=i;
abnormalStreak++;
}else{
if(abnormalStreak>=3){
patterns.push({
type:'sustained_abnormality',
severity:'medium',
duration:abnormalStreak,
startTime:readings[streakStart].t,
endTime:readings[i-1].t
});
}
abnormalStreak=0;
}
}
if(abnormalStreak>=3){
patterns.push({
type:'sustained_abnormality',
severity:'medium',
duration:abnormalStreak,
startTime:readings[streakStart].t,
endTime:readings[readings.length-1].t
});
}
return patterns;
}

function correlateWithContext(hrReading,meals,medications){
const hrTime=new Date(hrReading.t);
const correlations=[];
meals.forEach(meal=>{
const mealTime=new Date(meal.t);
const diffMinutes=(hrTime-mealTime)/(1000*60);
if(diffMinutes>=0&&diffMinutes<=60){
correlations.push({
type:'meal',
event:meal.meal,
minutesAfter:Math.round(diffMinutes),
relevance:hrReading.hr<60?'high':'medium'
});
}
});
medications.forEach(med=>{
const medTime=new Date(med.time);
const diffMinutes=(hrTime-medTime)/(1000*60);
if(diffMinutes>=0&&diffMinutes<=60){
correlations.push({
type:'medication',
event:med.medicine+(med.dose?' ('+med.dose+')':''),
minutesAfter:Math.round(diffMinutes),
relevance:'high'
});
}
});
return correlations;
}

function analyzeHeartRate(readings){
const sortedReadings=[...readings].sort((a,b)=>new Date(a.t)-new Date(b.t));
const stats=calculateHRStats(sortedReadings);
const timeInZone=calculateTimeInZones(sortedReadings);
const patterns=detectPatterns(sortedReadings);
displayHRStats(stats);
displayTimeInZone(timeInZone);
displayPatterns(patterns);
displayContext(sortedReadings);
createHRChart(sortedReadings);
}

function displayHRStats(stats){
// Quick Stats Grid (new enhanced version)
const quickGrid=document.getElementById('hrQuickStatsGrid');

// Get today's readings - B already contains only today's data, so no date filter needed
const todaysReadings=B.filter(r=>r.h&&r.h>0);
const todaysLow=todaysReadings.length>0?Math.min(...todaysReadings.map(r=>r.h)):null;
const todaysHigh=todaysReadings.length>0?Math.max(...todaysReadings.map(r=>r.h)):null;

// Get last reading if no today readings
let displayLabel='Today\'s Range';
let displayValue='‚Äî';
let displayUnit='0 readings';

if(todaysLow&&todaysHigh){
displayValue=todaysLow+'-'+todaysHigh;
displayUnit=todaysReadings.length+' reading'+(todaysReadings.length!==1?'s':'');
}else{
// B only has today's data, so check if we have any readings at all
const allTodayReadings=B.filter(r=>r.h&&r.h>0);
if(allTodayReadings.length>0){
// We have readings from today (earlier today)
const sortedToday=allTodayReadings.sort((a,b)=>{
// t is in HH:MM format, convert to comparable number
const getMinutes=time=>{const[h,m]=time.split(':');return parseInt(h)*60+parseInt(m);};
return getMinutes(b.t)-getMinutes(a.t);
});
const lastReading=sortedToday[0];
displayLabel='Last Reading';
displayValue=lastReading.h;
displayUnit='Today '+lastReading.t;
}else{
// No readings at all today - would need to check previous days
// For now just show no data
displayValue='‚Äî';
displayUnit='No data today';
}
}

// Determine status
const avgHR=stats.avg;
let status='No Data';
let statusColor='#6b7280';
if(avgHR>0){
if(avgHR>=60&&avgHR<=100){
status='Controlled';
statusColor='#22c55e';
}else if(avgHR>100){
status='Elevated';
statusColor='#dc2626';
}else{
status='Low';
statusColor='#f59e0b';
}
}

quickGrid.innerHTML=`
<div class="hr-stat-card">
<div class="hr-stat-label">7-Day Average</div>
<div class="hr-stat-value">${stats.avg.toFixed(0)}</div>
<div class="hr-stat-unit">bpm</div>
</div>
<div class="hr-stat-card">
<div class="hr-stat-label">${displayLabel}</div>
<div class="hr-stat-value" style="font-size:22px">${displayValue}</div>
<div class="hr-stat-unit">${displayUnit}</div>
</div>
<div class="hr-stat-card">
<div class="hr-stat-label">Status</div>
<div style="display:inline-block;background:${statusColor};color:white;padding:6px 14px;border-radius:6px;font-size:18px;font-weight:bold;margin:6px 0">${status}</div>
<div class="hr-stat-unit">Target: 60-100</div>
</div>
`;

// Original detailed stats grid (keep for backward compatibility)
const grid=document.getElementById('hrStatsGrid');
if(grid){
grid.innerHTML=`
<div class="stat-card">
<div class="stat-label">Minimum HR</div>
<div class="stat-value">${stats.min.toFixed(0)}</div>
<div class="stat-label">BPM</div>
</div>
<div class="stat-card">
<div class="stat-label">Average HR</div>
<div class="stat-value">${stats.avg.toFixed(1)}</div>
<div class="stat-label">BPM</div>
</div>
<div class="stat-card">
<div class="stat-label">Maximum HR</div>
<div class="stat-value">${stats.max.toFixed(0)}</div>
<div class="stat-label">BPM</div>
</div>
<div class="stat-card">
<div class="stat-label">HR Range</div>
<div class="stat-value">${stats.range.toFixed(0)}</div>
<div class="stat-label">BPM</div>
</div>
<div class="stat-card">
<div class="stat-label">Std Deviation</div>
<div class="stat-value">${stats.stdDev.toFixed(1)}</div>
<div class="stat-label">BPM</div>
</div>
<div class="stat-card">
<div class="stat-label">Coefficient of Variation</div>
<div class="stat-value">${stats.cv.toFixed(1)}%</div>
<div class="stat-label"></div>
</div>
`;
}
}

function displayTimeInZone(timeInZone){
const panel=document.getElementById('timeInZonePanel');
const bradyWidth=parseFloat(timeInZone.bradycardia.percent);
const normalWidth=parseFloat(timeInZone.normal.percent);
const tachyWidth=parseFloat(timeInZone.tachycardia.percent);
panel.innerHTML=`
<div style="background:white;padding:20px;border-radius:12px;border:1px solid #e5e7eb">
<h3 style="margin:0 0 15px 0;color:#111827">Time-in-Zone Analysis</h3>
<div class="zone-bar">
${bradyWidth>0?`<div class="zone-segment" style="width:${bradyWidth}%;background:#dc2626">${timeInZone.bradycardia.percent}%</div>`:''}
${normalWidth>0?`<div class="zone-segment" style="width:${normalWidth}%;background:#22c55e">${timeInZone.normal.percent}%</div>`:''}
${tachyWidth>0?`<div class="zone-segment" style="width:${tachyWidth}%;background:#f97316">${timeInZone.tachycardia.percent}%</div>`:''}
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:15px">
<div>
<div style="font-weight:600;color:#dc2626">Bradycardia (&lt;60)</div>
<div style="color:#6b7280">${timeInZone.bradycardia.count} readings</div>
</div>
<div>
<div style="font-weight:600;color:#22c55e">Normal (60-100)</div>
<div style="color:#6b7280">${timeInZone.normal.count} readings</div>
</div>
<div>
<div style="font-weight:600;color:#f97316">Tachycardia (&gt;100)</div>
<div style="color:#6b7280">${timeInZone.tachycardia.count} readings</div>
</div>
</div>
</div>
`;
}

function displayPatterns(patterns){
const panel=document.getElementById('patternsPanel');
if(patterns.length===0){
panel.innerHTML=`
<div style="background:white;padding:20px;border-radius:12px;border:1px solid #e5e7eb">
<h3 style="margin:0 0 15px 0;color:#111827">Pattern Detection</h3>
<p style="color:#6b7280">No significant patterns detected.</p>
</div>
`;
return;
}
let html=`
<div style="background:white;padding:20px;border-radius:12px;border:1px solid #e5e7eb">
<h3 style="margin:0 0 15px 0;color:#111827">Pattern Detection</h3>
`;
patterns.forEach(p=>{
const severityClass=p.severity==='high'?'pattern-high':(p.severity==='medium'?'pattern-medium':'pattern-low');
html+=`<div class="pattern-item ${severityClass}">`;
if(p.type==='severe_bradycardia'){
html+=`<div style="font-weight:600;color:#111827">‚ö†Ô∏è Severe Bradycardia</div>
<div style="color:#6b7280;margin-top:5px">${p.count} episode${p.count>1?'s':''} of HR &lt;50 BPM detected</div>`;
}else if(p.type==='rapid_change'){
html+=`<div style="font-weight:600;color:#111827">üìà Rapid Heart Rate Change</div>
<div style="color:#6b7280;margin-top:5px">HR changed from ${p.from} to ${p.to} BPM (Œî${p.change})</div>
<div style="color:#6b7280;font-size:14px">Time: ${new Date(p.timestamp).toLocaleString()}</div>`;
}else if(p.type==='sustained_abnormality'){
html+=`<div style="font-weight:600;color:#111827">‚è±Ô∏è Sustained Abnormality</div>
<div style="color:#6b7280;margin-top:5px">${p.duration} consecutive abnormal readings</div>
<div style="color:#6b7280;font-size:14px">Period: ${new Date(p.startTime).toLocaleTimeString()} - ${new Date(p.endTime).toLocaleTimeString()}</div>`;
}
html+=`</div>`;
});
html+=`</div>`;
panel.innerHTML=html;
}

function displayContext(readings){
const panel=document.getElementById('contextPanel');
const correlations=[];
readings.forEach(r=>{
const corr=correlateWithContext(r,M,medLog);
if(corr.length>0){
correlations.push({
reading:r,
correlations:corr
});
}
});
if(correlations.length===0){
panel.innerHTML=`
<div style="background:white;padding:20px;border-radius:12px;border:1px solid #e5e7eb">
<h3 style="margin:0 0 15px 0;color:#111827">Medical Context Correlations</h3>
<p style="color:#6b7280">No significant correlations with meals or medications found.</p>
</div>
`;
return;
}
let html=`
<div style="background:white;padding:20px;border-radius:12px;border:1px solid #e5e7eb">
<h3 style="margin:0 0 15px 0;color:#111827">Medical Context Correlations</h3>
`;
correlations.slice(0,5).forEach(c=>{
html+=`<div style="background:#f9fafb;padding:12px;border-radius:8px;margin-bottom:10px">`;
html+=`<div style="font-weight:600;color:#111827">${new Date(c.reading.t).toLocaleTimeString()} - HR: ${c.reading.hr} BPM</div>`;
c.correlations.forEach(corr=>{
const icon=corr.type==='meal'?'üçΩÔ∏è':'üíä';
const relevanceColor=corr.relevance==='high'?'#dc2626':'#6b7280';
html+=`<div style="color:${relevanceColor};margin-top:5px;font-size:14px">${icon} ${corr.minutesAfter} min after ${corr.event}</div>`;
});
html+=`</div>`;
});
if(correlations.length>5){
html+=`<p style="color:#6b7280;font-size:14px;margin-top:10px">Showing 5 of ${correlations.length} correlations</p>`;
}
html+=`</div>`;
panel.innerHTML=html;
}

function createHRChart(readings){
const canvas=document.getElementById('hrChart');
const ctx=canvas.getContext('2d');
if(hrChart){
hrChart.destroy();
}

// Limit to last 50 readings for clarity
const displayReadings=readings.slice(-50);

// Update info text
const infoEl=document.getElementById('chartDataInfo');
if(infoEl){
if(readings.length>50){
infoEl.textContent=`Showing last 50 of ${readings.length} readings`;
}else{
infoEl.textContent=`${readings.length} reading${readings.length!==1?'s':''}`;
}
}

// Format labels - t is already in "HH:MM" format, just use it directly
const labels=displayReadings.map(r=>r.t);

const data={
labels:labels,
datasets:[{
label:'Heart Rate',
data:displayReadings.map(r=>r.hr),
borderColor:'#dc2626',
backgroundColor:'rgba(220,38,38,0.1)',
borderWidth:2,
pointRadius:6,
pointHoverRadius:10,
pointBackgroundColor:'#dc2626',
pointBorderColor:'#fff',
pointBorderWidth:2,
tension:0.3,
fill:true
}]
};

const config={
type:'line',
data:data,
options:{
responsive:true,
maintainAspectRatio:false,
interaction:{
mode:'nearest',
axis:'x',
intersect:false
},
layout:{
padding:{
left:0,
right:0,
top:0,
bottom:0
}
},
plugins:{
legend:{
display:false
},
tooltip:{
backgroundColor:'rgba(0,0,0,0.8)',
titleFont:{size:14,weight:'bold'},
bodyFont:{size:13},
padding:12,
displayColors:true,
callbacks:{
title:function(context){
return 'Time: '+labels[context[0].dataIndex];
},
label:function(context){
return 'HR: '+context.parsed.y+' bpm';
},
afterLabel:function(context){
const reading=displayReadings[context.dataIndex];
const correlations=correlateWithContext(reading,M,medLog);
let extra=`BP: ${reading.s}/${reading.d}`;
if(correlations.length>0){
extra+=`\n\nContext:`;
correlations.forEach(c=>{
extra+=`\n${c.minutesAfter} min after ${c.event}`;
});
}
return extra;
}
}
}
},
scales:{
y:{
beginAtZero:false,
suggestedMin:Math.max(40,Math.min(...displayReadings.map(r=>r.hr))-10),
suggestedMax:Math.min(120,Math.max(...displayReadings.map(r=>r.hr))+10),
title:{
display:true,
text:'BPM',
font:{size:15,weight:'bold'},
color:'#111827'
},
grid:{
color:'rgba(0,0,0,0.08)'
},
ticks:{
font:{size:13},
color:'#6b7280',
padding:8
}
},
x:{
title:{
display:false
},
grid:{
display:false
},
ticks:{
font:{size:12},
color:'#6b7280',
maxRotation:0,
minRotation:0,
autoSkip:true,
maxTicksLimit:12
}
}
}
}
};
config.devicePixelRatio=window.devicePixelRatio||1;
hrChart=new Chart(ctx,config);
}

function exportHRReport(){
const hrReadings=B.filter(r=>r.h && r.h>0).map(r=>({...r,hr:r.h}));
if(hrReadings.length===0){
alert('No heart rate data available to export.');
return;
}
const sortedReadings=[...hrReadings].sort((a,b)=>new Date(a.t)-new Date(b.t));
const stats=calculateHRStats(sortedReadings);
const timeInZone=calculateTimeInZones(sortedReadings);
const patterns=detectPatterns(sortedReadings);
const report=[];
report.push('=== HEART RATE ANALYSIS REPORT ===');
report.push(`Generated: ${new Date().toLocaleString()}`);
report.push(`Analysis Period: ${new Date(sortedReadings[0].t).toLocaleDateString()} - ${new Date(sortedReadings[sortedReadings.length-1].t).toLocaleDateString()}`);
report.push(`Total Readings: ${sortedReadings.length}`);
report.push('');
report.push('STATISTICAL SUMMARY:');
report.push(`Minimum HR: ${stats.min.toFixed(0)} BPM`);
report.push(`Maximum HR: ${stats.max.toFixed(0)} BPM`);
report.push(`Average HR: ${stats.avg.toFixed(1)} BPM`);
report.push(`HR Range: ${stats.range.toFixed(0)} BPM`);
report.push(`Standard Deviation: ${stats.stdDev.toFixed(1)} BPM`);
report.push(`Coefficient of Variation: ${stats.cv.toFixed(1)}%`);
report.push('');
report.push('TIME-IN-ZONE ANALYSIS:');
report.push(`Bradycardia (<60): ${timeInZone.bradycardia.count} readings (${timeInZone.bradycardia.percent}%)`);
report.push(`Normal (60-100): ${timeInZone.normal.count} readings (${timeInZone.normal.percent}%)`);
report.push(`Tachycardia (>100): ${timeInZone.tachycardia.count} readings (${timeInZone.tachycardia.percent}%)`);
report.push('');
if(patterns.length>0){
report.push('PATTERN DETECTION:');
patterns.forEach((p,i)=>{
report.push(`${i+1}. ${p.type.toUpperCase().replace(/_/g,' ')} (Severity: ${p.severity})`);
if(p.type==='severe_bradycardia'){
report.push(`   - ${p.count} episode${p.count>1?'s':''} of HR <50 BPM detected`);
}else if(p.type==='rapid_change'){
report.push(`   - HR changed from ${p.from} to ${p.to} BPM (Œî${p.change})`);
report.push(`   - Time: ${new Date(p.timestamp).toLocaleString()}`);
}else if(p.type==='sustained_abnormality'){
report.push(`   - ${p.duration} consecutive abnormal readings`);
report.push(`   - Period: ${new Date(p.startTime).toLocaleTimeString()} - ${new Date(p.endTime).toLocaleTimeString()}`);
}
});
report.push('');
}
const correlations=[];
sortedReadings.forEach(r=>{
const corr=correlateWithContext(r,M,medLog);
if(corr.length>0){
correlations.push({reading:r,correlations:corr});
}
});
if(correlations.length>0){
report.push('MEDICAL CONTEXT CORRELATIONS:');
correlations.forEach(c=>{
report.push(`${new Date(c.reading.t).toLocaleTimeString()} - HR: ${c.reading.hr} BPM`);
c.correlations.forEach(corr=>{
report.push(`   - ${corr.minutesAfter} min after ${corr.event} (${corr.type})`);
});
});
report.push('');
}
report.push('CLINICAL RECOMMENDATIONS:');
if(stats.min<50){
report.push('‚ö†Ô∏è  Severe bradycardia detected - Discuss with cardiologist');
}
if(stats.cv>20){
report.push('‚ö†Ô∏è  High heart rate variability - May indicate autonomic dysfunction');
}
if(parseFloat(timeInZone.bradycardia.percent)>50){
report.push('‚ö†Ô∏è  Predominant bradycardia - Consider medication review');
}
if(patterns.some(p=>p.type==='rapid_change'&&p.severity==='medium')){
report.push('‚ö†Ô∏è  Rapid heart rate changes detected - Monitor for symptoms');
}
if(correlations.length>0){
report.push('‚ÑπÔ∏è  Heart rate correlations with meals/medications noted - Review timing');
}
if(report.length===report.indexOf('CLINICAL RECOMMENDATIONS:')+1){
report.push('‚úì No immediate concerns noted in this analysis period');
}
report.push('');
report.push('DETAILED READINGS:');
sortedReadings.forEach(r=>{
report.push(`${new Date(r.t).toLocaleString()} - HR: ${r.hr} BPM, BP: ${r.s}/${r.d}, Position: ${r.pos}`);
if(r.n)report.push(`   Notes: ${r.n}`);
if(r.contextSymptoms&&r.contextSymptoms.length>0)report.push(`   Symptoms: ${r.contextSymptoms.join(', ')}`);
if(r.contextActivity&&r.contextActivity.length>0)report.push(`   Context: ${r.contextActivity.join(', ')}`);
if(r.contextNotes)report.push(`   Additional Notes: ${r.contextNotes}`);
});
const blob=new Blob([report.join('\n')],{type:'text/plain'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download='HR-Analysis-Report-'+new Date().toISOString().split('T')[0]+'.txt';
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
}

// ========== MEDICAL REPORT SYSTEM ==========

function openReportModal(){
const preview=document.getElementById('reportPreview');
const actionsDiv=document.getElementById('reportActions');
const actionButtons=actionsDiv.querySelectorAll('button');

// Reset preview
preview.innerHTML='<em style="color:#9ca3af">No data available for selected date range.</em>';

// Disable action buttons initially
actionsDiv.style.opacity='0.4';
actionsDiv.style.pointerEvents='none';
actionButtons.forEach(btn=>btn.disabled=true);

// Show modal
document.getElementById('reportModal').style.display='block';
}

function closeReportModal(){
document.getElementById('reportModal').style.display='none';
}

function selectDateRange(btn,range){
document.querySelectorAll('.date-range-btn').forEach(b=>b.classList.remove('active'));
btn.classList.add('active');
reportDateRange=range;
const customInputs=document.getElementById('customDateInputs');
if(range==='custom'){
customInputs.style.display='block';
}else{
customInputs.style.display='none';
}

// Reset preview and disable buttons when date range changes
const preview=document.getElementById('reportPreview');
const actionsDiv=document.getElementById('reportActions');
const actionButtons=actionsDiv.querySelectorAll('button');
preview.innerHTML='<em style="color:#9ca3af">Click "Generate Report" to load data for this date range.</em>';
actionsDiv.style.opacity='0.4';
actionsDiv.style.pointerEvents='none';
actionButtons.forEach(btn=>btn.disabled=true);
}

function getDateRangeData(){
let startDate,endDate=new Date();
if(reportDateRange==='30'){
startDate=new Date();
startDate.setDate(startDate.getDate()-30);
}else if(reportDateRange==='all'){
const allDates=B.map(r=>new Date(r.t));
startDate=allDates.length>0?new Date(Math.min(...allDates)):new Date();
}else if(reportDateRange==='custom'){
const start=document.getElementById('reportStartDate').value;
const end=document.getElementById('reportEndDate').value;
if(!start||!end){
alert('Please select both start and end dates');
return null;
}
startDate=new Date(start);
endDate=new Date(end);
}
return{startDate,endDate};
}

function generateReportPreview(){
const range=getDateRangeData();
if(!range)return;
const{startDate,endDate}=range;

// Get ALL historical data, not just today's
const allData=getAllHistoricalData();
console.log('DEBUG: Total BP readings from getAllHistoricalData:', allData.bp.length);
console.log('DEBUG: First reading:', allData.bp[0]);
console.log('DEBUG: Start date:', startDate);
console.log('DEBUG: End date:', endDate);

const filteredBP=allData.bp.filter(r=>{
// Combine _date and t to create full datetime
const readingDate=new Date(r._date+' '+r.t);
const passes=readingDate>=startDate&&readingDate<=endDate;
if(!passes){
console.log('DEBUG: Filtered OUT - Date:', r._date, 'Time:', r.t, 'Combined:', readingDate);
}
return passes;
});

console.log('DEBUG: Filtered BP readings:', filteredBP.length);

const preview=document.getElementById('reportPreview');
const actionsDiv=document.getElementById('reportActions');
const actionButtons=actionsDiv.querySelectorAll('button');

if(filteredBP.length===0){
preview.innerHTML='<p style="color:#ef4444;font-weight:600;text-align:center;padding:20px">‚ö†Ô∏è No data available for selected date range.</p>';
// Disable action buttons
actionsDiv.style.opacity='0.4';
actionsDiv.style.pointerEvents='none';
actionButtons.forEach(btn=>btn.disabled=true);
return;
}
const stats=calculateBPStats(filteredBP);
const hrReadings=filteredBP.filter(r=>r.hr&&r.hr>0);
let previewHTML=`<div style="background:#f0f9ff;border:2px solid #3b82f6;border-radius:12px;padding:20px;margin:16px 0">
<div style="font-size:22px;font-weight:700;color:#1e3a8a;margin-bottom:16px;text-align:center">‚úì Report Ready</div>

<div style="font-size:18px;line-height:1.8">
<strong>üìÖ Date Range:</strong> ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}<br>
<strong>üìä Total BP Readings:</strong> ${filteredBP.length}<br>
<strong>‚ù§Ô∏è Total HR Readings:</strong> ${hrReadings.length}<br>
<br>
<strong>Blood Pressure Statistics:</strong><br>
‚Ä¢ Average: ${stats.avgSys}/${stats.avgDia} mmHg<br>
‚Ä¢ Range: ${stats.minSys}-${stats.maxSys}/${stats.minDia}-${stats.maxDia} mmHg<br>
`;
if(hrReadings.length>0){
const hrStats=calculateHRStatsSimple(hrReadings);
previewHTML+=`<br>
<strong>Heart Rate Statistics:</strong><br>
‚Ä¢ Average: ${hrStats.avg.toFixed(1)} BPM<br>
‚Ä¢ Range: ${hrStats.min}-${hrStats.max} BPM<br>
`;
}
previewHTML+=`<br>
<em style="color:#6b7280">Full report will include detailed readings, charts, trends, and clinical insights.</em>
</div>
</div>`;
preview.innerHTML=previewHTML;

// Enable action buttons
actionsDiv.style.opacity='1';
actionsDiv.style.pointerEvents='auto';
actionButtons.forEach(btn=>btn.disabled=false);
}

function calculateBPStats(readings){
if(readings.length===0)return{avgSys:0,avgDia:0,minSys:0,maxSys:0,minDia:0,maxDia:0};
const sys=readings.map(r=>r.s);
const dia=readings.map(r=>r.d);
return{
avgSys:Math.round(sys.reduce((a,b)=>a+b,0)/sys.length),
avgDia:Math.round(dia.reduce((a,b)=>a+b,0)/dia.length),
minSys:Math.min(...sys),
maxSys:Math.max(...sys),
minDia:Math.min(...dia),
maxDia:Math.max(...dia)
};
}

function calculateHRStatsSimple(readings){
const hrs=readings.map(r=>r.hr);
const min=Math.min(...hrs);
const max=Math.max(...hrs);
const avg=hrs.reduce((a,b)=>a+b,0)/hrs.length;
return{min,max,avg};
}

function generateTextReport(){
const range=getDateRangeData();
if(!range)return;
const{startDate,endDate}=range;

// Get ALL historical data, not just today's
const allData=getAllHistoricalData();
const filteredBP=allData.bp.filter(r=>{
// Combine _date and t to create full datetime
const readingDate=new Date(r._date+' '+r.t);
return readingDate>=startDate&&readingDate<=endDate;
});

if(filteredBP.length===0){
alert('No data available for selected date range.');
return;
}
const report=generateComprehensiveReport(filteredBP,startDate,endDate);
const blob=new Blob([report],{type:'text/plain'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download=`BP-Medical-Report-${startDate.toISOString().split('T')[0]}-to-${endDate.toISOString().split('T')[0]}.txt`;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
alert('Medical report downloaded! You can print or convert to PDF using your system.');
}

function generateComprehensiveReport(readings,startDate,endDate){
const report=[];
const sortedReadings=[...readings].sort((a,b)=>new Date(a.t)-new Date(b.t));
const stats=calculateBPStats(sortedReadings);
const hrReadings=sortedReadings.filter(r=>r.hr&&r.hr>0);
report.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
report.push('                    BP TRACKER v7.0');
report.push('              MEDICAL-GRADE ANALYSIS REPORT');
report.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
report.push('');
report.push('PATIENT INFORMATION:');
report.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
if(settings.patientName)report.push(`Name: ${settings.patientName}`);
if(settings.dateOfBirth){
var dob=new Date(settings.dateOfBirth);
var today=new Date();
var age=today.getFullYear()-dob.getFullYear();
var m=today.getMonth()-dob.getMonth();
if(m<0||(m===0&&today.getDate()<dob.getDate()))age--;
report.push(`Date of Birth: ${settings.dateOfBirth} (Age: ${age})`);
}
if(settings.conditions&&settings.conditions.length>0){
report.push('Cardiac Conditions:');
settings.conditions.forEach(function(c){
report.push(`  ‚Ä¢ ${c}`);
});
}
report.push(`Report Generated: ${new Date().toLocaleString()}`);
report.push(`Analysis Period: ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`);
report.push(`Total Days Monitored: ${Math.ceil((endDate-startDate)/(1000*60*60*24))}`);
report.push('');
report.push('EXECUTIVE SUMMARY:');
report.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
report.push(`Total BP Readings: ${sortedReadings.length}`);
report.push(`Total HR Readings: ${hrReadings.length}`);
report.push(`Average BP: ${stats.avgSys}/${stats.avgDia} mmHg`);
report.push(`BP Range: ${stats.minSys}-${stats.maxSys}/${stats.minDia}-${stats.maxDia} mmHg`);
const bpClass=classifyBP(stats.avgSys,stats.avgDia);
report.push(`BP Classification: ${bpClass}`);
report.push('');
report.push('CLINICAL FLAGS & ALERTS:');
report.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
const flags=generateClinicalFlags(sortedReadings,hrReadings);
if(flags.length===0){
report.push('‚úì No immediate concerns noted in this analysis period');
}else{
flags.forEach(flag=>report.push(`${flag}`));
}
report.push('');
report.push('BLOOD PRESSURE ANALYSIS:');
report.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
report.push('Position-Based Analysis:');
const positions=['Sitting','Standing','Lying'];
positions.forEach(pos=>{
const posReadings=sortedReadings.filter(r=>r.pos===pos);
if(posReadings.length>0){
const posStats=calculateBPStats(posReadings);
report.push(`  ${pos}: ${posStats.avgSys}/${posStats.avgDia} mmHg (n=${posReadings.length})`);
}
});
report.push('');
if(hrReadings.length>0){
report.push('HEART RATE ANALYSIS:');
report.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
const hrStats=calculateHRStatsSimple(hrReadings);
report.push(`Minimum HR: ${hrStats.min.toFixed(0)} BPM`);
report.push(`Maximum HR: ${hrStats.max.toFixed(0)} BPM`);
report.push(`Average HR: ${hrStats.avg.toFixed(1)} BPM`);
report.push('');
}
if(settings.features&&settings.features.weight&&W.length>0){
report.push('WEIGHT TRACKING:');
report.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
const sortedWeight=W.slice().sort((a,b)=>new Date('2000-01-01 '+a.t)-new Date('2000-01-01 '+b.t));
const firstWeight=sortedWeight[0];
const lastWeight=sortedWeight[sortedWeight.length-1];
const weightChange=lastWeight.w-firstWeight.w;
report.push(`Total Weigh-ins: ${W.length}`);
report.push(`Starting Weight: ${firstWeight.w.toFixed(1)} lbs`);
report.push(`Current Weight: ${lastWeight.w.toFixed(1)} lbs`);
report.push(`Change: ${weightChange>0?'+':''}${weightChange.toFixed(1)} lbs`);
if(Math.abs(weightChange)>=3){
const direction=weightChange>0?'gained':'lost';
report.push(`‚ö†Ô∏è  Notable ${direction} ${Math.abs(weightChange).toFixed(1)} lbs during monitoring period`);
}
report.push('');
}
if(settings.features&&settings.features.symptoms&&S.length>0){
report.push('SYMPTOM TRACKING:');
report.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
const symptomCounts={};
let severitySum=0;
S.forEach(symptom=>{
symptomCounts[symptom.symptom]=(symptomCounts[symptom.symptom]||0)+1;
severitySum+=symptom.severity;
});
report.push(`Total Symptom Entries: ${S.length}`);
report.push(`Average Severity: ${(severitySum/S.length).toFixed(1)}/10`);
report.push('');
report.push('Symptom Frequency:');
Object.entries(symptomCounts).sort((a,b)=>b[1]-a[1]).forEach(([name,count])=>{
report.push(`  ${name}: ${count} occurrence${count>1?'s':''}`);
});
// Find most severe symptom
const mostSevere=S.reduce((max,s)=>s.severity>max.severity?s:max,S[0]);
report.push('');
report.push(`Most Severe Symptom: ${mostSevere.symptom} (Severity: ${mostSevere.severity}/10)`);
report.push('');
}
if(medLog.length>0){
report.push('MEDICATION LOG:');
report.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
const medCounts={};
medLog.forEach(med=>{
medCounts[med.medicine]=(medCounts[med.medicine]||0)+1;
});
Object.entries(medCounts).forEach(([name,count])=>{
report.push(`  ${name}: ${count} dose${count>1?'s':''}`);
});
report.push('');
}
if(M.length>0){
report.push('MEAL TRACKING:');
report.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
const mealCounts={};
M.forEach(meal=>{
mealCounts[meal.type]=(mealCounts[meal.type]||0)+1;
});
Object.entries(mealCounts).forEach(([type,count])=>{
report.push(`  ${type}: ${count} meal${count>1?'s':''}`);
});
report.push('');
}
report.push('CLINICAL RECOMMENDATIONS:');
report.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
const recommendations=generateRecommendations(sortedReadings,hrReadings,stats);
recommendations.forEach(rec=>report.push(`${rec}`));
report.push('');
report.push('DETAILED READINGS:');
report.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
sortedReadings.forEach(r=>{
const hrText=r.hr?`, HR: ${r.hr} BPM`:'';
report.push(`${new Date(r.t).toLocaleString()} - BP: ${r.s}/${r.d} mmHg${hrText}, Position: ${r.pos}`);
if(r.notes)report.push(`  Notes: ${r.notes}`);
if(r.contextSymptoms&&r.contextSymptoms.length>0)report.push(`  Symptoms: ${r.contextSymptoms.join(', ')}`);
if(r.contextActivity&&r.contextActivity.length>0)report.push(`  Context: ${r.contextActivity.join(', ')}`);
if(r.contextNotes)report.push(`  Additional Notes: ${r.contextNotes}`);
});
report.push('');
report.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
report.push('BP TRACKER v7.0 - Medical-Grade Analysis');
report.push('Free Forever | 100% Private | Open Source');
report.push('This report is not a substitute for professional medical advice.');
report.push('Always consult your healthcare provider.');
report.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
return report.join('\n');
}

function classifyBP(sys,dia){
if(sys<120&&dia<80)return'Normal';
if(sys>=120&&sys<=129&&dia<80)return'Elevated';
if((sys>=130&&sys<=139)||(dia>=80&&dia<=89))return'Stage 1 Hypertension';
if(sys>=140||dia>=90)return'Stage 2 Hypertension';
if(sys>180||dia>120)return'Hypertensive Crisis';
return'Unclassified';
}

function generateClinicalFlags(bpReadings,hrReadings){
const flags=[];
const crisis=bpReadings.filter(r=>r.s>180||r.d>120);
if(crisis.length>0){
flags.push(`‚ö†Ô∏è  CRITICAL: ${crisis.length} hypertensive crisis episode${crisis.length>1?'s':''} detected (BP >180/120)`);
}
const bradycardia=hrReadings.filter(r=>r.hr<50);
if(bradycardia.length>0){
flags.push(`‚ö†Ô∏è  Severe bradycardia detected: ${bradycardia.length} reading${bradycardia.length>1?'s':''} with HR <50 BPM`);
}
const tachycardia=hrReadings.filter(r=>r.hr>100);
if(tachycardia.length>hrReadings.length*0.3){
flags.push(`‚ö†Ô∏è  Frequent tachycardia: ${tachycardia.length} reading${tachycardia.length>1?'s':''} with HR >100 BPM`);
}
const stats=calculateBPStats(bpReadings);
if(stats.maxSys-stats.minSys>50||stats.maxDia-stats.minDia>30){
flags.push(`‚ÑπÔ∏è  High BP variability noted - Range: ${stats.minSys}-${stats.maxSys}/${stats.minDia}-${stats.maxDia} mmHg`);
}
return flags;
}

function generateRecommendations(bpReadings,hrReadings,stats){
const recs=[];
const bpClass=classifyBP(stats.avgSys,stats.avgDia);
if(bpClass==='Hypertensive Crisis'){
recs.push('‚ö†Ô∏è  URGENT: Seek immediate medical attention for hypertensive crisis');
}else if(bpClass==='Stage 2 Hypertension'){
recs.push('‚ö†Ô∏è  Discuss BP management with your cardiologist - Stage 2 hypertension detected');
}else if(bpClass==='Stage 1 Hypertension'){
recs.push('‚ÑπÔ∏è  Consider lifestyle modifications and discuss medication with your doctor');
}else if(bpClass==='Elevated'){
recs.push('‚ÑπÔ∏è  Monitor closely and discuss prevention strategies with your healthcare provider');
}
if(hrReadings.length>0){
const hrStats=calculateHRStatsSimple(hrReadings);
if(hrStats.min<50){
recs.push('‚ö†Ô∏è  Consult cardiologist about bradycardia episodes');
}
if(hrStats.max>120){
recs.push('‚ÑπÔ∏è  Discuss tachycardia episodes with your doctor');
}
}
recs.push('‚úì Continue regular monitoring and bring this report to your next appointment');
recs.push('‚úì Keep tracking medications, meals, and lifestyle factors for correlation analysis');
if(recs.length===0){
recs.push('‚úì No immediate concerns - continue monitoring as directed by your healthcare provider');
}
return recs;
}

function generateSpreadsheetExport(){
const range=getDateRangeData();
if(!range)return;
const{startDate,endDate}=range;

// Get ALL historical data, not just today's
const allData=getAllHistoricalData();
const filteredBP=allData.bp.filter(r=>{
// Combine _date and t to create full datetime
const readingDate=new Date(r._date+' '+r.t);
return readingDate>=startDate&&readingDate<=endDate;
});

if(filteredBP.length===0){
alert('No data available for selected date range.');
return;
}
const sortedReadings=[...filteredBP].sort((a,b)=>new Date(a._date+' '+a.t)-new Date(b._date+' '+b.t));
const rows=[];
rows.push(['Date','Time','Systolic','Diastolic','Heart Rate','Position','Notes'].join('\t'));
sortedReadings.forEach(r=>{
rows.push([
r._date,
r.t,
r.s,
r.d,
r.hr||'',
r.pos,
r.notes||''
].join('\t'));
});
const blob=new Blob([rows.join('\n')],{type:'text/plain'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download=`BP-Data-Export-${startDate.toISOString().split('T')[0]}-to-${endDate.toISOString().split('T')[0]}.txt`;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
alert('Data exported! Open in Excel/Google Sheets:\n1. Open Excel\n2. Go to Data > From Text\n3. Select Tab as delimiter\n4. Import your file');
}

function printReport(){
const range=getDateRangeData();
if(!range)return;
const{startDate,endDate}=range;

// Get ALL historical data, not just today's
const allData=getAllHistoricalData();
const filteredBP=allData.bp.filter(r=>{
// Combine _date and t to create full datetime
const readingDate=new Date(r._date+' '+r.t);
return readingDate>=startDate&&readingDate<=endDate;
});

if(filteredBP.length===0){
alert('No data available for selected date range.');
return;
}
const report=generateComprehensiveReport(filteredBP,startDate,endDate);
const printWindow=window.open('','_blank');
printWindow.document.write(`
<html>
<head>
<title>BP Medical Report</title>
<style>
body{font-family:monospace;padding:20px;max-width:800px;margin:0 auto;}
pre{white-space:pre-wrap;line-height:1.5;}
</style>
</head>
<body>
<pre>${report}</pre>
</body>
</html>
`);
printWindow.document.close();
printWindow.print();
}

function showAbout(){
document.getElementById('aboutModal').style.display='block';
}

function closeAbout(){
document.getElementById('aboutModal').style.display='none';
}

// ============================================================================
// PHASE 3: ADVANCED ANALYTICS DASHBOARD
// ============================================================================

var analyticsRange='7';
var analyticsStartDate='';
var analyticsEndDate='';
var analyticsNotesData={};

// === PHASE 2: MEDICATION EFFECTIVENESS TRACKING ===
var medAnalysisPeriod='today';

function openMedicationEffectiveness(){
document.getElementById('medicationEffectivenessModal').style.display='block';

// Check if settings are properly configured
if(!settings.systolicMin||!settings.systolicMax||!settings.diastolicMin||!settings.diastolicMax||!settings.hrMin||!settings.hrMax){
var resultsDiv=document.getElementById('medEffectivenessResults');
resultsDiv.innerHTML='<div style="padding:40px;text-align:center;background:#fee2e2;border:2px solid #ef4444;border-radius:12px">'+
'<div style="font-size:48px;margin-bottom:16px">‚öôÔ∏è</div>'+
'<div style="font-size:22px;font-weight:700;color:#991b1b;margin-bottom:12px">Settings Required</div>'+
'<div style="font-size:16px;color:#6b7280;margin-bottom:20px">Please configure your target BP ranges in Settings first.</div>'+
'<button onclick="closeMedicationEffectiveness();openSettings();" style="background:#3b82f6;color:white;border:none;padding:16px 32px;border-radius:8px;font-size:18px;font-weight:600;cursor:pointer">Go to Settings</button>'+
'</div>';
return;
}

// Display current acceptable ranges from Settings
var rangeHTML='';
rangeHTML+='<div style="background:#fff;padding:12px;border:2px solid #3b82f6;border-radius:8px;text-align:center">';
rangeHTML+='<div style="font-weight:600;font-size:14px;color:#1e3a8a">Systolic</div>';
rangeHTML+='<div style="font-size:24px;font-weight:700;color:#3b82f6">'+settings.systolicMin+' ‚Äì '+settings.systolicMax+'</div>';
rangeHTML+='<div style="font-size:12px;color:#6b7280">mmHg</div>';
rangeHTML+='</div>';
rangeHTML+='<div style="background:#fff;padding:12px;border:2px solid #10b981;border-radius:8px;text-align:center">';
rangeHTML+='<div style="font-weight:600;font-size:14px;color:#166534">Diastolic</div>';
rangeHTML+='<div style="font-size:24px;font-weight:700;color:#10b981">'+settings.diastolicMin+' ‚Äì '+settings.diastolicMax+'</div>';
rangeHTML+='<div style="font-size:12px;color:#6b7280">mmHg</div>';
rangeHTML+='</div>';
rangeHTML+='<div style="background:#fff;padding:12px;border:2px solid #f59e0b;border-radius:8px;text-align:center">';
rangeHTML+='<div style="font-weight:600;font-size:14px;color:#92400e">Heart Rate</div>';
rangeHTML+='<div style="font-size:24px;font-weight:700;color:#f59e0b">'+settings.hrMin+' ‚Äì '+settings.hrMax+'</div>';
rangeHTML+='<div style="font-size:12px;color:#6b7280">bpm</div>';
rangeHTML+='</div>';
document.getElementById('medRangeDisplay').innerHTML=rangeHTML;

// Set default period and calculate
setMedAnalysisPeriod('today');
}

function closeMedicationEffectiveness(){
document.getElementById('medicationEffectivenessModal').style.display='none';
// Note: Targets are always calculated from Settings, no need to save custom values
}

// === PROCEDURE IMPACT ANALYSIS ===
var selectedProcedureDate='';
var procedureAnalysisPeriod='7';

function openProcedureImpact(){
document.getElementById('procedureImpactModal').style.display='block';

// DEBUG: Log all localStorage keys
console.log('=== LOCALSTORAGE DEBUG ===');
console.log('Total localStorage items:',localStorage.length);
for(var i=0;i<localStorage.length;i++){
var key=localStorage.key(i);
if(key.startsWith('BP_TRACKER_')&&key.match(/\d{4}-\d{2}-\d{2}/)){
console.log('Found BP data key:',key);
try{
var data=JSON.parse(localStorage.getItem(key));
console.log('  BP readings:',data.bp?data.bp.length:0);
}catch(e){
console.log('  Error parsing:',e);
}
}
}

// Load procedures directly from localStorage (more reliable than getAllHistoricalData)
var proceduresList=[];
try{
var saved=localStorage.getItem('BP_TRACKER_PROCEDURES');
if(saved){
proceduresList=JSON.parse(saved);
}
}catch(e){
console.error('Error loading procedures:',e);
}

console.log('Found',proceduresList.length,'procedures in localStorage');

// Populate procedure selector
var selector=document.getElementById('procedureSelector');
selector.innerHTML='<option value="">-- Select a procedure to analyze --</option>';

if(proceduresList.length===0){
document.getElementById('procedureImpactResults').innerHTML=
'<div style="padding:40px;text-align:center;background:#fef3c7;border:2px solid #f59e0b;border-radius:12px">'+
'<div style="font-size:48px;margin-bottom:16px">üè•</div>'+
'<div style="font-size:20px;font-weight:600;color:#92400e;margin-bottom:12px">No Procedures Found</div>'+
'<div style="font-size:16px;color:#6b7280;margin-bottom:20px">Log a procedure first to see recovery analysis.</div>'+
'<button onclick="closeProcedureImpact();logProcedure();" style="background:#8b5cf6;color:white;border:none;padding:16px 32px;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer">‚ûï Add Procedure</button>'+
'</div>';
return;
}

// Sort procedures by timestamp (most recent first)
proceduresList.sort(function(a,b){
var dateA=new Date(a.timestamp);
var dateB=new Date(b.timestamp);
return dateB-dateA;
});

// Add options
proceduresList.forEach(function(proc,index){
var displayName=proc.name||'Unnamed Procedure';
var procDate=new Date(proc.timestamp);
var dateDisplay=procDate.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
// Use index as value since we have the procedures in memory
selector.innerHTML+='<option value="'+index+'">'+dateDisplay+' - '+displayName+'</option>';
});

// Store procedures in a global for access by other functions
window.loadedProcedures=proceduresList;
}

function closeProcedureImpact(){
document.getElementById('procedureImpactModal').style.display='none';
}

function inspectLocalStorage(){
var output='=== LOCALSTORAGE INSPECTION ===\n\n';
output+='Total items in localStorage: '+localStorage.length+'\n\n';
var bpKeys=[];
for(var i=0;i<localStorage.length;i++){
var key=localStorage.key(i);
if(key.startsWith('BP_TRACKER_')&&key.match(/\d{4}-\d{2}-\d{2}/)){
bpKeys.push(key);
}
}
bpKeys.sort();
output+='BP Data Keys Found: '+bpKeys.length+'\n';
bpKeys.forEach(function(key){
output+='\n'+key+': ';
try{
var data=JSON.parse(localStorage.getItem(key));
output+='BP readings: '+(data.bp?data.bp.length:0);
}catch(e){
output+='ERROR parsing';
}
});
alert(output);
console.log(output);
}

function setProcedurePeriod(period){
procedureAnalysisPeriod=period;

// Update button states
['7','14','30','all'].forEach(function(p){
var btn=document.getElementById('procPeriod'+p.charAt(0).toUpperCase()+p.slice(1));
if(!btn)btn=document.getElementById('procPeriod'+p);
if(btn){
if(p===period){
btn.style.background='#3b82f6';
btn.style.color='#fff';
}else{
btn.style.background='#e5e7eb';
btn.style.color='#000';
}
}
});

// Note: Analysis will be triggered manually via "Generate Analysis" button
}

function analyzeProcedureImpact(){
var selector=document.getElementById('procedureSelector');
var selectedIndex=selector.value;

if(!selectedIndex||selectedIndex===''){
document.getElementById('procedureImpactResults').innerHTML=
'<div style="padding:60px;text-align:center;color:#9ca3af">'+
'<div style="font-size:48px;margin-bottom:16px">üè•</div>'+
'<div style="font-size:20px;font-weight:600">Select a procedure above to see recovery analysis</div>'+
'</div>';
return;
}

// Store selected index globally
selectedProcedureDate=selectedIndex;

// Show loading
document.getElementById('procedureImpactResults').innerHTML=
'<div style="padding:60px;text-align:center">'+
'<div style="font-size:48px;margin-bottom:16px">‚è≥</div>'+
'<div style="font-size:20px;font-weight:600;color:#8b5cf6">Analyzing procedure impact...</div>'+
'</div>';

setTimeout(function(){
calculateProcedureImpact();
},100);
}

function calculateProcedureImpact(){
// Get the selected procedure by index
if(!window.loadedProcedures||!selectedProcedureDate){
document.getElementById('procedureImpactResults').innerHTML='<div style="color:#ef4444">Error: Procedure not found</div>';
return;
}

var procedureIndex=parseInt(selectedProcedureDate);
var procedure=window.loadedProcedures[procedureIndex];

if(!procedure){
document.getElementById('procedureImpactResults').innerHTML='<div style="color:#ef4444">Error: Procedure not found</div>';
return;
}

// Get procedure date from timestamp and normalize to start of day
var procDate=new Date(procedure.timestamp);
procDate.setHours(0,0,0,0); // Normalize to start of day
var procDateDisplay=procDate.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
var procDateKey=procDate.toISOString().split('T')[0]; // YYYY-MM-DD format

console.log('=== PROCEDURE IMPACT ANALYSIS DEBUG ===');
console.log('Procedure:',procedure.name);
console.log('Procedure date:',procDateDisplay);
console.log('Procedure date key:',procDateKey);
console.log('Procedure timestamp:',procedure.timestamp);

// Show procedure details
var detailsHTML='<div style="font-weight:700;font-size:18px;color:#6b21a8;margin-bottom:8px">'+procedure.name+'</div>';
detailsHTML+='<div style="font-size:14px;color:#6b7280"><strong>Date:</strong> '+procDateDisplay+'</div>';
if(procedure.category)detailsHTML+='<div style="font-size:14px;color:#6b7280"><strong>Type:</strong> '+procedure.category+'</div>';
if(procedure.facility)detailsHTML+='<div style="font-size:14px;color:#6b7280"><strong>Facility:</strong> '+procedure.facility+'</div>';
if(procedure.physician)detailsHTML+='<div style="font-size:14px;color:#6b7280"><strong>Physician:</strong> '+procedure.physician+'</div>';
document.getElementById('procedureDetails').innerHTML=detailsHTML;
document.getElementById('procedureDetails').style.display='block';

// Define analysis periods BEFORE loading data
var beforeDays=7; // Look at 7 days before procedure
var afterDays=parseInt(procedureAnalysisPeriod)||7;
if(procedureAnalysisPeriod==='all')afterDays=90; // Max 90 days

var beforeDate=new Date(procDate);
beforeDate.setDate(beforeDate.getDate()-beforeDays);
beforeDate.setHours(0,0,0,0);

var afterDate=new Date(procDate);
afterDate.setDate(afterDate.getDate()+afterDays);
afterDate.setHours(23,59,59,999);

console.log('Analysis window:');
console.log('  Before date:',beforeDate.toISOString().split('T')[0],'to',procDateKey);
console.log('  After date:',procDateKey,'to',afterDate.toISOString().split('T')[0]);
console.log('  Analysis period:',afterDays,'days');

// Get all BP readings with proper date range
var allData=getAllHistoricalData(beforeDate, afterDate);
console.log('Total data retrieved:',allData?'Yes':'No');
console.log('BP readings available:',allData&&allData.bp?allData.bp.length:0);

if(!allData||!allData.bp||allData.bp.length===0){
// Build debug panel
var debugHTML='<div style="margin-top:20px;padding:16px;background:white;border-radius:8px;text-align:left;border:2px solid #e5e7eb">';
debugHTML+='<div style="font-weight:700;font-size:14px;margin-bottom:8px;color:#ef4444">üîç Debug Info</div>';
debugHTML+='<div style="font-size:13px;color:#374151">';
debugHTML+='allData exists: '+(allData?'Yes':'No')+'<br>';
if(allData){
debugHTML+='allData.bp exists: '+(allData.bp?'Yes':'No')+'<br>';
debugHTML+='allData.bp.length: '+(allData.bp?allData.bp.length:'N/A')+'<br>';
}
debugHTML+='<br>Open browser console (F12) for more details.';
debugHTML+='</div></div>';

document.getElementById('procedureImpactResults').innerHTML=
'<div style="padding:40px;text-align:center;background:#fef3c7;border:2px solid #f59e0b;border-radius:12px">'+
'<div style="font-size:48px;margin-bottom:16px">üìä</div>'+
'<div style="font-size:20px;font-weight:600;color:#92400e">No BP Data Available</div>'+
'<div style="font-size:16px;color:#6b7280;margin-top:12px">The system could not find any BP readings.</div>'+
debugHTML+
'</div>';
return;
}

console.log('Total BP readings available:',allData.bp.length);

// Collect before/after readings with improved date handling
var beforeReadings=[];
var afterReadings=[];

allData.bp.forEach(function(reading){
if(!reading._date){
console.log('Skipping reading with no _date field');
return;
}

// Parse the reading date - handle YYYY-MM-DD format
var readingDate=new Date(reading._date+'T00:00:00');
readingDate.setHours(0,0,0,0);

// Compare normalized dates
var isBeforeProcedure=readingDate>=beforeDate&&readingDate<procDate;
var isAfterProcedure=readingDate>=procDate&&readingDate<=afterDate;

if(isBeforeProcedure){
beforeReadings.push(reading);
}else if(isAfterProcedure){
afterReadings.push(reading);
}
});

console.log('Readings found:');
console.log('  Before procedure:',beforeReadings.length);
console.log('  After procedure:',afterReadings.length);

// Calculate averages
var html='';

if(beforeReadings.length===0&&afterReadings.length===0){
// Build detailed debug information
var debugInfo='';
debugInfo+='<div style="font-size:14px;color:#374151;margin-top:20px;padding:16px;background:white;border-radius:8px;text-align:left;border:2px solid #e5e7eb">';
debugInfo+='<div style="font-weight:700;font-size:16px;margin-bottom:12px;color:#ef4444">üîç Debug Information</div>';
debugInfo+='<div style="margin-bottom:8px"><strong>Procedure Date:</strong> '+procDateKey+'</div>';
debugInfo+='<div style="margin-bottom:8px"><strong>Analysis Period:</strong> '+procedureAnalysisPeriod+(procedureAnalysisPeriod==='all'?' (90 days)':' days')+'</div>';
debugInfo+='<div style="margin-bottom:8px"><strong>Looking for readings between:</strong></div>';
debugInfo+='<div style="margin-left:16px;margin-bottom:8px">Before: '+beforeDate.toISOString().split('T')[0]+' to '+procDateKey+'</div>';
debugInfo+='<div style="margin-left:16px;margin-bottom:12px">After: '+procDateKey+' to '+afterDate.toISOString().split('T')[0]+'</div>';
debugInfo+='<div style="margin-bottom:8px"><strong>Total BP readings in system:</strong> '+allData.bp.length+'</div>';

// Add localStorage inspector
debugInfo+='<button onclick="inspectLocalStorage()" style="background:#3b82f6;color:white;border:none;padding:8px 16px;border-radius:6px;font-size:13px;cursor:pointer;margin:12px 0">üìã Show All LocalStorage Keys</button>';

// Show sample of dates found in the system
debugInfo+='<div style="margin-top:12px;padding-top:12px;border-top:1px solid #e5e7eb">';
debugInfo+='<strong>Sample of BP reading dates in your system:</strong>';
debugInfo+='<div style="margin-top:8px;max-height:200px;overflow-y:auto;font-family:monospace;font-size:12px;background:#f9fafb;padding:8px;border-radius:4px">';
var uniqueDates=[];
allData.bp.forEach(function(r){
if(r._date&&uniqueDates.indexOf(r._date)===-1){
uniqueDates.push(r._date);
}
});
uniqueDates.sort();
if(uniqueDates.length>0){
debugInfo+='Found readings on these dates:<br>';
uniqueDates.forEach(function(d){
var readingDate=new Date(d+'T00:00:00');
var isBefore=readingDate>=beforeDate&&readingDate<procDate;
var isAfter=readingDate>=procDate&&readingDate<=afterDate;
var status=isBefore?'BEFORE':isAfter?'AFTER':'OUTSIDE RANGE';
var color=isBefore?'#3b82f6':isAfter?'#10b981':'#9ca3af';
debugInfo+='<span style="color:'+color+'">'+d+' ('+status+')</span><br>';
});
}else{
debugInfo+='No dates found in BP readings!';
}
debugInfo+='</div></div>';
debugInfo+='</div>';

html='<div style="padding:40px;text-align:center;background:#fef3c7;border:2px solid #f59e0b;border-radius:12px">';
html+='<div style="font-size:48px;margin-bottom:16px">üìä</div>';
html+='<div style="font-size:20px;font-weight:600;color:#92400e;margin-bottom:8px">No BP Data for Analysis Period</div>';
html+='<div style="font-size:16px;color:#6b7280;margin-bottom:12px">No BP readings found within the selected date range.</div>';
html+=debugInfo;
html+='</div>';
document.getElementById('procedureImpactResults').innerHTML=html;
return;
}

// Calculate statistics
function calcStats(readings){
if(readings.length===0)return{systolic:0,diastolic:0,hr:0};
var sum={s:0,d:0,h:0};
readings.forEach(function(r){
sum.s+=r.s||0;
sum.d+=r.d||0;
sum.h+=r.h||0;
});
return{
systolic:sum.s/readings.length,
diastolic:sum.d/readings.length,
hr:sum.h/readings.length
};
}

var beforeStats=calcStats(beforeReadings);
var afterStats=calcStats(afterReadings);

// Build HTML
html='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:24px">';

// Before procedure card
if(beforeReadings.length>0){
html+='<div style="background:#eff6ff;border:3px solid #3b82f6;border-radius:12px;padding:20px">';
html+='<div style="font-size:14px;color:#1e3a8a;font-weight:700;margin-bottom:12px">üìä BEFORE PROCEDURE</div>';
html+='<div style="font-size:16px;color:#6b7280;margin-bottom:8px">('+beforeDays+' days before)</div>';
html+='<div style="font-size:32px;font-weight:700;color:#3b82f6;margin-bottom:4px">'+Math.round(beforeStats.systolic)+'/'+Math.round(beforeStats.diastolic)+'</div>';
html+='<div style="font-size:16px;color:#3b82f6;font-weight:600">HR: '+Math.round(beforeStats.hr)+' bpm</div>';
html+='<div style="font-size:14px;color:#6b7280;margin-top:8px">'+beforeReadings.length+' readings</div>';
html+='</div>';
}else{
html+='<div style="background:#f3f4f6;border:2px solid #d1d5db;border-radius:12px;padding:20px;text-align:center">';
html+='<div style="font-size:14px;color:#6b7280;font-weight:600">No "Before" readings</div>';
html+='<div style="font-size:12px;color:#9ca3af;margin-top:4px">'+beforeDays+' days before procedure</div>';
html+='</div>';
}

// After procedure card
if(afterReadings.length>0){
html+='<div style="background:#dcfce7;border:3px solid #10b981;border-radius:12px;padding:20px">';
html+='<div style="font-size:14px;color:#166534;font-weight:700;margin-bottom:12px">üè• AFTER PROCEDURE</div>';
html+='<div style="font-size:16px;color:#6b7280;margin-bottom:8px">('+procedureAnalysisPeriod+(procedureAnalysisPeriod==='all'?'+ days':'days')+' after)</div>';
html+='<div style="font-size:32px;font-weight:700;color:#10b981;margin-bottom:4px">'+Math.round(afterStats.systolic)+'/'+Math.round(afterStats.diastolic)+'</div>';
html+='<div style="font-size:16px;color:#10b981;font-weight:600">HR: '+Math.round(afterStats.hr)+' bpm</div>';
html+='<div style="font-size:14px;color:#6b7280;margin-top:8px">'+afterReadings.length+' readings</div>';
html+='</div>';
}else{
html+='<div style="background:#f3f4f6;border:2px solid #d1d5db;border-radius:12px;padding:20px;text-align:center">';
html+='<div style="font-size:14px;color:#6b7280;font-weight:600">No "After" readings</div>';
html+='<div style="font-size:12px;color:#9ca3af;margin-top:4px">'+afterDays+' days after procedure</div>';
html+='</div>';
}

// Changes card
if(beforeReadings.length>0&&afterReadings.length>0){
var sChange=afterStats.systolic-beforeStats.systolic;
var dChange=afterStats.diastolic-beforeStats.diastolic;
var hChange=afterStats.hr-beforeStats.hr;

var changeColor='#6b7280';
var changeBg='#f3f4f6';
if(Math.abs(sChange)<5&&Math.abs(dChange)<5&&Math.abs(hChange)<5){
changeColor='#10b981';
changeBg='#dcfce7';
}else if(sChange>10||dChange>10||hChange>10){
changeColor='#f59e0b';
changeBg='#fef3c7';
}

html+='<div style="background:'+changeBg+';border:3px solid '+changeColor+';border-radius:12px;padding:20px">';
html+='<div style="font-size:14px;color:'+changeColor+';font-weight:700;margin-bottom:12px">üìà CHANGES</div>';
html+='<div style="font-size:16px;color:#374151;margin-bottom:4px"><strong>Systolic:</strong> '+(sChange>0?'+':'')+sChange.toFixed(1)+'</div>';
html+='<div style="font-size:16px;color:#374151;margin-bottom:4px"><strong>Diastolic:</strong> '+(dChange>0?'+':'')+dChange.toFixed(1)+'</div>';
html+='<div style="font-size:16px;color:#374151"><strong>Heart Rate:</strong> '+(hChange>0?'+':'')+hChange.toFixed(1)+'</div>';
html+='</div>';
}

html+='</div>';

// Recovery interpretation
if(beforeReadings.length>0&&afterReadings.length>0){
html+='<div style="background:#fef3c7;border:2px solid #f59e0b;border-radius:12px;padding:20px;margin-bottom:20px">';
html+='<h4 style="margin:0 0 12px 0;color:#92400e;font-size:18px">üí° Recovery Analysis</h4>';
html+='<div style="color:#374151;font-size:16px;line-height:1.8">';

var sChange=afterStats.systolic-beforeStats.systolic;
var dChange=afterStats.diastolic-beforeStats.diastolic;
var hChange=afterStats.hr-beforeStats.hr;

if(Math.abs(sChange)<5&&Math.abs(dChange)<5&&Math.abs(hChange)<5){
html+='<strong style="color:#10b981">‚úì Stable Recovery:</strong> Your BP and HR are within normal range of pre-procedure values. This suggests good recovery progress.';
}else if(sChange<-10||dChange<-10){
html+='<strong style="color:#10b981">‚úì Improved Readings:</strong> Your BP is lower than before the procedure, which may be positive depending on the procedure type.';
}else if(sChange>10||dChange>10||hChange>15){
html+='<strong style="color:#f59e0b">‚ö†Ô∏è Elevated Readings:</strong> Your BP/HR is higher than before the procedure. This is common during recovery but should be monitored.';
}

html+='<div style="margin-top:12px;padding:12px;background:#fff;border-radius:6px;font-size:14px">';
html+='<strong>For your appointment on 2/23:</strong> Share this analysis with your doctor to discuss your recovery progress and any concerns.';
html+='</div>';

html+='</div>';
html+='</div>';
}

// Summary
html+='<div style="background:#dbeafe;border:2px solid #3b82f6;border-radius:12px;padding:20px">';
html+='<h4 style="margin:0 0 12px 0;color:#1e3a8a;font-size:18px">üìã Analysis Summary</h4>';
html+='<div style="color:#374151;font-size:16px;line-height:1.8">';
html+='<div><strong>Procedure:</strong> '+procedure.name+'</div>';
html+='<div><strong>Date:</strong> '+procDateDisplay+'</div>';
html+='<div><strong>Before Data:</strong> '+beforeReadings.length+' readings ('+beforeDays+' days before)</div>';
html+='<div><strong>After Data:</strong> '+afterReadings.length+' readings ('+procedureAnalysisPeriod+(procedureAnalysisPeriod==='all'?'+ days':' days')+' after)</div>';
html+='<div style="margin-top:12px;padding:12px;background:#f0f9ff;border-left:3px solid #3b82f6;border-radius:4px;font-size:14px">';
html+='<strong>üí° Tip:</strong> Log daily BP readings to track your recovery progress. Consistent data helps identify trends.';
html+='</div>';
html+='</div>';
html+='</div>';

document.getElementById('procedureImpactResults').innerHTML=html;
}

function setMedAnalysisPeriod(period){
medAnalysisPeriod=period;

// Show loading indicator
document.getElementById('medEffectivenessResults').innerHTML=
'<div style="padding:60px;text-align:center">'+
'<div style="font-size:48px;margin-bottom:16px">‚è≥</div>'+
'<div style="font-size:20px;font-weight:600;color:#3b82f6">Analyzing '+getPeriodLabel(period)+'...</div>'+
'</div>';

// Update button states
['today','week','month','all'].forEach(function(p){
var btn=document.getElementById('medPeriod'+p.charAt(0).toUpperCase()+p.slice(1));
if(btn){
if(p===period){
btn.style.background='#3b82f6';
btn.style.color='#fff';
}else{
btn.style.background='#e5e7eb';
btn.style.color='#000';
}
}
});

// Calculate with slight delay for visual feedback
setTimeout(function(){
calculateMedicationEffectiveness();
},100);
}

function getMedicationReadings(){
var medReadings=[];
var todayKey=getTodayKey();

if(medAnalysisPeriod==='today'){
// TODAY: Read directly from in-memory B array (most reliable for current session)
B.forEach(function(reading){
if(reading.medicationRelated&&reading.medicationTiming&&reading.medicationTiming!=='none'){
medReadings.push({
s:reading.s,
d:reading.d,
h:reading.h,
t:reading.t,
medicationName:reading.medicationName,
medicationTiming:reading.medicationTiming,
hoursAfterMed:reading.hoursAfterMed||0,
date:todayKey
});
}
});
return medReadings;
}

// WEEK / MONTH / ALL: Use getAllHistoricalData with proper date range
var endDate=new Date();
endDate.setHours(23,59,59,999);
var startDate;

if(medAnalysisPeriod==='week'){
startDate=new Date();
startDate.setDate(startDate.getDate()-7);
startDate.setHours(0,0,0,0);
}else if(medAnalysisPeriod==='month'){
startDate=new Date();
startDate.setDate(startDate.getDate()-30);
startDate.setHours(0,0,0,0);
}else{
// All time ‚Äî go back 90 days (DATA_RETENTION_DAYS)
startDate=new Date();
startDate.setDate(startDate.getDate()-(typeof DATA_RETENTION_DAYS!=='undefined'?DATA_RETENTION_DAYS:90));
startDate.setHours(0,0,0,0);
}

var allData=getAllHistoricalData(startDate,endDate);

if(!allData||!allData.bp||allData.bp.length===0){
return[];
}

allData.bp.forEach(function(reading){
if(reading.medicationRelated&&reading.medicationTiming&&reading.medicationTiming!=='none'){
medReadings.push({
s:reading.s,
d:reading.d,
h:reading.h,
t:reading.t,
medicationName:reading.medicationName,
medicationTiming:reading.medicationTiming,
hoursAfterMed:reading.hoursAfterMed||0,
date:reading._date||todayKey
});
}
});

return medReadings;
}

function calculateMedicationEffectiveness(){
// Targets now come from settings ranges (used by calculateEffectiveness internally)
var targets={
systolicMin:settings.systolicMin||90,
systolicMax:settings.systolicMax||140,
diastolicMin:settings.diastolicMin||60,
diastolicMax:settings.diastolicMax||90,
hrMin:settings.hrMin||50,
hrMax:settings.hrMax||100
};

var readings=getMedicationReadings();

if(readings.length===0){
var periodText=getPeriodLabel(medAnalysisPeriod).toLowerCase();
document.getElementById('medEffectivenessResults').innerHTML=
'<div style="padding:40px;text-align:center;background:#fef3c7;border:2px solid #f59e0b;border-radius:12px">'+
'<div style="font-size:48px;margin-bottom:16px">üìä</div>'+
'<div style="font-size:20px;font-weight:600;color:#92400e;margin-bottom:8px">No Medication Readings for '+getPeriodLabel(medAnalysisPeriod)+'</div>'+
'<div style="font-size:16px;color:#6b7280;margin-bottom:16px">No BP readings with medication tracking were found for this time period.</div>'+
'<div style="background:#fff;border:2px solid #f59e0b;border-radius:8px;padding:16px;margin:16px auto;max-width:500px;text-align:left">'+
'<div style="font-weight:700;color:#92400e;margin-bottom:12px;font-size:16px">üí° How to track medication effectiveness:</div>'+
'<ol style="margin:0;padding-left:20px;color:#6b7280;font-size:14px;line-height:1.8">'+
'<li>Click "Log Blood Pressure" on main screen</li>'+
'<li>Check "This reading relates to medication"</li>'+
'<li>Select your medication from the dropdown</li>'+
'<li>Choose "Before Med" or "After Med"</li>'+
'<li>For After readings, enter hours since taking medication</li>'+
'</ol>'+
'</div>'+
'<div style="margin-top:20px">'+
'<button onclick="closeMedicationEffectiveness()" style="background:#10b981;color:white;border:none;padding:16px 32px;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(16,185,129,0.3)">'+
'‚úì Go Log BP Data'+
'</button>'+
'</div>'+
'</div>';
return;
}

// Group by medication
var byMedication={};
readings.forEach(function(r){
if(!byMedication[r.medicationName]){
byMedication[r.medicationName]={
before:[],
after:[]
};
}
if(r.medicationTiming==='before'){
byMedication[r.medicationName].before.push(r);
}else if(r.medicationTiming==='after'){
byMedication[r.medicationName].after.push(r);
}
});

// Calculate statistics for each medication
var html='';
var medNames=Object.keys(byMedication);

if(medNames.length===0){
html+='<div style="padding:40px;text-align:center;background:#fef3c7;border:2px solid #f59e0b;border-radius:12px">';
html+='<div style="font-size:48px;margin-bottom:16px">üìä</div>';
html+='<div style="font-size:20px;font-weight:600;color:#92400e">No paired readings found for analysis</div>';
html+='</div>';
document.getElementById('medEffectivenessResults').innerHTML=html;
return;
}

medNames.forEach(function(medName){
var data=byMedication[medName];
var beforeCount=data.before.length;
var afterCount=data.after.length;

html+='<div style="background:#fff;border:3px solid #10b981;border-radius:12px;padding:24px;margin-bottom:24px">';
html+='<h3 style="margin:0 0 20px 0;font-size:24px;color:#10b981">üíä '+medName+'</h3>';

// Statistics grid
html+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-bottom:24px">';

// Before statistics
if(beforeCount>0){
var beforeAvg=calculateAverages(data.before);
html+='<div style="background:#eff6ff;border:2px solid #3b82f6;border-radius:10px;padding:16px">';
html+='<div style="font-size:14px;font-weight:700;color:#1e3a8a;margin-bottom:12px">üìä BEFORE Medication ('+beforeCount+' readings)</div>';
html+='<div style="font-size:32px;font-weight:700;color:#1e3a8a;margin-bottom:4px">'+Math.round(beforeAvg.systolic)+'/'+Math.round(beforeAvg.diastolic)+'</div>';
html+='<div style="font-size:16px;color:#3b82f6;font-weight:600">HR: '+Math.round(beforeAvg.hr)+' bpm</div>';
html+='</div>';
}else{
html+='<div style="background:#f3f4f6;border:2px solid #d1d5db;border-radius:10px;padding:16px;text-align:center;color:#6b7280">';
html+='<div style="font-size:14px;font-weight:600">No "Before" readings</div>';
html+='</div>';
}

// After statistics
if(afterCount>0){
var afterAvg=calculateAverages(data.after);
html+='<div style="background:#dcfce7;border:2px solid #10b981;border-radius:10px;padding:16px">';
html+='<div style="font-size:14px;font-weight:700;color:#166534;margin-bottom:12px">üíä AFTER Medication ('+afterCount+' readings)</div>';
html+='<div style="font-size:32px;font-weight:700;color:#166534;margin-bottom:4px">'+Math.round(afterAvg.systolic)+'/'+Math.round(afterAvg.diastolic)+'</div>';
html+='<div style="font-size:16px;color:#10b981;font-weight:600">HR: '+Math.round(afterAvg.hr)+' bpm</div>';
html+='</div>';
}else{
html+='<div style="background:#f3f4f6;border:2px solid #d1d5db;border-radius:10px;padding:16px;text-align:center;color:#6b7280">';
html+='<div style="font-size:14px;font-weight:600">No "After" readings</div>';
html+='</div>';
}

// Effectiveness calculation
if(beforeCount>0&&afterCount>0){
var effectiveness=calculateEffectiveness(beforeAvg,afterAvg,targets);
var effColor=effectiveness.overall>=70?'#10b981':effectiveness.overall>=50?'#f59e0b':'#ef4444';
var effBg=effectiveness.overall>=70?'#dcfce7':effectiveness.overall>=50?'#fef3c7':'#fee2e2';
var effLabel=effectiveness.overall>=70?'Excellent':effectiveness.overall>=50?'Moderate':'Needs Review';

html+='<div style="background:'+effBg+';border:3px solid '+effColor+';border-radius:10px;padding:16px">';
html+='<div style="font-size:14px;font-weight:700;color:'+effColor+';margin-bottom:8px">üéØ EFFECTIVENESS</div>';
html+='<div style="font-size:48px;font-weight:700;color:'+effColor+';line-height:1">'+Math.round(effectiveness.overall)+'%</div>';
html+='<div style="font-size:14px;font-weight:600;color:'+effColor+';margin-top:4px">'+effLabel+'</div>';
html+='<div style="font-size:11px;color:#6b7280;margin-top:8px">In-Range ¬∑ Direction ¬∑ Stability</div>';

// Show if after readings are within range
var afterInRangeSys=(Math.round(afterAvg.systolic)>=settings.systolicMin&&Math.round(afterAvg.systolic)<=settings.systolicMax);
var afterInRangeDia=(Math.round(afterAvg.diastolic)>=settings.diastolicMin&&Math.round(afterAvg.diastolic)<=settings.diastolicMax);
html+='<div style="margin-top:8px;font-size:12px">';
html+=(afterInRangeSys?'‚úÖ':'‚ùå')+' Sys '+(afterInRangeSys?'in':'out of')+' range ';
html+=(afterInRangeDia?'‚úÖ':'‚ùå')+' Dia '+(afterInRangeDia?'in':'out of')+' range';
html+='</div>';
html+='</div>';
}

html+='</div>';

// Changes breakdown
if(beforeCount>0&&afterCount>0){
var change={
systolic:(afterAvg.systolic-beforeAvg.systolic).toFixed(1),
diastolic:(afterAvg.diastolic-beforeAvg.diastolic).toFixed(1),
hr:(afterAvg.hr-beforeAvg.hr).toFixed(1)
};

html+='<div style="background:#f9fafb;border:2px solid #e5e7eb;border-radius:10px;padding:16px;margin-bottom:16px">';
html+='<div style="font-weight:700;margin-bottom:12px;font-size:16px">üìà Average Changes:</div>';
html+='<div style="display:flex;justify-content:space-around;flex-wrap:wrap;gap:12px">';
html+='<div style="text-align:center">';
html+='<div style="font-size:11px;color:#6b7280;font-weight:600">SYSTOLIC</div>';
html+='<div style="font-size:24px;font-weight:700;color:'+(change.systolic<=0?'#10b981':'#ef4444')+'">'+(change.systolic>0?'+':'')+change.systolic+'</div>';
html+='</div>';
html+='<div style="text-align:center">';
html+='<div style="font-size:11px;color:#6b7280;font-weight:600">DIASTOLIC</div>';
html+='<div style="font-size:24px;font-weight:700;color:'+(change.diastolic<=0?'#10b981':'#ef4444')+'">'+(change.diastolic>0?'+':'')+change.diastolic+'</div>';
html+='</div>';
html+='<div style="text-align:center">';
html+='<div style="font-size:11px;color:#6b7280;font-weight:600">HEART RATE</div>';
html+='<div style="font-size:24px;font-weight:700;color:'+(change.hr<=0?'#10b981':'#ef4444')+'">'+(change.hr>0?'+':'')+change.hr+'</div>';
html+='</div>';
html+='</div>';
html+='</div>';

// Interpretation
var afterInRange=(Math.round(afterAvg.systolic)>=settings.systolicMin&&Math.round(afterAvg.systolic)<=settings.systolicMax&&Math.round(afterAvg.diastolic)>=settings.diastolicMin&&Math.round(afterAvg.diastolic)<=settings.diastolicMax);
var bpDropped=(afterAvg.systolic<=beforeAvg.systolic&&afterAvg.diastolic<=beforeAvg.diastolic);

html+='<div style="background:#dbeafe;border-left:4px solid #3b82f6;padding:16px;border-radius:8px">';
html+='<div style="font-weight:700;margin-bottom:8px;color:#1e3a8a">üí° Interpretation:</div>';
if(afterInRange&&bpDropped){
html+='<div style="color:#374151">'+medName+' is <strong>effectively controlling BP</strong>. Post-medication readings are within your acceptable range ('+settings.systolicMin+'‚Äì'+settings.systolicMax+'/'+settings.diastolicMin+'‚Äì'+settings.diastolicMax+') with consistent reductions. Continue as prescribed.</div>';
}else if(afterInRange){
html+='<div style="color:#374151">Post-medication readings are <strong>within your acceptable range</strong>, though the before/after pattern is mixed. Continue monitoring and discuss trends with your doctor.</div>';
}else if(bpDropped){
html+='<div style="color:#374151">'+medName+' is <strong>lowering your BP</strong> (Œî '+change.systolic+'/'+change.diastolic+'), but post-medication readings are still outside your range ('+settings.systolicMin+'‚Äì'+settings.systolicMax+'). Discuss whether a dosage adjustment might be beneficial.</div>';
}else{
html+='<div style="color:#374151">Post-medication readings are <strong>not consistently within your target range</strong>. This doesn\'t necessarily mean the medication isn\'t working ‚Äî discuss the full picture with your doctor, including timing, dosage, and other factors.</div>';
}
html+='</div>';
}

html+='</div>';
});

// === CLINICAL SUMMARY FOR CARDIOLOGIST ===
html+='<div style="background:#f0fdf4;border:3px solid #10b981;border-radius:12px;padding:24px;margin-top:24px">';
html+='<div style="font-weight:700;font-size:20px;color:#166534;margin-bottom:16px">ü©∫ Clinical Summary ‚Äì Medication Effectiveness</div>';
html+='<div style="color:#374151;font-size:16px;line-height:1.8">';

medNames.forEach(function(medName){
var data=byMedication[medName];
var bCnt=data.before.length;
var aCnt=data.after.length;
html+='<div style="margin-bottom:16px;padding:16px;background:#fff;border:1px solid #d1fae5;border-radius:8px">';
html+='<div style="font-weight:700;font-size:18px;color:#10b981;margin-bottom:8px">'+medName+'</div>';

if(bCnt>0&&aCnt>0){
var bAvg=calculateAverages(data.before);
var aAvg=calculateAverages(data.after);
var dSys=(aAvg.systolic-bAvg.systolic).toFixed(1);
var dDia=(aAvg.diastolic-bAvg.diastolic).toFixed(1);
var dHR=(aAvg.hr-bAvg.hr).toFixed(1);
var sDir=parseFloat(dSys)<=0?'decreased':'increased';
var dDir=parseFloat(dDia)<=0?'decreased':'increased';
var hDir=parseFloat(dHR)<=0?'decreased':'increased';
html+='<div>Pre-medication average: <strong>'+Math.round(bAvg.systolic)+'/'+Math.round(bAvg.diastolic)+' mmHg</strong>, HR <strong>'+Math.round(bAvg.hr)+' bpm</strong> (n='+bCnt+')</div>';
html+='<div>Post-medication average: <strong>'+Math.round(aAvg.systolic)+'/'+Math.round(aAvg.diastolic)+' mmHg</strong>, HR <strong>'+Math.round(aAvg.hr)+' bpm</strong> (n='+aCnt+')</div>';
html+='<div style="margin-top:8px;font-weight:600">Œî Systolic: <span style="color:'+(parseFloat(dSys)<=0?'#10b981':'#ef4444')+'">'+(parseFloat(dSys)>0?'+':'')+dSys+' mmHg ('+sDir+')</span></div>';
html+='<div style="font-weight:600">Œî Diastolic: <span style="color:'+(parseFloat(dDia)<=0?'#10b981':'#ef4444')+'">'+(parseFloat(dDia)>0?'+':'')+dDia+' mmHg ('+dDir+')</span></div>';
html+='<div style="font-weight:600">Œî Heart Rate: <span style="color:'+(parseFloat(dHR)<=0?'#10b981':'#ef4444')+'">'+(parseFloat(dHR)>0?'+':'')+dHR+' bpm ('+hDir+')</span></div>';

// Time-stratified breakdown for after readings
if(aCnt>=2){
var earlyAfter=data.after.filter(function(r){return(r.hoursAfterMed||0)<=2;});
var lateAfter=data.after.filter(function(r){return(r.hoursAfterMed||0)>2;});
if(earlyAfter.length>0&&lateAfter.length>0){
var earlyAvg=calculateAverages(earlyAfter);
var lateAvg=calculateAverages(lateAfter);
html+='<div style="margin-top:10px;padding:10px;background:#f0f9ff;border-left:3px solid #3b82f6;border-radius:4px;font-size:14px">';
html+='<strong>Time Response:</strong> At ‚â§2h post-med: '+Math.round(earlyAvg.systolic)+'/'+Math.round(earlyAvg.diastolic)+' (n='+earlyAfter.length+') ‚Üí At >2h: '+Math.round(lateAvg.systolic)+'/'+Math.round(lateAvg.diastolic)+' (n='+lateAfter.length+')';
html+='</div>';
}
}
}else if(bCnt>0){
var bAvg2=calculateAverages(data.before);
html+='<div>Pre-medication average: <strong>'+Math.round(bAvg2.systolic)+'/'+Math.round(bAvg2.diastolic)+' mmHg</strong>, HR <strong>'+Math.round(bAvg2.hr)+' bpm</strong> (n='+bCnt+')</div>';
html+='<div style="color:#92400e;font-style:italic">No post-medication readings logged yet.</div>';
}else{
var aAvg2=calculateAverages(data.after);
html+='<div>Post-medication average: <strong>'+Math.round(aAvg2.systolic)+'/'+Math.round(aAvg2.diastolic)+' mmHg</strong>, HR <strong>'+Math.round(aAvg2.hr)+' bpm</strong> (n='+aCnt+')</div>';
html+='<div style="color:#92400e;font-style:italic">No pre-medication baseline readings logged yet.</div>';
}
html+='</div>';
});

html+='</div>';
html+='</div>';

// Summary section
var dateRangeText='';
if(medAnalysisPeriod==='today'){
dateRangeText='Today only ('+getTodayKey()+')';
}else if(medAnalysisPeriod==='week'){
var weekAgo=new Date();
weekAgo.setDate(weekAgo.getDate()-7);
dateRangeText='Last 7 days ('+weekAgo.toISOString().split('T')[0]+' to '+getTodayKey()+')';
}else if(medAnalysisPeriod==='month'){
var monthAgo=new Date();
monthAgo.setDate(monthAgo.getDate()-30);
dateRangeText='Last 30 days ('+monthAgo.toISOString().split('T')[0]+' to '+getTodayKey()+')';
}else{
dateRangeText='All historical data';
}

html+='<div style="background:#dbeafe;border:2px solid #3b82f6;border-radius:12px;padding:20px;margin-top:24px">';
html+='<div style="font-weight:700;font-size:18px;color:#1e3a8a;margin-bottom:12px">üìã Analysis Summary</div>';
html+='<div style="color:#374151;font-size:16px;line-height:1.8">';
html+='<div style="margin-bottom:8px"><strong style="color:#1e3a8a">üìÖ Period:</strong> '+dateRangeText+'</div>';
html+='<div style="margin-bottom:8px"><strong style="color:#1e3a8a">üìä Data Points:</strong> '+readings.length+' total readings ('+medNames.length+' medication'+(medNames.length>1?'s':'')+' tracked)</div>';
html+='<div style="margin-bottom:8px"><strong style="color:#1e3a8a">üéØ Acceptable Ranges:</strong> Systolic '+settings.systolicMin+'‚Äì'+settings.systolicMax+' / Diastolic '+settings.diastolicMin+'‚Äì'+settings.diastolicMax+' / HR '+settings.hrMin+'‚Äì'+settings.hrMax+'</div>';
html+='<div style="padding:12px;background:#f0f9ff;border-left:3px solid #3b82f6;border-radius:4px;margin-top:12px;font-size:14px">';
html+='<strong>‚ÑπÔ∏è How scoring works:</strong> Effectiveness is scored on three factors: (1) Are post-medication readings within your acceptable ranges? (2) Did the medication move values toward your range? (3) Is the medication maintaining stability? A higher score means better overall control.';
html+='</div>';
html+='</div>';
html+='</div>';

document.getElementById('medEffectivenessResults').innerHTML=html;
}

function calculateAverages(readings){
if(readings.length===0)return{systolic:0,diastolic:0,hr:0};
var sum={s:0,d:0,h:0};
readings.forEach(function(r){
sum.s+=r.s;
sum.d+=r.d;
sum.h+=r.h;
});
return{
systolic:sum.s/readings.length,
diastolic:sum.d/readings.length,
hr:sum.h/readings.length
};
}

function calculateEffectiveness(before,after,targets){
// Range-aware effectiveness scoring using Settings ranges
var sMin=settings.systolicMin||90;
var sMax=settings.systolicMax||140;
var dMin=settings.diastolicMin||60;
var dMax=settings.diastolicMax||90;
var hMin=settings.hrMin||50;
var hMax=settings.hrMax||100;

// Helper: score a single metric (0-100)
// Considers: 1) Is after-value in range? 2) Did it move toward range? 3) Magnitude of improvement
function scoreMetric(beforeVal,afterVal,rangeMin,rangeMax){
var score=0;

// Component 1 (40pts): Is the after-value within acceptable range?
var afterInRange=(afterVal>=rangeMin&&afterVal<=rangeMax);
if(afterInRange)score+=40;

// Component 2 (35pts): Did it move in the right direction?
var beforeDist=0; // distance from range
if(beforeVal<rangeMin)beforeDist=rangeMin-beforeVal;
else if(beforeVal>rangeMax)beforeDist=beforeVal-rangeMax;

var afterDist=0;
if(afterVal<rangeMin)afterDist=rangeMin-afterVal;
else if(afterVal>rangeMax)afterDist=afterVal-rangeMax;

// Before was already in range
if(beforeDist===0){
// Still in range after = good; moved out = bad
if(afterDist===0)score+=35;
else score+=Math.max(0,35-afterDist*2);
}else{
// Before was out of range: reward any movement toward range
var improvement=beforeDist-afterDist;
if(improvement>0){
var pctImproved=Math.min(1,improvement/beforeDist);
score+=Math.round(35*pctImproved);
}
// Even if not fully in range, partial credit for direction
}

// Component 3 (25pts): Magnitude of beneficial change
// Any reduction in distance from range midpoint OR maintaining good position
var rangeMid=(rangeMin+rangeMax)/2;
var beforeDistMid=Math.abs(beforeVal-rangeMid);
var afterDistMid=Math.abs(afterVal-rangeMid);
if(afterDistMid<=beforeDistMid){
score+=25; // moved closer to or maintained distance to mid
}else{
// Still give partial credit if within range
if(afterInRange)score+=15;
}

return Math.min(100,score);
}

var sysScore=scoreMetric(before.systolic,after.systolic,sMin,sMax);
var diaScore=scoreMetric(before.diastolic,after.diastolic,dMin,dMax);
var hrScore=scoreMetric(before.hr,after.hr,hMin,hMax);

return{
systolic:Math.round(sysScore),
diastolic:Math.round(diaScore),
hr:Math.round(hrScore),
overall:Math.round((sysScore+diaScore+hrScore)/3),
rangeInfo:{sMin:sMin,sMax:sMax,dMin:dMin,dMax:dMax,hMin:hMin,hMax:hMax}
};
}

function getPeriodLabel(period){
if(period==='today')return'Today';
if(period==='week')return'Last 7 Days';
if(period==='month')return'Last 30 Days';
return'All Time';
}

// === PHASE 2: MEDICATION HR TAB FUNCTIONS ===
var hrMedPeriod='today';

function setHRMedPeriod(period){
hrMedPeriod=period;
// Update button states
['today','week','month','all'].forEach(function(p){
var btn=document.getElementById('hrMedPeriod'+p.charAt(0).toUpperCase()+p.slice(1));
if(btn){
if(p===period){
btn.style.background='#3b82f6';
btn.style.color='#fff';
}else{
btn.style.background='#e5e7eb';
btn.style.color='#000';
}
}
});
populateMedicationHRData();
}

function populateMedicationHRData(){
var allData=getAllHistoricalData();
var medReadings=[];
var cutoffDate=null;

// Determine date range based on period
if(hrMedPeriod==='today'){
// Today only - same date
var todayKey=getTodayKey();
cutoffDate=new Date(todayKey+'T00:00:00');
}else if(hrMedPeriod==='week'){
// Last 7 days
cutoffDate=new Date();
cutoffDate.setDate(cutoffDate.getDate()-7);
cutoffDate.setHours(0,0,0,0);
}else if(hrMedPeriod==='month'){
// Last 30 days
cutoffDate=new Date();
cutoffDate.setDate(cutoffDate.getDate()-30);
cutoffDate.setHours(0,0,0,0);
}else{
// All time - no cutoff
cutoffDate=null;
}

console.log('HR Med period:',hrMedPeriod,'Cutoff date:',cutoffDate);

// FIXED: allData is an object {bp: [...], weight: [...], ...}
if(!allData||!allData.bp||allData.bp.length===0){
console.log('No BP data found for HR medication analysis');
document.getElementById('hrMedicationResults').innerHTML=
'<div style="padding:40px;text-align:center;background:#fef3c7;border:2px solid #f59e0b;border-radius:12px">'+
'<div style="font-size:48px;margin-bottom:16px">üíä</div>'+
'<div style="font-size:20px;font-weight:600;color:#92400e;margin-bottom:8px">No Medication HR Data for '+getPeriodLabel(hrMedPeriod)+'</div>'+
'<div style="font-size:16px;color:#6b7280">Start logging BP readings with medication tracking to see heart rate analysis.</div>'+
'</div>';
return;
}

// Collect medication-related readings
allData.bp.forEach(function(reading){
if(reading.medicationRelated&&reading.medicationTiming&&reading.medicationTiming!=='none'&&reading.h){
// Get the date from the reading's _date property
var readingDateStr=reading._date;
if(!readingDateStr){
return;
}

// Parse the date properly
var readingDate=new Date(readingDateStr+'T00:00:00');

var includeReading=false;
if(!cutoffDate){
// All time - include everything
includeReading=true;
}else if(hrMedPeriod==='today'){
// Today only - exact date match
includeReading=(readingDateStr===getTodayKey());
}else{
// Week or Month - date is on or after cutoff
includeReading=(readingDate>=cutoffDate);
}

if(includeReading){
medReadings.push({
hr:reading.h,
timing:reading.medicationTiming,
medication:reading.medicationName,
hoursAfter:reading.hoursAfterMed||0,
date:readingDateStr,
time:reading.t
});
}
}
});

console.log('Found',medReadings.length,'HR medication readings for period',hrMedPeriod);

var html='';

if(medReadings.length===0){
html='<div style="padding:40px;text-align:center;background:#fef3c7;border:2px solid #f59e0b;border-radius:12px">';
html+='<div style="font-size:48px;margin-bottom:16px">üíä</div>';
html+='<div style="font-size:20px;font-weight:600;color:#92400e;margin-bottom:8px">No Medication HR Data for '+getPeriodLabel(hrMedPeriod)+'</div>';
html+='<div style="font-size:16px;color:#6b7280">Start logging BP readings with medication tracking to see heart rate analysis.</div>';
html+='</div>';
document.getElementById('hrMedicationResults').innerHTML=html;
return;
}

// Separate before/after readings
var beforeReadings=medReadings.filter(function(r){return r.timing==='before';});
var afterReadings=medReadings.filter(function(r){return r.timing==='after';});

// Calculate averages
var beforeAvgHR=beforeReadings.length>0?beforeReadings.reduce(function(sum,r){return sum+r.hr;},0)/beforeReadings.length:0;
var afterAvgHR=afterReadings.length>0?afterReadings.reduce(function(sum,r){return sum+r.hr;},0)/afterReadings.length:0;

// Statistics cards
html+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">';

// Before stats
html+='<div style="background:#eff6ff;border:3px solid #3b82f6;border-radius:12px;padding:20px;text-align:center">';
html+='<div style="font-size:14px;color:#1e3a8a;font-weight:700;margin-bottom:12px">üìä BEFORE Medication</div>';
html+='<div style="font-size:48px;font-weight:700;color:#3b82f6;line-height:1">'+Math.round(beforeAvgHR)+'</div>';
html+='<div style="font-size:14px;color:#6b7280;margin-top:8px">avg BPM ('+beforeReadings.length+' readings)</div>';
html+='</div>';

// After stats
html+='<div style="background:#dcfce7;border:3px solid #10b981;border-radius:12px;padding:20px;text-align:center">';
html+='<div style="font-size:14px;color:#166534;font-weight:700;margin-bottom:12px">üíä AFTER Medication</div>';
html+='<div style="font-size:48px;font-weight:700;color:#10b981;line-height:1">'+Math.round(afterAvgHR)+'</div>';
html+='<div style="font-size:14px;color:#6b7280;margin-top:8px">avg BPM ('+afterReadings.length+' readings)</div>';
html+='</div>';

// Change
if(beforeReadings.length>0&&afterReadings.length>0){
var change=afterAvgHR-beforeAvgHR;
var changeColor=change<0?'#10b981':'#ef4444';
var changeBg=change<0?'#dcfce7':'#fee2e2';
html+='<div style="background:'+changeBg+';border:3px solid '+changeColor+';border-radius:12px;padding:20px;text-align:center">';
html+='<div style="font-size:14px;color:'+changeColor+';font-weight:700;margin-bottom:12px">üìà CHANGE</div>';
html+='<div style="font-size:48px;font-weight:700;color:'+changeColor+';line-height:1">'+(change>0?'+':'')+change.toFixed(1)+'</div>';
html+='<div style="font-size:14px;color:#6b7280;margin-top:8px">BPM difference</div>';
html+='</div>';
}

html+='</div>';

// Group by medication
var byMedication={};
medReadings.forEach(function(r){
if(!byMedication[r.medication]){
byMedication[r.medication]={before:[],after:[]};
}
byMedication[r.medication][r.timing].push(r);
});

// Show per-medication breakdown
html+='<div style="background:#fff;border:2px solid #e5e7eb;border-radius:12px;padding:20px;margin-bottom:20px">';
html+='<h4 style="margin:0 0 16px 0;color:#374151;font-size:18px">üíä By Medication</h4>';

Object.keys(byMedication).forEach(function(medName){
var data=byMedication[medName];
var befAvg=data.before.length>0?data.before.reduce(function(s,r){return s+r.hr;},0)/data.before.length:0;
var aftAvg=data.after.length>0?data.after.reduce(function(s,r){return s+r.hr;},0)/data.after.length:0;

html+='<div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:16px;margin-bottom:12px">';
html+='<div style="font-weight:700;font-size:16px;margin-bottom:12px;color:#1f2937">'+medName+'</div>';
html+='<div style="display:flex;justify-content:space-around;flex-wrap:wrap;gap:16px;font-size:14px">';
html+='<div><span style="color:#3b82f6;font-weight:600">Before:</span> '+Math.round(befAvg)+' BPM ('+data.before.length+')</div>';
html+='<div><span style="color:#10b981;font-weight:600">After:</span> '+Math.round(aftAvg)+' BPM ('+data.after.length+')</div>';
if(befAvg>0&&aftAvg>0){
var medChange=aftAvg-befAvg;
html+='<div><span style="color:#6b7280;font-weight:600">Change:</span> <span style="color:'+(medChange<0?'#10b981':'#ef4444')+';font-weight:700">'+(medChange>0?'+':'')+medChange.toFixed(1)+' BPM</span></div>';
}
html+='</div>';
html+='</div>';
});

html+='</div>';

// Interpretation
if(beforeReadings.length>0&&afterReadings.length>0){
var change=afterAvgHR-beforeAvgHR;
html+='<div style="background:#dbeafe;border-left:4px solid #3b82f6;padding:16px;border-radius:8px">';
html+='<div style="font-weight:700;margin-bottom:8px;color:#1e3a8a">üí° Heart Rate Impact:</div>';
if(change<-5){
html+='<div style="color:#374151">Your medication is effectively <strong>lowering your heart rate</strong> by an average of '+Math.abs(change).toFixed(1)+' BPM. This is a positive response if you\'re being treated for high heart rate.</div>';
}else if(change>5){
html+='<div style="color:#374151">Your heart rate <strong>increases</strong> by an average of '+change.toFixed(1)+' BPM after medication. Discuss with your doctor if this is expected for your treatment.</div>';
}else{
html+='<div style="color:#374151">Your medication shows <strong>minimal impact</strong> on heart rate ('+change.toFixed(1)+' BPM change). This may be normal depending on your medication type.</div>';
}
html+='</div>';
}

// Period summary
html+='<div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:16px;margin-top:20px;font-size:14px;color:#6b7280">';
html+='<strong>Period:</strong> '+getPeriodLabel(hrMedPeriod)+' | ';
html+='<strong>Total Readings:</strong> '+medReadings.length+' | ';
html+='<strong>Medications Tracked:</strong> '+Object.keys(byMedication).length;
html+='</div>';

document.getElementById('hrMedicationResults').innerHTML=html;
}

function openAnalyticsDashboard(){
document.getElementById('analyticsDashboardModal').style.display='block';
// Load saved notes
const savedNotes=localStorage.getItem('analyticsNotes');
if(savedNotes){
analyticsNotesData=JSON.parse(savedNotes);
}
}

function closeAnalyticsDashboard(){
document.getElementById('analyticsDashboardModal').style.display='none';
closeAnalyticsChart(); // Close any open charts
}

// Doctor's Report Functions
function showDoctorReportSection(){
const section=document.getElementById('doctorReportSection');
section.style.display='block';
section.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function closeDoctorReportModal(){
document.getElementById('doctorReportModal').style.display='none';
}

function generateDoctorReport(){
// v9.5.5: Doctor's Report temporarily disabled ‚Äî calculations under review
var comingSoonHTML = '<div style="text-align:center;padding:60px 30px">';
comingSoonHTML += '<div style="font-size:64px;margin-bottom:20px">ü©∫</div>';
comingSoonHTML += '<h2 style="margin:0 0 16px 0;color:#1f2937;font-size:28px">Coming Soon in v9.6</h2>';
comingSoonHTML += '<p style="color:#6b7280;font-size:18px;max-width:500px;margin:0 auto 24px auto;line-height:1.6">';
comingSoonHTML += 'The Doctor\'s Report is being professionally audited to ensure all medical calculations meet clinical accuracy standards.</p>';
comingSoonHTML += '<div style="background:#fef3c7;border:2px solid #f59e0b;border-radius:12px;padding:20px;max-width:480px;margin:0 auto 24px auto">';
comingSoonHTML += '<p style="margin:0;color:#92400e;font-size:16px"><strong>‚ö†Ô∏è Why?</strong> Patient safety requires verified calculations before generating medical reports. We\'re reviewing every formula and statistic.</p>';
comingSoonHTML += '</div>';
comingSoonHTML += '<p style="color:#9ca3af;font-size:14px">In the meantime, use <strong>Export Today\'s Data</strong> or <strong>Advanced Analytics</strong> to share data with your doctor.</p>';
comingSoonHTML += '</div>';
document.getElementById('doctorReportContent').innerHTML = comingSoonHTML;
document.getElementById('doctorReportModal').style.display = 'block';
}

function buildDoctorReportHTML(data,startDate,endDate){
const patient=settings.patientName||'[Patient Name Not Set]';
const diagnosis=settings.diagnosis||'Not specified';
const reportDate=new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
const periodStart=startDate.toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'});
const periodEnd=endDate.toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'});

// Calculate key metrics
const bpReadings=data.bp;
const weightEntries=data.weight;
const medications=data.medications;
const symptoms=data.symptoms;
const procedures=getProceduresInRange(startDate,endDate);

// BP Statistics
let avgSystolic=0,avgDiastolic=0,avgHR=0;
let minSystolic=999,maxSystolic=0;
let minDiastolic=999,maxDiastolic=0;
if(bpReadings.length>0){
let sumSys=0,sumDia=0,sumHR=0;
bpReadings.forEach(r=>{
sumSys+=r.s;
sumDia+=r.d;
sumHR+=r.h||0;
if(r.s<minSystolic)minSystolic=r.s;
if(r.s>maxSystolic)maxSystolic=r.s;
if(r.d<minDiastolic)minDiastolic=r.d;
if(r.d>maxDiastolic)maxDiastolic=r.d;
});
avgSystolic=Math.round(sumSys/bpReadings.length);
avgDiastolic=Math.round(sumDia/bpReadings.length);
avgHR=Math.round(sumHR/bpReadings.length);
}

// Weight Statistics
let avgWeight=0,minWeight=999,maxWeight=0,weightChange=0;
if(weightEntries.length>0){
let sumWeight=0;
weightEntries.forEach(wt=>{
sumWeight+=wt.w;
if(wt.w<minWeight)minWeight=wt.w;
if(wt.w>maxWeight)maxWeight=wt.w;
});
avgWeight=(sumWeight/weightEntries.length).toFixed(1);
const sortedWeights=weightEntries.sort((a,b)=>new Date(a._date+' '+a.t)-new Date(b._date+' '+b.t));
if(sortedWeights.length>=2){
weightChange=(sortedWeights[sortedWeights.length-1].w-sortedWeights[0].w).toFixed(1);
}
}

// Medication adherence
const uniqueMedDays=new Set(medications.map(m=>m._date)).size;
const totalDays=Math.ceil((endDate-startDate)/(1000*60*60*24))+1;
const medicationAdherence=totalDays>0?Math.round((uniqueMedDays/totalDays)*100):0;

// Out-of-range readings
const outOfRangeSystolic=[];
const outOfRangeDiastolic=[];
const outOfRangeHR=[];
bpReadings.forEach(reading=>{
const date=reading._date;
const time=reading.t;
if(reading.s<settings.systolicMin||reading.s>settings.systolicMax){
outOfRangeSystolic.push({date,time,value:reading.s,status:reading.s<settings.systolicMin?'LOW':'HIGH'});
}
if(reading.d<settings.diastolicMin||reading.d>settings.diastolicMax){
outOfRangeDiastolic.push({date,time,value:reading.d,status:reading.d<settings.diastolicMin?'LOW':'HIGH'});
}
if(reading.h&&(reading.h<settings.hrMin||reading.h>settings.hrMax)){
outOfRangeHR.push({date,time,value:reading.h,status:reading.h<settings.hrMin?'LOW':'HIGH'});
}
});

// Build concise HTML report
let html=`
<div class="report-header">
<h1 style="color:#1f2937;margin:0;font-size:28px">Blood Pressure Medical Report</h1>
<p style="color:#6b7280;margin:8px 0 0 0">Generated: ${reportDate}</p>
</div>

<div class="report-section">
<div class="report-section-title">üìã Patient Information</div>
<table style="width:100%;border-collapse:collapse">
<tr><td style="padding:6px;font-weight:600;width:35%">Patient:</td><td style="padding:6px">${patient}</td></tr>
<tr><td style="padding:6px;font-weight:600">Diagnosis:</td><td style="padding:6px">${diagnosis}</td></tr>
<tr><td style="padding:6px;font-weight:600">Period:</td><td style="padding:6px">${periodStart} to ${periodEnd} (${totalDays} days)</td></tr>
<tr><td style="padding:6px;font-weight:600">Readings:</td><td style="padding:6px">${bpReadings.length} BP readings, ${weightEntries.length} weight entries</td></tr>
</table>
</div>

<div class="report-section">
<div class="report-section-title">üìä Blood Pressure Summary</div>
<table style="width:100%;border-collapse:collapse">
<tr><td style="padding:6px;font-weight:600;width:35%">Average BP:</td><td style="padding:6px;font-size:18px;font-weight:700;color:#1e40af">${avgSystolic}/${avgDiastolic} mmHg</td></tr>
<tr><td style="padding:6px;font-weight:600">Range:</td><td style="padding:6px">${minSystolic}-${maxSystolic} / ${minDiastolic}-${maxDiastolic} mmHg</td></tr>
<tr><td style="padding:6px;font-weight:600">Avg Heart Rate:</td><td style="padding:6px">${avgHR} bpm</td></tr>
<tr><td style="padding:6px;font-weight:600">Target Range:</td><td style="padding:6px">${settings.systolicMin}-${settings.systolicMax} / ${settings.diastolicMin}-${settings.diastolicMax} mmHg</td></tr>
</table>
</div>`;

// Out-of-range alerts (critical section)
const totalOutOfRange=outOfRangeSystolic.length+outOfRangeDiastolic.length+outOfRangeHR.length;
if(totalOutOfRange>0){
html+=`
<div class="report-section" style="background:#fef3c7;border:2px solid #f59e0b">
<div class="report-section-title" style="color:#92400e">‚ö†Ô∏è Out-of-Range Readings Alert</div>
<p style="margin:8px 0;font-weight:600">${totalOutOfRange} reading(s) outside target range:</p>
<ul style="margin:8px 0 8px 20px;line-height:1.8">`;
if(outOfRangeSystolic.length>0)html+=`<li><strong>Systolic:</strong> ${outOfRangeSystolic.length} occurrence(s) - ${outOfRangeSystolic.map(r=>r.status).join(', ')}</li>`;
if(outOfRangeDiastolic.length>0)html+=`<li><strong>Diastolic:</strong> ${outOfRangeDiastolic.length} occurrence(s) - ${outOfRangeDiastolic.map(r=>r.status).join(', ')}</li>`;
if(outOfRangeHR.length>0)html+=`<li><strong>Heart Rate:</strong> ${outOfRangeHR.length} occurrence(s) - ${outOfRangeHR.map(r=>r.status).join(', ')}</li>`;
html+=`</ul>
<p style="margin:8px 0;font-size:14px;color:#92400e"><strong>Note:</strong> Review these readings to determine if medication adjustment or further evaluation is needed.</p>
</div>`;
}

// Activity impact summary
if(settings.features&&settings.features.exercise){
const activityTypes={};
let totalActivitiesWithBP=0;
data.activities.forEach(activity=>{
const bpBefore=bpReadings.find(bp=>bp.activityId===activity.id&&bp.activityTiming==='before');
const bpAfter=bpReadings.find(bp=>bp.activityId===activity.id&&bp.activityTiming==='after');
if(bpBefore&&bpAfter){
totalActivitiesWithBP++;
let activityType=activity.activity.split('(')[0].trim();
if(activityType.startsWith('Manual Work'))activityType='Manual Work';
if(!activityTypes[activityType]){
activityTypes[activityType]={count:0,avgChange:{s:0,d:0}};
}
activityTypes[activityType].count++;
activityTypes[activityType].avgChange.s+=(bpAfter.s-bpBefore.s);
activityTypes[activityType].avgChange.d+=(bpAfter.d-bpBefore.d);
}
});

if(totalActivitiesWithBP>0){
Object.keys(activityTypes).forEach(type=>{
const data=activityTypes[type];
data.avgChange.s=Math.round(data.avgChange.s/data.count);
data.avgChange.d=Math.round(data.avgChange.d/data.count);
});

html+=`
<div class="report-section">
<div class="report-section-title">üèÉ Activity Impact on Blood Pressure</div>
<p style="margin:8px 0">${totalActivitiesWithBP} activities tracked with before/after BP measurements:</p>
<table style="width:100%;border-collapse:collapse;margin-top:8px">
<tr style="background:#f3f4f6"><th style="padding:8px;text-align:left;border:1px solid #e5e7eb">Activity</th><th style="padding:8px;text-align:center;border:1px solid #e5e7eb">Sessions</th><th style="padding:8px;text-align:center;border:1px solid #e5e7eb">Avg BP Change</th><th style="padding:8px;text-align:left;border:1px solid #e5e7eb">Assessment</th></tr>`;

Object.keys(activityTypes).forEach(type=>{
const d=activityTypes[type];
const sysChange=d.avgChange.s;
const diaChange=d.avgChange.d;
let assessment='Neutral';
let color='#6b7280';
if(sysChange>10||diaChange>5){assessment='Review Needed';color='#dc2626';}
else if(sysChange<-5||diaChange<-3){assessment='Beneficial';color='#10b981';}
html+=`<tr><td style="padding:8px;border:1px solid #e5e7eb">${type}</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">${d.count}</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:600">${sysChange>0?'+':''}${sysChange}/${diaChange>0?'+':''}${diaChange}</td><td style="padding:8px;border:1px solid #e5e7eb;color:${color};font-weight:600">${assessment}</td></tr>`;
});
html+=`</table></div>`;
}
}

// Weight summary
if(weightEntries.length>0){
html+=`
<div class="report-section">
<div class="report-section-title">‚öñÔ∏è Weight Summary</div>
<table style="width:100%;border-collapse:collapse">
<tr><td style="padding:6px;font-weight:600;width:35%">Average:</td><td style="padding:6px">${avgWeight} lbs</td></tr>
<tr><td style="padding:6px;font-weight:600">Range:</td><td style="padding:6px">${minWeight} - ${maxWeight} lbs</td></tr>
<tr><td style="padding:6px;font-weight:600">Net Change:</td><td style="padding:6px;font-weight:700">${weightChange>0?'+':''}${weightChange} lbs</td></tr>
</table>
</div>`;
}

// Procedures
if(procedures.length>0){
html+=`
<div class="report-section">
<div class="report-section-title">üè• Medical Procedures</div>`;
procedures.forEach(proc=>{
html+=`<div style="padding:8px;border-left:3px solid #dc2626;background:#fef2f2;margin:8px 0;border-radius:4px">
<strong>${new Date(proc.date).toLocaleDateString()}</strong> - ${proc.name}${proc.category?' ('+proc.category+')':''}`;
if(proc.facility)html+=`<br><span style="font-size:14px">Facility: ${proc.facility}</span>`;
if(proc.physician)html+=`<br><span style="font-size:14px">Physician: ${proc.physician}</span>`;
html+=`</div>`;
});
html+=`</div>`;
}

// Medication & symptoms summary
html+=`
<div class="report-section">
<div class="report-section-title">üíä Medication & Symptoms</div>
<table style="width:100%;border-collapse:collapse">
<tr><td style="padding:6px;font-weight:600;width:35%">Medication Adherence:</td><td style="padding:6px">${medicationAdherence}% (${uniqueMedDays} of ${totalDays} days)</td></tr>
<tr><td style="padding:6px;font-weight:600">Total Med Entries:</td><td style="padding:6px">${medications.length}</td></tr>
<tr><td style="padding:6px;font-weight:600">Symptom Events:</td><td style="padding:6px">${symptoms.length}</td></tr>
</table>
</div>`;

// Clinical assessment
html+=`
<div class="report-section" style="background:#f0f9ff;border:2px solid #3b82f6">
<div class="report-section-title" style="color:#1e40af">üìù Clinical Assessment</div>
<ul style="margin:12px 0;padding-left:20px;line-height:1.8">`;

if(avgSystolic>=140||avgDiastolic>=90){
html+=`<li style="color:#dc2626;font-weight:600">‚ö†Ô∏è Average BP (${avgSystolic}/${avgDiastolic}) indicates hypertension (‚â•140/90)</li>`;
}else if(avgSystolic>=130||avgDiastolic>=80){
html+=`<li style="color:#f59e0b">Average BP (${avgSystolic}/${avgDiastolic}) in Stage 1 range (130-139/80-89)</li>`;
}else{
html+=`<li style="color:#10b981">‚úì Average BP (${avgSystolic}/${avgDiastolic}) within normal range (&lt;130/80)</li>`;
}

if(totalOutOfRange>=10){
html+=`<li style="color:#dc2626;font-weight:600">‚ö†Ô∏è ${totalOutOfRange} out-of-range readings - medication review recommended</li>`;
}else if(totalOutOfRange>0){
html+=`<li style="color:#f59e0b">${totalOutOfRange} out-of-range reading(s) noted</li>`;
}

if(medicationAdherence>=80){
html+=`<li style="color:#10b981">‚úì Good medication adherence (${medicationAdherence}%)</li>`;
}else if(medicationAdherence>=50){
html+=`<li style="color:#f59e0b">Moderate medication adherence (${medicationAdherence}%) - consider barriers</li>`;
}else{
html+=`<li style="color:#dc2626">‚ö†Ô∏è Low medication adherence (${medicationAdherence}%) - requires intervention</li>`;
}

if(Math.abs(parseFloat(weightChange))>=5){
html+=`<li style="color:#f59e0b">Significant weight change: ${weightChange>0?'+':''}${weightChange} lbs</li>`;
}

html+=`</ul>
<p style="margin:12px 0 0 0;padding:12px;background:white;border-radius:6px;font-size:14px;color:#6b7280"><strong>Note:</strong> This report is based on patient self-tracked data. Clinical correlation and examination are essential for diagnosis and treatment decisions.</p>
</div>`;

html+=`
<div style="text-align:center;margin-top:24px;padding-top:16px;border-top:2px solid #e5e7eb;color:#6b7280;font-size:14px">
<p style="margin:0">ClinBridge v9.5.5 Medical Grade - Free</p>
<p style="margin:4px 0 0 0">Report Generated: ${reportDate}</p>
</div>`;

return html;
}

function buildDoctorReportText(data,startDate,endDate){
const patient=settings.patientName||'[Patient Name Not Set]';
const diagnosis=settings.diagnosis||'Not specified';
const reportDate=new Date().toLocaleDateString();
const periodStart=startDate.toLocaleDateString();
const periodEnd=endDate.toLocaleDateString();

// Calculate metrics
const bpReadings=data.bp;
const weightEntries=data.weight;
const medications=data.medications;
const symptoms=data.symptoms;
const procedures=getProceduresInRange(startDate,endDate);
const totalDays=Math.ceil((endDate-startDate)/(1000*60*60*24))+1;

// BP stats
let avgSystolic=0,avgDiastolic=0,avgHR=0,minSystolic=999,maxSystolic=0,minDiastolic=999,maxDiastolic=0;
if(bpReadings.length>0){
let sumSys=0,sumDia=0,sumHR=0;
bpReadings.forEach(r=>{
sumSys+=r.s;sumDia+=r.d;sumHR+=r.h||0;
if(r.s<minSystolic)minSystolic=r.s;
if(r.s>maxSystolic)maxSystolic=r.s;
if(r.d<minDiastolic)minDiastolic=r.d;
if(r.d>maxDiastolic)maxDiastolic=r.d;
});
avgSystolic=Math.round(sumSys/bpReadings.length);
avgDiastolic=Math.round(sumDia/bpReadings.length);
avgHR=Math.round(sumHR/bpReadings.length);
}

// Weight stats
let avgWeight=0,weightChange=0;
if(weightEntries.length>0){
let sumWeight=0;
weightEntries.forEach(wt=>sumWeight+=wt.w);
avgWeight=(sumWeight/weightEntries.length).toFixed(1);
const sorted=weightEntries.sort((a,b)=>new Date(a._date+' '+a.t)-new Date(b._date+' '+b.t));
if(sorted.length>=2)weightChange=(sorted[sorted.length-1].w-sorted[0].w).toFixed(1);
}

// Med adherence
const uniqueMedDays=new Set(medications.map(m=>m._date)).size;
const medicationAdherence=totalDays>0?Math.round((uniqueMedDays/totalDays)*100):0;

// Out-of-range
let outOfRangeSystolic=[],outOfRangeDiastolic=[],outOfRangeHR=[];
bpReadings.forEach(r=>{
if(r.s<settings.systolicMin||r.s>settings.systolicMax){
outOfRangeSystolic.push({date:r._date,time:r.t,value:r.s,status:r.s<settings.systolicMin?'LOW':'HIGH'});
}
if(r.d<settings.diastolicMin||r.d>settings.diastolicMax){
outOfRangeDiastolic.push({date:r._date,time:r.t,value:r.d,status:r.d<settings.diastolicMin?'LOW':'HIGH'});
}
if(r.h&&(r.h<settings.hrMin||r.h>settings.hrMax)){
outOfRangeHR.push({date:r._date,time:r.t,value:r.h,status:r.h<settings.hrMin?'LOW':'HIGH'});
}
});

// Build text report
let text=`BLOOD PRESSURE MEDICAL REPORT
Generated: ${reportDate}

PATIENT INFORMATION
-------------------
Patient: ${patient}
Diagnosis: ${diagnosis}
Period: ${periodStart} to ${periodEnd} (${totalDays} days)
Readings: ${bpReadings.length} BP readings, ${weightEntries.length} weight entries

BLOOD PRESSURE SUMMARY
----------------------
Average BP: ${avgSystolic}/${avgDiastolic} mmHg
Range: ${minSystolic}-${maxSystolic} / ${minDiastolic}-${maxDiastolic} mmHg
Average Heart Rate: ${avgHR} bpm
Target Range: ${settings.systolicMin}-${settings.systolicMax} / ${settings.diastolicMin}-${settings.diastolicMax} mmHg
`;

// Out-of-range alerts
const totalOutOfRange=outOfRangeSystolic.length+outOfRangeDiastolic.length+outOfRangeHR.length;
if(totalOutOfRange>0){
text+=`
*** OUT-OF-RANGE READINGS ALERT ***
${totalOutOfRange} reading(s) outside target range:
`;
if(outOfRangeSystolic.length>0)text+=`- Systolic: ${outOfRangeSystolic.length} occurrence(s)\n`;
if(outOfRangeDiastolic.length>0)text+=`- Diastolic: ${outOfRangeDiastolic.length} occurrence(s)\n`;
if(outOfRangeHR.length>0)text+=`- Heart Rate: ${outOfRangeHR.length} occurrence(s)\n`;
text+=`Note: Review these readings to determine if medication adjustment or further evaluation is needed.\n`;
}

// Activity impact
if(settings.features&&settings.features.exercise){
const activityTypes={};
let totalActivitiesWithBP=0;
data.activities.forEach(activity=>{
const bpBefore=bpReadings.find(bp=>bp.activityId===activity.id&&bp.activityTiming==='before');
const bpAfter=bpReadings.find(bp=>bp.activityId===activity.id&&bp.activityTiming==='after');
if(bpBefore&&bpAfter){
totalActivitiesWithBP++;
let activityType=activity.activity.split('(')[0].trim();
if(activityType.startsWith('Manual Work'))activityType='Manual Work';
if(!activityTypes[activityType])activityTypes[activityType]={count:0,avgChange:{s:0,d:0}};
activityTypes[activityType].count++;
activityTypes[activityType].avgChange.s+=(bpAfter.s-bpBefore.s);
activityTypes[activityType].avgChange.d+=(bpAfter.d-bpBefore.d);
}
});

if(totalActivitiesWithBP>0){
Object.keys(activityTypes).forEach(type=>{
const d=activityTypes[type];
d.avgChange.s=Math.round(d.avgChange.s/d.count);
d.avgChange.d=Math.round(d.avgChange.d/d.count);
});

text+=`
ACTIVITY IMPACT ON BLOOD PRESSURE
----------------------------------
${totalActivitiesWithBP} activities tracked with before/after BP:
`;
Object.keys(activityTypes).forEach(type=>{
const d=activityTypes[type];
const sysChange=d.avgChange.s;
const diaChange=d.avgChange.d;
let assessment='Neutral';
if(sysChange>10||diaChange>5)assessment='Review Needed';
else if(sysChange<-5||diaChange<-3)assessment='Beneficial';
text+=`- ${type}: ${d.count} session(s), BP change ${sysChange>0?'+':''}${sysChange}/${diaChange>0?'+':''}${diaChange} (${assessment})\n`;
});
}
}

// Weight
if(weightEntries.length>0){
text+=`
WEIGHT SUMMARY
--------------
Average: ${avgWeight} lbs
Net Change: ${weightChange>0?'+':''}${weightChange} lbs
`;
}

// Procedures
if(procedures.length>0){
text+=`
MEDICAL PROCEDURES
------------------
`;
procedures.forEach(proc=>{
text+=`${new Date(proc.date).toLocaleDateString()} - ${proc.name}${proc.category?' ('+proc.category+')':''}`;
if(proc.facility)text+=`\n  Facility: ${proc.facility}`;
if(proc.physician)text+=`\n  Physician: ${proc.physician}`;
text+=`\n`;
});
}

// Meds & symptoms
text+=`
MEDICATION & SYMPTOMS
---------------------
Medication Adherence: ${medicationAdherence}% (${uniqueMedDays} of ${totalDays} days)
Total Med Entries: ${medications.length}
Symptom Events: ${symptoms.length}

CLINICAL ASSESSMENT
-------------------
`;

if(avgSystolic>=140||avgDiastolic>=90){
text+=`* WARNING: Average BP (${avgSystolic}/${avgDiastolic}) indicates hypertension (‚â•140/90)\n`;
}else if(avgSystolic>=130||avgDiastolic>=80){
text+=`* Average BP (${avgSystolic}/${avgDiastolic}) in Stage 1 range (130-139/80-89)\n`;
}else{
text+=`* Average BP (${avgSystolic}/${avgDiastolic}) within normal range (<130/80)\n`;
}

if(totalOutOfRange>=10){
text+=`* WARNING: ${totalOutOfRange} out-of-range readings - medication review recommended\n`;
}else if(totalOutOfRange>0){
text+=`* ${totalOutOfRange} out-of-range reading(s) noted\n`;
}

if(medicationAdherence>=80){
text+=`* Good medication adherence (${medicationAdherence}%)\n`;
}else if(medicationAdherence>=50){
text+=`* Moderate medication adherence (${medicationAdherence}%) - consider barriers\n`;
}else{
text+=`* Low medication adherence (${medicationAdherence}%) - requires intervention\n`;
}

if(Math.abs(parseFloat(weightChange))>=5){
text+=`* Significant weight change: ${weightChange>0?'+':''}${weightChange} lbs\n`;
}

text+=`
Note: This report is based on patient self-tracked data. Clinical correlation 
and examination are essential for diagnosis and treatment decisions.

---
ClinBridge v9.5.5 Medical Grade - Free
Report Generated: ${reportDate}`;

return text;
}

function getProceduresInRange(startDate,endDate){
const procedures=settings.medicalProcedures||[];
return procedures.filter(p=>{
const procDate=new Date(p.date);
return procDate>=startDate&&procDate<=endDate;
});
}

function copyReportToClipboard(){
const reportText=document.getElementById('doctorReportContent').innerText;
copyToClipboard(reportText);
alert('‚úì Report copied to clipboard!');
}

function copyToClipboard(text){
if(navigator.clipboard&&navigator.clipboard.writeText){
navigator.clipboard.writeText(text).catch(err=>{
console.error('Clipboard copy failed:',err);
fallbackCopyToClipboard(text);
});
}else{
fallbackCopyToClipboard(text);
}
}

function fallbackCopyToClipboard(text){
const textArea=document.createElement('textarea');
textArea.value=text;
textArea.style.position='fixed';
textArea.style.top='-9999px';
document.body.appendChild(textArea);
textArea.select();
try{
document.execCommand('copy');
}catch(err){
console.error('Fallback copy failed:',err);
}
document.body.removeChild(textArea);
}


function selectAnalyticsRange(btn,range){
document.querySelectorAll('#analyticsDashboardModal .date-range-btn').forEach(b=>b.classList.remove('active'));
btn.classList.add('active');
analyticsRange=range;
const customInputs=document.getElementById('analyticsCustomDateInputs');
if(range==='custom'){
customInputs.style.display='block';
}else{
customInputs.style.display='none';
}
}

function getAnalyticsDateRange(){
const endDate=new Date();
endDate.setHours(23,59,59,999);
let startDate=new Date();
if(analyticsRange==='custom'){
const start=document.getElementById('analyticsStartDate').value;
const end=document.getElementById('analyticsEndDate').value;
if(!start||!end){
alert('Please select both start and end dates');
return null;
}
// Parse as LOCAL date parts to avoid UTC-midnight timezone shift
const[sy,sm,sd]=start.split('-').map(Number);
startDate=new Date(sy,sm-1,sd,0,0,0,0);
const[ey,em,ed]=end.split('-').map(Number);
const customEndDate=new Date(ey,em-1,ed,23,59,59,999);
return{startDate,endDate:customEndDate};
}
const days=parseInt(analyticsRange);
startDate.setDate(endDate.getDate()-(days-1));
startDate.setHours(0,0,0,0);
return{startDate,endDate};
}

function getAllHistoricalData(startDate,endDate){
const allData={bp:[],weight:[],symptoms:[],activities:[],meals:[],medications:[],fluids:[],notes:[]};
const todayKey=getTodayKey();
// Get all stored daily data within date range
for(let d=new Date(startDate);d<=endDate;d.setDate(d.getDate()+1)){
const key=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
// Check if this is today - if so, use current session data
if(key===todayKey){
// Include today's current data from global variables
if(B.length>0)allData.bp.push(...B.map(r=>({...r,_date:key})));
if(W.length>0)allData.weight.push(...W.map(r=>({...r,_date:key})));
if(S.length>0)allData.symptoms.push(...S.map(r=>({...r,_date:key})));
if(A.length>0)allData.activities.push(...A.map(r=>({...r,_date:key})));
if(M.length>0)allData.meals.push(...M.map(r=>({...r,_date:key})));
if(medLog.length>0)allData.medications.push(...medLog.map(r=>({...r,_date:key})));
if(fluidLog.length>0)allData.fluids.push(...fluidLog.map(r=>({...r,_date:key})));
if(notes.length>0)allData.notes.push(...notes.map(r=>({...r,_date:key})));
}else{
// Get historical data from localStorage - USE CORRECT KEY FORMAT
const dayData=localStorage.getItem('BP_TRACKER_'+key);
if(dayData){
try{
const parsed=JSON.parse(dayData);
// Map to consistent property names
if(parsed.bp)allData.bp.push(...parsed.bp.map(r=>({...r,_date:key})));
if(parsed.weight)allData.weight.push(...parsed.weight.map(r=>({...r,_date:key})));
if(parsed.symptoms)allData.symptoms.push(...parsed.symptoms.map(r=>({...r,_date:key})));
if(parsed.activities)allData.activities.push(...parsed.activities.map(r=>({...r,_date:key})));
if(parsed.meals)allData.meals.push(...parsed.meals.map(r=>({...r,_date:key})));
if(parsed.medLog)allData.medications.push(...parsed.medLog.map(r=>({...r,_date:key})));
if(parsed.fluid)allData.fluids.push(...parsed.fluid.map(r=>({...r,_date:key})));
if(parsed.notes)allData.notes.push(...parsed.notes.map(r=>({...r,_date:key})));
}catch(e){
console.error('Error parsing data for BP_TRACKER_'+key,e);
}
}
}
}
console.log('Historical data loaded:',allData.bp.length,'BP readings,',allData.weight.length,'weight entries');
return allData;
}

function generateAnalytics(){
const range=getAnalyticsDateRange();
if(!range)return;
const{startDate,endDate}=range;
const data=getAllHistoricalData(startDate,endDate);
if(data.bp.length===0){
alert('No data available for the selected period. Please track some readings first!');
return;
}
// Show all panels
document.getElementById('analyticsSummary').style.display='block';
document.getElementById('correlationPanel').style.display='block';
document.getElementById('trendPanel').style.display='block';
document.getElementById('patternPanel').style.display='block';
// Phase 6D: Show event panel only if events are defined
if(settings.dailyEvents&&settings.dailyEvents.length>0){
document.getElementById('eventPanel').style.display='block';
}else{
document.getElementById('eventPanel').style.display='none';
}
// NEW: Show activity impact panel if exercise feature is enabled
if(settings.features&&settings.features.exercise){
document.getElementById('activityImpactPanel').style.display='block';
}else{
document.getElementById('activityImpactPanel').style.display='none';
}
document.getElementById('periodPanel').style.display='block';
document.getElementById('insightsPanel').style.display='block';
// Generate each section with error handling
try{
generateSummaryStats(data,startDate,endDate);
}catch(e){
console.error('Error in generateSummaryStats:',e);
document.getElementById('analyticsStatsGrid').innerHTML='<p style="color:white">Error loading statistics</p>';
}
try{
generateCorrelationAnalysis(data);
}catch(e){
console.error('Error in generateCorrelationAnalysis:',e);
document.getElementById('correlationContent').innerHTML='<p style="color:#6b7280">Error loading correlations</p>';
}
try{
generateTrendAnalysis(data);
}catch(e){
console.error('Error in generateTrendAnalysis:',e);
document.getElementById('trendContent').innerHTML='<p style="color:#6b7280">Error loading trends</p>';
}
try{
generatePatternDetection(data);
}catch(e){
console.error('Error in generatePatternDetection:',e);
document.getElementById('patternContent').innerHTML='<p style="color:#6b7280">Error loading patterns</p>';
}
// Phase 6D: Generate event analysis
if(settings.dailyEvents&&settings.dailyEvents.length>0){
try{
generateEventAnalysis(data);
}catch(e){
console.error('Error in generateEventAnalysis:',e);
document.getElementById('eventContent').innerHTML='<p style="color:#6b7280">Error loading event analysis</p>';
}
}
// NEW: Generate activity impact analysis
if(settings.features&&settings.features.exercise){
try{
generateActivityImpactAnalysis(data);
}catch(e){
console.error('Error in generateActivityImpactAnalysis:',e);
document.getElementById('activityImpactContent').innerHTML='<p style="color:#6b7280">Error loading activity impact analysis</p>';
}
}
try{
generatePeriodBreakdown(data,startDate,endDate);
}catch(e){
console.error('Error in generatePeriodBreakdown:',e);
document.getElementById('periodContent').innerHTML='<p style="color:#6b7280">Error loading breakdown</p>';
}
try{
generateInsights(data);
}catch(e){
console.error('Error in generateInsights:',e);
document.getElementById('insightsContent').innerHTML='<p style="color:#6b7280">Error loading insights</p>';
}
// Load notes for this period
const periodKey=`${startDate.toISOString().split('T')[0]}_to_${endDate.toISOString().split('T')[0]}`;
document.getElementById('analyticsNotes').value=analyticsNotesData[periodKey]||'';
// Debug logging
console.log('Analytics generated for',data.bp.length,'BP readings');
}

// Store current analytics data globally for chart access
var currentAnalyticsData=null;

function generateSummaryStats(data,startDate,endDate){
// Inclusive day count: for preset ranges use the range value directly;
// for custom ranges, floor(diff/day)+1 gives correct inclusive count
// since startDate is always 00:00:00 and endDate is always 23:59:59.999
const days=analyticsRange==='custom'
  ?Math.floor((endDate-startDate)/(1000*60*60*24))+1
  :parseInt(analyticsRange)||Math.floor((endDate-startDate)/(1000*60*60*24))+1;
// Store data for chart functions
currentAnalyticsData=data;
let html='';
// BP Statistics
if(data.bp.length>0){
const avgSys=data.bp.reduce((sum,r)=>sum+r.s,0)/data.bp.length;
const avgDia=data.bp.reduce((sum,r)=>sum+r.d,0)/data.bp.length;
const avgHR=data.bp.reduce((sum,r)=>sum+(r.h||0),0)/data.bp.length;
html+=`<div class="stat-card clickable-stat" onclick="toggleAnalyticsChart('bp')" style="cursor:pointer;transition:transform 0.2s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
<div class="stat-value">${data.bp.length}</div>
<div class="stat-label">üìä BP Readings</div>
<div style="font-size:11px;color:rgba(255,255,255,0.7);margin-top:4px">Click to view trend</div>
</div>`;
html+=`<div class="stat-card clickable-stat" onclick="toggleAnalyticsChart('bp')" style="cursor:pointer;transition:transform 0.2s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
<div class="stat-value">${avgSys.toFixed(0)}/${avgDia.toFixed(0)}</div>
<div class="stat-label">üìà Avg BP (mmHg)</div>
<div style="font-size:11px;color:rgba(255,255,255,0.7);margin-top:4px">Click to view trend</div>
</div>`;
html+=`<div class="stat-card clickable-stat" onclick="toggleAnalyticsChart('hr')" style="cursor:pointer;transition:transform 0.2s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
<div class="stat-value">${avgHR.toFixed(0)}</div>
<div class="stat-label">‚ù§Ô∏è Avg HR (BPM)</div>
<div style="font-size:11px;color:rgba(255,255,255,0.7);margin-top:4px">Click to view zones</div>
</div>`;
}
// Weight statistics
if(data.weight.length>0){
const latestWeight=data.weight[data.weight.length-1].w;
const firstWeight=data.weight[0].w;
const change=latestWeight-firstWeight;
html+=`<div class="stat-card clickable-stat" onclick="toggleAnalyticsChart('weight')" style="cursor:pointer;transition:transform 0.2s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
<div class="stat-value">${change>=0?'+':''}${change.toFixed(1)} lbs</div>
<div class="stat-label">‚öñÔ∏è Weight Change</div>
<div style="font-size:11px;color:rgba(255,255,255,0.7);margin-top:4px">Click to view chart</div>
</div>`;
}
// Symptom statistics
if(data.symptoms.length>0){
const avgSeverity=data.symptoms.reduce((sum,s)=>sum+s.severity,0)/data.symptoms.length;
html+=`<div class="stat-card"><div class="stat-value">${data.symptoms.length}</div><div class="stat-label">üíä Symptom Events</div></div>`;
html+=`<div class="stat-card"><div class="stat-value">${avgSeverity.toFixed(1)}/10</div><div class="stat-label">Avg Severity</div></div>`;
}
// Activity statistics
if(data.activities.length>0){
const totalMinutes=data.activities.reduce((sum,a)=>sum+a.duration,0);
html+=`<div class="stat-card clickable-stat" onclick="toggleAnalyticsChart('activity')" style="cursor:pointer;transition:transform 0.2s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
<div class="stat-value">${data.activities.length}</div>
<div class="stat-label">üèÉ Activities</div>
<div style="font-size:11px;color:rgba(255,255,255,0.7);margin-top:4px">Click to view chart</div>
</div>`;
html+=`<div class="stat-card"><div class="stat-value">${totalMinutes} min</div><div class="stat-label">Total Exercise</div></div>`;
}
html+=`<div class="stat-card"><div class="stat-value">${days}</div><div class="stat-label">Days Analyzed</div></div>`;
document.getElementById('analyticsStatsGrid').innerHTML=html;
}

function generateCorrelationAnalysis(data){
try{
let html='<div style="color:#6b7280;font-size:16px;line-height:1.6">';
const correlations=[];
// BP vs Activity correlation
if(data.bp.length>0&&data.activities.length>0){
const bpByTime={};
data.bp.forEach(r=>{
const hour=parseInt(r.t.split(':')[0]);
bpByTime[hour]=bpByTime[hour]||[];
bpByTime[hour].push(r);
});
const actByTime={};
data.activities.forEach(a=>{
const hour=parseInt(a.t.split(':')[0]);
actByTime[hour]=actByTime[hour]||[];
actByTime[hour].push(a);
});
let postExerciseBP=[];
Object.keys(actByTime).forEach(hour=>{
const nextHour=(parseInt(hour)+1)%24;
if(bpByTime[nextHour]){
postExerciseBP.push(...bpByTime[nextHour]);
}
});
if(postExerciseBP.length>=3){
const avgPostEx=postExerciseBP.reduce((sum,r)=>sum+r.s,0)/postExerciseBP.length;
const allAvg=data.bp.reduce((sum,r)=>sum+r.s,0)/data.bp.length;
const diff=avgPostEx-allAvg;
correlations.push(`<div style="padding:12px;background:${diff>5?'#fee2e2':'#d1fae5'};border-radius:8px;margin-bottom:12px">
<b>Exercise ‚Üí BP Relationship:</b> Your systolic BP averages ${Math.abs(diff).toFixed(1)} mmHg ${diff>0?'HIGHER':'LOWER'} within 1 hour after exercise (${postExerciseBP.length} readings analyzed).
${diff>5?'‚ö†Ô∏è Consider lighter intensity or longer rest periods.':'‚úì Exercise appears beneficial for your BP.'}
</div>`);
}
}
// Symptom vs BP correlation
if(data.symptoms.length>0&&data.bp.length>0){
let symptomBP=[];
data.symptoms.forEach(s=>{
const symptomTime=s.t;
const matchingBP=data.bp.find(r=>Math.abs(timeToMinutes(r.t)-timeToMinutes(symptomTime))<60);
if(matchingBP){
symptomBP.push({symptom:s,bp:matchingBP});
}
});
if(symptomBP.length>=2){
const highSeverity=symptomBP.filter(sb=>sb.symptom.severity>=7);
if(highSeverity.length>0){
const avgSysBP=highSeverity.reduce((sum,sb)=>sum+sb.bp.s,0)/highSeverity.length;
const allAvgSys=data.bp.reduce((sum,r)=>sum+r.s,0)/data.bp.length;
correlations.push(`<div style="padding:12px;background:#fef3c7;border-radius:8px;margin-bottom:12px">
<b>High-Severity Symptoms ‚Üí BP:</b> During ${highSeverity.length} high-severity symptom events (7+/10), your BP averaged ${avgSysBP.toFixed(0)} mmHg systolic vs. overall average of ${allAvgSys.toFixed(0)} mmHg.
${avgSysBP>allAvgSys+10?'‚ö†Ô∏è Discuss this correlation with your cardiologist.':'‚ÑπÔ∏è Symptoms may not directly correlate with elevated BP.'}
</div>`);
}
}
}
// Weight vs BP correlation
if(data.weight.length>=7&&data.bp.length>=7){
const sortedWeight=[...data.weight].sort((a,b)=>new Date(a._date)-new Date(b._date));
const firstWeek=sortedWeight.slice(0,7);
const firstWeekAvg=firstWeek.reduce((sum,w)=>sum+w.w,0)/firstWeek.length;
const lastWeek=sortedWeight.slice(-7);
const lastWeekAvg=lastWeek.reduce((sum,w)=>sum+w.w,0)/lastWeek.length;
const weightChange=lastWeekAvg-firstWeekAvg;
if(Math.abs(weightChange)>3){
const firstWeekDates=firstWeek.map(w=>w._date);
const lastWeekDates=lastWeek.map(w=>w._date);
const firstWeekBP=data.bp.filter(r=>firstWeekDates.includes(r._date));
const lastWeekBP=data.bp.filter(r=>lastWeekDates.includes(r._date));
if(firstWeekBP.length>0&&lastWeekBP.length>0){
const firstBPAvg=firstWeekBP.reduce((sum,r)=>sum+r.s,0)/firstWeekBP.length;
const lastBPAvg=lastWeekBP.reduce((sum,r)=>sum+r.s,0)/lastWeekBP.length;
const bpChange=lastBPAvg-firstBPAvg;
correlations.push(`<div style="padding:12px;background:${Math.abs(weightChange)>5?'#fee2e2':'#fef3c7'};border-radius:8px;margin-bottom:12px">
<b>Weight Change ‚Üí BP Trend:</b> Weight ${weightChange>0?'increased':'decreased'} by ${Math.abs(weightChange).toFixed(1)} lbs, while systolic BP ${bpChange>0?'increased':'decreased'} by ${Math.abs(bpChange).toFixed(1)} mmHg.
${Math.abs(weightChange)>5?'‚ö†Ô∏è Significant weight change - discuss with your doctor.':'‚ÑπÔ∏è Monitor this trend over time.'}
</div>`);
}
}
}
if(correlations.length===0){
html+=`<div style="padding:20px;background:#f9fafb;border-radius:8px;text-align:center">
<div style="font-size:20px;margin-bottom:12px">üîç</div>
<div style="font-weight:600;color:#374151;margin-bottom:8px">What are Multi-Metric Correlations?</div>
<div style="color:#6b7280;font-size:15px;line-height:1.6">
This section analyzes relationships between different health metrics to reveal important patterns:
<ul style="text-align:left;margin:12px 0;padding-left:20px">
<li><b>Exercise ‚Üí BP:</b> How physical activity affects your blood pressure</li>
<li><b>Symptoms ‚Üí BP:</b> Whether symptoms occur during high/low BP episodes</li>
<li><b>Weight ‚Üí BP:</b> How weight changes correlate with BP trends</li>
</ul>
<div style="margin-top:16px;padding:12px;background:#dbeafe;border-radius:6px">
<b>To unlock correlations:</b> Log multiple data types (BP + activities, BP + symptoms, BP + weight) over several days. The more complete your tracking, the more insights you'll discover!
</div>
</div>
</div>`;
}else{
html+=correlations.join('');
}
html+='</div>';
const contentDiv=document.getElementById('correlationContent');
if(contentDiv){
contentDiv.innerHTML=html;
console.log('Correlation content set, length:',html.length);
}else{
console.error('correlationContent element not found!');
}
}catch(e){
console.error('Error in generateCorrelationAnalysis:',e);
const contentDiv=document.getElementById('correlationContent');
if(contentDiv){
contentDiv.innerHTML='<p style="padding:20px;color:#dc2626">Error generating correlation analysis. Please try again.</p>';
}
}
}

function timeToMinutes(timeStr){
const[h,m]=timeStr.split(':').map(Number);
return h*60+m;
}

function generateTrendAnalysis(data){
let html='';
// BP Trend
if(data.bp.length>=7){
const sorted=[...data.bp].sort((a,b)=>new Date(a._date+' '+a.t)-new Date(b._date+' '+b.t));
const firstHalf=sorted.slice(0,Math.floor(sorted.length/2));
const secondHalf=sorted.slice(Math.floor(sorted.length/2));
const firstAvgSys=firstHalf.reduce((sum,r)=>sum+r.s,0)/firstHalf.length;
const secondAvgSys=secondHalf.reduce((sum,r)=>sum+r.s,0)/secondHalf.length;
const firstAvgDia=firstHalf.reduce((sum,r)=>sum+r.d,0)/firstHalf.length;
const secondAvgDia=secondHalf.reduce((sum,r)=>sum+r.d,0)/secondHalf.length;
const sysTrend=secondAvgSys-firstAvgSys;
const diaTrend=secondAvgDia-firstAvgDia;
const sysIcon=sysTrend>5?'üìà':sysTrend<-5?'üìâ':'‚û°Ô∏è';
const diaIcon=diaTrend>5?'üìà':diaTrend<-5?'üìâ':'‚û°Ô∏è';
html+=`<div style="padding:16px;background:#f9fafb;border-radius:8px;margin-bottom:12px">
<h4 style="margin:0 0 12px 0;color:#374151">Blood Pressure Trajectory</h4>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
<div>
<div style="font-size:14px;color:#6b7280;margin-bottom:4px">Systolic Trend</div>
<div style="font-size:24px;font-weight:700;color:${Math.abs(sysTrend)>5?(sysTrend>0?'#dc2626':'#10b981'):'#6b7280'}">
${sysIcon} ${sysTrend>0?'+':''}${sysTrend.toFixed(1)} mmHg
</div>
<div style="font-size:13px;color:#9ca3af;margin-top:4px">
${firstAvgSys.toFixed(0)} ‚Üí ${secondAvgSys.toFixed(0)} mmHg
</div>
</div>
<div>
<div style="font-size:14px;color:#6b7280;margin-bottom:4px">Diastolic Trend</div>
<div style="font-size:24px;font-weight:700;color:${Math.abs(diaTrend)>5?(diaTrend>0?'#dc2626':'#10b981'):'#6b7280'}">
${diaIcon} ${diaTrend>0?'+':''}${diaTrend.toFixed(1)} mmHg
</div>
<div style="font-size:13px;color:#9ca3af;margin-top:4px">
${firstAvgDia.toFixed(0)} ‚Üí ${secondAvgDia.toFixed(0)} mmHg
</div>
</div>
</div>
</div>`;
}
// Weight Trend
if(data.weight.length>=3){
const sorted=[...data.weight].sort((a,b)=>new Date(a._date)-new Date(b._date));
const first=sorted[0].w;
const last=sorted[sorted.length-1].w;
const change=last-first;
const trend=change>0?'üìà Increasing':change<0?'üìâ Decreasing':'‚û°Ô∏è Stable';
html+=`<div style="padding:16px;background:#f9fafb;border-radius:8px;margin-bottom:12px">
<h4 style="margin:0 0 12px 0;color:#374151">Weight Trajectory</h4>
<div style="font-size:24px;font-weight:700;color:${Math.abs(change)>3?(change>0?'#dc2626':'#10b981'):'#6b7280'}">
${trend}: ${change>0?'+':''}${change.toFixed(1)} lbs
</div>
<div style="font-size:13px;color:#9ca3af;margin-top:4px">
${first.toFixed(1)} ‚Üí ${last.toFixed(1)} lbs over ${sorted.length} readings
</div>
</div>`;
}
// Activity Trend
if(data.activities.length>=5){
const byDate={};
data.activities.forEach(a=>{
byDate[a._date]=byDate[a._date]||[];
byDate[a._date].push(a);
});
const daysWithActivity=Object.keys(byDate).length;
const avgPerDay=data.activities.reduce((sum,a)=>sum+a.duration,0)/daysWithActivity;
html+=`<div style="padding:16px;background:#f9fafb;border-radius:8px">
<h4 style="margin:0 0 12px 0;color:#374151">Activity Pattern</h4>
<div style="font-size:24px;font-weight:700;color:#3b82f6">
${avgPerDay.toFixed(0)} minutes/day
</div>
<div style="font-size:13px;color:#9ca3af;margin-top:4px">
Across ${daysWithActivity} active days (${data.activities.length} total activities)
</div>
</div>`;
}
if(!html){
html=`<div style="padding:20px;background:#f9fafb;border-radius:8px;text-align:center">
<div style="font-size:20px;margin-bottom:12px">üìà</div>
<div style="font-weight:600;color:#374151;margin-bottom:8px">What is Trend Analysis?</div>
<div style="color:#6b7280;font-size:15px;line-height:1.6">
This section shows how your health metrics are changing over time:
<ul style="text-align:left;margin:12px 0;padding-left:20px">
<li><b>BP Trajectory:</b> Is your blood pressure improving, worsening, or stable?</li>
<li><b>Weight Trajectory:</b> Track weight changes that may affect heart health</li>
<li><b>Activity Patterns:</b> Monitor your exercise consistency</li>
</ul>
<div style="margin-top:16px;padding:12px;background:#dbeafe;border-radius:6px">
<b>Data needed:</b> At least 7 BP readings over multiple days for meaningful trend analysis. Add weight and activity tracking for complete insights!
</div>
</div>
</div>`;
}
document.getElementById('trendContent').innerHTML=html;
}

function generatePatternDetection(data){
let html='';
const patterns=[];
// Time-of-Day BP Pattern
if(data.bp.length>=10){
const byHour={morning:[],afternoon:[],evening:[],night:[]};
data.bp.forEach(r=>{
const hour=parseInt(r.t.split(':')[0]);
if(hour>=6&&hour<12)byHour.morning.push(r);
else if(hour>=12&&hour<17)byHour.afternoon.push(r);
else if(hour>=17&&hour<22)byHour.evening.push(r);
else byHour.night.push(r);
});
let maxPeriod='';
let maxAvg=0;
let minPeriod='';
let minAvg=999;
Object.keys(byHour).forEach(period=>{
if(byHour[period].length>=2){
const avg=byHour[period].reduce((sum,r)=>sum+r.s,0)/byHour[period].length;
if(avg>maxAvg){maxAvg=avg;maxPeriod=period;}
if(avg<minAvg){minAvg=avg;minPeriod=period;}
}
});
if(maxPeriod&&minPeriod&&maxAvg-minAvg>10){
patterns.push(`<div class="pattern-item pattern-medium">
<b>üïê Time-of-Day Pattern:</b> Your BP peaks during <b>${maxPeriod}</b> (${maxAvg.toFixed(0)} mmHg avg) and is lowest during <b>${minPeriod}</b> (${minAvg.toFixed(0)} mmHg avg). Difference: ${(maxAvg-minAvg).toFixed(0)} mmHg.
</div>`);
}
}
// High Variability Detection
if(data.bp.length>=5){
const sorted=[...data.bp].sort((a,b)=>a.s-b.s);
const range=sorted[sorted.length-1].s-sorted[0].s;
if(range>40){
patterns.push(`<div class="pattern-item pattern-high">
<b>‚ö†Ô∏è High BP Variability:</b> Your readings range from ${sorted[0].s} to ${sorted[sorted.length-1].s} mmHg (${range} mmHg spread). High variability may indicate poor control or situational factors.
</div>`);
}
}
// Symptom Clustering
if(data.symptoms.length>=5){
const bySymptom={};
data.symptoms.forEach(s=>{
bySymptom[s.symptom]=bySymptom[s.symptom]||[];
bySymptom[s.symptom].push(s);
});
const mostCommon=Object.entries(bySymptom).sort((a,b)=>b[1].length-a[1].length)[0];
if(mostCommon&&mostCommon[1].length>=3){
const avgSeverity=mostCommon[1].reduce((sum,s)=>sum+s.severity,0)/mostCommon[1].length;
patterns.push(`<div class="pattern-item pattern-${avgSeverity>=7?'high':avgSeverity>=5?'medium':'low'}">
<b>üíä Recurring Symptom:</b> <b>${mostCommon[0]}</b> appears ${mostCommon[1].length} times (avg severity: ${avgSeverity.toFixed(1)}/10). Consider discussing this pattern with your doctor.
</div>`);
}
}
// Medication Adherence - Proper tracking per medication
if(data.medications.length>0&&medicineList.length>0){
const dateRange=new Set(data.medications.map(m=>m._date));
const totalDays=dateRange.size;
const scheduledMeds=[];
const prnMeds=[];
const periodicMeds=[];
// Categorize medicines
medicineList.forEach(med=>{
const medName=typeof med==='string'?med:med.name;
const medFreq=typeof med==='object'&&med.frequency?med.frequency:null;
const medMonthInterval=typeof med==='object'&&med.monthInterval?med.monthInterval:null;
if(!medFreq||medFreq==='Not set'){
// Skip medicines without schedule info
return;
}
if(medFreq==='as_needed'){
prnMeds.push({name:medName,uses:[]});
}else if(medFreq==='weekly'||medFreq==='monthly'||medFreq==='custom_months'){
// Weekly, monthly, and custom interval meds tracked separately
let freqLabel=medFreq==='weekly'?'Weekly':medFreq==='monthly'?'Monthly':`Every ${medMonthInterval||'X'} months`;
periodicMeds.push({name:medName,frequency:freqLabel,uses:[]});
}else{
const dosesPerDay=medFreq==='once'?1:medFreq==='twice'?2:medFreq==='three_times'?3:4;
scheduledMeds.push({
name:medName,
frequency:medFreq,
dosesPerDay:dosesPerDay,
expectedDoses:dosesPerDay*totalDays,
actualDoses:0,
dosesByDate:{}
});
}
});
// Count actual doses
data.medications.forEach(m=>{
const medName=m.medicine;
// Check scheduled meds
scheduledMeds.forEach(sm=>{
if(sm.name.toLowerCase()===medName.toLowerCase()){
sm.actualDoses++;
sm.dosesByDate[m._date]=(sm.dosesByDate[m._date]||0)+1;
}
});
// Check PRN meds
prnMeds.forEach(pm=>{
if(pm.name.toLowerCase()===medName.toLowerCase()){
pm.uses.push({date:m._date,time:m.time||m.t||'Unknown'});
}
});
// Check periodic meds
periodicMeds.forEach(pm=>{
if(pm.name.toLowerCase()===medName.toLowerCase()){
pm.uses.push({date:m._date,time:m.time||m.t||'Unknown'});
}
});
});
// Generate adherence report
if(scheduledMeds.length>0||prnMeds.length>0||periodicMeds.length>0){
let html='<div class="pattern-item" style="border-left-color:#8b5cf6;padding:16px">';
html+='<b style="font-size:18px;color:#111827">üíä Medication Adherence Analysis</b>';
html+='<div style="margin-top:12px">';
// Scheduled medications
if(scheduledMeds.length>0){
html+='<div style="font-weight:600;color:#374151;margin:12px 0 8px 0">üìã Scheduled Daily Medications:</div>';
scheduledMeds.forEach(sm=>{
const adherencePercent=(sm.actualDoses/sm.expectedDoses*100).toFixed(0);
const color=adherencePercent>=90?'#10b981':adherencePercent>=75?'#f59e0b':'#ef4444';
const icon=adherencePercent>=90?'‚úÖ':adherencePercent>=75?'‚ö†Ô∏è':'‚ùå';
html+=`<div style="padding:12px;background:#f9fafb;border-left:4px solid ${color};border-radius:6px;margin-bottom:8px">`;
html+=`<div style="display:flex;justify-content:space-between;align-items:center">`;
html+=`<div>`;
html+=`<div style="font-weight:600;color:#111827">${sm.name}</div>`;
html+=`<div style="font-size:14px;color:#6b7280;margin-top:4px">`;
const freqLabel=sm.frequency==='once'?'Once daily':sm.frequency==='twice'?'Twice daily':sm.frequency==='three_times'?'3x daily':'4x daily';
html+=`${freqLabel} ‚Ä¢ ${sm.actualDoses}/${sm.expectedDoses} doses`;
html+=`</div>`;
html+=`</div>`;
html+=`<div style="font-size:24px;font-weight:700" style="color:${color}">`;
html+=`${icon} ${adherencePercent}%`;
html+=`</div>`;
html+=`</div>`;
// Check for missed doses by date
const missedDates=[];
dateRange.forEach(date=>{
const takenOnDate=sm.dosesByDate[date]||0;
if(takenOnDate<sm.dosesPerDay){
missedDates.push(`${new Date(date).toLocaleDateString('en-US',{month:'short',day:'numeric'})} (${sm.dosesPerDay-takenOnDate} missed)`);
}
});
if(missedDates.length>0&&missedDates.length<=5){
html+=`<div style="font-size:13px;color:#dc2626;margin-top:8px;padding-top:8px;border-top:1px solid #e5e7eb">`;
html+=`<b>Missed doses:</b> ${missedDates.join(', ')}`;
html+=`</div>`;
}else if(missedDates.length>5){
html+=`<div style="font-size:13px;color:#dc2626;margin-top:8px;padding-top:8px;border-top:1px solid #e5e7eb">`;
html+=`<b>Missed doses on ${missedDates.length} days</b> - Review your medication schedule`;
html+=`</div>`;
}
html+=`</div>`;
});
}
// Periodic medications (weekly/monthly)
if(periodicMeds.length>0){
html+='<div style="font-weight:600;color:#374151;margin:16px 0 8px 0">üìÖ Periodic Medications (Weekly/Monthly):</div>';
periodicMeds.forEach(pm=>{
if(pm.uses.length>0){
html+=`<div style="padding:12px;background:#e0f2fe;border-left:4px solid #0ea5e9;border-radius:6px;margin-bottom:8px">`;
html+=`<div style="font-weight:600;color:#111827">${pm.name}</div>`;
html+=`<div style="font-size:14px;color:#075985;margin-top:4px">`;
html+=`${pm.frequency} ‚Ä¢ Taken ${pm.uses.length} time${pm.uses.length>1?'s':''} during this period`;
if(pm.uses.length<=3){
html+=`<br>${pm.uses.map(u=>`${new Date(u.date).toLocaleDateString('en-US',{month:'short',day:'numeric'})} at ${u.time}`).join(', ')}`;
}
html+=`</div>`;
html+=`</div>`;
}
});
}
// PRN medications
if(prnMeds.length>0){
  html+='<div style="font-weight:600;color:#374151;margin:16px 0 8px 0">üíä As-Needed (PRN) Medications:</div>';
  prnMeds.forEach(pm=>{
    if(pm.uses.length>0){
      html+=`<div style="padding:12px;background:#fef3c7;border-left:4px solid #f59e0b;border-radius:6px;margin-bottom:8px">`;
      html+=`<div style="font-weight:600;color:#111827">${pm.name}</div>`;
      html+=`<div style="font-size:14px;color:#92400e;margin-top:4px">`;
      html+=`Used ${pm.uses.length} time${pm.uses.length>1?'s':''} during this period`;
      if(pm.uses.length<=3){
        html += ': ' + pm.uses.map(function(u){
          var d = new Date(u.date).toLocaleDateString('en-US',{month:'short',day:'numeric'});
          return d + ' at ' + u.time;
        }).join(', ');
      }
      html+=`</div>`;
      html+=`</div>`;
    }
  });
}

// Overall summary for daily scheduled meds only
const totalExpected = scheduledMeds.reduce((sum, sm) => sum + sm.expectedDoses, 0);
const totalActual   = scheduledMeds.reduce((sum, sm) => sum + sm.actualDoses, 0);

if (totalExpected > 0) {
  const overallPercent = (totalActual / totalExpected * 100).toFixed(0);
  const summaryColor = overallPercent >= 90 ? '#10b981'
                      : overallPercent >= 75 ? '#f59e0b'
                      : '#ef4444';

  html += '<div style="margin-top:12px; padding:12px; background:white; border:2px solid ' + summaryColor + '; border-radius:8px">';
  html += '<b style="color:' + summaryColor + '">Overall Daily Med Adherence: ' + overallPercent + '%</b>';
  html += ' (' + totalActual + '/' + totalExpected + ' scheduled doses)';
  html += '</div>';
}

html += '</div>';
html += '</div>';

patterns.push(html);
} // close if(scheduledMeds||prnMeds||periodicMeds)
} // close if(data.medications&&medicineList)

// Independent pattern checks (these can appear in addition to the summary)
if (medicineList.length > 0 && data.medications.length === 0) {
    patterns.push(
        '<div class="pattern-item pattern-high">' +
            '<b>üíä Medication Tracking:</b> You have ' + medicineList.length +
            ' medicine' + (medicineList.length > 1 ? 's' : '') +
            ' in your list but no doses logged during this period. ' +
            'Remember to log when you take your medications!' +
        '</div>'
    );
}

if (data.medications.length > 0 && medicineList.length === 0) {
    patterns.push(
        '<div class="pattern-item pattern-medium">' +
            '<b>üíä Medication Log:</b> ' + data.medications.length +
            ' doses logged, but medicine schedules not set up. ' +
            'Go to <b>Manage Medicines</b> and add your medications ' +
            'with their schedules for detailed adherence tracking.' +
        '</div>'
    );
}

if (patterns.length === 0) {
  html = `<div style="padding:20px;background:#f9fafb;border-radius:8px;text-align:center">
<div style="font-size:20px;margin-bottom:12px">üéØ</div>
<div style="font-weight:600;color:#374151;margin-bottom:8px">What is Pattern Detection?</div>
<div style="color:#6b7280;font-size:15px;line-height:1.6">
This AI-powered analysis automatically identifies important patterns in your health data:
<ul style="text-align:left;margin:12px 0;padding-left:20px">
<li><b>Time-of-Day Patterns:</b> When is your BP highest/lowest?</li>
<li><b>BP Variability:</b> Detect inconsistent readings that need attention</li>
<li><b>Recurring Symptoms:</b> Identify which symptoms happen most often</li>
<li><b>Medication Adherence:</b> Track how consistently you take medications</li>
</ul>
<div style="margin-top:16px;padding:12px;background:#dbeafe;border-radius:6px">
<b>Getting started:</b> Log BP readings at different times of day (morning, afternoon, evening). Add symptoms and medications when they occur. Pattern detection unlocks after 10+ BP readings!
</div>
</div>
</div>`;
}else{
html=patterns.join('');
}
document.getElementById('patternContent').innerHTML=html;
}

// ================== PHASE 6D: EVENT ANALYSIS ==================
function updateFluidModeUI(){
var mode=document.querySelector('input[name="fluidMode"]:checked');
if(!mode)return;
var v=mode.value;
var maxSection=document.getElementById('fluidMaxSection');
var minWrapper=document.getElementById('fluidMinWrapper');
var maxLabel=document.querySelector('#fluidMaxSection label');
if(maxSection)maxSection.style.display=v==='none'?'none':'block';
if(minWrapper)minWrapper.style.display=v==='range'?'block':'none';
// Highlight selected radio card
document.querySelectorAll('input[name="fluidMode"]').forEach(function(r){
var card=r.closest('label');
if(!card)return;
if(r.checked){card.style.border='2px solid #3b82f6';card.style.background='#eff6ff';}
else{card.style.border='2px solid #e2e8f0';card.style.background='white';}
});
}

function timeToMins(t){
if(!t)return 0;
var parts=t.split(':');
return parseInt(parts[0]||0)*60+parseInt(parts[1]||0);
}
// Analyze health metrics grouped by daily events

function generateEventAnalysis(data){
if(!settings.dailyEvents||settings.dailyEvents.length===0){
document.getElementById('eventContent').innerHTML='<p style="color:#6b7280">No daily events defined. Set up your schedule in Settings to see event-based analysis.</p>';
return;
}
let html='';
// Group BP readings by event
const bpByEvent={};
const fluidByEvent={};
const medsByEvent={};
const mealsByEvent={};
// Initialize for all events
settings.dailyEvents.forEach(evt=>{
bpByEvent[evt.id]={event:evt,readings:[],count:0};
fluidByEvent[evt.id]={event:evt,entries:[],totalOz:0,count:0};
medsByEvent[evt.id]={event:evt,doses:[],count:0};
mealsByEvent[evt.id]={event:evt,meals:[],count:0};
});
// Group BP readings
if(data.bp&&Array.isArray(data.bp)){
data.bp.forEach(reading=>{
if(reading.eventId&&bpByEvent[reading.eventId]){
bpByEvent[reading.eventId].readings.push(reading);
bpByEvent[reading.eventId].count++;
}
});
}
// Group fluid entries ‚Äî match by eventId first, then fall back to time proximity (¬±30 min)
const fluidSource=data.fluids||data.fluid||[];
if(Array.isArray(fluidSource)){
fluidSource.forEach(entry=>{
// Primary match: explicit eventId
if(entry.eventId&&fluidByEvent[entry.eventId]){
fluidByEvent[entry.eventId].entries.push(entry);
fluidByEvent[entry.eventId].totalOz+=entry.amount||0;
fluidByEvent[entry.eventId].count++;
return;
}
// Fallback: match to nearest event within ¬±30 minutes by time
if(entry.time){
const entryMins=timeToMins(entry.time);
let bestEvt=null,bestDiff=31;
settings.dailyEvents.forEach(evt=>{
if(!evt.time)return;
const evtMins=timeToMins(evt.time);
const diff=Math.abs(entryMins-evtMins);
if(diff<bestDiff){bestDiff=diff;bestEvt=evt;}
});
if(bestEvt&&fluidByEvent[bestEvt.id]){
fluidByEvent[bestEvt.id].entries.push(entry);
fluidByEvent[bestEvt.id].totalOz+=entry.amount||0;
fluidByEvent[bestEvt.id].count++;
}
}
});
}
// Group medications
if(data.medications&&Array.isArray(data.medications)){
data.medications.forEach(med=>{
if(med.eventId&&medsByEvent[med.eventId]){
medsByEvent[med.eventId].doses.push(med);
medsByEvent[med.eventId].count++;
}
});
}
// Group meals
if(data.meals&&Array.isArray(data.meals)){
data.meals.forEach(meal=>{
if(meal.eventId&&mealsByEvent[meal.eventId]){
mealsByEvent[meal.eventId].meals.push(meal);
mealsByEvent[meal.eventId].count++;
}
});
}
// Generate BP by Event Table
html+='<div style="margin-bottom:24px">';
html+='<h4 style="font-size:18px;font-weight:600;color:#111827;margin-bottom:12px">üìä Blood Pressure by Event</h4>';
html+='<div style="overflow-x:auto">';
html+='<table style="width:100%;border-collapse:collapse">';
html+='<thead><tr style="background:#f3f4f6">';
html+='<th style="padding:12px;text-align:left;border:1px solid #e5e7eb">Event</th>';
html+='<th style="padding:12px;text-align:center;border:1px solid #e5e7eb">Count</th>';
html+='<th style="padding:12px;text-align:center;border:1px solid #e5e7eb">Avg Systolic</th>';
html+='<th style="padding:12px;text-align:center;border:1px solid #e5e7eb">Avg Diastolic</th>';
html+='<th style="padding:12px;text-align:center;border:1px solid #e5e7eb">Avg HR</th>';
html+='<th style="padding:12px;text-align:center;border:1px solid #e5e7eb">Status</th>';
html+='</tr></thead><tbody>';
let hasAnyBPData=false;
settings.dailyEvents.forEach(evt=>{
const eventData=bpByEvent[evt.id];
if(eventData.count>0){
hasAnyBPData=true;
const avgSys=eventData.readings.reduce((sum,r)=>sum+r.s,0)/eventData.count;
const avgDia=eventData.readings.reduce((sum,r)=>sum+r.d,0)/eventData.count;
const avgHR=eventData.readings.filter(r=>r.h).length>0?eventData.readings.filter(r=>r.h).reduce((sum,r)=>sum+(r.h||0),0)/eventData.readings.filter(r=>r.h).length:0;
const isElevated=avgSys>settings.systolicMax||avgDia>settings.diastolicMax;
const statusColor=isElevated?'#ef4444':'#10b981';
const statusText=isElevated?'‚ö†Ô∏è Elevated':'‚úì Normal';
html+='<tr>';
html+='<td style="padding:12px;border:1px solid #e5e7eb"><span style="font-size:18px">'+evt.icon+'</span> '+evt.name+(evt.time?' ('+evt.time+')':'')+'</td>';
html+='<td style="padding:12px;text-align:center;border:1px solid #e5e7eb;font-weight:600">'+eventData.count+'</td>';
html+='<td style="padding:12px;text-align:center;border:1px solid #e5e7eb;font-weight:600;color:'+(avgSys>settings.systolicMax?'#ef4444':'#10b981')+'">'+avgSys.toFixed(0)+'</td>';
html+='<td style="padding:12px;text-align:center;border:1px solid #e5e7eb;font-weight:600;color:'+(avgDia>settings.diastolicMax?'#ef4444':'#10b981')+'">'+avgDia.toFixed(0)+'</td>';
html+='<td style="padding:12px;text-align:center;border:1px solid #e5e7eb;font-weight:600">'+avgHR.toFixed(0)+'</td>';
html+='<td style="padding:12px;text-align:center;border:1px solid #e5e7eb;font-weight:600;color:'+statusColor+'">'+statusText+'</td>';
html+='</tr>';
}
});
if(!hasAnyBPData){
html+='<tr><td colspan="6" style="padding:20px;text-align:center;color:#9ca3af;border:1px solid #e5e7eb">No BP readings tagged with events yet</td></tr>';
}
html+='</tbody></table></div></div>';
// Generate Fluid Compliance by Event
html+='<div style="margin-bottom:24px">';
html+='<h4 style="font-size:18px;font-weight:600;color:#111827;margin-bottom:12px">üíß Fluid Intake by Event</h4>';
html+='<div style="overflow-x:auto">';
html+='<table style="width:100%;border-collapse:collapse">';
html+='<thead><tr style="background:#f3f4f6">';
html+='<th style="padding:12px;text-align:left;border:1px solid #e5e7eb">Event</th>';
html+='<th style="padding:12px;text-align:center;border:1px solid #e5e7eb">Goal (oz)</th>';
html+='<th style="padding:12px;text-align:center;border:1px solid #e5e7eb">Times Logged</th>';
html+='<th style="padding:12px;text-align:center;border:1px solid #e5e7eb">Total (oz)</th>';
html+='<th style="padding:12px;text-align:center;border:1px solid #e5e7eb">Avg per Log</th>';
html+='<th style="padding:12px;text-align:center;border:1px solid #e5e7eb">Compliance</th>';
html+='</tr></thead><tbody>';
let hasAnyFluidData=false;
settings.dailyEvents.forEach(evt=>{
const eventData=fluidByEvent[evt.id];
if(eventData.count>0||evt.fluidGoal>0){
hasAnyFluidData=true;
const avgPerLog=eventData.count>0?eventData.totalOz/eventData.count:0;
const goalText=evt.fluidGoal>0?evt.fluidGoal+' oz':'No goal';
let complianceText='‚Äî';
let complianceColor='#6b7280';
if(evt.fluidGoal>0&&eventData.count>0){
const avgGoalMet=(eventData.totalOz/(eventData.count*evt.fluidGoal))*100;
complianceText=avgGoalMet.toFixed(0)+'%';
if(avgGoalMet>=90)complianceColor='#10b981';
else if(avgGoalMet>=70)complianceColor='#f59e0b';
else complianceColor='#ef4444';
}
html+='<tr>';
html+='<td style="padding:12px;border:1px solid #e5e7eb"><span style="font-size:18px">'+evt.icon+'</span> '+evt.name+(evt.time?' ('+evt.time+')':'')+'</td>';
html+='<td style="padding:12px;text-align:center;border:1px solid #e5e7eb">'+goalText+'</td>';
html+='<td style="padding:12px;text-align:center;border:1px solid #e5e7eb;font-weight:600">'+eventData.count+'</td>';
html+='<td style="padding:12px;text-align:center;border:1px solid #e5e7eb;font-weight:600;color:#0ea5e9">'+eventData.totalOz.toFixed(0)+'</td>';
html+='<td style="padding:12px;text-align:center;border:1px solid #e5e7eb">'+avgPerLog.toFixed(1)+'</td>';
html+='<td style="padding:12px;text-align:center;border:1px solid #e5e7eb;font-weight:600;color:'+complianceColor+'">'+complianceText+'</td>';
html+='</tr>';
}
});
if(!hasAnyFluidData){
html+='<tr><td colspan="6" style="padding:20px;text-align:center;color:#9ca3af;border:1px solid #e5e7eb">No fluid entries tagged with events yet</td></tr>';
}
html+='</tbody></table></div></div>';
// Generate Medication Adherence by Event
html+='<div style="margin-bottom:24px">';
html+='<h4 style="font-size:18px;font-weight:600;color:#111827;margin-bottom:12px">üíä Medications by Event</h4>';
html+='<div style="overflow-x:auto">';
html+='<table style="width:100%;border-collapse:collapse">';
html+='<thead><tr style="background:#f3f4f6">';
html+='<th style="padding:12px;text-align:left;border:1px solid #e5e7eb">Event</th>';
html+='<th style="padding:12px;text-align:center;border:1px solid #e5e7eb">Doses Logged</th>';
html+='<th style="padding:12px;text-align:center;border:1px solid #e5e7eb">Most Common</th>';
html+='</tr></thead><tbody>';
let hasAnyMedData=false;
settings.dailyEvents.forEach(evt=>{
const eventData=medsByEvent[evt.id];
if(eventData.count>0){
hasAnyMedData=true;
// Find most common medication
const medCounts={};
eventData.doses.forEach(dose=>{
medCounts[dose.medicine]=(medCounts[dose.medicine]||0)+1;
});
let mostCommon='‚Äî';
let maxCount=0;
Object.keys(medCounts).forEach(med=>{
if(medCounts[med]>maxCount){
maxCount=medCounts[med];
mostCommon=med+' ('+medCounts[med]+'x)';
}
});
html+='<tr>';
html+='<td style="padding:12px;border:1px solid #e5e7eb"><span style="font-size:18px">'+evt.icon+'</span> '+evt.name+(evt.time?' ('+evt.time+')':'')+'</td>';
html+='<td style="padding:12px;text-align:center;border:1px solid #e5e7eb;font-weight:600;color:#f97316">'+eventData.count+'</td>';
html+='<td style="padding:12px;text-align:center;border:1px solid #e5e7eb">'+mostCommon+'</td>';
html+='</tr>';
}
});
if(!hasAnyMedData){
html+='<tr><td colspan="3" style="padding:20px;text-align:center;color:#9ca3af;border:1px solid #e5e7eb">No medications tagged with events yet</td></tr>';
}
html+='</tbody></table></div></div>';
// Event Insights
html+='<div style="background:#f0fdf4;border-left:4px solid #10b981;padding:16px;border-radius:8px">';
html+='<h4 style="font-size:16px;font-weight:600;color:#065f46;margin-bottom:8px">üí° Event Insights</h4>';
html+='<ul style="margin:0;padding-left:20px;color:#047857">';
// Find event with highest BP
let highestBPEvent=null;
let highestAvgSys=0;
Object.keys(bpByEvent).forEach(eventId=>{
if(bpByEvent[eventId].count>0){
const avgSys=bpByEvent[eventId].readings.reduce((sum,r)=>sum+r.s,0)/bpByEvent[eventId].count;
if(avgSys>highestAvgSys){
highestAvgSys=avgSys;
highestBPEvent=bpByEvent[eventId].event;
}
}
});
if(highestBPEvent){
html+='<li>Highest average BP at <strong>'+highestBPEvent.name+'</strong> ('+highestAvgSys.toFixed(0)+' systolic)</li>';
}
// Find best fluid compliance
let bestFluidEvent=null;
let bestCompliance=0;
Object.keys(fluidByEvent).forEach(eventId=>{
const evt=fluidByEvent[eventId].event;
const eventData=fluidByEvent[eventId];
if(evt.fluidGoal>0&&eventData.count>0){
const compliance=(eventData.totalOz/(eventData.count*evt.fluidGoal))*100;
if(compliance>bestCompliance){
bestCompliance=compliance;
bestFluidEvent=evt;
}
}
});
if(bestFluidEvent){
html+='<li>Best fluid compliance at <strong>'+bestFluidEvent.name+'</strong> ('+bestCompliance.toFixed(0)+'%)</li>';
}
// Count events with data
let eventsWithBP=0;
let eventsWithFluid=0;
let eventsWithMeds=0;
Object.keys(bpByEvent).forEach(id=>{if(bpByEvent[id].count>0)eventsWithBP++;});
Object.keys(fluidByEvent).forEach(id=>{if(fluidByEvent[id].count>0)eventsWithFluid++;});
Object.keys(medsByEvent).forEach(id=>{if(medsByEvent[id].count>0)eventsWithMeds++;});
html+='<li>Data tagged for <strong>'+eventsWithBP+'</strong> events (BP), <strong>'+eventsWithFluid+'</strong> events (Fluid), <strong>'+eventsWithMeds+'</strong> events (Meds)</li>';
html+='</ul></div>';
document.getElementById('eventContent').innerHTML=html;
}

// NEW: Generate Activity Impact on Blood Pressure Analysis
function generateActivityImpactAnalysis(data){
if(!data.bp||data.bp.length===0||!data.activities||data.activities.length===0){
document.getElementById('activityImpactContent').innerHTML='<p style="color:#6b7280">No activity or BP data available for analysis. Log activities with before/after BP readings to see their impact.</p>';
return;
}

// Group activities by type and collect linked BP readings
const activityTypes={};
let totalActivitiesWithBP=0;

data.activities.forEach(activity=>{
// Check if activity has linked BP readings
const bpBefore=data.bp.find(bp=>bp.activityId===activity.id&&bp.activityTiming==='before');
const bpAfter=data.bp.find(bp=>bp.activityId===activity.id&&bp.activityTiming==='after');

if(bpBefore&&bpAfter){
totalActivitiesWithBP++;
// Extract activity type (remove parenthetical descriptions)
let activityType=activity.activity.split('(')[0].trim();
if(activityType.startsWith('Manual Work')){
activityType='Manual Work';
}

if(!activityTypes[activityType]){
activityTypes[activityType]={
sessions:[],
avgBefore:{systolic:0,diastolic:0,hr:0},
avgAfter:{systolic:0,diastolic:0,hr:0},
avgChange:{systolic:0,diastolic:0,hr:0}
};
}

activityTypes[activityType].sessions.push({
activity:activity,
before:bpBefore,
after:bpAfter,
change:{
systolic:bpAfter.s-bpBefore.s,
diastolic:bpAfter.d-bpBefore.d,
hr:bpAfter.h-bpBefore.h
}
});
}
});

if(totalActivitiesWithBP===0){
document.getElementById('activityImpactContent').innerHTML='<p style="color:#6b7280">No activities with both before & after BP readings yet. When logging activities, take BP before and after to see their impact on your blood pressure.</p>';
return;
}

// Calculate averages for each activity type
Object.keys(activityTypes).forEach(type=>{
const sessions=activityTypes[type].sessions;
const count=sessions.length;

activityTypes[type].avgBefore.systolic=Math.round(sessions.reduce((sum,s)=>sum+s.before.s,0)/count);
activityTypes[type].avgBefore.diastolic=Math.round(sessions.reduce((sum,s)=>sum+s.before.d,0)/count);
activityTypes[type].avgBefore.hr=Math.round(sessions.reduce((sum,s)=>sum+s.before.h,0)/count);

activityTypes[type].avgAfter.systolic=Math.round(sessions.reduce((sum,s)=>sum+s.after.s,0)/count);
activityTypes[type].avgAfter.diastolic=Math.round(sessions.reduce((sum,s)=>sum+s.after.d,0)/count);
activityTypes[type].avgAfter.hr=Math.round(sessions.reduce((sum,s)=>sum+s.after.h,0)/count);

activityTypes[type].avgChange.systolic=activityTypes[type].avgAfter.systolic-activityTypes[type].avgBefore.systolic;
activityTypes[type].avgChange.diastolic=activityTypes[type].avgAfter.diastolic-activityTypes[type].avgBefore.diastolic;
activityTypes[type].avgChange.hr=activityTypes[type].avgAfter.hr-activityTypes[type].avgBefore.hr;
});

// Build HTML
let html='<p style="color:#6b7280;margin-bottom:20px">This analysis shows how different physical activities affect your blood pressure. Negative changes (‚Üì) indicate BP reduction, which is generally beneficial.</p>';

// Sort by number of sessions
const sortedTypes=Object.keys(activityTypes).sort((a,b)=>activityTypes[b].sessions.length-activityTypes[a].sessions.length);

sortedTypes.forEach(type=>{
const data=activityTypes[type];
const sessions=data.sessions.length;

// Determine impact category
let impactCategory='beneficial';
let impactColor='#10b981';
let impactIcon='‚úì';
let impactText='Beneficial';

const sysChange=data.avgChange.systolic;
const diaChange=data.avgChange.diastolic;

if(sysChange>10||diaChange>5){
impactCategory='concerning';
impactColor='#ef4444';
impactIcon='‚ö†Ô∏è';
impactText='Review Needed';
}else if(sysChange>5||diaChange>3){
impactCategory='moderate';
impactColor='#f59e0b';
impactIcon='‚ö°';
impactText='Moderate Impact';
}else if(sysChange<-5||diaChange<-3){
impactCategory='excellent';
impactColor='#10b981';
impactIcon='üåü';
impactText='Excellent';
}

html+=`<div style="margin-bottom:20px;padding:20px;background:#f9fafb;border-radius:12px;border-left:4px solid ${impactColor}">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<h4 style="margin:0;font-size:20px;font-weight:700;color:#111827">${type}</h4>
<div style="padding:6px 14px;background:${impactColor}20;border-radius:8px;font-weight:600;color:${impactColor}">${impactIcon} ${impactText}</div>
</div>
<div style="color:#6b7280;font-size:14px;margin-bottom:16px">${sessions} session${sessions>1?'s':''} with complete BP data</div>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:16px">
<div style="padding:12px;background:white;border-radius:8px">
<div style="font-size:12px;color:#6b7280;margin-bottom:4px">Average BP Before</div>
<div style="font-size:20px;font-weight:700;color:#374151">${data.avgBefore.systolic}/${data.avgBefore.diastolic}</div>
<div style="font-size:12px;color:#6b7280">HR: ${data.avgBefore.hr} bpm</div>
</div>
<div style="padding:12px;background:white;border-radius:8px">
<div style="font-size:12px;color:#6b7280;margin-bottom:4px">Average BP After</div>
<div style="font-size:20px;font-weight:700;color:#374151">${data.avgAfter.systolic}/${data.avgAfter.diastolic}</div>
<div style="font-size:12px;color:#6b7280">HR: ${data.avgAfter.hr} bpm</div>
</div>
<div style="padding:12px;background:white;border-radius:8px">
<div style="font-size:12px;color:#6b7280;margin-bottom:4px">Average Change</div>
<div style="font-size:20px;font-weight:700;color:${impactColor}">
${data.avgChange.systolic>0?'+':''}${data.avgChange.systolic}/${data.avgChange.diastolic>0?'+':''}${data.avgChange.diastolic}
</div>
<div style="font-size:12px;color:#6b7280">HR: ${data.avgChange.hr>0?'+':''}${data.avgChange.hr} bpm</div>
</div>
</div>`;

// Add interpretation
if(impactCategory==='excellent'){
html+=`<div style="padding:12px;background:#d1fae5;border-radius:6px;font-size:14px;color:#065f46">
<strong>Excellent for BP management!</strong> This activity consistently lowers your blood pressure. Continue with this activity as part of your routine.
</div>`;
}else if(impactCategory==='beneficial'){
html+=`<div style="padding:12px;background:#d1fae5;border-radius:6px;font-size:14px;color:#065f46">
<strong>Beneficial activity.</strong> Shows positive or neutral effects on blood pressure.
</div>`;
}else if(impactCategory==='moderate'){
html+=`<div style="padding:12px;background:#fef3c7;border-radius:6px;font-size:14px;color:#92400e">
<strong>Moderate BP increase noted.</strong> May be normal for vigorous activity, but monitor how you feel and discuss with your provider.
</div>`;
}else if(impactCategory==='concerning'){
html+=`<div style="padding:12px;background:#fee2e2;border-radius:6px;font-size:14px;color:#991b1b">
<strong>Significant BP increase detected.</strong> Discuss this activity's intensity with your healthcare provider to ensure safety.
</div>`;
}

html+=`</div>`;
});

// Add summary
html+=`<div style="margin-top:24px;padding:20px;background:#f0f9ff;border-radius:12px;border-left:4px solid #3b82f6">
<h4 style="margin:0 0 12px 0;color:#1e40af">üìä Summary & Recommendations</h4>
<ul style="margin:0;padding-left:20px;color:#374151;line-height:1.8">
<li><strong>Total Activities Tracked:</strong> ${totalActivitiesWithBP} activities with complete before/after BP data</li>
<li><strong>For Best Results:</strong> Continue activities that show BP reduction (‚Üì), especially those with 5+ mmHg systolic decrease</li>
<li><strong>Safety Note:</strong> If any activity causes dizziness, chest discomfort, or extreme fatigue, stop and consult your doctor</li>
<li><strong>Build Data:</strong> More sessions = more accurate analysis. Try to take BP before and after each activity</li>
</ul>
</div>`;

document.getElementById('activityImpactContent').innerHTML=html;
}

function generatePeriodBreakdown(data,startDate,endDate){
let html='';
const days=Math.ceil((endDate-startDate)/(1000*60*60*24))+1;
if(data.bp.length===0&&data.weight.length===0&&data.symptoms.length===0&&data.activities.length===0){
html=`<div style="padding:20px;background:#f9fafb;border-radius:8px;text-align:center">
<div style="font-size:20px;margin-bottom:12px">üìÖ</div>
<div style="font-weight:600;color:#374151;margin-bottom:8px">What is Period Breakdown?</div>
<div style="color:#6b7280;font-size:15px;line-height:1.6">
This section organizes your health data by time period for easy review:
<ul style="text-align:left;margin:12px 0;padding-left:20px">
<li><b>Daily View:</b> Day-by-day breakdown for short periods (‚â§7 days)</li>
<li><b>Weekly View:</b> Week-by-week summary for medium periods (8-31 days)</li>
<li><b>Monthly View:</b> Month-by-month overview for long periods (32+ days)</li>
</ul>
<div style="margin-top:16px;padding:12px;background:#dbeafe;border-radius:6px">
<b>Start tracking:</b> Log your BP, weight, symptoms, or activities to see them organized by time period. Perfect for spotting weekly or monthly patterns!
</div>
</div>
</div>`;
}else if(days<=7){
html+='<p style="color:#6b7280;margin-bottom:16px"><b>üìÖ Daily Breakdown</b> - Shows each day\'s health metrics for detailed day-to-day tracking</p>';
html+=generateDailyBreakdown(data,startDate,endDate);
}else if(days<=31){
html+='<p style="color:#6b7280;margin-bottom:16px"><b>üìÖ Weekly Breakdown</b> - Summarizes your metrics week by week for easier pattern recognition</p>';
html+=generateWeeklyBreakdown(data,startDate,endDate);
}else{
html+='<p style="color:#6b7280;margin-bottom:16px"><b>üìÖ Monthly Breakdown</b> - Long-term overview organized by month to track progress over time</p>';
html+=generateMonthlyBreakdown(data,startDate,endDate);
}
document.getElementById('periodContent').innerHTML=html;
}

function generateDailyBreakdown(data,startDate,endDate){
let html='<div style="display:grid;gap:12px">';
for(let d=new Date(startDate);d<=endDate;d.setDate(d.getDate()+1)){
const dateKey=d.toISOString().split('T')[0];
const dayData={
bp:data.bp.filter(r=>r._date===dateKey),
weight:data.weight.filter(r=>r._date===dateKey),
symptoms:data.symptoms.filter(r=>r._date===dateKey),
activities:data.activities.filter(r=>r._date===dateKey)
};
if(dayData.bp.length>0||dayData.weight.length>0||dayData.symptoms.length>0||dayData.activities.length>0){
const avgSys=dayData.bp.length>0?dayData.bp.reduce((sum,r)=>sum+r.s,0)/dayData.bp.length:0;
html+=`<div style="padding:16px;background:#f9fafb;border-radius:8px;border-left:4px solid #3b82f6">
<div style="font-weight:700;color:#1f2937;margin-bottom:8px">${new Date(dateKey).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})}</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;font-size:14px;color:#6b7280">
${dayData.bp.length>0?`<div>üìä BP: ${avgSys.toFixed(0)} mmHg (${dayData.bp.length})</div>`:''}
${dayData.weight.length>0?`<div>‚öñÔ∏è ${dayData.weight[0].w.toFixed(1)} lbs</div>`:''}
${dayData.symptoms.length>0?`<div>üíä ${dayData.symptoms.length} symptom${dayData.symptoms.length>1?'s':''}</div>`:''}
${dayData.activities.length>0?`<div>üèÉ ${dayData.activities.reduce((sum,a)=>sum+a.duration,0)} min exercise</div>`:''}
</div>
</div>`;
}
}
html+='</div>';
return html;
}

function generateWeeklyBreakdown(data,startDate,endDate){
let html='<div style="display:grid;gap:12px">';
let weekStart=new Date(startDate);
weekStart.setDate(weekStart.getDate()-(weekStart.getDay()||7)+1);
let weekNum=1;
while(weekStart<=endDate){
const weekEnd=new Date(weekStart);
weekEnd.setDate(weekEnd.getDate()+6);
const weekKey=`${weekStart.toISOString().split('T')[0]}_to_${weekEnd.toISOString().split('T')[0]}`;
const weekData={
bp:data.bp.filter(r=>{const d=new Date(r._date);return d>=weekStart&&d<=weekEnd;}),
weight:data.weight.filter(r=>{const d=new Date(r._date);return d>=weekStart&&d<=weekEnd;}),
symptoms:data.symptoms.filter(r=>{const d=new Date(r._date);return d>=weekStart&&d<=weekEnd;}),
activities:data.activities.filter(r=>{const d=new Date(r._date);return d>=weekStart&&d<=weekEnd;})
};
if(weekData.bp.length>0){
const avgSys=weekData.bp.reduce((sum,r)=>sum+r.s,0)/weekData.bp.length;
const avgDia=weekData.bp.reduce((sum,r)=>sum+r.d,0)/weekData.bp.length;
html+=`<div style="padding:16px;background:#f9fafb;border-radius:8px;border-left:4px solid #8b5cf6">
<div style="font-weight:700;color:#1f2937;margin-bottom:8px">Week ${weekNum}: ${weekStart.toLocaleDateString('en-US',{month:'short',day:'numeric'})} - ${weekEnd.toLocaleDateString('en-US',{month:'short',day:'numeric'})}</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;font-size:14px;color:#6b7280">
<div>üìä Avg BP: ${avgSys.toFixed(0)}/${avgDia.toFixed(0)} mmHg</div>
<div>üìà ${weekData.bp.length} readings</div>
${weekData.weight.length>0?`<div>‚öñÔ∏è Avg: ${(weekData.weight.reduce((sum,w)=>sum+w.w,0)/weekData.weight.length).toFixed(1)} lbs</div>`:''}
${weekData.symptoms.length>0?`<div>üíä ${weekData.symptoms.length} symptom events</div>`:''}
${weekData.activities.length>0?`<div>üèÉ ${weekData.activities.reduce((sum,a)=>sum+a.duration,0)} min total</div>`:''}
</div>
</div>`;
weekNum++;
}
weekStart.setDate(weekStart.getDate()+7);
}
html+='</div>';
return html;
}

function generateMonthlyBreakdown(data,startDate,endDate){
let html='<div style="display:grid;gap:12px">';
const months={};
data.bp.forEach(r=>{
const date=new Date(r._date);
const monthKey=`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`;
months[monthKey]=months[monthKey]||{bp:[],weight:[],symptoms:[],activities:[]};
months[monthKey].bp.push(r);
});
data.weight.forEach(r=>{
const date=new Date(r._date);
const monthKey=`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`;
if(months[monthKey])months[monthKey].weight.push(r);
});
data.symptoms.forEach(r=>{
const date=new Date(r._date);
const monthKey=`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`;
if(months[monthKey])months[monthKey].symptoms.push(r);
});
data.activities.forEach(r=>{
const date=new Date(r._date);
const monthKey=`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`;
if(months[monthKey])months[monthKey].activities.push(r);
});
Object.entries(months).sort().forEach(([monthKey,monthData])=>{
const[year,month]=monthKey.split('-');
const monthName=new Date(year,month-1,1).toLocaleDateString('en-US',{month:'long',year:'numeric'});
const avgSys=monthData.bp.reduce((sum,r)=>sum+r.s,0)/monthData.bp.length;
const avgDia=monthData.bp.reduce((sum,r)=>sum+r.d,0)/monthData.bp.length;
html+=`<div style="padding:16px;background:#f9fafb;border-radius:8px;border-left:4px solid #ec4899">
<div style="font-weight:700;color:#1f2937;margin-bottom:8px">${monthName}</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;font-size:14px;color:#6b7280">
<div>üìä Avg BP: ${avgSys.toFixed(0)}/${avgDia.toFixed(0)} mmHg</div>
<div>üìà ${monthData.bp.length} readings</div>
${monthData.weight.length>0?`<div>‚öñÔ∏è Avg: ${(monthData.weight.reduce((sum,w)=>sum+w.w,0)/monthData.weight.length).toFixed(1)} lbs</div>`:''}
${monthData.symptoms.length>0?`<div>üíä ${monthData.symptoms.length} symptom events</div>`:''}
${monthData.activities.length>0?`<div>üèÉ ${monthData.activities.reduce((sum,a)=>sum+a.duration,0)} min total</div>`:''}
</div>
</div>`;
});
html+='</div>';
return html;
}

function generateInsights(data){
let html='<div style="font-size:16px;line-height:1.8;color:#1f2937">';
const insights=[];
// Critical BP readings
if(data.bp.length>0){
const critical=data.bp.filter(r=>r.s>180||r.d>120);
const stage2=data.bp.filter(r=>r.s>=140||r.d>=90);
if(critical.length>0){
insights.push(`‚ö†Ô∏è <b>CRITICAL:</b> ${critical.length} hypertensive crisis reading${critical.length>1?'s':''} detected (>180/120 mmHg). Seek immediate medical attention if you experience symptoms.`);
}
if(stage2.length>data.bp.length*0.5){
insights.push(`‚ö†Ô∏è Over 50% of your readings indicate Stage 2 Hypertension. Strongly recommend discussing medication adjustment with your cardiologist.`);
}
// Best readings
const normal=data.bp.filter(r=>r.s<120&&r.d<80);
if(normal.length>0){
insights.push(`‚úì Great news: ${normal.length} reading${normal.length>1?'s':''} in the normal range (<120/80 mmHg). Keep up the healthy habits!`);
}
}
// Weight insights
if(data.weight.length>=7){
const sorted=[...data.weight].sort((a,b)=>new Date(a._date)-new Date(b._date));
const change=sorted[sorted.length-1].w-sorted[0].w;
if(Math.abs(change)>5){
insights.push(`${change>0?'‚ö†Ô∏è':'‚ÑπÔ∏è'} Weight ${change>0?'gain':'loss'} of ${Math.abs(change).toFixed(1)} lbs over ${sorted.length} measurements. ${Math.abs(change)>5?'Discuss this with your doctor, especially if you have CHF.':'Monitor and maintain healthy habits.'}`);
}
}
// Activity consistency
if(data.activities.length>0){
const daysWithActivity=new Set(data.activities.map(a=>a._date)).size;
const totalDays=Math.ceil((new Date(data.activities[data.activities.length-1]._date)-new Date(data.activities[0]._date))/(1000*60*60*24))+1;
const consistency=(daysWithActivity/totalDays)*100;
if(consistency>=70){
insights.push(`‚úì Excellent activity consistency: Active on ${daysWithActivity} of ${totalDays} days (${consistency.toFixed(0)}%). Regular exercise is beneficial for cardiovascular health.`);
}else if(consistency>=40){
insights.push(`‚ÑπÔ∏è Moderate activity level: Active on ${daysWithActivity} of ${totalDays} days (${consistency.toFixed(0)}%). Consider increasing frequency for optimal benefits.`);
}
}
// Symptom severity
if(data.symptoms.length>0){
const highSeverity=data.symptoms.filter(s=>s.severity>=7);
if(highSeverity.length>=3){
insights.push(`‚ö†Ô∏è ${highSeverity.length} high-severity symptom events (7+/10) recorded. Please discuss these episodes with your healthcare provider.`);
}
}
if(insights.length===0){
html+=`<div style="padding:20px;background:#f0f9ff;border-radius:8px;text-align:center">
<div style="font-size:20px;margin-bottom:12px">üí°</div>
<div style="font-weight:600;color:#1e40af;margin-bottom:8px">Key Insights - Powered by Your Data</div>
<div style="color:#1e40af;font-size:15px;line-height:1.6">
This section provides personalized health insights based on your tracking data:
<ul style="text-align:left;margin:12px 0;padding-left:20px">
<li><b>Critical Alerts:</b> Immediate warnings for dangerous BP readings</li>
<li><b>Progress Recognition:</b> Celebrate when readings are in healthy ranges</li>
<li><b>Weight Monitoring:</b> Track significant changes that affect heart health</li>
<li><b>Activity Assessment:</b> Evaluate your exercise consistency</li>
<li><b>Symptom Tracking:</b> Identify when symptoms need medical attention</li>
</ul>
<div style="margin-top:16px;padding:12px;background:white;border-radius:6px;border:2px solid #3b82f6">
<b>Keep tracking!</b> The more complete your data, the more valuable insights you'll receive. Log BP, weight, symptoms, activities, and medications regularly for comprehensive analysis.
</div>
</div>
</div>`;
}else{
html+=insights.map(i=>`<div style="padding:12px 0;border-bottom:1px solid #e5e7eb">${i}</div>`).join('');
}
html+='</div>';
document.getElementById('insightsContent').innerHTML=html;
}

function addContextToReading(dateKey,time){
// Load the reading data for this date
console.log('Looking for dateKey:',dateKey,'time:',time);
const saved=localStorage.getItem(dateKey);
if(!saved){
// Try without BP_TRACKER_ prefix if not found
const altKey=dateKey.includes('BP_TRACKER_')?dateKey.replace('BP_TRACKER_',''):'BP_TRACKER_'+dateKey;
const altSaved=localStorage.getItem(altKey);
if(!altSaved){
alert('Reading data not found. Date key: '+dateKey);
console.error('Keys tried:',dateKey,altKey);
console.error('Available keys:',Object.keys(localStorage).filter(k=>k.includes('BP_TRACKER')));
return;
}
// Use alternative key
const data=JSON.parse(altSaved);
processReading(data,altKey,time);
return;
}
const data=JSON.parse(saved);
processReading(data,dateKey,time);
}

function processReading(data,dateKey,time){
const bp=data.bp||[];
console.log('BP readings:',bp,'looking for time:',time);
console.log('Available times in readings:',bp.map(r=>r.t));
// Find the specific reading by time
let reading=bp.find(r=>r.t===time);
console.log('Exact match result:',reading);
// If not found, try to find by partial match
if(!reading){
reading=bp.find(r=>r.t&&r.t.startsWith(time.substring(0,5)));
console.log('Partial match result:',reading);
}
if(!reading){
alert('Reading not found at time '+time+'. Available times: '+bp.map(r=>r.t).join(', '));
console.error('Could not find reading at time',time,'in',bp);
return;
}
console.log('Found reading:',reading);
// Create modal for adding context
const modal=document.getElementById('modal');
const modalContent=document.getElementById('modalContent');
console.log('Modal element:',modal,'ModalContent:',modalContent);
let html='<div class="modal-title">üìù Add Context to Reading</div>';
html+='<div style="background:#f9fafb;padding:16px;border-radius:8px;margin-bottom:20px">';
html+='<div style="font-weight:600;margin-bottom:8px">Reading Details:</div>';
html+='<div>üìÖ '+new Date(dateKey.replace('BP_TRACKER_','')).toLocaleDateString()+' at '+time+'</div>';
html+='<div>üíâ BP: '+reading.s+'/'+reading.d+' mmHg'+(reading.h?' | ‚ù§Ô∏è HR: '+reading.h+' BPM':'')+'</div>';
html+='</div>';

// Load custom symptoms and activities
const customSymptoms=JSON.parse(localStorage.getItem('customSymptoms')||'[]');
const customActivities=JSON.parse(localStorage.getItem('customActivities')||'[]');

// Symptoms checklist
html+='<div style="margin-bottom:20px">';
html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">';
html+='<label style="font-weight:600;font-size:18px">Common Symptoms (check all that apply):</label>';
html+='<button onclick="addCustomSymptom()" style="background:#10b981;color:white;border:none;padding:6px 12px;border-radius:6px;font-size:14px;cursor:pointer">+ Add Custom</button>';
html+='</div>';
const symptoms=['Dizziness','Lightheadedness','Fatigue','Chest discomfort','Palpitations','Shortness of breath','Headache','Nausea','Anxiety','No symptoms'];
const existingSymptoms=reading.contextSymptoms||[];
symptoms.forEach(symptom=>{
const checked=existingSymptoms.includes(symptom)?'checked':'';
html+='<label style="display:block;padding:8px;margin:4px 0;background:#fff;border:2px solid #e5e7eb;border-radius:6px;cursor:pointer">';
html+='<input type="checkbox" class="symptom-checkbox" value="'+symptom+'" '+checked+' style="margin-right:8px"> '+symptom;
html+='</label>';
});
// Add custom symptoms
customSymptoms.forEach(symptom=>{
const checked=existingSymptoms.includes(symptom)?'checked':'';
html+='<label style="display:block;padding:8px;margin:4px 0;background:#e0f2fe;border:2px solid #0ea5e9;border-radius:6px;cursor:pointer;position:relative;padding-right:80px">';
html+='<input type="checkbox" class="symptom-checkbox" value="'+symptom+'" '+checked+' style="margin-right:8px"> '+symptom+' <span style="font-size:12px;color:#0369a1">(custom)</span>';
html+='<button onclick="event.stopPropagation();deleteCustomSymptom(\''+symptom.replace(/'/g,"\\'")+'\')" style="position:absolute;right:8px;top:8px;background:#ef4444;color:white;border:none;padding:2px 8px;border-radius:4px;font-size:12px;cursor:pointer">Delete</button>';
html+='</label>';
});
html+='</div>';
// Activity/Context
html+='<div style="margin-bottom:20px">';
html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">';
html+='<label style="font-weight:600;font-size:18px">Activity/Context (check all that apply):</label>';
html+='<button onclick="addCustomActivity()" style="background:#10b981;color:white;border:none;padding:6px 12px;border-radius:6px;font-size:14px;cursor:pointer">+ Add Custom</button>';
html+='</div>';
const contexts=['Resting','After exercise','After medication','Before medication','After eating','Feeling stressed','Just woke up','Before bed','At work'];
const existingContexts=reading.contextActivity||[];
contexts.forEach(context=>{
const checked=existingContexts.includes(context)?'checked':'';
html+='<label style="display:block;padding:8px;margin:4px 0;background:#fff;border:2px solid #e5e7eb;border-radius:6px;cursor:pointer">';
html+='<input type="checkbox" class="activity-checkbox" value="'+context+'" '+checked+' style="margin-right:8px"> '+context;
html+='</label>';
});
// Add custom activities
customActivities.forEach(activity=>{
const checked=existingContexts.includes(activity)?'checked':'';
html+='<label style="display:block;padding:8px;margin:4px 0;background:#f0fdf4;border:2px solid #10b981;border-radius:6px;cursor:pointer;position:relative;padding-right:80px">';
html+='<input type="checkbox" class="activity-checkbox" value="'+activity+'" '+checked+' style="margin-right:8px"> '+activity+' <span style="font-size:12px;color:#047857">(custom)</span>';
html+='<button onclick="event.stopPropagation();deleteCustomActivity(\''+activity.replace(/'/g,"\\'")+'\')" style="position:absolute;right:8px;top:8px;background:#ef4444;color:white;border:none;padding:2px 8px;border-radius:4px;font-size:12px;cursor:pointer">Delete</button>';
html+='</label>';
});
html+='</div>';
// Free text notes
html+='<label style="display:block;font-weight:600;font-size:18px;margin-bottom:8px">Additional Notes:</label>';
html+='<textarea id="readingContextNotes" style="width:100%;min-height:120px;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:16px;box-sizing:border-box" placeholder="Add any additional context about how you were feeling, what you were doing, etc...">'+(reading.contextNotes||'')+'</textarea>';
html+='<div class="modal-actions">';
html+='<button class="modal-cancel" onclick="hideModal()">Cancel</button>';
html+='<button class="modal-ok" onclick="saveReadingContext(\''+dateKey+'\',\''+reading.t+'\')">üíæ Save Context</button>';
html+='</div>';
modalContent.innerHTML=html;
console.log('About to show modal. Modal:',modal,'Display was:',modal.style.display);
modal.setAttribute('data-current-datekey',dateKey);
modal.setAttribute('data-current-time',reading.t);
modal.style.display='block';
modal.style.zIndex='99999';
modal.style.position='fixed';
console.log('Modal display now set to:',modal.style.display,'z-index:',modal.style.zIndex);
}

function saveReadingContext(dateKey,time){
// Get selected symptoms and activities using class selectors
const symptomCheckboxes=document.querySelectorAll('.symptom-checkbox');
const activityCheckboxes=document.querySelectorAll('.activity-checkbox');
const selectedSymptoms=[];
const selectedContexts=[];

symptomCheckboxes.forEach(cb=>{
if(cb.checked){
selectedSymptoms.push(cb.value);
}
});

activityCheckboxes.forEach(cb=>{
if(cb.checked){
selectedContexts.push(cb.value);
}
});
// Get notes
const notes=document.getElementById('readingContextNotes').value;
// Load and update the reading
let saved=localStorage.getItem(dateKey);
if(!saved){
// Try alternate key
const altKey=dateKey.includes('BP_TRACKER_')?dateKey.replace('BP_TRACKER_',''):'BP_TRACKER_'+dateKey;
saved=localStorage.getItem(altKey);
if(!saved){
alert('Cannot save - reading data not found');
return;
}
dateKey=altKey; // Use the key that worked
}
const data=JSON.parse(saved);
const bp=data.bp||[];
let reading=bp.find(r=>r.t===time);
// Try partial match if exact not found
if(!reading){
reading=bp.find(r=>r.t&&r.t.startsWith(time.substring(0,5)));
}
if(!reading){
alert('Cannot save - reading not found at time '+time);
return;
}
// Save context to reading
reading.contextSymptoms=selectedSymptoms;
reading.contextActivity=selectedContexts;
reading.contextNotes=notes;
reading.contextTimestamp=new Date().toISOString();
// Save back to localStorage
localStorage.setItem(dateKey,JSON.stringify(data));
hideModal();
alert('‚úì Context saved! This information will be included in your doctor\'s report.');
// Refresh the analytics view if it's open
if(document.getElementById('analyticsPanel').style.display!=='none'){
runAdvancedAnalytics();
}
}

function addCustomSymptom(){
const symptom=prompt('Enter a custom symptom (e.g., "Blurred vision", "Sweating", "Cold hands"):');
if(!symptom||symptom.trim()==='')return;
const trimmed=symptom.trim();
// Load existing custom symptoms
const customSymptoms=JSON.parse(localStorage.getItem('customSymptoms')||'[]');
// Check if already exists
if(customSymptoms.includes(trimmed)){
alert('This symptom already exists!');
return;
}
// Add and save
customSymptoms.push(trimmed);
localStorage.setItem('customSymptoms',JSON.stringify(customSymptoms));
alert('‚úì Custom symptom "'+trimmed+'" added! It will now appear in all future readings.');
// Refresh the modal
const modal=document.getElementById('modal');
const dateKey=modal.getAttribute('data-current-datekey');
const time=modal.getAttribute('data-current-time');
if(dateKey&&time){
addContextToReading(dateKey,time);
}
}

function deleteCustomSymptom(symptom){
if(!confirm('Delete custom symptom "'+symptom+'"? This will remove it from all future readings.')){
return;
}
const customSymptoms=JSON.parse(localStorage.getItem('customSymptoms')||'[]');
const updated=customSymptoms.filter(s=>s!==symptom);
localStorage.setItem('customSymptoms',JSON.stringify(updated));
alert('‚úì Custom symptom deleted.');
// Refresh the modal
const modal=document.getElementById('modal');
const dateKey=modal.getAttribute('data-current-datekey');
const time=modal.getAttribute('data-current-time');
if(dateKey&&time){
addContextToReading(dateKey,time);
}
}

function addCustomActivity(){
const activity=prompt('Enter a custom activity/context (e.g., "After coffee", "During argument", "Walking stairs"):');
if(!activity||activity.trim()==='')return;
const trimmed=activity.trim();
// Load existing custom activities
const customActivities=JSON.parse(localStorage.getItem('customActivities')||'[]');
// Check if already exists
if(customActivities.includes(trimmed)){
alert('This activity already exists!');
return;
}
// Add and save
customActivities.push(trimmed);
localStorage.setItem('customActivities',JSON.stringify(customActivities));
alert('‚úì Custom activity "'+trimmed+'" added! It will now appear in all future readings.');
// Refresh the modal
const modal=document.getElementById('modal');
const dateKey=modal.getAttribute('data-current-datekey');
const time=modal.getAttribute('data-current-time');
if(dateKey&&time){
addContextToReading(dateKey,time);
}
}

function saveAnalyticsNotes(){
const range=getAnalyticsDateRange();
if(!range)return;
const{startDate,endDate}=range;
const periodKey=`${startDate.toISOString().split('T')[0]}_to_${endDate.toISOString().split('T')[0]}`;
const notes=document.getElementById('analyticsNotes').value;
analyticsNotesData[periodKey]=notes;
localStorage.setItem('analyticsNotes',JSON.stringify(analyticsNotesData));
alert('‚úì Notes saved for this analysis period!');
}

function exportAnalyticsPDF(){
const range=getAnalyticsDateRange();
if(!range){
alert('Please generate analytics first');
return;
}
const{startDate,endDate}=range;
const data=getAllHistoricalData(startDate,endDate);
if(data.bp.length===0){
alert('No data to export');
return;
}
const report=[];
report.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
report.push('ADVANCED ANALYTICS REPORT');
report.push('BP TRACKER v7.3C - Clinical Analytics Dashboard');
report.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
report.push('');
report.push(`Analysis Period: ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`);
report.push(`Generated: ${new Date().toLocaleString()}`);
report.push('');
report.push('SUMMARY STATISTICS:');
report.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
if(data.bp.length>0){
const avgSys=data.bp.reduce((sum,r)=>sum+r.s,0)/data.bp.length;
const avgDia=data.bp.reduce((sum,r)=>sum+r.d,0)/data.bp.length;
const avgHR=data.bp.reduce((sum,r)=>sum+(r.h||0),0)/data.bp.length;
report.push(`Total BP Readings: ${data.bp.length}`);
report.push(`Average BP: ${avgSys.toFixed(0)}/${avgDia.toFixed(0)} mmHg`);
report.push(`Average HR: ${avgHR.toFixed(0)} BPM`);
}
if(data.weight.length>0){
report.push(`Total Weight Entries: ${data.weight.length}`);
const change=data.weight[data.weight.length-1].w-data.weight[0].w;
report.push(`Weight Change: ${change>=0?'+':''}${change.toFixed(1)} lbs`);
}
if(data.symptoms.length>0){
report.push(`Total Symptom Events: ${data.symptoms.length}`);
const avgSeverity=data.symptoms.reduce((sum,s)=>sum+s.severity,0)/data.symptoms.length;
report.push(`Average Severity: ${avgSeverity.toFixed(1)}/10`);
}
if(data.activities.length>0){
report.push(`Total Activities: ${data.activities.length}`);
const totalMin=data.activities.reduce((sum,a)=>sum+a.duration,0);
report.push(`Total Exercise Time: ${totalMin} minutes`);
}
report.push('');
const periodKey=`${startDate.toISOString().split('T')[0]}_to_${endDate.toISOString().split('T')[0]}`;
const notes=analyticsNotesData[periodKey];
if(notes){
report.push('ANALYSIS NOTES:');
report.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
report.push(notes);
report.push('');
}
report.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
report.push('This report was generated by ClinBridge v9.5.5 Medical Grade - Free');
report.push('Advanced Analytics Dashboard - Phase 3 Implementation');
report.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
const blob=new Blob([report.join('\n')],{type:'text/plain'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download=`Advanced-Analytics-${startDate.toISOString().split('T')[0]}-to-${endDate.toISOString().split('T')[0]}.txt`;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
alert('‚úì Analytics report exported!');
}

function exportAnalyticsSpreadsheet(){
const range=getAnalyticsDateRange();
if(!range){
alert('Please generate analytics first');
return;
}
const{startDate,endDate}=range;
const data=getAllHistoricalData(startDate,endDate);
if(data.bp.length===0){
alert('No data to export');
return;
}
const rows=[];
rows.push(['Type','Date','Time','Value1','Value2','Value3','Notes'].join('\t'));
data.bp.forEach(r=>{
rows.push(['BP',r._date,r.t,r.s,r.d,r.h||'',''].join('\t'));
});
data.weight.forEach(r=>{
rows.push(['Weight',r._date,r.time||'',r.w,'','',''].join('\t'));
});
data.symptoms.forEach(r=>{
rows.push(['Symptom',r._date,r.time,r.symptom,r.severity,'',r.notes||''].join('\t'));
});
data.activities.forEach(r=>{
rows.push(['Activity',r._date,r.time,r.type,r.duration,r.intensity,''].join('\t'));
});
const blob=new Blob([rows.join('\n')],{type:'text/plain'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download=`Analytics-Data-${startDate.toISOString().split('T')[0]}-to-${endDate.toISOString().split('T')[0]}.txt`;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
alert('‚úì Data exported to spreadsheet format!');
}

function printAnalytics(){
const summaryHTML=document.getElementById('analyticsSummary').innerHTML;
const correlationHTML=document.getElementById('correlationContent').innerHTML;
const trendHTML=document.getElementById('trendContent').innerHTML;
const patternHTML=document.getElementById('patternContent').innerHTML;
const periodHTML=document.getElementById('periodContent').innerHTML;
const insightsHTML=document.getElementById('insightsContent').innerHTML;
const printWindow=window.open('','_blank');
printWindow.document.write(`
<html>
<head>
<title>Advanced Analytics Report</title>
<style>
body{font-family:-apple-system,sans-serif;padding:30px;max-width:900px;margin:0 auto;}
h2{color:#8b5cf6;border-bottom:3px solid #8b5cf6;padding-bottom:10px;margin-top:30px;}
h3{color:#374151;margin-top:20px;}
.stat-card{display:inline-block;padding:15px;margin:10px;background:#f9fafb;border-radius:8px;min-width:150px;}
.stat-value{font-size:28px;font-weight:bold;color:#1f2937;}
.stat-label{font-size:14px;color:#6b7280;margin-top:5px;}
</style>
</head>
<body>
<h1 style="color:#8b5cf6">üìä Advanced Analytics Report</h1>
<p style="color:#6b7280">Generated: ${new Date().toLocaleString()}</p>
<h2>Summary Statistics</h2>
${summaryHTML}
<h2>Multi-Metric Correlations</h2>
${correlationHTML}
<h2>Trend Analysis</h2>
${trendHTML}
<h2>Pattern Detection</h2>
${patternHTML}
<h2>Period Breakdown</h2>
${periodHTML}
<h2>Key Insights</h2>
${insightsHTML}
<div style="margin-top:40px;padding:20px;background:#f0f9ff;border-left:4px solid #3b82f6;border-radius:8px">
<strong>ClinBridge v9.5.5 Medical Grade - Free</strong> - Advanced Analytics Dashboard<br>
This report is not a substitute for professional medical advice.
</div>
</body>
</html>
`);
printWindow.document.close();
printWindow.print();
}

// Analytics Chart Functions
var currentAnalyticsChart=null;
var currentChartType=null;

function toggleAnalyticsChart(type){
const container=document.getElementById('analyticsChartContainer');
// If same chart clicked, toggle visibility
if(currentChartType===type&&container.style.display==='block'){
closeAnalyticsChart();
return;
}
// Show container, wait for browser to fully paint (double-rAF works on iOS Safari)
currentChartType=type;
container.style.display='block';
requestAnimationFrame(()=>{
requestAnimationFrame(()=>{
renderAnalyticsChart(type);
container.scrollIntoView({behavior:'smooth',block:'nearest'});
});
});
}

function closeAnalyticsChart(){
document.getElementById('analyticsChartContainer').style.display='none';
if(currentAnalyticsChart){
currentAnalyticsChart.destroy();
currentAnalyticsChart=null;
}
currentChartType=null;
}

// LTTB decimation ‚Äî preserves visual shape while reducing point count
function lttbDecimate(items, yFn, threshold){
  if(items.length<=threshold)return items;
  const sampled=[items[0]];
  const bucketSize=(items.length-2)/(threshold-2);
  for(let i=1;i<threshold-1;i++){
    const bStart=Math.floor((i-1)*bucketSize)+1;
    const bEnd=Math.min(Math.floor(i*bucketSize)+1,items.length-1);
    const nStart=Math.floor(i*bucketSize)+1;
    const nEnd=Math.min(Math.floor((i+1)*bucketSize)+1,items.length-1);
    let avgX=0,avgY=0,nCount=nEnd-nStart;
    for(let j=nStart;j<nEnd;j++){avgX+=j;avgY+=yFn(items[j]);}
    if(nCount>0){avgX/=nCount;avgY/=nCount;}
    const prev=sampled[sampled.length-1];
    const prevIdx=items.indexOf(prev);
    let maxArea=-1,sel=bStart;
    for(let j=bStart;j<bEnd;j++){
      const area=Math.abs((prevIdx-avgX)*(yFn(items[j])-yFn(prev))-(prevIdx-j)*(avgY-yFn(prev)))*0.5;
      if(area>maxArea){maxArea=area;sel=j;}
    }
    sampled.push(items[sel]);
  }
  sampled.push(items[items.length-1]);
  return sampled;
}

function renderAnalyticsChart(type){
if(!currentAnalyticsData)return;
if(currentAnalyticsChart){currentAnalyticsChart.destroy();currentAnalyticsChart=null;}
const canvas=document.getElementById('analyticsChart');
const scroller=document.getElementById('analyticsChartScroller');
const dpr=window.devicePixelRatio||1;
const viewW=scroller.clientWidth||window.innerWidth-48;
// Count data points to size canvas
let pointCount=0;
if(type==='bp')pointCount=currentAnalyticsData.bp.length;
else if(type==='hr')pointCount=currentAnalyticsData.bp.filter(r=>r.h).length;
else if(type==='weight')pointCount=currentAnalyticsData.weight.length;
else if(type==='activity')pointCount=Object.keys(
  currentAnalyticsData.activities.reduce((a,r)=>{a[r._date]=1;return a;},{})
).length;
// BP/HR: 8px per point (many readings per day). Weight: 20px (once daily). Activity bars: 30px
const pxPerPoint=(type==='activity')?30:(type==='weight')?20:8;
const logicalW=Math.min(Math.max(pointCount*pxPerPoint+120,viewW),4000);
const logicalH=350;
canvas.width=logicalW*dpr;
canvas.height=logicalH*dpr;
canvas.style.width=logicalW+'px';
canvas.style.height=logicalH+'px';
canvas._logW=logicalW;
canvas._logH=logicalH;
canvas._threshold=pointCount+1;
const ctx=canvas.getContext('2d');
ctx.scale(dpr,dpr);
switch(type){
case 'bp': renderBPAnalyticsChart(ctx,canvas); break;
case 'hr': renderHRAnalyticsChart(ctx,canvas); break;
case 'weight': renderWeightAnalyticsChart(ctx,canvas); break;
case 'activity': renderActivityAnalyticsChart(ctx,canvas); break;
}
requestAnimationFrame(()=>{scroller.scrollLeft=scroller.scrollWidth;});
}

function renderBPAnalyticsChart(ctx,canvas){
document.getElementById('analyticsChartTitle').textContent='üìä Blood Pressure Trend Over Time';
const data=currentAnalyticsData.bp;
if(data.length===0)return;
// Sort by date/time, then LTTB decimate to keep chart crisp
const raw=[...data].sort((a,b)=>new Date(a._date+' '+a.t)-new Date(b._date+' '+b.t));
const sorted=lttbDecimate(raw,r=>r.s,canvas._threshold||150);
const w=canvas._logW||canvas.width;
const h=canvas._logH||canvas.height;
const pad=80;
const rightPad=40;
// Find min/max for scaling
const allSys=sorted.map(r=>r.s);
const allDia=sorted.map(r=>r.d);
const minVal=Math.min(...allDia)-10;
const maxVal=Math.max(...allSys)+10;
const range=maxVal-minVal;
// Clear canvas
ctx.clearRect(0,0,w,h);
// Draw background zones
const zones=[
{min:120,max:maxVal,color:'rgba(239,68,68,0.05)',label:'High'},
{min:80,max:120,color:'rgba(16,185,129,0.05)',label:'Normal'},
{min:minVal,max:80,color:'rgba(59,130,246,0.05)',label:'Low'}
];
zones.forEach(zone=>{
if(zone.max<minVal||zone.min>maxVal)return;
const yTop=pad+((maxVal-Math.min(zone.max,maxVal))/range)*(h-pad-rightPad);
const yBottom=pad+((maxVal-Math.max(zone.min,minVal))/range)*(h-pad-rightPad);
ctx.fillStyle=zone.color;
ctx.fillRect(pad,yTop,w-pad-rightPad,yBottom-yTop);
});
// Draw grid lines with labels
ctx.strokeStyle='#e5e7eb';
ctx.lineWidth=1;
ctx.fillStyle='#6b7280';
ctx.font='12px sans-serif';
ctx.textAlign='right';
for(let i=0;i<=5;i++){
const value=minVal+i*(range/5);
const y=pad+((maxVal-value)/range)*(h-pad-rightPad);
ctx.beginPath();
ctx.moveTo(pad,y);
ctx.lineTo(w-rightPad,y);
ctx.stroke();
ctx.fillText(value.toFixed(0),pad-10,y+4);
}
// Draw axes
ctx.strokeStyle='#374151';
ctx.lineWidth=2;
ctx.beginPath();
ctx.moveTo(pad,pad);
ctx.lineTo(pad,h-rightPad);
ctx.lineTo(w-rightPad,h-rightPad);
ctx.stroke();
// Calculate point positions
const xStep=(w-pad-rightPad)/(sorted.length-1||1);
const points={systolic:[],diastolic:[]};
sorted.forEach((r,i)=>{
const x=pad+i*xStep;
const ySys=pad+((maxVal-r.s)/range)*(h-pad-rightPad);
const yDia=pad+((maxVal-r.d)/range)*(h-pad-rightPad);
points.systolic.push({x,y:ySys,value:r.s,time:r.t,date:r._date,reading:r});
points.diastolic.push({x,y:yDia,value:r.d,time:r.t,date:r._date,reading:r});
});
// Draw systolic line
ctx.strokeStyle='#ef4444';
ctx.lineWidth=3;
ctx.beginPath();
points.systolic.forEach((p,i)=>{
if(i===0)ctx.moveTo(p.x,p.y);
else ctx.lineTo(p.x,p.y);
});
ctx.stroke();
// Draw systolic points
var outOfRangeSystolic=[];
points.systolic.forEach(p=>{
const isOutOfRange=p.value<settings.systolicMin||p.value>settings.systolicMax;
if(isOutOfRange){
outOfRangeSystolic.push(p);
// Draw larger warning point
ctx.fillStyle='#fbbf24';
ctx.strokeStyle='#dc2626';
ctx.lineWidth=3;
ctx.beginPath();
ctx.arc(p.x,p.y,8,0,2*Math.PI);
ctx.fill();
ctx.stroke();
// Add warning icon
ctx.fillStyle='#dc2626';
ctx.font='bold 12px sans-serif';
ctx.textAlign='center';
ctx.fillText('!',p.x,p.y+4);
}else{
// Normal point
ctx.fillStyle='#ef4444';
ctx.beginPath();
ctx.arc(p.x,p.y,5,0,2*Math.PI);
ctx.fill();
}
});
// Draw diastolic line
ctx.strokeStyle='#3b82f6';
ctx.lineWidth=3;
ctx.beginPath();
points.diastolic.forEach((p,i)=>{
if(i===0)ctx.moveTo(p.x,p.y);
else ctx.lineTo(p.x,p.y);
});
ctx.stroke();
// Draw diastolic points
var outOfRangeDiastolic=[];
points.diastolic.forEach(p=>{
const isOutOfRange=p.value<settings.diastolicMin||p.value>settings.diastolicMax;
if(isOutOfRange){
outOfRangeDiastolic.push(p);
// Draw larger warning point
ctx.fillStyle='#fbbf24';
ctx.strokeStyle='#dc2626';
ctx.lineWidth=3;
ctx.beginPath();
ctx.arc(p.x,p.y,8,0,2*Math.PI);
ctx.fill();
ctx.stroke();
// Add warning icon
ctx.fillStyle='#dc2626';
ctx.font='bold 12px sans-serif';
ctx.textAlign='center';
ctx.fillText('!',p.x,p.y+4);
}else{
// Normal point
ctx.fillStyle='#3b82f6';
ctx.beginPath();
ctx.arc(p.x,p.y,5,0,2*Math.PI);
ctx.fill();
}
});
// X-axis date labels (show first, middle, last)
ctx.fillStyle='#374151';
ctx.font='11px sans-serif';
ctx.textAlign='center';
const labelIndices=[0,Math.floor(sorted.length/2),sorted.length-1];
labelIndices.forEach(i=>{
if(i<sorted.length){
const x=pad+i*xStep;
const dateStr=new Date(sorted[i]._date).toLocaleDateString('en-US',{month:'short',day:'numeric'});
ctx.fillText(dateStr,x,h-rightPad+20);
}
});
// Legend
ctx.fillStyle='#ef4444';
ctx.fillRect(w-rightPad-120,20,30,3);
ctx.fillStyle='#374151';
ctx.font='14px sans-serif';
ctx.textAlign='left';
ctx.fillText('Systolic',w-rightPad-85,25);
ctx.fillStyle='#3b82f6';
ctx.fillRect(w-rightPad-120,40,30,3);
ctx.fillStyle='#374151';
ctx.fillText('Diastolic',w-rightPad-85,45);
// Add hover interaction
canvas.onmousemove=function(e){
const rect=canvas.getBoundingClientRect();
const mouseX=e.clientX-rect.left;
const mouseY=e.clientY-rect.top;
let hoveredPoint=null;
let hoveredType=null;
// Check systolic points
points.systolic.forEach(p=>{
const dist=Math.sqrt(Math.pow(mouseX-p.x,2)+Math.pow(mouseY-p.y,2));
if(dist<10){
hoveredPoint=p;
hoveredType='Systolic';
}
});
// Check diastolic points
if(!hoveredPoint){
points.diastolic.forEach(p=>{
const dist=Math.sqrt(Math.pow(mouseX-p.x,2)+Math.pow(mouseY-p.y,2));
if(dist<10){
hoveredPoint=p;
hoveredType='Diastolic';
}
});
}
if(hoveredPoint){
canvas.style.cursor='pointer';
// Redraw chart
renderBPAnalyticsChart(ctx,canvas);
// Draw tooltip
const tooltipX=hoveredPoint.x;
const tooltipY=hoveredPoint.y-60;
ctx.fillStyle='rgba(0,0,0,0.8)';
ctx.fillRect(tooltipX-70,tooltipY,140,50);
ctx.fillStyle='#fff';
ctx.font='12px sans-serif';
ctx.textAlign='center';
ctx.fillText(`${hoveredType}: ${hoveredPoint.value} mmHg`,tooltipX,tooltipY+15);
ctx.fillText(`${new Date(hoveredPoint.date).toLocaleDateString()}`,tooltipX,tooltipY+30);
ctx.fillText(`${hoveredPoint.time}`,tooltipX,tooltipY+45);
}else{
canvas.style.cursor='default';
}
};
canvas.onclick=function(e){
const rect=canvas.getBoundingClientRect();
const mouseX=e.clientX-rect.left;
const mouseY=e.clientY-rect.top;
// Check if clicked on a point
[...points.systolic,...points.diastolic].forEach(p=>{
const dist=Math.sqrt(Math.pow(mouseX-p.x,2)+Math.pow(mouseY-p.y,2));
if(dist<10){
const r=p.reading;
alert(`üìä Blood Pressure Reading\n\n` +
`Date: ${new Date(r._date).toLocaleDateString()}\n` +
`Time: ${r.t}\n` +
`Systolic: ${r.s} mmHg\n` +
`Diastolic: ${r.d} mmHg\n` +
`Heart Rate: ${r.h||'N/A'} BPM`);
}
});
};
// Generate summary of out-of-range readings
const notesDiv=document.getElementById('analyticsChartNotes');
if(outOfRangeSystolic.length>0||outOfRangeDiastolic.length>0){
let summaryHTML='<div style="color:#374151;font-size:14px">';
summaryHTML+='<div style="font-weight:700;margin-bottom:8px;color:#dc2626;font-size:16px">‚ö†Ô∏è Out-of-Range Readings Detected</div>';
summaryHTML+='<div style="margin-bottom:4px"><strong>Settings Range:</strong> Systolic '+settings.systolicMin+'-'+settings.systolicMax+' mmHg, Diastolic '+settings.diastolicMin+'-'+settings.diastolicMax+' mmHg</div>';
if(outOfRangeSystolic.length>0){
summaryHTML+='<div style="margin-top:12px;padding:8px;background:#fee2e2;border-radius:6px">';
summaryHTML+='<div style="font-weight:600;color:#991b1b;margin-bottom:6px">üî¥ Systolic Out-of-Range ('+outOfRangeSystolic.length+' occurrence'+(outOfRangeSystolic.length>1?'s':'')+'):</div>';
outOfRangeSystolic.forEach(p=>{
const status=p.value>settings.systolicMax?'HIGH ('+p.value+')':'LOW ('+p.value+')';
const r=p.reading;
const readingKey='BP_TRACKER_'+r._date;
summaryHTML+='<div style="margin-left:12px;margin-top:8px;padding:8px;background:white;border-radius:4px">';
summaryHTML+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">';
summaryHTML+='<span>‚Ä¢ '+new Date(r._date).toLocaleDateString()+' at '+r.t+' - <strong>'+status+'</strong> mmHg</span>';
summaryHTML+='<button onclick="addContextToReading(\''+readingKey+'\',\''+r.t+'\')" style="background:#3b82f6;color:white;border:none;padding:4px 12px;border-radius:6px;font-size:12px;cursor:pointer;margin-left:8px">üìù '+(r.contextSymptoms||r.contextActivity||r.contextNotes?'Edit':'Add')+' Notes/Symptoms</button>';
summaryHTML+='</div>';
// Show saved context if exists
if(r.contextSymptoms&&r.contextSymptoms.length>0){
summaryHTML+='<div style="margin-top:4px;font-size:13px;color:#6b7280"><strong>Symptoms:</strong> '+r.contextSymptoms.join(', ')+'</div>';
}
if(r.contextActivity&&r.contextActivity.length>0){
summaryHTML+='<div style="margin-top:2px;font-size:13px;color:#6b7280"><strong>Context:</strong> '+r.contextActivity.join(', ')+'</div>';
}
if(r.contextNotes){
summaryHTML+='<div style="margin-top:2px;font-size:13px;color:#6b7280"><strong>Notes:</strong> '+r.contextNotes+'</div>';
}
summaryHTML+='</div>';
});
summaryHTML+='</div>';
}
if(outOfRangeDiastolic.length>0){
summaryHTML+='<div style="margin-top:12px;padding:8px;background:#dbeafe;border-radius:6px">';
summaryHTML+='<div style="font-weight:600;color:#1e40af;margin-bottom:6px">üîµ Diastolic Out-of-Range ('+outOfRangeDiastolic.length+' occurrence'+(outOfRangeDiastolic.length>1?'s':'')+'):</div>';
outOfRangeDiastolic.forEach(p=>{
const status=p.value>settings.diastolicMax?'HIGH ('+p.value+')':'LOW ('+p.value+')';
const r=p.reading;
const readingKey='BP_TRACKER_'+r._date;
summaryHTML+='<div style="margin-left:12px;margin-top:8px;padding:8px;background:white;border-radius:4px">';
summaryHTML+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">';
summaryHTML+='<span>‚Ä¢ '+new Date(r._date).toLocaleDateString()+' at '+r.t+' - <strong>'+status+'</strong> mmHg</span>';
summaryHTML+='<button onclick="addContextToReading(\''+readingKey+'\',\''+r.t+'\')" style="background:#3b82f6;color:white;border:none;padding:4px 12px;border-radius:6px;font-size:12px;cursor:pointer;margin-left:8px">üìù '+(r.contextSymptoms||r.contextActivity||r.contextNotes?'Edit':'Add')+' Notes/Symptoms</button>';
summaryHTML+='</div>';
// Show saved context if exists
if(r.contextSymptoms&&r.contextSymptoms.length>0){
summaryHTML+='<div style="margin-top:4px;font-size:13px;color:#6b7280"><strong>Symptoms:</strong> '+r.contextSymptoms.join(', ')+'</div>';
}
if(r.contextActivity&&r.contextActivity.length>0){
summaryHTML+='<div style="margin-top:2px;font-size:13px;color:#6b7280"><strong>Context:</strong> '+r.contextActivity.join(', ')+'</div>';
}
if(r.contextNotes){
summaryHTML+='<div style="margin-top:2px;font-size:13px;color:#6b7280"><strong>Notes:</strong> '+r.contextNotes+'</div>';
}
summaryHTML+='</div>';
});
summaryHTML+='</div>';
}
// Add interpretation guide
summaryHTML+='<div style="margin-top:20px;padding:20px;background:#f0f9ff;border-left:4px solid #3b82f6;border-radius:6px">';
summaryHTML+='<div style="font-weight:700;color:#1e40af;margin-bottom:16px;font-size:22px">üìä How to Interpret These Readings</div>';
summaryHTML+='<div style="line-height:1.8;color:#374151;font-size:18px">';
summaryHTML+='<p style="margin:12px 0;font-size:18px"><strong>This is not medical advice.</strong> These markers indicate readings outside your personal settings range.</p>';
summaryHTML+='<p style="margin:12px 0;font-size:18px"><strong>What to do:</strong></p>';
summaryHTML+='<ul style="margin:12px 0 12px 20px;padding:0;font-size:18px">';
summaryHTML+='<li style="margin:8px 0;font-size:18px">üìù <strong>Add context</strong> - Click "Add Notes/Symptoms" to record what you were feeling or doing</li>';
summaryHTML+='<li style="margin:8px 0;font-size:18px">üîç <strong>Look for patterns</strong> - A few borderline readings are usually not concerning</li>';
summaryHTML+='<li style="margin:8px 0;font-size:18px">üìû <strong>Contact your doctor if:</strong> Readings stay consistently out of range for 2+ weeks, you notice symptoms (dizziness, fatigue, chest discomfort), or you see a worsening trend</li>';
summaryHTML+='<li style="margin:8px 0;font-size:18px">üìã <strong>Share with your doctor</strong> - This data with your notes helps them understand your condition better</li>';
summaryHTML+='</ul>';
summaryHTML+='<p style="margin:16px 0 0 0;font-size:16px;color:#6b7280;font-style:italic">Your cardiologist will interpret these readings in the context of your complete medical history.</p>';
summaryHTML+='</div>';
summaryHTML+='</div>';
summaryHTML+='</div>';
notesDiv.innerHTML=summaryHTML;
notesDiv.style.display='block';
}else{
notesDiv.innerHTML='<div style="color:#065f46;font-weight:600;font-size:14px">‚úì All readings within normal range ('+settings.systolicMin+'-'+settings.systolicMax+'/'+settings.diastolicMin+'-'+settings.diastolicMax+' mmHg)</div>';
notesDiv.style.display='block';
}
}

function renderHRAnalyticsChart(ctx,canvas){
document.getElementById('analyticsChartTitle').textContent='‚ù§Ô∏è Heart Rate Trend & Zones';
const data=currentAnalyticsData.bp.filter(r=>r.h);
const w=canvas._logW||canvas.width;
const h=canvas._logH||canvas.height;
if(data.length===0){
ctx.fillStyle='#6b7280';
ctx.font='18px sans-serif';
ctx.textAlign='center';
ctx.fillText('No heart rate data available',w/2,h/2);
return;
}
const raw=[...data].sort((a,b)=>new Date(a._date+' '+a.t)-new Date(b._date+' '+b.t));
const sorted=lttbDecimate(raw,r=>r.h,canvas._threshold||150);
const pad=80;
const rightPad=40;
const hrs=sorted.map(r=>r.h);
const minHR=Math.max(Math.min(...hrs)-10,30);
const maxHR=Math.min(Math.max(...hrs)+10,200);
const range=maxHR-minHR;
ctx.clearRect(0,0,w,h);
// Draw HR zones
const zones=[
{min:100,max:maxHR,color:'rgba(245,158,11,0.1)',label:'Elevated (>100)'},
{min:60,max:100,color:'rgba(16,185,129,0.1)',label:'Normal (60-100)'},
{min:minHR,max:60,color:'rgba(59,130,246,0.1)',label:'Low (<60)'}
];
zones.forEach(zone=>{
if(zone.max<minHR||zone.min>maxHR)return;
const yTop=pad+((maxHR-Math.min(zone.max,maxHR))/range)*(h-pad-rightPad);
const yBottom=pad+((maxHR-Math.max(zone.min,minHR))/range)*(h-pad-rightPad);
ctx.fillStyle=zone.color;
ctx.fillRect(pad,yTop,w-pad-rightPad,yBottom-yTop);
});
// Draw grid
ctx.strokeStyle='#e5e7eb';
ctx.lineWidth=1;
ctx.fillStyle='#6b7280';
ctx.font='12px sans-serif';
ctx.textAlign='right';
for(let i=0;i<=5;i++){
const value=minHR+i*(range/5);
const y=pad+((maxHR-value)/range)*(h-pad-rightPad);
ctx.beginPath();
ctx.moveTo(pad,y);
ctx.lineTo(w-rightPad,y);
ctx.stroke();
ctx.fillText(value.toFixed(0)+' BPM',pad-10,y+4);
}
// Draw axes
ctx.strokeStyle='#374151';
ctx.lineWidth=2;
ctx.beginPath();
ctx.moveTo(pad,pad);
ctx.lineTo(pad,h-rightPad);
ctx.lineTo(w-rightPad,h-rightPad);
ctx.stroke();
// Calculate points
const xStep=(w-pad-rightPad)/(sorted.length-1||1);
const points=[];
sorted.forEach((r,i)=>{
const x=pad+i*xStep;
const y=pad+((maxHR-r.h)/range)*(h-pad-rightPad);
points.push({x,y,value:r.h,time:r.t,date:r._date,bp:`${r.s}/${r.d}`,reading:r});
});
// Draw line
ctx.strokeStyle='#ec4899';
ctx.lineWidth=3;
ctx.beginPath();
points.forEach((p,i)=>{
if(i===0)ctx.moveTo(p.x,p.y);
else ctx.lineTo(p.x,p.y);
});
ctx.stroke();
// Draw points with color coding and out-of-range detection
var outOfRangeHR=[];
points.forEach(p=>{
const isOutOfRange=p.value<settings.hrMin||p.value>settings.hrMax;
if(isOutOfRange){
outOfRangeHR.push(p);
// Draw larger warning point
ctx.fillStyle='#fbbf24';
ctx.strokeStyle='#dc2626';
ctx.lineWidth=3;
ctx.beginPath();
ctx.arc(p.x,p.y,8,0,2*Math.PI);
ctx.fill();
ctx.stroke();
// Add warning icon
ctx.fillStyle='#dc2626';
ctx.font='bold 12px sans-serif';
ctx.textAlign='center';
ctx.fillText('!',p.x,p.y+4);
}else{
// Normal point - color code by zone
if(p.value<60)ctx.fillStyle='#3b82f6';
else if(p.value>100)ctx.fillStyle='#f59e0b';
else ctx.fillStyle='#10b981';
ctx.beginPath();
ctx.arc(p.x,p.y,5,0,2*Math.PI);
ctx.fill();
}
});
// X-axis labels
ctx.fillStyle='#374151';
ctx.font='11px sans-serif';
ctx.textAlign='center';
[0,Math.floor(sorted.length/2),sorted.length-1].forEach(i=>{
if(i<sorted.length){
const x=pad+i*xStep;
const dateStr=new Date(sorted[i]._date).toLocaleDateString('en-US',{month:'short',day:'numeric'});
ctx.fillText(dateStr,x,h-rightPad+20);
}
});
// Stats summary
const avgHR=(hrs.reduce((sum,h)=>sum+h,0)/hrs.length).toFixed(0);
const minReading=Math.min(...hrs);
const maxReading=Math.max(...hrs);
ctx.fillStyle='#374151';
ctx.font='bold 14px sans-serif';
ctx.textAlign='left';
ctx.fillText(`Avg: ${avgHR} BPM  |  Range: ${minReading}-${maxReading} BPM`,pad,h-rightPad+40);
// Hover interaction
canvas.onmousemove=function(e){
const rect=canvas.getBoundingClientRect();
const mouseX=e.clientX-rect.left;
const mouseY=e.clientY-rect.top;
let hoveredPoint=null;
points.forEach(p=>{
const dist=Math.sqrt(Math.pow(mouseX-p.x,2)+Math.pow(mouseY-p.y,2));
if(dist<10){
hoveredPoint=p;
}
});
if(hoveredPoint){
canvas.style.cursor='pointer';
renderHRAnalyticsChart(ctx,canvas);
// Draw tooltip
const tooltipX=hoveredPoint.x;
const tooltipY=hoveredPoint.y-75;
ctx.fillStyle='rgba(0,0,0,0.9)';
ctx.fillRect(tooltipX-70,tooltipY,140,65);
ctx.fillStyle='#fff';
ctx.font='12px sans-serif';
ctx.textAlign='center';
ctx.fillText(`HR: ${hoveredPoint.value} BPM`,tooltipX,tooltipY+15);
ctx.fillText(`BP: ${hoveredPoint.bp} mmHg`,tooltipX,tooltipY+30);
ctx.fillText(`${new Date(hoveredPoint.date).toLocaleDateString()}`,tooltipX,tooltipY+45);
ctx.fillText(`${hoveredPoint.time}`,tooltipX,tooltipY+60);
}else{
canvas.style.cursor='default';
}
};
canvas.onclick=function(e){
const rect=canvas.getBoundingClientRect();
const mouseX=e.clientX-rect.left;
const mouseY=e.clientY-rect.top;
points.forEach(p=>{
const dist=Math.sqrt(Math.pow(mouseX-p.x,2)+Math.pow(mouseY-p.y,2));
if(dist<10){
const r=p.reading;
let zone='Normal';
if(r.h<60)zone='Low (Bradycardia)';
else if(r.h>100)zone='Elevated (Tachycardia)';
alert(`‚ù§Ô∏è Heart Rate Reading\n\n` +
`Date: ${new Date(r._date).toLocaleDateString()}\n` +
`Time: ${r.t}\n` +
`Heart Rate: ${r.h} BPM\n` +
`Zone: ${zone}\n` +
`Blood Pressure: ${r.s}/${r.d} mmHg`);
}
});
};
// Generate summary of out-of-range HR readings
const notesDiv=document.getElementById('analyticsChartNotes');
if(outOfRangeHR.length>0){
let summaryHTML='<div style="color:#374151;font-size:14px">';
summaryHTML+='<div style="font-weight:700;margin-bottom:8px;color:#dc2626;font-size:16px">‚ö†Ô∏è Out-of-Range Heart Rate Readings Detected</div>';
summaryHTML+='<div style="margin-bottom:4px"><strong>Settings Range:</strong> '+settings.hrMin+'-'+settings.hrMax+' BPM</div>';
summaryHTML+='<div style="margin-top:12px;padding:8px;background:#fee2e2;border-radius:6px">';
summaryHTML+='<div style="font-weight:600;color:#991b1b;margin-bottom:6px">‚ù§Ô∏è Heart Rate Out-of-Range ('+outOfRangeHR.length+' occurrence'+(outOfRangeHR.length>1?'s':'')+'):</div>';
outOfRangeHR.forEach(p=>{
const status=p.value>settings.hrMax?'HIGH ('+p.value+')':'LOW ('+p.value+')';
const r=p.reading;
const readingKey='BP_TRACKER_'+r._date;
summaryHTML+='<div style="margin-left:12px;margin-top:8px;padding:8px;background:white;border-radius:4px">';
summaryHTML+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">';
summaryHTML+='<span>‚Ä¢ '+new Date(r._date).toLocaleDateString()+' at '+r.t+' - <strong>'+status+'</strong> BPM</span>';
summaryHTML+='<button onclick="addContextToReading(\''+readingKey+'\',\''+r.t+'\')" style="background:#3b82f6;color:white;border:none;padding:4px 12px;border-radius:6px;font-size:12px;cursor:pointer;margin-left:8px">üìù '+(r.contextSymptoms||r.contextActivity||r.contextNotes?'Edit':'Add')+' Notes/Symptoms</button>';
summaryHTML+='</div>';
// Show saved context if exists
if(r.contextSymptoms&&r.contextSymptoms.length>0){
summaryHTML+='<div style="margin-top:4px;font-size:13px;color:#6b7280"><strong>Symptoms:</strong> '+r.contextSymptoms.join(', ')+'</div>';
}
if(r.contextActivity&&r.contextActivity.length>0){
summaryHTML+='<div style="margin-top:2px;font-size:13px;color:#6b7280"><strong>Context:</strong> '+r.contextActivity.join(', ')+'</div>';
}
if(r.contextNotes){
summaryHTML+='<div style="margin-top:2px;font-size:13px;color:#6b7280"><strong>Notes:</strong> '+r.contextNotes+'</div>';
}
summaryHTML+='</div>';
});
summaryHTML+='</div>';
// Add interpretation guide
summaryHTML+='<div style="margin-top:20px;padding:20px;background:#f0f9ff;border-left:4px solid #3b82f6;border-radius:6px">';
summaryHTML+='<div style="font-weight:700;color:#1e40af;margin-bottom:16px;font-size:22px">üìä How to Interpret These Readings</div>';
summaryHTML+='<div style="line-height:1.8;color:#374151;font-size:18px">';
summaryHTML+='<p style="margin:12px 0;font-size:18px"><strong>This is not medical advice.</strong> These markers indicate heart rate readings outside your personal settings range.</p>';
summaryHTML+='<p style="margin:12px 0;font-size:18px"><strong>What to do:</strong></p>';
summaryHTML+='<ul style="margin:12px 0 12px 20px;padding:0;font-size:18px">';
summaryHTML+='<li style="margin:8px 0;font-size:18px">üìù <strong>Add context</strong> - Click "Add Notes/Symptoms" to record what you were feeling or doing (e.g., after exercise, feeling anxious, resting)</li>';
summaryHTML+='<li style="margin:8px 0;font-size:18px">üîç <strong>Look for patterns</strong> - Occasional variations are normal, especially with activity or stress</li>';
summaryHTML+='<li style="margin:8px 0;font-size:18px">üìû <strong>Contact your doctor if:</strong> You experience palpitations, dizziness, chest pain, or shortness of breath with abnormal readings</li>';
summaryHTML+='<li style="margin:8px 0;font-size:18px">üìã <strong>Share with your doctor</strong> - Context about activities and symptoms helps them assess significance</li>';
summaryHTML+='</ul>';
summaryHTML+='<p style="margin:16px 0 0 0;font-size:16px;color:#6b7280;font-style:italic">Your cardiologist will interpret these readings in the context of your complete medical history.</p>';
summaryHTML+='</div>';
summaryHTML+='</div>';
summaryHTML+='</div>';
notesDiv.innerHTML=summaryHTML;
notesDiv.style.display='block';
}else{
notesDiv.innerHTML='<div style="color:#065f46;font-weight:600;font-size:14px">‚úì All heart rate readings within normal range ('+settings.hrMin+'-'+settings.hrMax+' BPM)</div>';
notesDiv.style.display='block';
}
}

function renderWeightAnalyticsChart(ctx,canvas){
document.getElementById('analyticsChartTitle').textContent='‚öñÔ∏è Weight Trajectory & Daily Changes';
const data=currentAnalyticsData.weight;
if(data.length===0)return;
const raw=[...data].sort((a,b)=>new Date(a._date)-new Date(b._date));
const sorted=lttbDecimate(raw,r=>r.w,canvas._threshold||150);
const w=canvas._logW||canvas.width;
const h=canvas._logH||canvas.height;
const pad=80;
const rightPad=40;
const weights=sorted.map(r=>r.w);
const minWeight=Math.min(...weights)-2;
const maxWeight=Math.max(...weights)+2;
const range=maxWeight-minWeight;
ctx.clearRect(0,0,w,h);
// Calculate daily changes
const dailyChanges=[];
for(let i=1;i<sorted.length;i++){
dailyChanges.push(sorted[i].w-sorted[i-1].w);
}
// Draw grid
ctx.strokeStyle='#e5e7eb';
ctx.lineWidth=1;
ctx.fillStyle='#6b7280';
ctx.font='12px sans-serif';
ctx.textAlign='right';
for(let i=0;i<=5;i++){
const value=minWeight+i*(range/5);
const y=pad+((maxWeight-value)/range)*(h-pad-rightPad);
ctx.beginPath();
ctx.moveTo(pad,y);
ctx.lineTo(w-rightPad,y);
ctx.stroke();
ctx.fillText(value.toFixed(1)+' lbs',pad-10,y+4);
}
// Draw axes
ctx.strokeStyle='#374151';
ctx.lineWidth=2;
ctx.beginPath();
ctx.moveTo(pad,pad);
ctx.lineTo(pad,h-rightPad);
ctx.lineTo(w-rightPad,h-rightPad);
ctx.stroke();
// Calculate points
const xStep=(w-pad-rightPad)/(sorted.length-1||1);
const points=[];
sorted.forEach((r,i)=>{
const x=pad+i*xStep;
const y=pad+((maxWeight-r.w)/range)*(h-pad-rightPad);
const change=i>0?(r.w-sorted[i-1].w):0;
points.push({x,y,value:r.w,date:r._date,time:r.time||'',change,reading:r});
});
// Draw weight line
ctx.strokeStyle='#f97316';
ctx.lineWidth=3;
ctx.beginPath();
points.forEach((p,i)=>{
if(i===0)ctx.moveTo(p.x,p.y);
else ctx.lineTo(p.x,p.y);
});
ctx.stroke();
// Draw points with color based on change
points.forEach((p,i)=>{
if(i===0)ctx.fillStyle='#6b7280';
else if(p.change>0.5)ctx.fillStyle='#ef4444';
else if(p.change<-0.5)ctx.fillStyle='#10b981';
else ctx.fillStyle='#f97316';
ctx.beginPath();
ctx.arc(p.x,p.y,6,0,2*Math.PI);
ctx.fill();
});
// Trend line
let sumX=0,sumY=0,sumXY=0,sumX2=0;
for(let i=0;i<sorted.length;i++){
sumX+=i;
sumY+=sorted[i].w;
sumXY+=i*sorted[i].w;
sumX2+=i*i;
}
const n=sorted.length;
const slope=(n*sumXY-sumX*sumY)/(n*sumX2-sumX*sumX);
const intercept=(sumY-slope*sumX)/n;
ctx.strokeStyle='#3b82f6';
ctx.lineWidth=2;
ctx.setLineDash([5,5]);
ctx.beginPath();
const trendY1=intercept;
const trendY2=slope*(n-1)+intercept;
const y1=pad+((maxWeight-trendY1)/range)*(h-pad-rightPad);
const y2=pad+((maxWeight-trendY2)/range)*(h-pad-rightPad);
ctx.moveTo(pad,y1);
ctx.lineTo(w-rightPad,y2);
ctx.stroke();
ctx.setLineDash([]);
// X-axis labels ‚Äî show every Nth point to avoid crowding
ctx.fillStyle='#374151';
ctx.font='11px sans-serif';
ctx.textAlign='center';
const labelInterval=Math.max(1,Math.ceil(sorted.length/20));
sorted.forEach((r,i)=>{
if(i%labelInterval!==0&&i!==sorted.length-1)return;
const x=pad+i*xStep;
const dateStr=new Date(r._date).toLocaleDateString('en-US',{month:'short',day:'numeric'});
ctx.save();
ctx.translate(x,h-rightPad+10);
ctx.rotate(-Math.PI/4);
ctx.fillText(dateStr,0,0);
ctx.restore();
});
// Stats summary
const totalChange=sorted[sorted.length-1].w-sorted[0].w;
const trendText=totalChange>0?'‚Üë Gaining':'‚Üì Losing';
const trendColor=totalChange>0?'#ef4444':'#10b981';
ctx.fillStyle=trendColor;
ctx.font='bold 14px sans-serif';
ctx.textAlign='left';
ctx.fillText(`${trendText}: ${Math.abs(totalChange).toFixed(1)} lbs over ${sorted.length} days`,pad,h-rightPad+40);
// Legend
ctx.fillStyle='#6b7280';
ctx.font='12px sans-serif';
ctx.textAlign='right';
ctx.fillText('üî¥ Gain  üü¢ Loss  üü† Stable',w-rightPad,25);
// Hover interaction
canvas.onmousemove=function(e){
const rect=canvas.getBoundingClientRect();
const mouseX=e.clientX-rect.left;
const mouseY=e.clientY-rect.top;
let hoveredPoint=null;
points.forEach(p=>{
const dist=Math.sqrt(Math.pow(mouseX-p.x,2)+Math.pow(mouseY-p.y,2));
if(dist<10){
hoveredPoint=p;
}
});
if(hoveredPoint){
canvas.style.cursor='pointer';
renderWeightAnalyticsChart(ctx,canvas);
// Draw tooltip
const tooltipX=hoveredPoint.x;
const tooltipY=hoveredPoint.y-80;
const changeText=hoveredPoint.change>0?`+${hoveredPoint.change.toFixed(1)}`:hoveredPoint.change.toFixed(1);
ctx.fillStyle='rgba(0,0,0,0.9)';
ctx.fillRect(tooltipX-75,tooltipY,150,75);
ctx.fillStyle='#fff';
ctx.font='12px sans-serif';
ctx.textAlign='center';
ctx.fillText(`Weight: ${hoveredPoint.value.toFixed(1)} lbs`,tooltipX,tooltipY+15);
if(hoveredPoint.change!==0){
ctx.fillText(`Change: ${changeText} lbs`,tooltipX,tooltipY+30);
}
ctx.fillText(`${new Date(hoveredPoint.date).toLocaleDateString()}`,tooltipX,tooltipY+50);
if(hoveredPoint.time){
ctx.fillText(`${hoveredPoint.time}`,tooltipX,tooltipY+65);
}
}else{
canvas.style.cursor='default';
}
};
canvas.onclick=function(e){
const rect=canvas.getBoundingClientRect();
const mouseX=e.clientX-rect.left;
const mouseY=e.clientY-rect.top;
points.forEach(p=>{
const dist=Math.sqrt(Math.pow(mouseX-p.x,2)+Math.pow(mouseY-p.y,2));
if(dist<10){
const changeText=p.change>0?`+${p.change.toFixed(1)}`:p.change<0?p.change.toFixed(1):'No change';
alert(`‚öñÔ∏è Weight Reading\n\n` +
`Date: ${new Date(p.date).toLocaleDateString()}\n` +
`Weight: ${p.value.toFixed(1)} lbs\n` +
`Daily Change: ${changeText} lbs`);
}
});
};
}

function renderActivityAnalyticsChart(ctx,canvas){
document.getElementById('analyticsChartTitle').textContent='üèÉ Activity Duration & Consistency';
const data=currentAnalyticsData.activities;
if(data.length===0)return;
// Group by date
const byDate={};
data.forEach(a=>{
if(!byDate[a._date]){
byDate[a._date]={total:0,activities:[],types:{}};
}
byDate[a._date].total+=a.duration;
byDate[a._date].activities.push(a);
const actType=a.activity||a.type||'Exercise';
byDate[a._date].types[actType]=(byDate[a._date].types[actType]||0)+a.duration;
});
const dates=Object.keys(byDate).sort();
const w=canvas._logW||canvas.width;
const h=canvas._logH||canvas.height;
const pad=80;
const rightPad=40;
const maxDuration=Math.max(...dates.map(d=>byDate[d].total))+10;
ctx.clearRect(0,0,w,h);
// Draw grid
ctx.strokeStyle='#e5e7eb';
ctx.lineWidth=1;
ctx.fillStyle='#6b7280';
ctx.font='12px sans-serif';
ctx.textAlign='right';
for(let i=0;i<=5;i++){
const value=i*(maxDuration/5);
const y=pad+i*(h-pad-rightPad)/5;
ctx.beginPath();
ctx.moveTo(pad,y);
ctx.lineTo(w-rightPad,y);
ctx.stroke();
ctx.fillText(value.toFixed(0)+' min',pad-10,y+4);
}
// Draw axes
ctx.strokeStyle='#374151';
ctx.lineWidth=2;
ctx.beginPath();
ctx.moveTo(pad,pad);
ctx.lineTo(pad,h-rightPad);
ctx.lineTo(w-rightPad,h-rightPad);
ctx.stroke();
// Draw bars
const barWidth=Math.min((w-pad-rightPad)/dates.length*0.7,50);
const barGap=(w-pad-rightPad)/dates.length*0.3;
const bars=[];
dates.forEach((date,i)=>{
const x=pad+i*((w-pad-rightPad)/dates.length)+(barGap/2);
const duration=byDate[date].total;
const barHeight=(duration/maxDuration)*(h-pad-rightPad);
const y=(h-rightPad)-barHeight;
// Color based on duration
let color='#14b8a6';
if(duration>=45)color='#10b981';
else if(duration>=30)color='#14b8a6';
else if(duration>=15)color='#f59e0b';
else color='#ef4444';
ctx.fillStyle=color;
ctx.fillRect(x,y,barWidth,barHeight);
bars.push({x,y,width:barWidth,height:barHeight,date,duration,activities:byDate[date].activities,types:byDate[date].types});
// Value label on bar
ctx.fillStyle='#374151';
ctx.font='bold 12px sans-serif';
ctx.textAlign='center';
ctx.fillText(duration.toFixed(0),x+barWidth/2,y-5);
});
// X-axis date labels
ctx.fillStyle='#374151';
ctx.font='10px sans-serif';
ctx.textAlign='center';
dates.forEach((date,i)=>{
const x=pad+i*((w-pad-rightPad)/dates.length)+(barGap/2)+barWidth/2;
const dateStr=new Date(date).toLocaleDateString('en-US',{month:'short',day:'numeric'});
ctx.save();
ctx.translate(x,h-rightPad+15);
ctx.rotate(-Math.PI/4);
ctx.fillText(dateStr,0,0);
ctx.restore();
});
// Summary stats
const totalMinutes=dates.reduce((sum,d)=>sum+byDate[d].total,0);
const avgPerDay=(totalMinutes/dates.length).toFixed(0);
ctx.fillStyle='#374151';
ctx.font='bold 14px sans-serif';
ctx.textAlign='left';
ctx.fillText(`Total: ${totalMinutes} min  |  Avg: ${avgPerDay} min/day  |  ${dates.length} active days`,pad,h-rightPad+50);
// Legend
ctx.font='12px sans-serif';
ctx.textAlign='right';
ctx.fillText('üü¢ 45+ min  üîµ 30+ min  üü† 15+ min  üî¥ <15 min',w-rightPad,25);
// Hover interaction
canvas.onmousemove=function(e){
const rect=canvas.getBoundingClientRect();
const mouseX=e.clientX-rect.left;
const mouseY=e.clientY-rect.top;
let hoveredBar=null;
bars.forEach(bar=>{
if(mouseX>=bar.x&&mouseX<=bar.x+bar.width&&mouseY>=bar.y&&mouseY<=bar.y+bar.height){
hoveredBar=bar;
}
});
if(hoveredBar){
canvas.style.cursor='pointer';
renderActivityAnalyticsChart(ctx,canvas);
// Draw tooltip
const tooltipX=hoveredBar.x+hoveredBar.width/2;
const tooltipY=hoveredBar.y-85;
const activityList=Object.entries(hoveredBar.types).map(([type,dur])=>`${type}: ${dur} min`).join('\n');
const lines=[
`${new Date(hoveredBar.date).toLocaleDateString()}`,
`Total: ${hoveredBar.duration} min`,
`${hoveredBar.activities.length} activity/ies`
];
ctx.fillStyle='rgba(0,0,0,0.9)';
ctx.fillRect(tooltipX-80,tooltipY,160,lines.length*18+10);
ctx.fillStyle='#fff';
ctx.font='12px sans-serif';
ctx.textAlign='center';
lines.forEach((line,i)=>{
ctx.fillText(line,tooltipX,tooltipY+18+i*18);
});
}else{
canvas.style.cursor='default';
}
};
canvas.onclick=function(e){
const rect=canvas.getBoundingClientRect();
const mouseX=e.clientX-rect.left;
const mouseY=e.clientY-rect.top;
bars.forEach(bar=>{
if(mouseX>=bar.x&&mouseX<=bar.x+bar.width&&mouseY>=bar.y&&mouseY<=bar.y+bar.height){
const activityDetails=bar.activities.map(a=>{
const actName=a.activity||a.type||'Exercise';
return `  ‚Ä¢ ${actName}: ${a.duration} min (${a.exertion||'N/A'})`;
}).join('\n');
alert(`üèÉ Activity Summary\n\n` +
`Date: ${new Date(bar.date).toLocaleDateString()}\n` +
`Total Duration: ${bar.duration} minutes\n` +
`Number of Activities: ${bar.activities.length}\n\n` +
`Activities:\n${activityDetails}`);
}
});
};
}

// ============================================================================
// END OF PHASE 3: ADVANCED ANALYTICS DASHBOARD
// ============================================================================

loadSettings();
loadMedicineList();
loadDailyData();
loadProcedures();
loadPlan();
applyFeatureVisibility();
showMeals();showBP();showWeight();showSymptoms();showActivities();updateFluid();showMedicines();showNotes();showProcedures();renderWeightChart();renderSymptomChart();renderActivityChart();renderBPChart();renderRateDetector();showTodayZone();

// Phase 6C: Initialize Smart Reminder System
initReminderSystem();

// Midnight Auto-Refresh System (v7.1)
// Checks every minute if the date has changed, and refreshes displays automatically
var currentDate=new Date().toDateString();
setInterval(function(){
var newDate=new Date().toDateString();
if(newDate!==currentDate){
console.log('Date changed from',currentDate,'to',newDate,'- refreshing displays');
currentDate=newDate;
// Reset daily data for new day
M=[];
B=[];
W=[];
S=[];
A=[];
fluidLog=[];
medLog=[];
notes=[];
dailyFluid=0;
exportedToday=false;
dismissedEvents=[];
firedEvents={};
// Phase 6C: Reset fired reminders for new day
firedReminders={};
loadFiredReminders();
// Clear daily plan completion status
if(dailyPlan&&dailyPlan.length>0){
dailyPlan.forEach(function(event){
event.completed=false;
});
savePlan();
}
// Refresh all displays
refreshAllDisplays();
updateFluid();
updateNextEvent();
updateUpcomingEventsWidget();
renderBPChart();
renderFluidChart();
console.log('New day started - all displays refreshed');
}
},60000); // Check every minute

// ================== PHASE 5: ENHANCED PDF REPORTS ==================
// Report configuration and generation for professional medical reports

function openReportConfig(){
const range=getAnalyticsDateRange();
if(!range){
alert('Please select a date range first!');
return;
}
const{startDate,endDate}=range;
const data=getAllHistoricalData(startDate,endDate);
if(data.bp.length===0){
alert('No data available for the selected period. Please track some readings first!');
return;
}
// Build configuration modal
let html='<div style="background:white;padding:24px;border-radius:12px;max-width:600px;margin:40px auto">';
html+='<h2 style="font-size:28px;font-weight:700;color:#111827;margin-bottom:8px">üìÑ Generate PDF Report</h2>';
html+='<p style="color:#6b7280;margin-bottom:24px">Select which sections to include in your medical report</p>';
// Patient Info Section
html+='<div style="margin-bottom:24px;padding:16px;background:#f0fdf4;border-left:4px solid #10b981;border-radius:8px">';
html+='<div style="font-weight:600;color:#065f46;margin-bottom:8px">üìã Patient Information</div>';
html+='<div style="font-size:14px;color:#047857">Name: '+(settings.patientName||'Not set - Update in Settings')+'</div>';
html+='<div style="font-size:14px;color:#047857">Period: '+startDate.toLocaleDateString()+' to '+endDate.toLocaleDateString()+'</div>';
html+='</div>';
// Section Toggles
html+='<div style="margin-bottom:24px">';
html+='<div style="font-weight:600;margin-bottom:12px;color:#111827">Report Sections:</div>';
const sections=[
{id:'summary',label:'Executive Summary',desc:'Overview of health metrics',enabled:true},
{id:'statistics',label:'Statistics Tables',desc:'Detailed numerical data',enabled:true},
{id:'trends',label:'Trend Analysis',desc:'BP, HR, Weight trends over time',enabled:true},
{id:'charts',label:'Visual Charts',desc:'Graphical representation of data',enabled:true},
{id:'correlation',label:'Symptom-Activity Correlation',desc:'Relationships between symptoms and activities',enabled:settings.features.symptoms&&settings.features.exercise},
{id:'medication',label:'Medication Adherence',desc:'Compliance tracking for prescribed medications',enabled:true},
{id:'recommendations',label:'Health Recommendations',desc:'AI-generated insights and suggestions',enabled:true},
{id:'notes',label:'Doctor\'s Notes Section',desc:'Blank space for physician annotations',enabled:true}
];
sections.forEach(function(section){
if(!section.enabled)return;
html+='<label style="display:flex;align-items:center;padding:12px;background:#f9fafb;border:2px solid #e5e7eb;border-radius:8px;margin-bottom:8px;cursor:pointer">';
html+='<input type="checkbox" class="report-section-check" value="'+section.id+'" checked style="width:20px;height:20px;margin-right:12px;cursor:pointer">';
html+='<div style="flex:1">';
html+='<div style="font-weight:600;color:#111827">'+section.label+'</div>';
html+='<div style="font-size:13px;color:#6b7280">'+section.desc+'</div>';
html+='</div>';
html+='</label>';
});
html+='</div>';
// Action Buttons
html+='<div style="display:flex;gap:12px">';
html+='<button onclick="hideModal()" style="flex:1;padding:12px 24px;background:#6b7280;color:white;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer">Cancel</button>';
html+='<button onclick="generatePDFReport()" style="flex:1;padding:12px 24px;background:#10b981;color:white;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer">üìÑ Generate Report</button>';
html+='</div>';
html+='</div>';
showModal(html);
}

function generatePDFReport(){
// Get selected sections
const checkboxes=document.querySelectorAll('.report-section-check:checked');
const selectedSections=Array.from(checkboxes).map(cb=>cb.value);
if(selectedSections.length===0){
alert('Please select at least one section to include in the report.');
return;
}
// Get data
const range=getAnalyticsDateRange();
const{startDate,endDate}=range;
const data=getAllHistoricalData(startDate,endDate);
hideModal();
// Generate report HTML
const reportHTML=createReportHTML(data,startDate,endDate,selectedSections);
// Open in new window for printing
const printWindow=window.open('','_blank','width=800,height=600');
printWindow.document.write(reportHTML);
printWindow.document.close();
// Auto-print dialog after load
setTimeout(function(){
printWindow.focus();
printWindow.print();
},500);
}

function createReportHTML(data,startDate,endDate,sections){
const patientName=settings.patientName||'Patient Name Not Set';
let html='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Blood Pressure Medical Report</title>';
html+='<style>';
html+='@media print{@page{size:letter;margin:0.5in}}';
html+='body{font-family:Arial,sans-serif;line-height:1.5;color:#111827;margin:0;padding:0}';
html+='.page{page-break-after:always;padding:40px}';
html+='.no-break{page-break-inside:avoid}';
html+='.header{border-bottom:3px solid #10b981;padding-bottom:16px;margin-bottom:24px}';
html+='.logo{font-size:24px;font-weight:700;color:#10b981;margin-bottom:8px}';
html+='.report-title{font-size:20px;font-weight:600;color:#374151}';
html+='.patient-info{background:#f3f4f6;padding:16px;border-radius:8px;margin-bottom:24px}';
html+='.section-title{font-size:18px;font-weight:700;color:#111827;border-bottom:2px solid #e5e7eb;padding-bottom:8px;margin:24px 0 16px 0}';
html+='table{width:100%;border-collapse:collapse;margin:16px 0}';
html+='th,td{border:1px solid #d1d5db;padding:8px;text-align:left}';
html+='th{background:#f3f4f6;font-weight:600}';
html+='.metric-value{font-size:20px;font-weight:700;color:#10b981}';
html+='.alert{background:#fee2e2;border-left:4px solid #ef4444;padding:12px;margin:8px 0}';
html+='.normal{background:#d1fae5;border-left:4px solid #10b981;padding:12px;margin:8px 0}';
html+='.notes-section{border:1px solid #d1d5db;min-height:150px;padding:16px;margin:16px 0}';
html+='</style></head><body>';
// Header on first page
html+='<div class="page">';
html+=createReportHeader(patientName,startDate,endDate);
// Add selected sections
if(sections.indexOf('summary')!==-1){
html+=createSummarySection(data,startDate,endDate);
}
if(sections.indexOf('statistics')!==-1){
html+=createStatisticsSection(data);
}
if(sections.indexOf('trends')!==-1){
html+=createTrendsSection(data);
}
html+='</div>'; // End first page
// Continue with more sections on new pages if needed
if(sections.indexOf('charts')!==-1||sections.indexOf('correlation')!==-1||sections.indexOf('medication')!==-1){
html+='<div class="page">';
html+=createReportHeader(patientName,startDate,endDate);
if(sections.indexOf('charts')!==-1){
html+=createChartsSection(data);
}
if(sections.indexOf('correlation')!==-1){
html+=createCorrelationSection(data);
}
if(sections.indexOf('medication')!==-1){
html+=createMedicationSection(data);
}
if(data.procedures&&data.procedures.length>0){
html+=createProceduresSection(data);
}
html+='</div>';
}
// Final page with recommendations and notes
if(sections.indexOf('recommendations')!==-1||sections.indexOf('notes')!==-1){
html+='<div class="page">';
html+=createReportHeader(patientName,startDate,endDate);
if(sections.indexOf('recommendations')!==-1){
html+=createRecommendationsSection(data);
}
if(sections.indexOf('notes')!==-1){
html+=createDoctorNotesSection();
}
html+='</div>';
}
html+='</body></html>';
return html;
}

function createReportHeader(patientName,startDate,endDate){
let html='<div class="header">';
html+='<div class="logo">üìä ClinBridge - Medical Report</div>';
html+='<div class="report-title">Blood Pressure & Health Monitoring Report</div>';
html+='</div>';
html+='<div class="patient-info">';
html+='<table style="border:none"><tr><td style="border:none;padding:4px"><strong>Patient:</strong> '+patientName+'</td>';
html+='<td style="border:none;padding:4px"><strong>Report Period:</strong> '+startDate.toLocaleDateString()+' to '+endDate.toLocaleDateString()+'</td></tr>';
html+='<tr><td style="border:none;padding:4px"><strong>Generated:</strong> '+new Date().toLocaleDateString()+' '+new Date().toLocaleTimeString()+'</td>';
html+='<td style="border:none;padding:4px"><strong>Days Analyzed:</strong> '+( Math.floor((endDate-startDate)/(1000*60*60*24))+1 )+'</td></tr></table>';
html+='</div>';
return html;
}

function createSummarySection(data,startDate,endDate){
const avgSys=data.bp.length>0?data.bp.reduce((sum,r)=>sum+r.s,0)/data.bp.length:0;
const avgDia=data.bp.length>0?data.bp.reduce((sum,r)=>sum+r.d,0)/data.bp.length:0;
const avgHR=data.bp.filter(r=>r.h).length>0?data.bp.filter(r=>r.h).reduce((sum,r)=>sum+r.h,0)/data.bp.filter(r=>r.h).length:0;
let html='<div class="no-break">';
html+='<div class="section-title">üìã Executive Summary</div>';
html+='<table><tr>';
html+='<th>Metric</th><th>Value</th><th>Status</th></tr>';
html+='<tr><td>Total BP Readings</td><td class="metric-value">'+data.bp.length+'</td><td>Data collected</td></tr>';
html+='<tr><td>Average Blood Pressure</td><td class="metric-value">'+avgSys.toFixed(0)+'/'+avgDia.toFixed(0)+' mmHg</td>';
html+='<td>'+(avgSys>140||avgDia>90?'<span style="color:#ef4444">‚ö†Ô∏è Elevated</span>':'<span style="color:#10b981">‚úì Normal</span>')+'</td></tr>';
if(avgHR>0){
html+='<tr><td>Average Heart Rate</td><td class="metric-value">'+avgHR.toFixed(0)+' BPM</td>';
html+='<td>'+(avgHR>100||avgHR<60?'<span style="color:#f59e0b">‚ö†Ô∏è Monitor</span>':'<span style="color:#10b981">‚úì Normal</span>')+'</td></tr>';
}
if(data.weight.length>0){
const latestWeight=data.weight[data.weight.length-1].w;
html+='<tr><td>Current Weight</td><td class="metric-value">'+latestWeight.toFixed(1)+' lbs</td><td>Tracked</td></tr>';
}
html+='<tr><td>Medication Doses Logged</td><td class="metric-value">'+data.medications.length+'</td><td>Adherence monitored</td></tr>';
html+='</table>';
html+='</div>';
return html;
}

function createStatisticsSection(data){
// Calculate detailed statistics
const systolic=data.bp.map(r=>r.s);
const diastolic=data.bp.map(r=>r.d);
const heartRates=data.bp.filter(r=>r.h).map(r=>r.h);
let html='<div class="no-break">';
html+='<div class="section-title">üìä Detailed Statistics</div>';
html+='<table>';
html+='<tr><th>Parameter</th><th>Minimum</th><th>Maximum</th><th>Average</th><th>Std Dev</th></tr>';
// Systolic
const sysAvg=(systolic.reduce((a,b)=>a+b,0)/systolic.length).toFixed(1);
const sysStd=Math.sqrt(systolic.map(x=>Math.pow(x-sysAvg,2)).reduce((a,b)=>a+b)/systolic.length).toFixed(1);
html+='<tr><td>Systolic BP</td><td>'+Math.min(...systolic)+'</td><td>'+Math.max(...systolic)+'</td><td>'+sysAvg+'</td><td>'+sysStd+'</td></tr>';
// Diastolic
const diaAvg=(diastolic.reduce((a,b)=>a+b,0)/diastolic.length).toFixed(1);
const diaStd=Math.sqrt(diastolic.map(x=>Math.pow(x-diaAvg,2)).reduce((a,b)=>a+b)/diastolic.length).toFixed(1);
html+='<tr><td>Diastolic BP</td><td>'+Math.min(...diastolic)+'</td><td>'+Math.max(...diastolic)+'</td><td>'+diaAvg+'</td><td>'+diaStd+'</td></tr>';
// Heart Rate
if(heartRates.length>0){
const hrAvg=(heartRates.reduce((a,b)=>a+b,0)/heartRates.length).toFixed(1);
const hrStd=Math.sqrt(heartRates.map(x=>Math.pow(x-hrAvg,2)).reduce((a,b)=>a+b)/heartRates.length).toFixed(1);
html+='<tr><td>Heart Rate</td><td>'+Math.min(...heartRates)+'</td><td>'+Math.max(...heartRates)+'</td><td>'+hrAvg+'</td><td>'+hrStd+'</td></tr>';
}
html+='</table>';
html+='</div>';
return html;
}

function createTrendsSection(data){
let html='<div class="no-break">';
html+='<div class="section-title">üìà Trend Analysis</div>';
// BP Trend
const firstHalf=data.bp.slice(0,Math.floor(data.bp.length/2));
const secondHalf=data.bp.slice(Math.floor(data.bp.length/2));
if(firstHalf.length>0&&secondHalf.length>0){
const firstAvgSys=firstHalf.reduce((sum,r)=>sum+r.s,0)/firstHalf.length;
const secondAvgSys=secondHalf.reduce((sum,r)=>sum+r.s,0)/secondHalf.length;
const change=secondAvgSys-firstAvgSys;
html+='<div style="margin:16px 0">';
html+='<strong>Blood Pressure Trend:</strong> ';
if(Math.abs(change)<2){
html+='<span style="color:#10b981">‚úì Stable</span> (¬±'+Math.abs(change).toFixed(1)+' mmHg)';
}else if(change>0){
html+='<span style="color:#ef4444">‚ö†Ô∏è Increasing</span> (+'+change.toFixed(1)+' mmHg)';
}else{
html+='<span style="color:#10b981">‚úì Decreasing</span> ('+change.toFixed(1)+' mmHg)';
}
html+='</div>';
}
// Weight Trend
if(data.weight.length>=2){
const firstWeight=data.weight[0].w;
const lastWeight=data.weight[data.weight.length-1].w;
const weightChange=lastWeight-firstWeight;
html+='<div style="margin:16px 0">';
html+='<strong>Weight Trend:</strong> ';
if(Math.abs(weightChange)<1){
html+='<span style="color:#10b981">‚úì Stable</span> (¬±'+Math.abs(weightChange).toFixed(1)+' lbs)';
}else if(weightChange>0){
html+='<span style="color:#f59e0b">Gained</span> (+'+weightChange.toFixed(1)+' lbs)';
}else{
html+='<span style="color:#10b981">Lost</span> ('+Math.abs(weightChange).toFixed(1)+' lbs)';
}
html+='</div>';
}
html+='</div>';
return html;
}

function createChartsSection(data){
let html='<div class="no-break">';
html+='<div class="section-title">üìâ Visual Data Representation</div>';
html+='<p><em>Note: Interactive charts can be accessed in the digital Analytics Dashboard. This report includes statistical summaries.</em></p>';
// Reading frequency
html+='<div style="margin:16px 0">';
html+='<strong>Reading Frequency:</strong><br>';
const dateCount=new Set(data.bp.map(r=>r._date)).size;
html+='Average readings per day: '+(data.bp.length/dateCount).toFixed(1)+'<br>';
html+='Total tracking days: '+dateCount;
html+='</div>';
html+='</div>';
return html;
}

function createCorrelationSection(data){
let html='<div class="no-break">';
html+='<div class="section-title">üîó Symptom-Activity Correlation</div>';
if(data.symptoms.length===0&&data.activities.length===0){
html+='<p><em>No symptom or activity data available for correlation analysis.</em></p>';
}else{
html+='<p><strong>Symptoms Logged:</strong> '+data.symptoms.length+'</p>';
html+='<p><strong>Activities Logged:</strong> '+data.activities.length+'</p>';
if(data.symptoms.length>0&&data.activities.length>0){
html+='<p><em>Correlation analysis suggests reviewing symptom patterns in relation to physical activity levels. Consult with your healthcare provider to interpret these relationships.</em></p>';
}
}
html+='</div>';
return html;
}

function createMedicationSection(data){
let html='<div class="no-break">';
html+='<div class="section-title">üíä Medication Adherence</div>';
if(data.medications.length===0){
html+='<p><em>No medication doses logged during this period.</em></p>';
}else{
const totalDoses=data.medications.length;
const uniqueDays=new Set(data.medications.map(m=>m._date)).size;
const avgPerDay=(totalDoses/uniqueDays).toFixed(1);
html+='<table>';
html+='<tr><th>Metric</th><th>Value</th></tr>';
html+='<tr><td>Total Doses Logged</td><td>'+totalDoses+'</td></tr>';
html+='<tr><td>Days with Medication</td><td>'+uniqueDays+'</td></tr>';
html+='<tr><td>Average Doses/Day</td><td>'+avgPerDay+'</td></tr>';
html+='</table>';
html+='<p style="margin-top:12px"><em>Note: Review with your healthcare provider to ensure all prescribed medications are being taken as directed.</em></p>';
}
html+='</div>';
return html;
}

function createProceduresSection(data){
let html='<div class="no-break">';
html+='<div class="section-title">üè• Medical Procedures</div>';
if(!data.procedures||data.procedures.length===0){
html+='<p><em>No medical procedures logged during this period.</em></p>';
}else{
html+='<p><strong>Total Procedures:</strong> '+data.procedures.length+'</p>';
html+='<table>';
html+='<tr><th>Date</th><th>Procedure</th><th>Category</th><th>Facility</th><th>Physician</th><th>Notes</th></tr>';
data.procedures.forEach(proc=>{
const procDate=new Date(proc.timestamp);
const dateStr=procDate.toLocaleDateString();
html+='<tr>';
html+='<td>'+dateStr+'</td>';
html+='<td><strong>'+proc.name+'</strong></td>';
html+='<td>'+(proc.category||'-')+'</td>';
html+='<td>'+(proc.facility||'-')+'</td>';
html+='<td>'+(proc.physician||'-')+'</td>';
html+='<td>'+(proc.notes||'-')+'</td>';
html+='</tr>';
});
html+='</table>';
html+='<p style="margin-top:12px"><em>Note: Medical procedures may affect blood pressure readings, medication requirements, and overall treatment plan.</em></p>';
}
html+='</div>';
return html;
}

function createRecommendationsSection(data){
let html='<div class="no-break">';
html+='<div class="section-title">üéØ Health Recommendations</div>';
const avgSys=data.bp.reduce((sum,r)=>sum+r.s,0)/data.bp.length;
const avgDia=data.bp.reduce((sum,r)=>sum+r.d,0)/data.bp.length;
html+='<ul style="line-height:1.8">';
if(avgSys>140||avgDia>90){
html+='<li><strong>Blood Pressure:</strong> Readings indicate elevated blood pressure. Consult with your healthcare provider about management strategies.</li>';
}
if(data.bp.length<14){
html+='<li><strong>Monitoring Frequency:</strong> Consider increasing reading frequency to at least twice daily for better tracking.</li>';
}
if(data.weight.length>0){
html+='<li><strong>Weight Monitoring:</strong> Continue regular weight tracking as it relates to cardiovascular health.</li>';
}
if(data.medications.length>0){
html+='<li><strong>Medication Adherence:</strong> Maintain consistent medication logging to help track compliance.</li>';
}
html+='<li><strong>Lifestyle:</strong> Continue monitoring diet, exercise, and stress levels as they impact cardiovascular health.</li>';
html+='<li><strong>Follow-up:</strong> Share this report with your healthcare provider during your next visit.</li>';
html+='</ul>';
html+='</div>';
return html;
}

function createDoctorNotesSection(){
let html='<div class="no-break">';
html+='<div class="section-title">ü©∫ Physician Notes & Observations</div>';
html+='<div class="notes-section">';
html+='<p style="color:#9ca3af;font-style:italic">Space reserved for healthcare provider notes, observations, and recommendations...</p>';
html+='</div>';
html+='<div style="margin-top:40px;border-top:1px solid #d1d5db;padding-top:20px">';
html+='<div style="display:flex;justify-content:space-between">';
html+='<div>Physician Signature: _______________________</div>';
html+='<div>Date: _______________________</div>';
html+='</div>';
html+='</div>';
html+='</div>';
return html;
}

// ============================================
// DOCTOR APPOINTMENTS SYSTEM
// ============================================

var appointments = [];

// Load appointments from localStorage
function loadAppointments() {
    var saved = localStorage.getItem('cardiacAppointments');
    if (saved) {
        try {
            appointments = JSON.parse(saved);
            updateRecentAppointmentWidget();
            checkAppointmentReminders();
        } catch (e) {
            appointments = [];
        }
    }
}

// Save appointments to localStorage
function saveAppointmentsToStorage() {
    localStorage.setItem('cardiacAppointments', JSON.stringify(appointments));
    updateRecentAppointmentWidget();
}

// Open appointment modal
function openAppointmentModal(editId = null) {
    // Close the appointments list modal if it's open (prevents z-index issues)
    closeAppointmentsListModal();
    
    document.getElementById('appointmentModal').style.display = 'flex';
    
    if (editId) {
        // Edit mode
        var appt = appointments.find(a => a.id === editId);
        if (appt) {
            document.getElementById('appointmentModalTitle').textContent = '‚úèÔ∏è Edit Doctor Appointment';
            document.getElementById('appointmentDate').value = appt.date;
            document.getElementById('appointmentTime').value = appt.time || '';
            document.getElementById('appointmentReminder').value = appt.reminder || 'none';
            document.getElementById('doctorName').value = appt.doctorName || '';
            document.getElementById('appointmentReason').value = appt.reason || '';
            document.getElementById('appointmentQuestions').value = appt.questions || '';
            document.getElementById('doctorNotes').value = appt.doctorNotes || '';
            document.getElementById('prescriptionsGiven').value = appt.prescriptions || '';
            document.getElementById('testsOrdered').value = appt.tests || '';
            document.getElementById('appointmentEditId').value = editId;
        }
    } else {
        // New appointment mode
        document.getElementById('appointmentModalTitle').textContent = 'ü©∫ Log Doctor Appointment';
        document.getElementById('appointmentDate').value = '';
        document.getElementById('appointmentTime').value = '';
        document.getElementById('appointmentReminder').value = 'none';
        document.getElementById('doctorName').value = '';
        document.getElementById('appointmentReason').value = '';
        document.getElementById('appointmentQuestions').value = '';
        document.getElementById('doctorNotes').value = '';
        document.getElementById('prescriptionsGiven').value = '';
        document.getElementById('testsOrdered').value = '';
        document.getElementById('appointmentEditId').value = '';
    }
}

// Close appointment modal
function closeAppointmentModal() {
    document.getElementById('appointmentModal').style.display = 'none';
}

// Save appointment
function saveAppointment() {
    var date = document.getElementById('appointmentDate').value;
    var reason = document.getElementById('appointmentReason').value.trim();
    
    if (!date) {
        alert('‚ö†Ô∏è Please enter an appointment date');
        return;
    }
    
    if (!reason) {
        alert('‚ö†Ô∏è Please enter a reason for the visit');
        return;
    }
    
    var editId = document.getElementById('appointmentEditId').value;
    
    var appointment = {
        id: editId || Date.now().toString(),
        date: date,
        time: document.getElementById('appointmentTime').value,
        reminder: document.getElementById('appointmentReminder').value,
        doctorName: document.getElementById('doctorName').value.trim(),
        reason: reason,
        questions: document.getElementById('appointmentQuestions').value.trim(),
        doctorNotes: document.getElementById('doctorNotes').value.trim(),
        prescriptions: document.getElementById('prescriptionsGiven').value.trim(),
        tests: document.getElementById('testsOrdered').value.trim(),
        createdAt: editId ? appointments.find(a => a.id === editId).createdAt : Date.now(),
        updatedAt: Date.now()
    };
    
    if (editId) {
        // Update existing
        var index = appointments.findIndex(a => a.id === editId);
        if (index !== -1) {
            appointments[index] = appointment;
        }
    } else {
        // Add new
        appointments.push(appointment);
    }
    
    saveAppointmentsToStorage();
    closeAppointmentModal();
    
    alert('‚úÖ Appointment saved successfully!');
}

// Display recent appointment widget
function updateRecentAppointmentWidget() {
    var widget = document.getElementById('recent-appointment-widget');
    var content = document.getElementById('recent-appointment-content');
    
    if (appointments.length === 0) {
        widget.style.display = 'none';
        return;
    }
    
    var now = new Date();
    now.setHours(0, 0, 0, 0); // Set to start of day for comparison
    
    // Separate future and past appointments
    var futureAppts = appointments.filter(a => {
        var apptDate = parseLocalDate(a.date);
        apptDate.setHours(0, 0, 0, 0);
        return apptDate >= now;
    });
    
    var pastAppts = appointments.filter(a => {
        var apptDate = parseLocalDate(a.date);
        apptDate.setHours(0, 0, 0, 0);
        return apptDate < now;
    });
    
    var recent, widgetTitle;
    
    // Priority 1: Show next upcoming appointment (soonest future)
    if (futureAppts.length > 0) {
        futureAppts.sort((a, b) => {
            var dateA = parseLocalDate(a.date);
            if (a.time) {
                var timeParts = a.time.split(':');
                dateA.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]));
            }
            var dateB = parseLocalDate(b.date);
            if (b.time) {
                var timeParts = b.time.split(':');
                dateB.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]));
            }
            return dateA - dateB; // Ascending - soonest first
        });
        recent = futureAppts[0];
        
        var apptDate = parseLocalDate(recent.date);
        var isToday = apptDate.toDateString() === new Date().toDateString();
        if (isToday) {
            widgetTitle = 'ü©∫ Today\'s Doctor Appointment';
        } else {
            var daysUntil = Math.ceil((apptDate - new Date()) / (1000 * 60 * 60 * 24));
            widgetTitle = 'ü©∫ Upcoming Appointment (in ' + daysUntil + ' day' + (daysUntil !== 1 ? 's' : '') + ')';
        }
    } 
    // Priority 2: Show most recent past appointment
    else if (pastAppts.length > 0) {
        pastAppts.sort((a, b) => {
            var dateA = parseLocalDate(a.date);
            if (a.time) {
                var timeParts = a.time.split(':');
                dateA.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]));
            }
            var dateB = parseLocalDate(b.date);
            if (b.time) {
                var timeParts = b.time.split(':');
                dateB.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]));
            }
            return dateB - dateA; // Descending - most recent first
        });
        recent = pastAppts[0];
        widgetTitle = 'ü©∫ Most Recent Doctor Visit';
    } else {
        widget.style.display = 'none';
        return;
    }
    
    var apptDate = parseLocalDate(recent.date);
    var isPast = apptDate < new Date();
    var isFuture = apptDate >= new Date();
    
    var html = '<div style="background:white;border-radius:8px;padding:16px">';
    html += '<div style="display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:start">';
    
    // Date section
    html += '<div style="text-align:center;background:#' + (isFuture ? 'dbeafe' : 'f3f4f6') + ';padding:12px;border-radius:8px;min-width:80px">';
    html += '<div style="font-size:28px;font-weight:700;color:#1e3a8a">' + apptDate.getDate() + '</div>';
    html += '<div style="font-size:14px;color:#3b82f6">' + apptDate.toLocaleDateString('en-US', {month: 'short'}) + '</div>';
    html += '<div style="font-size:12px;color:#6b7280">' + apptDate.getFullYear() + '</div>';
    if (recent.time) {
        html += '<div style="font-size:14px;color:#374151;margin-top:4px">üïê ' + formatTime12Hour(recent.time) + '</div>';
    }
    html += '</div>';
    
    // Details section
    html += '<div>';
    if (recent.doctorName) {
        html += '<div style="font-weight:600;color:#1f2937;font-size:18px;margin-bottom:4px">üë®‚Äç‚öïÔ∏è ' + recent.doctorName + '</div>';
    }
    html += '<div style="color:#374151;margin-bottom:8px"><strong>Reason:</strong> ' + recent.reason + '</div>';
    
    if (recent.doctorNotes) {
        html += '<div style="background:#f0fdf4;border-left:3px solid #22c55e;padding:8px;margin-top:8px;border-radius:4px">';
        html += '<div style="font-weight:600;color:#15803d;margin-bottom:4px">üìù Doctor\'s Notes:</div>';
        html += '<div style="color:#166534;font-size:14px">' + recent.doctorNotes.replace(/\n/g, '<br>') + '</div>';
        html += '</div>';
    }
    
    if (recent.prescriptions) {
        html += '<div style="background:#fef3c7;border-left:3px solid #f59e0b;padding:8px;margin-top:8px;border-radius:4px">';
        html += '<div style="font-weight:600;color:#92400e;margin-bottom:4px">üíä Prescriptions:</div>';
        html += '<div style="color:#78350f;font-size:14px">' + recent.prescriptions.replace(/\n/g, '<br>') + '</div>';
        html += '</div>';
    }
    
    if (recent.tests) {
        html += '<div style="background:#dbeafe;border-left:3px solid #3b82f6;padding:8px;margin-top:8px;border-radius:4px">';
        html += '<div style="font-weight:600;color:#1e40af;margin-bottom:4px">üî¨ Tests Ordered:</div>';
        html += '<div style="color:#1e3a8a;font-size:14px">' + recent.tests.replace(/\n/g, '<br>') + '</div>';
        html += '</div>';
    }
    
    html += '</div>';
    
    // Actions section
    html += '<div style="display:flex;flex-direction:column;gap:8px">';
    html += '<button class="btn" style="background:#3b82f6;padding:8px 16px;font-size:14px;white-space:nowrap" onclick="openAppointmentModal(\'' + recent.id + '\')">‚úèÔ∏è Edit</button>';
    html += '<button class="btn" style="background:#ef4444;padding:8px 16px;font-size:14px;white-space:nowrap" onclick="deleteAppointment(\'' + recent.id + '\')">üóëÔ∏è Delete</button>';
    html += '</div>';
    
    html += '</div></div>';
    
    document.getElementById('recent-appointment-title').textContent = widgetTitle;
    content.innerHTML = html;
    widget.style.display = 'block';
}

// Delete appointment with confirmation
function deleteAppointment(id) {
    var appt = appointments.find(a => a.id === id);
    if (!appt) return;
    
    var confirmMsg = '‚ö†Ô∏è Are you sure you want to delete this appointment?\n\n';
    confirmMsg += 'Date: ' + parseLocalDate(appt.date).toLocaleDateString() + '\n';
    confirmMsg += 'Doctor: ' + (appt.doctorName || 'Not specified') + '\n';
    confirmMsg += 'Reason: ' + appt.reason;
    
    if (confirm(confirmMsg)) {
        appointments = appointments.filter(a => a.id !== id);
        saveAppointmentsToStorage();
        filterAppointments(); // Refresh the list if open
        alert('‚úÖ Appointment deleted successfully');
    }
}

// Open appointments list modal
function viewAllAppointments() {
    document.getElementById('appointmentsListModal').style.display = 'flex';
    filterAppointments();
}

// Close appointments list modal
function closeAppointmentsListModal() {
    document.getElementById('appointmentsListModal').style.display = 'none';
}

// Filter and display appointments
function filterAppointments() {
    var searchTerm = document.getElementById('appointmentSearch').value.toLowerCase();
    var sortOrder = document.getElementById('appointmentSortOrder').value;
    var startDate = document.getElementById('appointmentFilterStart').value;
    var endDate = document.getElementById('appointmentFilterEnd').value;
    
    var filtered = appointments.filter(appt => {
        // Search filter
        var matchesSearch = !searchTerm || 
            (appt.doctorName && appt.doctorName.toLowerCase().includes(searchTerm)) ||
            (appt.reason && appt.reason.toLowerCase().includes(searchTerm)) ||
            (appt.doctorNotes && appt.doctorNotes.toLowerCase().includes(searchTerm)) ||
            (appt.questions && appt.questions.toLowerCase().includes(searchTerm));
        
        // Date range filter
        var apptDate = parseLocalDate(appt.date);
        var matchesDateRange = true;
        if (startDate) {
            matchesDateRange = matchesDateRange && apptDate >= parseLocalDate(startDate);
        }
        if (endDate) {
            matchesDateRange = matchesDateRange && apptDate <= parseLocalDate(endDate);
        }
        
        return matchesSearch && matchesDateRange;
    });
    
    // Sort
    filtered.sort((a, b) => {
        var dateA = new Date(a.date + ' ' + (a.time || '00:00'));
        var dateB = new Date(b.date + ' ' + (b.time || '00:00'));
        
        if (sortOrder === 'newest') {
            return dateB - dateA;
        } else if (sortOrder === 'oldest') {
            return dateA - dateB;
        } else if (sortOrder === 'upcoming') {
            var now = new Date();
            var futureA = dateA >= now;
            var futureB = dateB >= now;
            if (futureA && !futureB) return -1;
            if (!futureA && futureB) return 1;
            return dateA - dateB;
        }
    });
    
    displayAppointmentsList(filtered);
}

// Display appointments list
function displayAppointmentsList(apptList) {
    var container = document.getElementById('appointmentsList');
    
    if (apptList.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:#6b7280">No appointments found matching your criteria</div>';
        return;
    }
    
    var html = '';
    var now = new Date();
    
    apptList.forEach(appt => {
        var apptDate = parseLocalDate(appt.date);
        var isPast = apptDate < now;
        var isToday = apptDate.toDateString() === now.toDateString();
        var isFuture = apptDate > now && !isToday;
        
        var bgColor = isFuture ? '#dbeafe' : (isToday ? '#fef3c7' : '#f3f4f6');
        var borderColor = isFuture ? '#3b82f6' : (isToday ? '#f59e0b' : '#d1d5db');
        
        html += '<div style="background:' + bgColor + ';border:2px solid ' + borderColor + ';border-radius:12px;padding:16px;margin-bottom:12px">';
        html += '<div style="display:flex;justify-content:space-between;align-items:start;gap:12px">';
        
        // Date badge
        html += '<div style="text-align:center;background:white;padding:10px;border-radius:8px;min-width:70px;border:2px solid ' + borderColor + '">';
        html += '<div style="font-size:24px;font-weight:700;color:#1e3a8a">' + apptDate.getDate() + '</div>';
        html += '<div style="font-size:12px;color:#3b82f6">' + apptDate.toLocaleDateString('en-US', {month: 'short', year: 'numeric'}) + '</div>';
        if (appt.time) {
            html += '<div style="font-size:13px;color:#374151;margin-top:4px">üïê ' + formatTime12Hour(appt.time) + '</div>';
        }
        html += '</div>';
        
        // Details
        html += '<div style="flex:1">';
        
        if (isToday) {
            html += '<div style="display:inline-block;background:#f59e0b;color:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600;margin-bottom:8px">üìÖ TODAY</div>';
        } else if (isFuture) {
            var daysUntil = Math.ceil((apptDate - now) / (1000 * 60 * 60 * 24));
            html += '<div style="display:inline-block;background:#3b82f6;color:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600;margin-bottom:8px">üìÖ In ' + daysUntil + ' day' + (daysUntil !== 1 ? 's' : '') + '</div>';
        }
        
        if (appt.doctorName) {
            html += '<div style="font-weight:600;color:#1f2937;font-size:16px;margin-bottom:4px">üë®‚Äç‚öïÔ∏è ' + appt.doctorName + '</div>';
        }
        html += '<div style="color:#374151;margin-bottom:8px"><strong>Reason:</strong> ' + appt.reason + '</div>';
        
        if (appt.questions) {
            html += '<div style="background:white;padding:8px;margin-top:8px;border-radius:6px;border-left:3px solid #8b5cf6">';
            html += '<div style="font-size:13px;color:#6b21a8;font-weight:600;margin-bottom:4px">‚ùì Questions for Doctor:</div>';
            html += '<div style="font-size:13px;color:#4b5563;white-space:pre-wrap">' + appt.questions + '</div>';
            html += '</div>';
        }
        
        if (appt.doctorNotes) {
            html += '<div style="background:white;padding:8px;margin-top:8px;border-radius:6px;border-left:3px solid #22c55e">';
            html += '<div style="font-size:13px;color:#15803d;font-weight:600;margin-bottom:4px">üìù Doctor\'s Notes:</div>';
            html += '<div style="font-size:13px;color:#166534;white-space:pre-wrap">' + appt.doctorNotes + '</div>';
            html += '</div>';
        }
        
        if (appt.prescriptions) {
            html += '<div style="background:white;padding:8px;margin-top:8px;border-radius:6px;border-left:3px solid #f59e0b">';
            html += '<div style="font-size:13px;color:#92400e;font-weight:600;margin-bottom:4px">üíä Prescriptions:</div>';
            html += '<div style="font-size:13px;color:#78350f;white-space:pre-wrap">' + appt.prescriptions + '</div>';
            html += '</div>';
        }
        
        if (appt.tests) {
            html += '<div style="background:white;padding:8px;margin-top:8px;border-radius:6px;border-left:3px solid #3b82f6">';
            html += '<div style="font-size:13px;color:#1e40af;font-weight:600;margin-bottom:4px">üî¨ Tests Ordered:</div>';
            html += '<div style="font-size:13px;color:#1e3a8a;white-space:pre-wrap">' + appt.tests + '</div>';
            html += '</div>';
        }
        
        html += '</div>';
        
        // Actions
        html += '<div style="display:flex;flex-direction:column;gap:8px">';
        html += '<button class="btn" style="background:#3b82f6;padding:8px 12px;font-size:13px" onclick="openAppointmentModal(\'' + appt.id + '\')">‚úèÔ∏è Edit</button>';
        html += '<button class="btn" style="background:#ef4444;padding:8px 12px;font-size:13px" onclick="deleteAppointment(\'' + appt.id + '\')">üóëÔ∏è Delete</button>';
        html += '</div>';
        
        html += '</div></div>';
    });
    
    container.innerHTML = html;
}

// Clear appointment filters
function clearAppointmentFilters() {
    document.getElementById('appointmentSearch').value = '';
    document.getElementById('appointmentFilterStart').value = '';
    document.getElementById('appointmentFilterEnd').value = '';
    document.getElementById('appointmentSortOrder').value = 'newest';
    filterAppointments();
}

// ================== VIEW ALL PROCEDURES ==================

function viewAllProcedures() {
    document.getElementById('proceduresListModal').style.display = 'flex';
    filterProcedures();
}

function closeProceduresListModal() {
    document.getElementById('proceduresListModal').style.display = 'none';
}

function filterProcedures() {
    var searchTerm = document.getElementById('procedureSearch').value.toLowerCase();
    var sortOrder = document.getElementById('procedureSortOrder').value;
    var startDate = document.getElementById('procedureFilterStart').value;
    var endDate = document.getElementById('procedureFilterEnd').value;
    
    var filtered = (procedures || []).filter(function(proc) {
        var matchesSearch = !searchTerm ||
            (proc.name && proc.name.toLowerCase().includes(searchTerm)) ||
            (proc.category && proc.category.toLowerCase().includes(searchTerm)) ||
            (proc.physician && proc.physician.toLowerCase().includes(searchTerm)) ||
            (proc.facility && proc.facility.toLowerCase().includes(searchTerm)) ||
            (proc.notes && proc.notes.toLowerCase().includes(searchTerm));
        
        var procDate = new Date(proc.timestamp);
        var matchesDateRange = true;
        if (startDate) {
            matchesDateRange = matchesDateRange && procDate >= parseLocalDate(startDate);
        }
        if (endDate) {
            var endDateObj = parseLocalDate(endDate);
            endDateObj.setHours(23, 59, 59, 999);
            matchesDateRange = matchesDateRange && procDate <= endDateObj;
        }
        
        return matchesSearch && matchesDateRange;
    });
    
    filtered.sort(function(a, b) {
        var dateA = new Date(a.timestamp);
        var dateB = new Date(b.timestamp);
        return sortOrder === 'oldest' ? dateA - dateB : dateB - dateA;
    });
    
    displayProceduresList(filtered);
}

function displayProceduresList(procList) {
    var container = document.getElementById('proceduresList');
    var totalProcs = (procedures || []).length;
    
    // Summary (always visible)
    var summaryHtml = '<div style="padding:10px 14px;font-size:13px;color:#6b7280;background:#f9fafb;border-radius:8px;margin-bottom:12px;border:1px solid #e5e7eb">';
    summaryHtml += 'üìä Your procedure history contains <strong>' + totalProcs + ' procedure' + (totalProcs !== 1 ? 's' : '') + '</strong>.';
    if (procList.length !== totalProcs) {
        summaryHtml += '<br>üîç Your search/filters narrowed this to <strong>' + procList.length + ' procedure' + (procList.length !== 1 ? 's' : '') + '</strong>.';
    }
    summaryHtml += '</div>';
    
    if (procList.length === 0) {
        container.innerHTML = summaryHtml + '<div style="text-align:center;padding:40px;color:#6b7280">No procedures found matching your criteria</div>';
        return;
    }
    
    var html = summaryHtml;
    
    procList.forEach(function(proc) {
        var procDate = new Date(proc.timestamp);
        var dateStr = procDate.toLocaleDateString('en-US', {weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'});
        var timeStr = procDate.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        
        var catColor = '#dc2626';
        if (proc.category === 'Cardiac') catColor = '#ef4444';
        else if (proc.category === 'Vascular') catColor = '#8b5cf6';
        else if (proc.category === 'Diagnostic') catColor = '#3b82f6';
        else if (proc.category === 'Surgical') catColor = '#f59e0b';
        
        html += '<div style="background:#fff;border:2px solid ' + catColor + ';border-radius:12px;padding:16px;margin-bottom:12px">';
        html += '<div style="display:flex;justify-content:space-between;align-items:start;gap:12px">';
        
        // Date badge
        html += '<div style="text-align:center;background:#fef2f2;padding:10px;border-radius:8px;min-width:70px;border:2px solid ' + catColor + '">';
        html += '<div style="font-size:24px;font-weight:700;color:' + catColor + '">' + procDate.getDate() + '</div>';
        html += '<div style="font-size:12px;color:' + catColor + '">' + procDate.toLocaleDateString('en-US', {month: 'short', year: 'numeric'}) + '</div>';
        html += '<div style="font-size:13px;color:#374151;margin-top:4px">üïê ' + timeStr + '</div>';
        html += '</div>';
        
        // Details
        html += '<div style="flex:1">';
        
        if (proc.category) {
            html += '<div style="display:inline-block;background:' + catColor + ';color:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600;margin-bottom:8px">' + proc.category + '</div>';
        }
        
        html += '<div style="font-weight:700;color:#1f2937;font-size:18px;margin-bottom:4px">üè• ' + proc.name + '</div>';
        
        if (proc.facility) {
            html += '<div style="color:#374151;margin-bottom:4px"><strong>Facility:</strong> ' + proc.facility + '</div>';
        }
        if (proc.physician) {
            html += '<div style="color:#374151;margin-bottom:4px"><strong>Physician:</strong> ' + proc.physician + '</div>';
        }
        
        if (proc.notes) {
            html += '<div style="background:#fef2f2;padding:8px;margin-top:8px;border-radius:6px;border-left:3px solid ' + catColor + '">';
            html += '<div style="font-size:13px;color:#991b1b;font-weight:600;margin-bottom:4px">üìù Notes:</div>';
            html += '<div style="font-size:13px;color:#4b5563;white-space:pre-wrap">' + proc.notes + '</div>';
            html += '</div>';
        }
        
        html += '</div>';
        
        // Actions
        html += '<div style="display:flex;flex-direction:column;gap:8px">';
        var actualIdx = procedures.indexOf(proc);
        html += '<button class="btn" style="background:#3b82f6;padding:8px 12px;font-size:13px" onclick="closeProceduresListModal();editProcedure(' + actualIdx + ')">‚úèÔ∏è Edit</button>';
        html += '<button class="btn" style="background:#ef4444;padding:8px 12px;font-size:13px" onclick="deleteProcedureFromList(' + actualIdx + ')">üóëÔ∏è Delete</button>';
        html += '</div>';
        
        html += '</div></div>';
    });
    
    container.innerHTML = html;
}

function deleteProcedureFromList(index) {
    if (confirm('Delete this medical procedure?')) {
        procedures.splice(index, 1);
        saveProcedures();
        showProcedures();
        filterProcedures();
        if (procedures.length === 0) closeProceduresListModal();
    }
}

function clearProcedureFilters() {
    document.getElementById('procedureSearch').value = '';
    document.getElementById('procedureFilterStart').value = '';
    document.getElementById('procedureFilterEnd').value = '';
    document.getElementById('procedureSortOrder').value = 'newest';
    filterProcedures();
}

// ================== VIEW ALL MEALS ==================

function viewAllMeals() {
    document.getElementById('mealsListModal').style.display = 'flex';
    filterMeals();
}

function closeMealsListModal() {
    document.getElementById('mealsListModal').style.display = 'none';
}

function filterMeals() {
    var searchTerm = document.getElementById('mealSearch').value.toLowerCase();
    var sortOrder = document.getElementById('mealSortOrder').value;
    var startDate = document.getElementById('mealFilterStart').value;
    var endDate = document.getElementById('mealFilterEnd').value;
    
    // Gather all meals from history (mirrors getAllHistoricalData approach)
    var allMeals = [];
    var todayKey = getTodayKey();
    var daysScanned = 0;
    var daysWithMeals = 0;
    
    // Today's meals from current session
    if (M.length > 0) {
        daysWithMeals++;
        M.forEach(function(meal) {
            allMeals.push(Object.assign({}, meal, {_date: todayKey}));
        });
    }
    
    // Historical meals from localStorage
    for (var i = 0; i < localStorage.length; i++) {
        var key = localStorage.key(i);
        var dateStr = null;
        
        // New format: BP_TRACKER_YYYY-MM-DD
        if (key && key.startsWith('BP_TRACKER_') && key !== 'BP_TRACKER_DAILY_DATA' && key !== 'BP_TRACKER_SETTINGS' && key !== 'BP_TRACKER_PROCEDURES') {
            dateStr = key.replace('BP_TRACKER_', '');
        }
        // Legacy format: data-YYYY-MM-DD
        else if (key && key.startsWith('data-')) {
            dateStr = key.replace('data-', '');
        }
        
        if (!dateStr || !dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) continue;
        if (dateStr === todayKey) continue; // Already added from session
        
        daysScanned++;
        try {
            var dayData = JSON.parse(localStorage.getItem(key));
            if (dayData && dayData.meals && dayData.meals.length > 0) {
                daysWithMeals++;
                dayData.meals.forEach(function(meal) {
                    allMeals.push(Object.assign({}, meal, {_date: dateStr}));
                });
            }
        } catch (e) {}
    }
    
    // Store totals before filtering for the summary line
    var totalMealsBeforeFilter = allMeals.length;
    var totalDaysWithMeals = daysWithMeals;
    var totalDaysScanned = daysScanned;
    
    // Filter
    var filtered = allMeals.filter(function(meal) {
        var matchesSearch = !searchTerm ||
            (meal.m && meal.m.toLowerCase().includes(searchTerm));
        
        var matchesDateRange = true;
        if (startDate && meal._date) {
            matchesDateRange = matchesDateRange && meal._date >= startDate;
        }
        if (endDate && meal._date) {
            matchesDateRange = matchesDateRange && meal._date <= endDate;
        }
        
        return matchesSearch && matchesDateRange;
    });
    
    // Sort
    filtered.sort(function(a, b) {
        var dateTimeA = a._date + ' ' + (a.t || '00:00');
        var dateTimeB = b._date + ' ' + (b.t || '00:00');
        return sortOrder === 'oldest' ? dateTimeA.localeCompare(dateTimeB) : dateTimeB.localeCompare(dateTimeA);
    });
    
    displayMealsList(filtered, totalMealsBeforeFilter, totalDaysWithMeals, totalDaysScanned);
}

function displayMealsList(mealList, totalBeforeFilter, daysWithMeals, daysScanned) {
    var container = document.getElementById('mealsList');
    
    // Data source summary (always visible)
    var summaryHtml = '<div style="padding:10px 14px;font-size:13px;color:#6b7280;background:#f9fafb;border-radius:8px;margin-bottom:12px;border:1px solid #e5e7eb">';
    summaryHtml += 'üìä Your meal history contains <strong>' + (totalBeforeFilter || 0) + ' meals</strong> recorded over <strong>' + (daysWithMeals || 0) + ' days</strong>.';
    if (mealList.length !== (totalBeforeFilter || 0)) {
        summaryHtml += '<br>üîç Your search/filters narrowed this to <strong>' + mealList.length + ' meal' + (mealList.length !== 1 ? 's' : '') + '</strong>.';
    }
    summaryHtml += '</div>';
    
    if (mealList.length === 0) {
        container.innerHTML = summaryHtml + '<div style="text-align:center;padding:40px;color:#6b7280">No meals found matching your criteria</div>';
        return;
    }
    
    var html = summaryHtml;
    var currentDate = '';
    
    mealList.forEach(function(meal) {
        // Date grouping header
        if (meal._date !== currentDate) {
            currentDate = meal._date;
            var displayDate = currentDate;
            try {
                var d = parseLocalDate(currentDate);
                displayDate = d.toLocaleDateString('en-US', {weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'});
            } catch(e) {}
            html += '<div style="background:#f3f4f6;padding:10px 16px;border-radius:8px;margin-bottom:8px;margin-top:12px;font-weight:700;color:#374151;font-size:16px">üìÖ ' + displayDate + '</div>';
        }
        
        html += '<div style="background:#fff;border:2px solid #fbbf24;border-radius:12px;padding:14px;margin-bottom:8px">';
        html += '<div style="display:flex;justify-content:space-between;align-items:start">';
        html += '<div style="flex:1">';
        
        // Time
        if (meal.t) {
            html += '<div style="font-size:13px;color:#6b7280;margin-bottom:4px">üïê ' + meal.t + '</div>';
        }
        
        // Event tag
        if (meal.eventId) {
            var evt = getEventById(meal.eventId);
            if (evt) {
                html += '<div style="display:inline-block;padding:4px 10px;background:#f0fdf4;border:1px solid #86efac;border-radius:6px;font-size:13px;font-weight:600;color:#166534;margin-bottom:8px">' + evt.icon + ' ' + evt.name + '</div><br>';
            }
        }
        
        // Meal description
        html += '<div style="font-weight:600;font-size:17px;color:#1f2937">' + meal.m + '</div>';
        
        // Fluid with meal
        if (meal.mealFluidOz && meal.mealFluidOz > 0) {
            html += '<div style="margin-top:6px;font-size:13px;color:#3b82f6">üíß ' + meal.mealFluidOz + ' oz fluid with meal</div>';
        }
        
        html += '</div></div></div>';
    });
    
    container.innerHTML = html;
}

function clearMealFilters() {
    document.getElementById('mealSearch').value = '';
    document.getElementById('mealFilterStart').value = '';
    document.getElementById('mealFilterEnd').value = '';
    document.getElementById('mealSortOrder').value = 'newest';
    filterMeals();
}

// ================== CUSTOM CONDITIONS ==================

function addCustomCondition() {
    var input = document.getElementById('newCustomCondition');
    if (!input) return;
    var val = input.value.trim();
    if (!val) {
        alert('Please enter a condition name');
        return;
    }
    if (!settings.customConditions) settings.customConditions = [];
    if (settings.customConditions.length >= 5) {
        alert('Maximum 5 custom conditions allowed');
        return;
    }
    // Check for duplicates
    var allConditions = (settings.conditions || []).concat(settings.customConditions);
    if (allConditions.indexOf(val) >= 0) {
        alert('This condition already exists');
        return;
    }
    settings.customConditions.push(val);
    settings.conditions.push(val); // Auto-select when added
    try {
        localStorage.setItem('BP_TRACKER_SETTINGS', JSON.stringify(settings));
    } catch(e) {}
    // Refresh settings modal
    openSettings();
}

function removeCustomCondition(index) {
    if (!settings.customConditions) return;
    var condName = settings.customConditions[index];
    if (confirm('Remove custom condition "' + condName + '"?')) {
        settings.customConditions.splice(index, 1);
        // Also remove from selected conditions
        var condIdx = (settings.conditions || []).indexOf(condName);
        if (condIdx >= 0) settings.conditions.splice(condIdx, 1);
        try {
            localStorage.setItem('BP_TRACKER_SETTINGS', JSON.stringify(settings));
        } catch(e) {}
        // Refresh settings modal
        openSettings();
    }
}

// Check for appointment reminders
function checkAppointmentReminders() {
    if (!appointments || appointments.length === 0) return;
    
    var now = new Date();
    var today = now.toDateString();
    
    appointments.forEach(appt => {
        if (!appt.reminder || appt.reminder === 'none') return;
        
        var apptDate = parseLocalDate(appt.date);
        var daysUntil = Math.ceil((apptDate - now) / (1000 * 60 * 60 * 24));
        
        // Check if we should show reminder
        var shouldRemind = false;
        var reminderKey = 'appt_reminder_' + appt.id + '_' + today;
        
        if (localStorage.getItem(reminderKey)) {
            return; // Already shown today
        }
        
        if (appt.reminder === '1day' && daysUntil === 1) {
            shouldRemind = true;
        } else if (appt.reminder === '3days' && daysUntil === 3) {
            shouldRemind = true;
        } else if (appt.reminder === '1week' && daysUntil === 7) {
            shouldRemind = true;
        } else if (appt.reminder === '2weeks' && daysUntil === 14) {
            shouldRemind = true;
        }
        
        if (shouldRemind) {
            localStorage.setItem(reminderKey, 'shown');
            var msg = 'ü©∫ Doctor Appointment Reminder!\n\n';
            msg += 'You have an appointment in ' + daysUntil + ' day' + (daysUntil !== 1 ? 's' : '') + ':\n\n';
            msg += 'Date: ' + apptDate.toLocaleDateString() + '\n';
            if (appt.time) msg += 'Time: ' + formatTime12Hour(appt.time) + '\n';
            if (appt.doctorName) msg += 'Doctor: ' + appt.doctorName + '\n';
            msg += 'Reason: ' + appt.reason;
            alert(msg);
        }
    });
}

// Helper function to format time in 12-hour format with AM/PM
function formatTime12Hour(time24) {
    if (!time24) return '';
    var parts = time24.split(':');
    var hours = parseInt(parts[0]);
    var minutes = parts[1];
    var ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12; // 0 should be 12
    return hours + ':' + minutes + ' ' + ampm;
}

// Helper function to parse date string in local timezone (avoids UTC conversion issues)
function parseLocalDate(dateString) {
    var parts = dateString.split('-');
    // new Date(year, monthIndex, day) creates date in local timezone
    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
}

// Initialize appointments system
loadAppointments();
setInterval(checkAppointmentReminders, 60000 * 60); // Check every hour

// Request OS notification permission silently on startup.
// If already granted or denied, this is a no-op.
// If 'default', Chrome will prompt ‚Äî user sees the browser permission dialog.
setTimeout(function(){ requestOSNotificationPermission(false); }, 2000);

// ============================================================
// ANDROID TAB-RESUME FIX (v9.5.5-AR)
// On Android Chrome, tabs are suspended in the background.
// When the user returns, in-memory state can be stale (or the
// date can have ticked over midnight).  Re-load from localStorage
// and refresh all displays the moment the tab becomes visible again.
// ============================================================
(function(){
  var lastVisibleDate = getTodayKey();

  document.addEventListener('visibilitychange', function(){
    if(document.visibilityState !== 'visible') return;

    var nowDate = getTodayKey();

    if(nowDate !== lastVisibleDate){
      // Date rolled over while tab was in background ‚Äî full reset
      lastVisibleDate = nowDate;
      M=[]; B=[]; W=[]; S=[]; A=[]; fluidLog=[]; medLog=[]; notes=[];
      dailyFluid=0; exportedToday=false; dismissedEvents=[];
      firedEvents={};
      if(typeof firedReminders !== 'undefined') firedReminders={};
      if(typeof loadFiredReminders === 'function') loadFiredReminders();
      if(dailyPlan && dailyPlan.length>0){
        dailyPlan.forEach(function(evt){ evt.completed=false; });
        if(typeof savePlan === 'function') savePlan();
      }
    } else {
      // Same day ‚Äî reload from storage in case data was written by another
      // tab instance or the OS killed/restored the page
      lastVisibleDate = nowDate;
      loadDailyData();
    }

    // Refresh all visible data
    refreshAllDisplays();
    updateFluid();
    if(typeof updateNextEvent === 'function') updateNextEvent();
    if(typeof updateUpcomingEventsWidget === 'function') updateUpcomingEventsWidget();
    renderBPChart();
    renderFluidChart();
    showTodayZone();
    // Android tab-resume fix: fire any reminders/alerts that were skipped while
    // the browser was suspended in the background
    if(typeof checkEventReminders === 'function') checkEventReminders();
    if(typeof checkScheduledAlerts === 'function') checkScheduledAlerts();
    console.log('[ClinBridge] Tab resumed ‚Äì displays refreshed ('+nowDate+')');
  });
})();
(function() {
  var FIRST_RUN_KEY = 'CLINBRIDGE_FIRST_RUN_DONE';
  if (!localStorage.getItem(FIRST_RUN_KEY)) {
    // Short delay so the page finishes rendering first
    setTimeout(function() {
      openHelpModal('welcome');
    }, 500);
    localStorage.setItem(FIRST_RUN_KEY, new Date().toISOString());
  }
})();

// ============================================================
// DATA MANAGEMENT ‚Äî Reset Today / Delete All (v9.5.5-DM)
// ============================================================

// Identify which localStorage keys belong to this app
function getAppKeys() {
  var all = [];
  for (var i = 0; i < localStorage.length; i++) {
    var key = localStorage.key(i);
    if (key.startsWith('BP_TRACKER_') ||
        key.startsWith('dismissedEvents_') ||
        key.startsWith('appt_reminder_') ||
        key === 'dailyPlan' ||
        key === 'medicineList' ||
        key === 'cardiacAppointments' ||
        key === 'customSymptoms' ||
        key === 'customActivities' ||
        key === 'analyticsNotes' ||
        key === 'CLINBRIDGE_FIRST_RUN_DONE') {
      all.push(key);
    }
  }
  return all;
}

// Identify today-only keys
function getTodayKeys() {
  var today = getTodayKey(); // YYYY-MM-DD
  var todayKeys = [];
  for (var i = 0; i < localStorage.length; i++) {
    var key = localStorage.key(i);
    // BP_TRACKER_YYYY-MM-DD (today's daily data)
    if (key === 'BP_TRACKER_' + today) {
      todayKeys.push(key);
    }
    // dismissedEvents_YYYY-MM-DD (today's dismissed events)
    if (key === 'dismissedEvents_' + today) {
      todayKeys.push(key);
    }
    // appt_reminder_*_<today's dateString> (today's fired appointment reminders)
    if (key.startsWith('appt_reminder_') && key.endsWith('_' + new Date().toDateString())) {
      todayKeys.push(key);
    }
    // dailyPlan (single-day working plan)
    if (key === 'dailyPlan') {
      todayKeys.push(key);
    }
    // BP_TRACKER_FIRED_REMINDERS ‚Äî clear only today's entries
    // (handled separately in resetToday to preserve other days)
  }
  return todayKeys;
}

// Preview which keys will be deleted for Reset Today
function previewResetToday() {
  var keys = getTodayKeys();
  var previewEl = document.getElementById('resetTodayPreview');

  if (keys.length === 0) {
    previewEl.style.display = 'block';
    previewEl.innerHTML = '<strong>No data found for today (' + getTodayKey() + ').</strong> Nothing to reset.';
    return;
  }

  var html = '<strong>Keys to be removed (' + keys.length + '):</strong><br>';
  keys.forEach(function(k) { html += '‚Ä¢ ' + k + '<br>'; });

  // Check for fired reminders with today's entries
  var firedRaw = localStorage.getItem('BP_TRACKER_FIRED_REMINDERS');
  if (firedRaw) {
    html += '‚Ä¢ BP_TRACKER_FIRED_REMINDERS (today\'s entries only)<br>';
  }

  html += '<br><button onclick="executeResetToday()" class="btn" style="background:#dc2626;padding:14px;font-size:18px;margin:0">' +
          '‚ö†Ô∏è Confirm: Reset Today\'s Data</button>';
  previewEl.style.display = 'block';
  previewEl.innerHTML = html;
}

// Execute Reset Today
function executeResetToday() {
  if (!confirm('Are you sure you want to delete today\'s data (' + getTodayKey() + ')?\n\nThis cannot be undone.')) {
    return;
  }

  var keys = getTodayKeys();
  var count = 0;

  keys.forEach(function(k) {
    localStorage.removeItem(k);
    count++;
  });

  // Clean today's entries from BP_TRACKER_FIRED_REMINDERS
  var today = getTodayKey();
  var firedRaw = localStorage.getItem('BP_TRACKER_FIRED_REMINDERS');
  if (firedRaw) {
    try {
      var fired = JSON.parse(firedRaw);
      // fired is typically keyed by date; remove today's key
      if (fired[today]) {
        delete fired[today];
        localStorage.setItem('BP_TRACKER_FIRED_REMINDERS', JSON.stringify(fired));
        count++;
      }
    } catch(e) { /* ignore parse errors */ }
  }

  // Reset in-memory state for today
  if (typeof dailyData !== 'undefined') {
    dailyData = { bp: [], meals: [], fluids: [], symptoms: [], activities: [], notes: '' };
  }
  if (typeof dismissedEvents !== 'undefined') {
    dismissedEvents = [];
  }
  if (typeof dailyPlan !== 'undefined') {
    dailyPlan = null;
  }

  // Refresh display
  if (typeof renderTimeline === 'function') { try { renderTimeline(); } catch(e) {} }
  if (typeof updateTodayView === 'function') { try { updateTodayView(); } catch(e) {} }

  var previewEl = document.getElementById('resetTodayPreview');
  previewEl.innerHTML = '<strong style="color:#15803d">‚úÖ Done!</strong> Removed ' + count + ' item(s) for ' + today + '.';

  alert('Today\'s data has been reset (' + count + ' item' + (count !== 1 ? 's' : '') + ' removed).\n\nYour settings, medications, and past days are untouched.');
}

// Preview which keys will be deleted for Delete All
function previewDeleteAll() {
  var keys = getAppKeys();
  var previewEl = document.getElementById('deleteAllPreview');

  if (keys.length === 0) {
    previewEl.style.display = 'block';
    previewEl.innerHTML = '<strong>No app data found.</strong> Storage is already clean.';
    return;
  }

  // Categorize for clarity
  var daily = 0, settings = 0, other = 0;
  keys.forEach(function(k) {
    if (k.match(/^BP_TRACKER_\d{4}-\d{2}-\d{2}$/)) daily++;
    else if (k === 'BP_TRACKER_SETTINGS') settings++;
    else other++;
  });

  var html = '<strong>Total keys to be removed: ' + keys.length + '</strong><br>';
  if (daily > 0) html += '‚Ä¢ ' + daily + ' daily data record(s)<br>';
  if (settings > 0) html += '‚Ä¢ Settings<br>';
  html += '‚Ä¢ ' + other + ' other key(s) (medications, procedures, appointments, etc.)<br>';
  html += '<br><details style="margin-bottom:12px"><summary style="cursor:pointer;color:#991b1b">Show all keys</summary><div style="margin-top:8px">';
  keys.forEach(function(k) { html += '‚Ä¢ ' + k + '<br>'; });
  html += '</div></details>';

  html += '<button onclick="executeDeleteAll()" class="btn" style="background:#dc2626;padding:14px;font-size:18px;margin:0">' +
          '‚ö†Ô∏è Confirm: DELETE ALL DATA</button>';
  previewEl.style.display = 'block';
  previewEl.innerHTML = html;
}

// Execute Delete All
function executeDeleteAll() {
  if (!confirm('‚ö†Ô∏è DELETE ALL DATA ‚ö†Ô∏è\n\nThis will permanently erase ALL your ClinBridge data on this device:\n' +
               '‚Ä¢ All daily readings (every day)\n‚Ä¢ Settings & preferences\n‚Ä¢ Medications & procedures\n' +
               '‚Ä¢ Appointments\n‚Ä¢ Custom symptoms & activities\n‚Ä¢ Analytics notes & reminders\n\n' +
               'This CANNOT be undone. Continue?')) {
    return;
  }

  // Second confirmation for safety
  if (!confirm('FINAL CONFIRMATION\n\nType-to-confirm is not available in this browser.\nClick OK one more time to permanently delete everything.')) {
    return;
  }

  var keys = getAppKeys();
  var count = keys.length;

  // Remove all app keys
  keys.forEach(function(k) {
    localStorage.removeItem(k);
  });

  // Reset in-memory state
  if (typeof dailyData !== 'undefined') {
    dailyData = { bp: [], meals: [], fluids: [], symptoms: [], activities: [], notes: '' };
  }
  if (typeof dismissedEvents !== 'undefined') { dismissedEvents = []; }
  if (typeof dailyPlan !== 'undefined') { dailyPlan = null; }
  if (typeof medicineList !== 'undefined') { medicineList = []; }
  if (typeof procedures !== 'undefined') { procedures = []; }
  if (typeof appointments !== 'undefined') { appointments = []; }
  if (typeof settings !== 'undefined') {
    // Re-initialize to defaults
    settings = {
      enableWeight: true,
      enableSymptoms: true,
      enableActivity: true,
      enableFluid: true,
      enableMeals: true,
      enableNotes: true,
      weightUnit: 'lbs',
      fluidUnit: 'oz',
      reminderTimes: [],
      enableAudioAlerts: false
    };
  }

  // Refresh display
  if (typeof renderTimeline === 'function') { try { renderTimeline(); } catch(e) {} }
  if (typeof updateTodayView === 'function') { try { updateTodayView(); } catch(e) {} }

  var previewEl = document.getElementById('deleteAllPreview');
  previewEl.innerHTML = '<strong style="color:#15803d">‚úÖ Done!</strong> Removed ' + count + ' item(s). The app is now in a fresh state.';

  alert('All ClinBridge data has been deleted (' + count + ' item' + (count !== 1 ? 's' : '') + ' removed).\n\nThe app is now in a fresh-install state. You may want to reload the page.');
}

</script>
</body>
</html>